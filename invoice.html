<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Invoice</title>
<style>
body { font-family: "Segoe UI", sans-serif; background: #f8f9fb; margin: 0; padding: 0; }
.invoice-container { max-width: 900px; margin: 40px auto; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.1); padding: 30px; border-radius: 12px; }
header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
.shop-name { font-size: 26px; font-weight: bold; color: #333; }
.invoice-meta { text-align: right; }
.invoice-meta div { color: #555; }
h2 { text-align: center; margin: 20px 0; color: #444; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border-bottom: 1px solid #ddd; text-align: left; padding: 10px; }
th { background: #f3f4f6; }
.total { text-align: right; margin-top: 20px; font-size: 18px; font-weight: bold; }
.total-words { color: #666; font-style: italic; }
.info { margin-top: 20px; color: #333; }
.btns { display: flex; justify-content: space-between; margin-top: 25px; }
button { background: #0078d7; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 15px; }
button:hover { background: #005fa3; }
input { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 250px; }
.search-section { text-align: center; margin-bottom: 20px; }
.editable { background: #f9f9f9; border: 1px dashed #ccc; padding: 4px; border-radius: 6px; }
</style>
</head>
<body>

<div class="invoice-container">
  <div class="search-section">
    <input type="text" id="invoiceInput" placeholder="Enter Invoice Number">
    <button onclick="loadInvoice()">Search Invoice</button>
  </div>

  <header>
    <div class="shop-name" id="shopName">Shop Name</div>
    <div class="invoice-meta">
      <div><strong>Invoice:</strong> <span id="invoiceNumber"></span></div>
      <div><strong>Date:</strong> <span id="invoiceDate"></span></div>
      <div><strong>Sales Person:</strong> <span id="salesPerson"></span></div>
    </div>
  </header>

  <div class="info">
    <strong>Customer Name:</strong> <span id="custName"></span><br>
    <strong>Mobile:</strong> <span id="custMobile"></span><br>
    <strong>Address:</strong> <span id="custAddress"></span><br>
    <strong>GST:</strong> <span id="custGST"></span><br>
    <strong>Tag:</strong> 
    <span id="tagField" class="editable" contenteditable="true" onblur="updateTag()"></span>
  </div>

  <h2>Invoice Details</h2>
  <table>
    <thead>
      <tr>
        <th>Product ID</th>
        <th>Item Name</th>
        <th>Batch No</th>
        <th>Qty</th>
        <th>Price (â‚¹)</th>
        <th>Subtotal (â‚¹)</th>
      </tr>
    </thead>
    <tbody id="itemTable"></tbody>
  </table>

  <div class="total">
    Total: â‚¹<span id="totalAmount">0.00</span><br>
    <span class="total-words" id="amountWords"></span>
  </div>

  <div class="btns">
    <button onclick="window.print()">ðŸ–¨ Print Invoice</button>
  </div>
</div>

<script>
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const SALES_TABLE = 736209;
const PRODUCT_TABLE = 734793;
let currentRowId = null;

function inWords(num) {
  const a=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
  const b=['','', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
  if((num=num.toString()).length>9) return 'Overflow';
  let n=('000000000'+num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
  if(!n) return; let str='';
  str += (n[1]!=0)?(a[Number(n[1])]||b[n[1][0]]+' '+a[n[1][1]])+'Crore ':'';
  str += (n[2]!=0)?(a[Number(n[2])]||b[n[2][0]]+' '+a[n[2][1]])+'Lakh ':'';
  str += (n[3]!=0)?(a[Number(n[3])]||b[n[3][0]]+' '+a[n[3][1]])+'Thousand ':'';
  str += (n[4]!=0)?(a[Number(n[4])]||b[n[4][0]]+' '+a[n[4][1]])+'Hundred ':'';
  str += (n[5]!=0)?((str!='')?'and ':'')+(a[Number(n[5])]||b[n[5][0]]+' '+a[n[5][1]])+'Rupees Only':'';
  return str;
}

window.onload = () => {
  document.getElementById("shopName").textContent = localStorage.getItem("ShopTag") || "Shop Name";
  const urlParams = new URLSearchParams(window.location.search);
  const inv = urlParams.get("inv");
  if(inv){ document.getElementById("invoiceInput").value=inv; loadInvoice(); }
};

async function loadInvoice() {
  const inv = document.getElementById("invoiceInput").value.trim();
  if(!inv) return alert("Enter Invoice Number");

  const shopIdTag = localStorage.getItem("ShopIDTag");
  if(!shopIdTag) return alert("ShopIDTag not found in localStorage");

  const salesResp = await fetch(`https://api.baserow.io/api/database/rows/table/${SALES_TABLE}/?user_field_names=true&filter__field=Invoice Number__equal=${inv}`, {
    headers:{ Authorization:`Token ${API_KEY}` }
  });
  const salesData = await salesResp.json();
  if(!salesData.results.length) return alert("Invoice not found");

  console.log("Invoice Row Data:", salesData.results[0]); 

  // Use exact ShopID field
  const shopIdFromSales = salesData.results[0].ShopID;

  if(shopIdTag.toString()!==shopIdFromSales.toString()){
    return alert(`Access denied! ShopIDTag (${shopIdTag}) does not match ShopID (${shopIdFromSales}) in Sales Table.`);
  }

  const row = salesData.results[0];
  document.getElementById("invoiceNumber").textContent = row["Invoice Number"];
  document.getElementById("invoiceDate").textContent = row.Date;
  document.getElementById("custName").textContent = row["Costomer Name"];
  document.getElementById("custMobile").textContent = row["Mobile-number"];
  document.getElementById("custAddress").textContent = row.Address;
  document.getElementById("custGST").textContent = row.GST || "Nil";
  document.getElementById("salesPerson").textContent = row["Sales Person"];
  document.getElementById("tagField").textContent = row.Tag || "";
  currentRowId = row.id;

  let total = 0;
  let tableHTML = "";
  for(const r of salesData.results){
    const pid = r["Product ID"];
    const pname = r["Item Name"] || await getProductName(pid);
    const qty = parseFloat(r.Quantity||0);
    const price = parseFloat(r.Price||0);
    const subtotal = qty*price;
    total += subtotal;

    tableHTML += `<tr>
      <td>${pid}</td>
      <td>${pname}</td>
      <td>${r["Batch No"]}</td>
      <td>${qty}</td>
      <td>${price.toFixed(2)}</td>
      <td>${subtotal.toFixed(2)}</td>
    </tr>`;
  }
  document.getElementById("itemTable").innerHTML = tableHTML;
  document.getElementById("totalAmount").textContent = total.toFixed(2);
  document.getElementById("amountWords").textContent = inWords(Math.round(total));
}

async function getProductName(pid){
  const resp = await fetch(`https://api.baserow.io/api/database/rows/table/${PRODUCT_TABLE}/?user_field_names=true&filter__field=Product ID__equal=${pid}`, {
    headers:{ Authorization:`Token ${API_KEY}` }
  });
  const data = await resp.json();
  return data.results[0]?.["Product Name"] || "N/A";
}

async function updateTag(){
  const newTag = document.getElementById("tagField").textContent.trim();
  if(!currentRowId) return;
  await fetch(`https://api.baserow.io/api/database/rows/table/${SALES_TABLE}/${currentRowId}/?user_field_names=true`, {
    method:"PATCH",
    headers:{ Authorization:`Token ${API_KEY}`, "Content-Type":"application/json" },
    body: JSON.stringify({ Tag:newTag })
  });
  alert("Tag updated successfully!");
}
</script>
</body>
</html>