<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Management</title>
<style>
body{font-family:Arial, sans-serif;background:#f3f4f6;margin:0;padding:20px;}
.container{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
h1{text-align:center;color:#333;}
label{font-weight:bold;display:block;margin-top:10px;}
input,textarea,select{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:5px;}
button{margin-top:15px;padding:10px 16px;border:none;border-radius:5px;background:#2563eb;color:white;font-weight:bold;cursor:pointer;}
button:hover{background:#1e40af;}
#video{width:100%;max-height:240px;background:#000;margin-top:10px;border-radius:8px;}
.notice{padding:10px;border-radius:6px;margin-bottom:10px;}
.success{background:#d1fae5;color:#065f46;}
.error{background:#fee2e2;color:#991b1b;}
.disabled input, .disabled textarea, .disabled select, .disabled button:not(#startScan):not(#stopScan){opacity:0.5;pointer-events:none;}
</style>
</head>
<body>

<div class="container">
<h1>Inventory Management</h1>
<div id="message"></div>

<div id="userInfo" class="notice"></div>

<!-- Camera and Scan Section -->
<div>
  <label>Scan Product Barcode</label>
  <video id="video" autoplay></video>
  <button id="startScan">Start Camera</button>
  <button id="stopScan" style="background:#6b7280;">Stop Camera</button>
</div>

<!-- Product Form -->
<div id="formContainer">
  <label>Product ID</label>
  <input type="text" id="productId" placeholder="Scan or enter product ID">

  <label>Product Name</label>
  <input type="text" id="productName">

  <label>Details</label>
  <textarea id="details" rows="3"></textarea>

  <label>Price</label>
  <input type="number" id="price" step="0.01">

  <label>Image (File URL)</label>
  <input type="text" id="image">

  <hr>

  <label>Count</label>
  <input type="number" id="count">

  <label>Batch No</label>
  <input type="text" id="batch">

  <label>Expiry Date</label>
  <input type="date" id="expiry">

  <label>Date</label>
  <input type="date" id="date">

  <label>Location</label>
  <input type="text" id="location">

  <button id="saveBtn">Add to Inventory</button>
</div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const SITE = "https://api.baserow.io";
const USER_TABLE = 729979;
const PRODUCT_TABLE = 734793;
const INVENTORY_TABLE = 734795;

const message = document.getElementById("message");
const userInfo = document.getElementById("userInfo");
const formContainer = document.getElementById("formContainer");

// --- Step 1: Get MobileTag from localStorage ---
const MobileTag = localStorage.getItem("MobileTag");
if(!MobileTag){
  message.innerHTML = `<div class="notice error">‚ùå Please login first. MobileTag not found in localStorage.</div>`;
  formContainer.classList.add("disabled");
}else{
  validateUser();
}

async function validateUser(){
  try{
    const res = await fetch(`${SITE}/api/database/rows/table/${USER_TABLE}/?user_field_names=true`,{
      headers:{Authorization:`Token ${API_KEY}`}
    });
    const data = await res.json();
    const user = data.results.find(r => r.Username === MobileTag);
    if(!user){
      message.innerHTML = `<div class="notice error">‚ùå User not found in Baserow.</div>`;
      formContainer.classList.add("disabled");
      return;
    }

    userInfo.innerHTML = `‚úÖ Logged in as <b>${user.Username}</b> ‚Äî Role: <b>${user.Role}</b>`;
    if(user.Role.toLowerCase() !== "manager"){
      formContainer.classList.add("disabled");
      message.innerHTML = `<div class="notice error">üîí Access Denied: Only Managers can update inventory.</div>`;
    }else{
      message.innerHTML = `<div class="notice success">‚úÖ Access Granted. You can manage inventory.</div>`;
      setupCameraScanner();
    }
  }catch(e){
    message.innerHTML = `<div class="notice error">Error: ${e.message}</div>`;
  }
}

// --- Step 2: Setup Camera and Barcode Scanning ---
let codeReader;
function setupCameraScanner(){
  codeReader = new ZXing.BrowserMultiFormatReader();
  document.getElementById("startScan").addEventListener("click", async ()=>{
    try{
      const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
      const selectedDeviceId = devices[0].deviceId;
      codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err)=>{
        if(result){
          document.getElementById("productId").value = result.text;
          message.innerHTML = `<div class="notice success">üì∑ Scanned: ${result.text}</div>`;
        }
      });
    }catch(err){
      message.innerHTML = `<div class="notice error">Camera Error: ${err}</div>`;
    }
  });

  document.getElementById("stopScan").addEventListener("click", ()=>{
    codeReader.reset();
    message.innerHTML = `<div class="notice">Camera stopped.</div>`;
  });
}

// --- Step 3: Add to Inventory ---
document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const payload = {
    "Product ID": document.getElementById("productId").value.trim(),
    "Product Name": document.getElementById("productName").value.trim(),
    "Details": document.getElementById("details").value.trim(),
    "Price": parseFloat(document.getElementById("price").value) || 0,
    "Image": document.getElementById("image").value.trim(),
  };

  const invPayload = {
    "Product ID": document.getElementById("productId").value.trim(),
    "Count": parseInt(document.getElementById("count").value) || 0,
    "Batch No": document.getElementById("batch").value.trim(),
    "Expiry Date": document.getElementById("expiry").value,
    "Date": document.getElementById("date").value,
    "Location": document.getElementById("location").value.trim(),
    "ShopID": MobileTag
  };

  try{
    // --- Save Product if not exists ---
    const check = await fetch(`${SITE}/api/database/rows/table/${PRODUCT_TABLE}/?user_field_names=true`,{
      headers:{Authorization:`Token ${API_KEY}`}
    });
    const data = await check.json();
    const exist = data.results.find(p => p["Product ID"] === payload["Product ID"]);

    if(!exist){
      await fetch(`${SITE}/api/database/rows/table/${PRODUCT_TABLE}/?user_field_names=true`,{
        method:"POST",
        headers:{Authorization:`Token ${API_KEY}`,"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
    }

    // --- Add to Inventory Table ---
    const invRes = await fetch(`${SITE}/api/database/rows/table/${INVENTORY_TABLE}/?user_field_names=true`,{
      method:"POST",
      headers:{Authorization:`Token ${API_KEY}`,"Content-Type":"application/json"},
      body:JSON.stringify(invPayload)
    });

    if(invRes.ok){
      message.innerHTML = `<div class="notice success">‚úÖ Inventory record added successfully!</div>`;
      document.getElementById("formContainer").reset;
    }else{
      const errTxt = await invRes.text();
      message.innerHTML = `<div class="notice error">‚ùå Failed: ${errTxt}</div>`;
    }
  }catch(e){
    message.innerHTML = `<div class="notice error">${e.message}</div>`;
  }
});
</script>
</body>
</html>