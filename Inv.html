<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add / Manage Inventory</title>
<style>
body{font-family:Inter,system-ui,Arial;margin:0;padding:20px;background:#f3f4f6}
.container{max-width:950px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,0.06)}
h1{margin-top:0}
label{font-weight:600;display:block;margin-top:12px}
input,textarea,select{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;box-sizing:border-box}
button{padding:10px 14px;border:none;border-radius:8px;cursor:pointer}
button.primary{background:#2563eb;color:#fff}
button.secondary{background:#e5e7eb}
.notice{padding:10px;margin-bottom:10px;border-radius:8px;background:#fef3c7}
video{width:100%;max-width:340px;border-radius:8px}
#cameraWrap{display:none;margin-top:12px}
</style>
</head>
<body>
<div class="container">
  <h1>Inventory Management</h1>
  <div id="status" class="notice">Loading user details…</div>

  <div id="loginError" class="notice" style="background:#fee2e2;display:none">
    ⚠️ Please login first (MobileTag missing in local storage)
  </div>

  <div id="accessError" class="notice" style="background:#fee2e2;display:none"></div>

  <div id="mainForm" style="display:none">
    <label>Operation</label>
    <select id="operation">
      <option value="existing">Existing Product (Scan / Type ID)</option>
      <option value="new">New Product</option>
    </select>

    <div style="margin-top:12px">
      <label>Product ID</label>
      <input id="productId" placeholder="Scan or type product ID">
      <div style="margin-top:6px">
        <button id="startCam" class="secondary">Start Camera</button>
        <button id="stopCam" class="secondary">Stop Camera</button>
        <button id="fetchBtn" class="secondary">Fetch Product</button>
        <button id="genBtn" class="secondary">Generate ID</button>
      </div>
    </div>

    <div id="cameraWrap">
      <video id="preview" playsinline></video>
    </div>

    <label>Product Name</label>
    <input id="pname">
    <label>Details</label>
    <textarea id="pdetails" rows="3"></textarea>
    <label>Price</label>
    <input id="price" type="number" step="0.01">
    <label>Image (optional)</label>
    <input id="img" type="file" accept="image/*">

    <hr>
    <h3>Stock / Batch Info</h3>
    <label>Count</label><input id="count" type="number">
    <label>Batch No</label><input id="batch">
    <label>Expire Date</label><input id="expire" type="date">
    <label>Date</label><input id="date" type="date">
    <label>Location</label><input id="location">
    <label>Shop ID</label><input id="shopid" readonly>

    <div style="margin-top:16px">
      <button id="addBtn" class="primary">Add to Inventory</button>
      <span id="msg" style="margin-left:10px"></span>
    </div>
  </div>
</div>

<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
(async ()=>{
  const API_KEY="jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
  const BASE="https://api.baserow.io";
  const USER_TBL=729979, PROD_TBL=734793, INV_TBL=734795;
  const MobileTag=localStorage.getItem("MobileTag");
  const ShopIDTag=localStorage.getItem("ShopIDTag")||"";
  const status=document.getElementById("status");
  const mainForm=document.getElementById("mainForm");
  const accessError=document.getElementById("accessError");
  const loginError=document.getElementById("loginError");

  if(!MobileTag){ loginError.style.display="block"; status.style.display="none"; return; }

  async function getRole(){
    const r=await fetch(`${BASE}/api/database/rows/table/${USER_TBL}/?user_field_names=true`,{
      headers:{Authorization:"Token "+API_KEY}
    });
    const j=await r.json();
    const u=(j.results||j).find(x=>String(x.Username)===String(MobileTag));
    return u?u.Role:null;
  }

  const role=await getRole();
  if(!role){ accessError.style.display="block"; accessError.textContent="User not found."; status.style.display="none"; return; }

  status.textContent=`Logged in as ${MobileTag} (${role})`;
  mainForm.style.display="block";
  document.getElementById("shopid").value=ShopIDTag;
  document.getElementById("date").value=new Date().toISOString().slice(0,10);

  if(role.toLowerCase()!=="manager"){
    document.querySelectorAll("input,textarea,select,button").forEach(e=>e.disabled=true);
    status.textContent+=" – Read only (Staff)";
    return;
  }

  /* ---------- Camera Scan ---------- */
  let html5QrCode;
  const camWrap=document.getElementById("cameraWrap");
  const startCam=document.getElementById("startCam");
  const stopCam=document.getElementById("stopCam");
  const productId=document.getElementById("productId");
  startCam.onclick=async()=>{
    camWrap.style.display="block";
    if(html5QrCode){html5QrCode.stop();html5QrCode.clear();}
    html5QrCode=new Html5Qrcode("preview");
    const devices=await Html5Qrcode.getCameras();
    const id=devices[0]?.id;
    if(!id){alert("No camera found");return;}
    html5QrCode.start(id,{fps:10,qrbox:250},
      decoded=>{productId.value=decoded;status.textContent="Scanned → "+decoded;},
      err=>{}
    );
  };
  stopCam.onclick=()=>{ if(html5QrCode){html5QrCode.stop();html5QrCode.clear();} camWrap.style.display="none"; };

  /* ---------- Product Handling ---------- */
  const fetchBtn=document.getElementById("fetchBtn");
  const genBtn=document.getElementById("genBtn");
  fetchBtn.onclick=async()=>{
    const pid=productId.value.trim();
    if(!pid){status.textContent="Enter Product ID";return;}
    const res=await fetch(`${BASE}/api/database/rows/table/${PROD_TBL}/?user_field_names=true`,{
      headers:{Authorization:"Token "+API_KEY}
    });
    const data=await res.json();
    const prod=(data.results||data).find(p=>String(p["Product ID"])===pid);
    if(!prod){status.textContent="No product found";return;}
    document.getElementById("pname").value=prod["Product Name"]||"";
    document.getElementById("pdetails").value=prod["Details"]||"";
    document.getElementById("price").value=prod["Price"]||"";
    status.textContent="Product loaded successfully";
  };
  genBtn.onclick=()=>{ productId.value="P"+Date.now(); status.textContent="Generated Product ID"; };

  /* ---------- Add to Inventory ---------- */
  const addBtn=document.getElementById("addBtn");
  const msg=document.getElementById("msg");
  addBtn.onclick=async()=>{
    const pid=productId.value.trim();
    const op=document.getElementById("operation").value;
    if(!pid){msg.textContent="❌ Product ID required";return;}

    // if new → create product first
    if(op==="new"){
      const payload={
        "Product ID":pid,
        "Product Name":document.getElementById("pname").value,
        "Details":document.getElementById("pdetails").value,
        "Price":Number(document.getElementById("price").value)||0
      };
      await fetch(`${BASE}/api/database/rows/table/${PROD_TBL}/?user_field_names=true`,{
        method:"POST",
        headers:{Authorization:"Token "+API_KEY,"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
    }

    const inv={
      "Product ID":pid,
      "Count":Number(document.getElementById("count").value)||0,
      "Batch No":document.getElementById("batch").value,
      "Expire Date":document.getElementById("expire").value,
      "Date":document.getElementById("date").value,
      "Location":document.getElementById("location").value,
      "ShopID":ShopIDTag
    };
    const r=await fetch(`${BASE}/api/database/rows/table/${INV_TBL}/?user_field_names=true`,{
      method:"POST",
      headers:{Authorization:"Token "+API_KEY,"Content-Type":"application/json"},
      body:JSON.stringify(inv)
    });
    msg.textContent=r.ok?"✅ Inventory added":"❌ Error adding inventory";
  };
})();
</script>
</body>
</html>