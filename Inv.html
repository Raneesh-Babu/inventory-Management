<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Product & Inventory</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
  .container { max-width:500px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
  input, button { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc; }
  button { background:#007bff; color:white; cursor:pointer; }
  button:hover { background:#0056b3; }
  #reader { width:100%; height:400px; display:none; }
</style>
</head>
<body>
<div class="container">
  <h2>Add Product / Inventory</h2>
  <button id="scanBtn">ðŸ“· Scan Product ID</button>
  <button id="switchBtn" style="display:none;">ðŸ”„ Switch Camera</button>
  <div id="reader"></div>

  <label>Product ID</label>
  <input type="text" id="productId" placeholder="Scan or Enter Product ID">

  <label>Product Name</label>
  <input type="text" id="productName">

  <label>Details</label>
  <textarea id="details"></textarea>

  <label>Price</label>
  <input type="number" id="price">

  <label>Count</label>
  <input type="number" id="count">

  <label>Batch No</label>
  <input type="number" id="batchNo">

  <label>Expire Date</label>
  <input type="date" id="expireDate">

  <label>Location</label>
  <input type="text" id="location">

  <button id="addBtn">Add to Inventory</button>
</div>

<script>
const BASEROW_URL = "https://api.baserow.io/api/database/rows/table/";
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const USER_TABLE = 729979;
const PRODUCT_TABLE = 734793;
const INVENTORY_TABLE = 734795;

let shopIDTag = localStorage.getItem("ShopIDTag");
let mobileTag = localStorage.getItem("MobileTag");
let role = "";
let cameraId = null;
let html5QrCode = null;

async function checkRole() {
  if (!mobileTag) {
    alert("Please login first!");
    window.location.href = "login.html";
    return;
  }

  const res = await fetch(`${BASEROW_URL}${USER_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });
  const data = await res.json();
  const user = data.results.find(u => u.Username === mobileTag);

  if (!user) { alert("User not found."); return; }
  role = user.Role;
  shopIDTag = user.ShopName;

  if (role !== "Manager") {
    document.querySelectorAll("input, button").forEach(el => el.disabled = true);
    alert("Access Denied. Only Managers can add stocks!");
  }
}
checkRole();

// Camera Functions
const reader = document.getElementById("reader");
const scanBtn = document.getElementById("scanBtn");
const switchBtn = document.getElementById("switchBtn");

scanBtn.addEventListener("click", async () => {
  reader.style.display = "block";
  switchBtn.style.display = "block";
  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
  const devices = await Html5Qrcode.getCameras();
  if (devices.length) {
    cameraId = devices[0].id;
    startScanner();
  }
});

switchBtn.addEventListener("click", async () => {
  const devices = await Html5Qrcode.getCameras();
  if (devices.length > 1) {
    cameraId = (cameraId === devices[0].id) ? devices[1].id : devices[0].id;
    await html5QrCode.stop();
    startScanner();
  } else {
    alert("No secondary camera found!");
  }
});

function startScanner() {
  html5QrCode.start(
    cameraId,
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      document.getElementById("productId").value = qrCodeMessage;
      html5QrCode.stop();
      reader.style.display = "none";
      switchBtn.style.display = "none";
      fetchProductDetails(qrCodeMessage);
    }
  ).catch(err => console.error(err));
}

async function fetchProductDetails(id) {
  const res = await fetch(`${BASEROW_URL}${PRODUCT_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });
  const data = await res.json();
  const prod = data.results.find(p => p["Product ID"] === id);
  if (prod) {
    document.getElementById("productName").value = prod["Product Name"];
    document.getElementById("details").value = prod["Details"];
    document.getElementById("price").value = prod["Price"];
  } else {
    alert("New Product! Please fill details.");
  }
}

document.getElementById("addBtn").addEventListener("click", async () => {
  const productId = document.getElementById("productId").value.trim();
  const productName = document.getElementById("productName").value.trim();
  const details = document.getElementById("details").value.trim();
  const price = document.getElementById("price").value.trim();
  const count = document.getElementById("count").value.trim();
  const batchNo = document.getElementById("batchNo").value.trim();
  const expireDate = document.getElementById("expireDate").value;
  const location = document.getElementById("location").value.trim();
  const dateNow = new Date().toISOString().split('T')[0];

  if (!productId || !count) { alert("Product ID and Count required!"); return; }

  // Check if Product ID already exists
  const res = await fetch(`${BASEROW_URL}${PRODUCT_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });
  const data = await res.json();
  const existing = data.results.find(p => p["Product ID"] === productId);

  // Add to Product table if new
  if (!existing) {
    await fetch(`${BASEROW_URL}${PRODUCT_TABLE}/`, {
      method: "POST",
      headers: {
        Authorization: `Token ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        "Product ID": productId,
        "Product Name": productName,
        "Details": details,
        "Price": parseFloat(price),
        "ShopID": shopIDTag
      })
    });
  }

  // Add to Inventory table
  await fetch(`${BASEROW_URL}${INVENTORY_TABLE}/`, {
    method: "POST",
    headers: {
      Authorization: `Token ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      "Product ID": productId,
      "Count": parseInt(count),
      "Batch No": parseInt(batchNo),
      "Expire Date": expireDate,
      "Date": dateNow,
      "Location": location,
      "ShopID": shopIDTag
    })
  });

  alert("Product Added to Inventory!");
  document.querySelector("form")?.reset();
});
</script>
</body>
</html>