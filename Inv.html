<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Product & Inventory</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:0; text-align:center; }
  h2 { background:#0984e3; color:white; padding:10px; margin:0; }
  .container { padding:15px; max-width:450px; margin:auto; }
  input, textarea, select, button {
    width:100%; padding:10px; margin:6px 0; border:1px solid #ccc; border-radius:6px;
  }
  button { background:#0984e3; color:white; font-weight:bold; border:none; cursor:pointer; border-radius:8px; }
  button:disabled { background:#b2bec3; cursor:not-allowed; }
  #reader { width:100%; margin-top:10px; display:none; }
  #status { margin:10px 0; font-weight:bold; color:#2d3436; }
</style>
</head>
<body>
<h2>Add Product & Inventory</h2>
<div class="container">
  <div id="status">Checking user...</div>
  <div id="loginPrompt" style="display:none; color:red;">Please login first.</div>
  <div id="accessDenied" style="display:none; color:red;"></div>

  <div id="app" style="display:none;">
    <button id="startScanBtn">Start Camera Scan</button>
    <div id="reader"></div>

    <h3>Product Details</h3>
    <input type="text" id="productId" placeholder="Product ID (scan or auto)">
    <input type="text" id="productName" placeholder="Product Name">
    <textarea id="details" placeholder="Details"></textarea>
    <input type="number" id="price" placeholder="Price">
    <input type="file" id="image">

    <h3>Inventory Details</h3>
    <input type="number" id="count" placeholder="Count">
    <input type="number" id="batchNo" placeholder="Batch No">
    <input type="date" id="expireDate" placeholder="Expire Date">
    <input type="text" id="location" placeholder="Location">

    <button id="addBtn" disabled>Add to Inventory</button>
  </div>
</div>

<script>
const API_KEY = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw';
const BASEROW_BASE = 'https://api.baserow.io';
const USERS_TABLE = 729979;
const PRODUCTS_TABLE = 734793;
const INVENTORY_TABLE = 734795;

let role = "";
let scanner = null;

// 1ï¸âƒ£ User Validation
(async function(){
  const MobileTag = localStorage.getItem("MobileTag");
  const ShopIDTag = localStorage.getItem("ShopIDTag");

  if(!MobileTag){
    document.getElementById("loginPrompt").style.display = "block";
    document.getElementById("status").innerText = "MobileTag missing. Please login.";
    return;
  }

  document.getElementById("status").innerText = "Checking user role...";

  try {
    const url = `${BASEROW_BASE}/api/database/rows/table/${USERS_TABLE}/?user_field_names=true&page_size=1000`;
    const res = await fetch(url, { headers: { Authorization: 'Token ' + API_KEY } });
    const data = await res.json();
    const user = data.results.find(u => String(u.Username) === String(MobileTag));

    if(!user){
      document.getElementById("accessDenied").style.display = "block";
      document.getElementById("accessDenied").innerText = "User not found. Please login again.";
      return;
    }

    role = user.Role || "Staff";
    document.getElementById("status").innerText = "Role: " + role;
    document.getElementById("app").style.display = "block";

    if(role.toLowerCase() === "manager"){
      document.getElementById("addBtn").disabled = false;
    } else {
      document.getElementById("addBtn").disabled = true;
      document.getElementById("status").innerText += " (Read only)";
    }
  } catch(err){
    document.getElementById("status").innerText = "Error fetching user info";
  }
})();

// 2ï¸âƒ£ Camera Scanning
document.getElementById("startScanBtn").addEventListener("click", () => {
  const reader = document.getElementById("reader");
  reader.style.display = "block";
  if(scanner) scanner.clear();
  scanner = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {
    if(devices && devices.length) {
      let backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
      scanner.start(
        backCam.id,
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          document.getElementById("productId").value = qrCodeMessage;
          fetchProductDetails(qrCodeMessage);
          stopScan();
        },
        error => {}
      );
    }
  }).catch(err => alert("Camera error: " + err));
});

function stopScan(){
  if(scanner){
    scanner.stop().then(()=>{ 
      document.getElementById("reader").style.display="none";
    }).catch(()=>{});
  }
}

// 3ï¸âƒ£ Fetch product details by barcode
async function fetchProductDetails(productId){
  const url = `${BASEROW_BASE}/api/database/rows/table/${PRODUCTS_TABLE}/?user_field_names=true&page_size=1000`;
  const res = await fetch(url, { headers: { Authorization: 'Token ' + API_KEY }});
  const data = await res.json();
  const product = data.results.find(p => String(p['Product ID']) === String(productId));

  if(product){
    document.getElementById("productName").value = product['Product Name'] || "";
    document.getElementById("details").value = product['Details'] || "";
    document.getElementById("price").value = product['Price'] || "";
    document.getElementById("status").innerText = "Existing product loaded.";
  } else {
    document.getElementById("status").innerText = "New product detected.";
  }
}

// 4ï¸âƒ£ Add to Inventory
document.getElementById("addBtn").addEventListener("click", async ()=>{
  if(role.toLowerCase() !== "manager") return alert("Access denied. Manager only.");

  let pid = document.getElementById("productId").value.trim();
  if(!pid){
    pid = "PID-" + Date.now();
    document.getElementById("productId").value = pid;
  }

  const name = document.getElementById("productName").value.trim();
  const details = document.getElementById("details").value.trim();
  const price = document.getElementById("price").value.trim();
  const count = document.getElementById("count").value.trim();
  const batchNo = document.getElementById("batchNo").value.trim();
  const expireDate = document.getElementById("expireDate").value;
  const location = document.getElementById("location").value.trim();
  const ShopID = localStorage.getItem("ShopIDTag") || "";

  const now = new Date().toISOString().split('T')[0];

  // ðŸ”¹ Check if product exists
  const purl = `${BASEROW_BASE}/api/database/rows/table/${PRODUCTS_TABLE}/?user_field_names=true`;
  const pres = await fetch(purl, { headers:{Authorization:'Token '+API_KEY}});
  const pdata = await pres.json();
  const exists = pdata.results.find(p=>String(p['Product ID'])===String(pid));

  if(!exists){
    // âž• Add new product
    const formData = new FormData();
    formData.append('Product ID', pid);
    formData.append('Product Name', name);
    formData.append('Details', details);
    formData.append('Price', price);
    const fileInput = document.getElementById("image");
    if(fileInput.files.length>0) formData.append('Image', fileInput.files[0]);

    await fetch(`${BASEROW_BASE}/api/database/rows/table/${PRODUCTS_TABLE}/`, {
      method:"POST", headers:{Authorization:'Token '+API_KEY}, body:formData
    });
  }

  // âž• Add to Inventory
  await fetch(`${BASEROW_BASE}/api/database/rows/table/${INVENTORY_TABLE}/`, {
    method:"POST",
    headers:{Authorization:'Token '+API_KEY,'Content-Type':'application/json'},
    body:JSON.stringify({
      'Product ID': pid,
      'Count': parseInt(count)||0,
      'Batch No': parseInt(batchNo)||0,
      'Expire Date': expireDate,
      'Date': now,
      'Location': location,
      'ShopID': ShopID
    })
  });

  alert("Product added successfully!");
  document.getElementById("status").innerText = "Added successfully.";
});
</script>
</body>
</html>