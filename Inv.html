<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Inventory Manager</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
body{font-family:Inter,system-ui,Arial;margin:0;background:#f5f6fa;color:#111}
.container{max-width:900px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,0.1)}
h1{margin-bottom:16px;text-align:center}
input,textarea,select{width:100%;padding:8px;margin-top:4px;margin-bottom:12px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box}
button{padding:10px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
button:disabled{background:#ccc}
label{font-weight:600}
.notice{background:#fff3cd;padding:10px;border-radius:8px;margin-bottom:10px}
.fullscreen-camera{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9999}
#reader{width:90%;max-width:400px;margin:auto}
.close-btn,.switch-btn{background:#ff4444;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;margin:8px}
.switch-btn{background:#2563eb}
</style>
</head>
<body>
<div class="container">
  <h1>Inventory Manager</h1>
  <div id="status" class="notice">Checking access...</div>
  <div id="form" style="display:none;">
    <label>Operation</label>
    <select id="op">
      <option value="existing">Existing Product</option>
      <option value="new">New Product</option>
    </select>

    <label>Product ID / Barcode</label>
    <input id="productId" type="text" placeholder="Scan or enter Product ID">
    <button id="startCamera">Start Camera Scan</button>

    <label>Product Name</label>
    <input id="pname" type="text">

    <label>Details</label>
    <textarea id="pdetails" rows="3"></textarea>

    <label>Price</label>
    <input id="price" type="number" step="0.01">

    <label>Image (Preview Only)</label>
    <input id="imgfile" type="file" accept="image/*">
    <img id="preview" style="max-width:120px;border-radius:8px;display:none">

    <hr>
    <h3>Stock / Batch Info</h3>
    <label>Count</label>
    <input id="count" type="number">

    <label>Batch No</label>
    <input id="batch" type="text">

    <label>Expire Date</label>
    <input id="expiry" type="date">

    <label>Date</label>
    <input id="date" type="date">

    <label>Location</label>
    <input id="location" type="text">

    <label>Shop ID</label>
    <input id="shopid" type="text" readonly>

    <button id="submitBtn">Submit</button>
  </div>
</div>

<!-- Fullscreen Camera -->
<div class="fullscreen-camera" id="cameraOverlay">
  <div style="display:flex;justify-content:center;gap:10px;margin-bottom:10px;">
    <div class="close-btn" id="closeCam">Close</div>
    <div class="switch-btn" id="switchCam">Switch Camera</div>
  </div>
  <div id="reader"></div>
</div>

<script>
(async ()=>{
  const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
  const BASE = "https://api.baserow.io";
  const USER_TABLE = 729979;
  const PRODUCT_TABLE = 734793;
  const INVENTORY_TABLE = 734795;

  const MobileTag = localStorage.getItem("MobileTag");
  const ShopIDTag = localStorage.getItem("ShopIDTag") || "";
  const status = document.getElementById("status");
  const form = document.getElementById("form");

  if(!MobileTag){status.innerText="❌ Login first (MobileTag missing).";return;}

  // Get Role from Baserow
  const roleRes = await fetch(`${BASE}/api/database/rows/table/${USER_TABLE}/?user_field_names=true`,{
    headers:{Authorization:"Token "+API_KEY}
  });
  const roleData = await roleRes.json();
  const userRow = roleData.results.find(r=>r.Username==MobileTag);
  if(!userRow){status.innerText="User not found.";return;}
  const role = userRow.Role;
  status.innerText = `✅ Logged in as ${MobileTag} (${role})`;

  if(role.toLowerCase()!=="manager"){
    status.innerText += " — Staff view (Read-only)";
    form.querySelectorAll("input,textarea,select,button").forEach(e=>e.disabled=true);
    return;
  }

  form.style.display="block";
  document.getElementById("shopid").value=ShopIDTag;
  document.getElementById("date").value=new Date().toISOString().slice(0,10);

  const productIdField=document.getElementById("productId");
  const op=document.getElementById("op");
  const preview=document.getElementById("preview");
  const imgfile=document.getElementById("imgfile");
  imgfile.onchange=()=>{const f=imgfile.files[0];if(f){preview.src=URL.createObjectURL(f);preview.style.display="block";}}

  op.onchange=()=>{
    if(op.value==="new"){
      productIdField.value="P"+Date.now();
      productIdField.readOnly=true;
    }else{
      productIdField.value="";
      productIdField.readOnly=false;
    }
  };

  // Fullscreen QR scanner with switch camera
  const cameraOverlay=document.getElementById("cameraOverlay");
  const html5QrCode=new Html5Qrcode("reader");
  let cameras=[], currentCamIndex=0;

  document.getElementById("startCamera").onclick=async()=>{
    cameraOverlay.style.display="flex";
    cameras = await Html5Qrcode.getCameras();
    if(!cameras.length){alert("No cameras found");return;}
    startCam(cameras[currentCamIndex].id);
  };

  document.getElementById("switchCam").onclick=()=>{
    if(!cameras.length)return;
    currentCamIndex=(currentCamIndex+1)%cameras.length;
    html5QrCode.stop().then(()=>startCam(cameras[currentCamIndex].id));
  };

  function startCam(camId){
    html5QrCode.start(
      camId,
      {fps:10,qrbox:250},
      qrCodeMessage=>{
        productIdField.value=qrCodeMessage;
        html5QrCode.stop();
        cameraOverlay.style.display="none";
        status.innerText="✅ Scanned: "+qrCodeMessage;
      }
    ).catch(err=>console.error(err));
  }

  document.getElementById("closeCam").onclick=()=>{
    html5QrCode.stop().catch(()=>{});
    cameraOverlay.style.display="none";
  };

  // Submit handler
  document.getElementById("submitBtn").onclick=async()=>{
    const pid=productIdField.value.trim();
    if(!pid){alert("Enter or scan Product ID");return;}

    // 1️⃣ Create product if new
    if(op.value==="new"){
      const payload={
        "Product ID":pid,
        "Product Name":document.getElementById("pname").value,
        "Details":document.getElementById("pdetails").value,
        "Price":parseFloat(document.getElementById("price").value)||0
      };
      await fetch(`${BASE}/api/database/rows/table/${PRODUCT_TABLE}/?user_field_names=true`,{
        method:"POST",headers:{Authorization:"Token "+API_KEY,"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
    }

    // 2️⃣ Add to inventory
    const inv={
      "Product ID":pid,
      "Count":Number(document.getElementById("count").value)||0,
      "Batch No":document.getElementById("batch").value,
      "Expire Date":document.getElementById("expiry").value,
      "Date":document.getElementById("date").value,
      "Location":document.getElementById("location").value,
      "ShopID":ShopIDTag
    };
    const invRes=await fetch(`${BASE}/api/database/rows/table/${INVENTORY_TABLE}/?user_field_names=true`,{
      method:"POST",
      headers:{Authorization:"Token "+API_KEY,"Content-Type":"application/json"},
      body:JSON.stringify(inv)
    });
    if(invRes.ok){status.innerText="✅ Inventory Added Successfully";}
    else{status.innerText="❌ Failed to Add Inventory";}
  };
})();
</script>
</body>
</html>