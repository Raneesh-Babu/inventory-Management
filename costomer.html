<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Database</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f6fa;
    padding: 20px;
  }
  h2 {
    text-align: center;
    color: #2f3640;
  }
  .form-container, .list-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  input, button {
    padding: 10px;
    margin: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    background: #0984e3;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background: #74b9ff;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #dcdde1;
    padding: 8px;
    text-align: left;
  }
  th {
    background: #f1f2f6;
  }
  #search {
    width: 100%;
    margin-bottom: 10px;
  }
  .edit-btn {
    background: #00b894;
    padding: 5px 10px;
    border: none;
    color: white;
    border-radius: 5px;
    cursor: pointer;
  }
  .edit-btn:hover {
    background: #55efc4;
  }
</style>
</head>
<body>

<h2>Customer Database</h2>

<div class="form-container" id="addForm">
  <h3>Add New Customer</h3>
  <input type="text" id="name" placeholder="Customer Name" required><br>
  <input type="number" id="mobile" placeholder="Mobile Number" required><br>
  <textarea id="address" placeholder="Address" required></textarea><br>
  <input type="text" id="gst" placeholder="GST (optional)"><br>
  <button onclick="addCustomer()">Add Customer</button>
</div>

<div class="list-container">
  <h3>Customer List</h3>
  <input type="text" id="search" placeholder="Search by Name or Mobile..." onkeyup="filterList()">
  <table id="customerTable">
    <thead>
      <tr>
        <th>Customer Name</th>
        <th>Mobile</th>
        <th>Address</th>
        <th>GST</th>
        <th>Added By</th>
        <th>Date</th>
        <th id="actionsHeader">Actions</th>
      </tr>
    </thead>
    <tbody id="customerList">
      <tr><td colspan="7" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
const CUSTOMER_API = "https://api.baserow.io/api/database/rows/table/736204/?user_field_names=true";
const USERS_API = "https://api.baserow.io/api/database/rows/table/729979/?user_field_names=true";
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";

const shopID = localStorage.getItem("ShopIDTag");
const addedBy = localStorage.getItem("NameTag");
const mobileTag = localStorage.getItem("MobileTag");
let role = "Staff"; // default

// ðŸ”¹ Step 1: Get Role from Users Table
async function getUserRole() {
  try {
    const res = await fetch(USERS_API, { headers: { Authorization: `Token ${API_KEY}` } });
    const data = await res.json();
    const user = data.results.find(u => u.Username == mobileTag);
    if (user && user.Role) {
      role = user.Role;
    }
    if (role.toLowerCase() !== "manager") {
      document.getElementById("addForm").style.display = "none";
      document.getElementById("actionsHeader").style.display = "none";
    }
  } catch (err) {
    console.error("Error fetching role:", err);
  }
}

// ðŸ”¹ Step 2: Load Customers
async function loadCustomers() {
  const res = await fetch(CUSTOMER_API, { headers: { Authorization: `Token ${API_KEY}` } });
  const data = await res.json();
  const customers = data.results.filter(c => c.ShopID == shopID);
  const list = document.getElementById("customerList");
  list.innerHTML = "";

  if (customers.length === 0) {
    list.innerHTML = `<tr><td colspan="7" style="text-align:center;">No customers found for your shop.</td></tr>`;
    return;
  }

  customers.forEach(c => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${c["Costomer Name"]}</td>
      <td>${c["Mobile"]}</td>
      <td>${c["Address"]}</td>
      <td>${c["GST"] || "Nil"}</td>
      <td>${c["Added by"]}</td>
      <td>${c["Date"]}</td>
      ${role.toLowerCase() === "manager" ? `<td><button class="edit-btn" onclick="editCustomer(${c.id})">Edit</button></td>` : ""}
    `;
    list.appendChild(row);
  });
}

// ðŸ”¹ Step 3: Add New Customer
async function addCustomer() {
  const name = document.getElementById("name").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const address = document.getElementById("address").value.trim();
  const gst = document.getElementById("gst").value.trim() || "Nil";

  if (!name || !mobile || !address) {
    alert("Please fill all required fields!");
    return;
  }

  const res = await fetch(CUSTOMER_API, { headers: { Authorization: `Token ${API_KEY}` } });
  const data = await res.json();
  const existing = data.results.find(c => c.Mobile == Number(mobile) && c.ShopID == shopID);
  if (existing) {
    alert("Customer with this mobile number already exists in your shop!");
    return;
  }

  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

  await fetch(CUSTOMER_API, {
    method: "POST",
    headers: {
      "Authorization": `Token ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      "Costomer Name": name,
      "Mobile": Number(mobile),
      "Address": address,
      "GST": gst,
      "Added by": addedBy || "Unknown",
      "Date": today,
      "ShopID": shopID
    })
  });

  alert("Customer added successfully!");
  document.getElementById("name").value = "";
  document.getElementById("mobile").value = "";
  document.getElementById("address").value = "";
  document.getElementById("gst").value = "";
  loadCustomers();
}

// ðŸ”¹ Step 4: Edit Customer
async function editCustomer(id) {
  const newAddress = prompt("Enter new address:");
  if (!newAddress) return;

  await fetch(`https://api.baserow.io/api/database/rows/table/736204/${id}/?user_field_names=true`, {
    method: "PATCH",
    headers: {
      "Authorization": `Token ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ "Address": newAddress })
  });
  alert("Customer updated successfully!");
  loadCustomers();
}

// ðŸ”¹ Step 5: Search Filter
function filterList() {
  const input = document.getElementById("search").value.toLowerCase();
  const rows = document.querySelectorAll("#customerList tr");
  rows.forEach(row => {
    const name = row.children[0].textContent.toLowerCase();
    const mobile = row.children[1].textContent.toLowerCase();
    row.style.display = name.includes(input) || mobile.includes(input) ? "" : "none";
  });
}

// Run
(async () => {
  await getUserRole();
  await loadCustomers();
  setInterval(loadCustomers, 5000);
})();
</script>

</body>
</html>