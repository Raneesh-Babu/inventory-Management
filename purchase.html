<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Purchase Invoice System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; padding:20px; }
    h2 { text-align:center; margin-bottom:20px; }

    .card {
        background:#fff; padding:20px; border-radius:10px;
        box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:20px;
    }

    input, button {
        padding:10px; font-size:16px; margin:5px 0;
        width:100%; border:1px solid #ccc; border-radius:5px;
    }

    button { background:#007bff; color:#fff; cursor:pointer; }
    button:hover { background:#0056b3; }

    .invoice-list-item {
        padding:12px; background:#fafafa; border:1px solid #ddd;
        border-radius:6px; margin-bottom:10px; cursor:pointer;
    }

    /* GST Invoice Layout */
    #invoiceView { display:none; background:white; padding:20px; }

    .inv-header { text-align:center; padding-bottom:10px; border-bottom:2px solid #000; }
    .inv-header h2 { margin:0; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    table, th, td { border:1px solid black; }
    th, td { padding:8px; text-align:left; }

    .totals { margin-top:20px; width:300px; float:right; }
    .totals td { border:none; }

    @media print {
        body * { visibility: hidden; }
        #invoiceView, #invoiceView * { visibility: visible; }
        #invoiceView { position:absolute; top:0; left:0; }
    }
</style>

</head>
<body>

<h2>Purchase Invoice System (GST)</h2>

<div class="card">
    <h3>üîç Search Invoice</h3>
    <input id="searchInvoice" placeholder="Enter Invoice Number">
    <button onclick="searchByInvoice()">Search</button>
</div>

<div class="card">
    <h3>üìÖ Filter by Date</h3>
    <label>From Date</label>
    <input type="date" id="fromDate">
    <label>To Date</label>
    <input type="date" id="toDate">
    <button onclick="filterByDate()">Filter</button>
</div>

<div class="card">
    <h3>üìÑ Invoice List</h3>
    <div id="invoiceList"></div>
</div>

<!-- INVOICE VIEW -->
<div id="invoiceView" class="card">
    <div class="inv-header">
        <h2>PURCHASE INVOICE</h2>
    </div>

    <p><b>Invoice Number:</b> <span id="invNum"></span></p>
    <p><b>Date:</b> <span id="invDate"></span></p>
    <p><b>ShopID:</b> <span id="shopID"></span></p>

    <h3>Supplier Details</h3>
    <p><b>Name:</b> <span id="supName"></span></p>
    <p><b>ID:</b> <span id="supID"></span></p>
    <p><b>Address:</b> <span id="supAddress"></span></p>

    <h3>Items</h3>
    <table id="itemTable">
        <thead>
            <tr>
                <th>Item</th>
                <th>Product ID</th>
                <th>Price</th>
                <th>GST</th>
                <th>Batch</th>
                <th>Qty</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <table class="totals">
        <tr><td>Subtotal:</td><td id="subTot"></td></tr>
        <tr><td>GST Total:</td><td id="gstTot"></td></tr>
        <tr><td><b>Grand Total:</b></td><td id="grandTot"></td></tr>
    </table>

    <br><br><button onclick="window.print()">Print</button>
</div>

<script>
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const TABLE_ID = 745465;
const API_URL = `https://api.baserow.io/api/database/rows/table/${TABLE_ID}/?user_field_names=true`;

/* ---------- Fetch All Rows ---------- */
async function fetchAll() {
    const res = await fetch(API_URL, {
        headers: { Authorization: `Token ${API_KEY}` }
    });
    const data = await res.json();
    return data.results;
}

/* ---------- Search by Invoice Number ---------- */
async function searchByInvoice() {
    let inv = document.getElementById("searchInvoice").value.trim();
    if (!inv) return alert("Enter invoice number");

    let all = await fetchAll();
    let row = all.find(x => x["Invoice Number"] == inv);

    if (!row) return alert("Invoice not found");

    openInvoice(row);
}

/* ---------- Filter by Date Range ---------- */
async function filterByDate() {
    let f = document.getElementById("fromDate").value;
    let t = document.getElementById("toDate").value;

    if (!f || !t) return alert("Select both dates");

    let from = new Date(f);
    let to = new Date(t);

    let all = await fetchAll();
    let filtered = all.filter(row => {
        let d = new Date(row["Date"]);
        return d >= from && d <= to;
    });

    displayList(filtered);
}

/* ---------- Display Invoice List ---------- */
function displayList(list) {
    let box = document.getElementById("invoiceList");
    box.innerHTML = "";

    if (list.length == 0) {
        box.innerHTML = "<p>No invoices found.</p>";
        return;
    }

    list.forEach(row => {
        let div = document.createElement("div");
        div.className = "invoice-list-item";
        div.innerHTML = `
            <b>${row["Invoice Number"]}</b> <br>
            Supplier: ${row["Supplier Name"]} <br>
            Date: ${row["Date"]}
        `;
        div.onclick = () => openInvoice(row);
        box.appendChild(div);
    });
}

/* ---------- Open Invoice ---------- */
function openInvoice(row) {
    document.getElementById("invNum").innerText = row["Invoice Number"];
    document.getElementById("invDate").innerText = row["Date"];
    document.getElementById("shopID").innerText = row["ShopID"];

    document.getElementById("supName").innerText = row["Supplier Name"];
    document.getElementById("supID").innerText = row["Supplier ID"];
    document.getElementById("supAddress").innerText = row["Supplier Details"];

    parseRemark(row["Remark"]);

    document.getElementById("invoiceView").style.display = "block";
}

/* ---------- Parse Remark into Items ---------- */
function parseRemark(remark) {
    let tbody = document.querySelector("#itemTable tbody");
    tbody.innerHTML = "";

    let items = remark.split(" - "); 

    let subtotal = 0, gstTotal = 0;

    items.forEach(txt => {
        let p = txt.split(",");

        let item = p[0];
        let pid = p[1];
        let price = parseFloat(p[2].replace(/‚Çπ/g,""));
        let gstStr = p[3];
        let batch = p[4].replace("Batch:","");
        let qty = parseInt(p[5].replace("Qty:",""));

        let gstPercent = gstStr.includes("%") ? parseInt(gstStr) : 0;

        let rowTotal = price * qty;
        let rowGST = rowTotal * gstPercent/100;

        subtotal += rowTotal;
        gstTotal += rowGST;

        tbody.innerHTML += `
            <tr>
                <td>${item}</td>
                <td>${pid}</td>
                <td>‚Çπ${price.toFixed(2)}</td>
                <td>${gstPercent}%</td>
                <td>${batch}</td>
                <td>${qty}</td>
                <td>‚Çπ${(rowTotal + rowGST).toFixed(2)}</td>
            </tr>
        `;
    });

    document.getElementById("subTot").innerText = "‚Çπ" + subtotal.toFixed(2);
    document.getElementById("gstTot").innerText = "‚Çπ" + gstTotal.toFixed(2);
    document.getElementById("grandTot").innerText = "‚Çπ" + (subtotal + gstTotal).toFixed(2);
}
</script>

</body>
</html>