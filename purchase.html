<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Purchase Invoice (GST Format)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

.container {
    max-width: 950px;
    margin: auto;
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

h2 {
    text-align: center;
    margin-bottom: 20px;
    text-transform: uppercase;
}

.header-section {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.header-section div {
    width: 48%;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.table th, .table td {
    border: 1px solid #333;
    padding: 8px;
    font-size: 14px;
}

.table th {
    background: #e0e0e0;
}

.summary-box {
    margin-top: 20px;
    float: right;
    width: 300px;
}

.summary-box table {
    width: 100%;
    border-collapse: collapse;
}

.summary-box td {
    border: 1px solid #333;
    padding: 8px;
}

.buttons {
    margin-top: 30px;
    text-align: center;
}

button {
    padding: 10px 20px;
    margin: 5px;
    background: #007bff;
    color: white;
    border: none;
    font-size: 15px;
    border-radius: 5px;
    cursor: pointer;
}

.search-box {
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

input {
    padding: 8px;
    width: 160px;
    margin-right: 10px;
    font-size: 14px;
}

@media print {
    .buttons, .search-box {
        display: none !important;
    }
    body { background: white; }
    .container {
        box-shadow: none;
        margin: 0;
        padding: 0;
    }
}
</style>

</head>

<body>

<div class="search-box">
    <label>Invoice Number:</label>
    <input type="text" id="searchInvoice" placeholder="Enter Invoice No">

    <label>Date:</label>
    <input type="date" id="searchDate">

    <button onclick="searchInvoice()">Search</button>
    <button onclick="loadLatest()">Load Latest</button>
</div>

<div class="container">

    <h2>PURCHASE TAX INVOICE</h2>

    <div class="header-section">
        <div>
            <h3>Supplier Details</h3>
            <p><b>Name:</b> <span id="supplierName"></span></p>
            <p><b>Supplier ID:</b> <span id="supplierId"></span></p>
            <p><b>Address:</b> <span id="supplierAddress"></span></p>
        </div>

        <div>
            <h3>Invoice Details</h3>
            <p><b>Invoice No:</b> <span id="invoiceNumber"></span></p>
            <p><b>Date:</b> <span id="invoiceDate"></span></p>
            <p><b>Shop ID:</b> <span id="shopId"></span></p>
        </div>
    </div>

    <h3>Item Details</h3>

    <table class="table" id="itemsTable">
        <tr>
            <th>Sl</th>
            <th>Item</th>
            <th>Product ID</th>
            <th>Batch</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Tax</th>
            <th>Total</th>
        </tr>
    </table>

    <div class="summary-box">
        <table>
            <tr><td><b>Sub Total</b></td><td><span id="subtotal"></span></td></tr>
            <tr><td><b>Total GST</b></td><td><span id="gstTotal"></span></td></tr>
            <tr><td><b>Grand Total</b></td><td><span id="grandTotal"></span></td></tr>
        </table>
    </div>

    <div class="buttons">
        <button onclick="window.print()">Print</button>
        <button onclick="downloadPDF()">Download PDF</button>
    </div>

</div>

<script>
// ---------- CONFIG ----------
const BASEROW_API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const TABLE_ID = 745465;

// -------- FETCH ALL ROWS --------
async function fetchRows() {
    const url = `https://api.baserow.io/api/database/rows/table/${TABLE_ID}/?user_field_names=true`;
    const res = await fetch(url, {
        headers: { Authorization: `Token ${BASEROW_API_KEY}` }
    });
    return await res.json();
}

// -------- LOAD LATEST INVOICE --------
async function loadLatest() {
    const data = await fetchRows();
    loadInvoice(data.results[data.results.length - 1]);
}

// -------- SEARCH INVOICE --------
async function searchInvoice() {
    const invoiceNo = document.getElementById("searchInvoice").value.trim();
    const date = document.getElementById("searchDate").value;

    const data = await fetchRows();

    let filtered = data.results;

    if (invoiceNo !== "")
        filtered = filtered.filter(r => r["Invoice Number"] == invoiceNo);

    if (date !== "")
        filtered = filtered.filter(r => r["Date"] == date);

    if (filtered.length === 0) {
        alert("No invoice found");
        return;
    }

    loadInvoice(filtered[0]);
}

// ---------- LOAD DATA INTO TEMPLATE ----------
function loadInvoice(row) {

    document.getElementById("invoiceNumber").innerText = row["Invoice Number"];
    document.getElementById("supplierName").innerText = row["Supplier Name"];
    document.getElementById("supplierId").innerText = row["Supplier ID"];
    document.getElementById("supplierAddress").innerText = row["Supplier Address"] ?? "N/A";
    document.getElementById("invoiceDate").innerText = row["Date"];
    document.getElementById("shopId").innerText = row["ShopID"];

    document.getElementById("itemsTable").innerHTML = `
        <tr>
            <th>Sl</th>
            <th>Item</th>
            <th>Product ID</th>
            <th>Batch</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Tax</th>
            <th>Total</th>
        </tr>
    `;

    parseItems(row["Remark"]);
}

// -------- PARSE REMARK FORMAT --------
function parseItems(remark) {

    const items = remark.split(" - ");

    let table = document.getElementById("itemsTable");
    let subtotal = 0;
    let gstTotal = 0;

    items.forEach((item, index) => {
        const parts = item.split(",");

        const name = parts[0];
        const productId = parts[1];
        const price = parseFloat(parts[2].replace("₹","").replace(",",""));
        const taxInfo = parts[3];
        const batch = parts[4].split(":")[1];
        const qty = parseInt(parts[5].split(":")[1]);

        let gst = 0, taxPercent = 0;

        if (taxInfo.includes("%")) {
            taxPercent = parseInt(taxInfo);
            gst = (price * qty) * (taxPercent / 100);
        }

        const total = (price * qty) + gst;

        subtotal += price * qty;
        gstTotal += gst;

        table.insertAdjacentHTML("beforeend", `
            <tr>
                <td>${index + 1}</td>
                <td>${name}</td>
                <td>${productId}</td>
                <td>${batch}</td>
                <td>${qty}</td>
                <td>₹${price.toFixed(2)}</td>
                <td>${taxInfo}</td>
                <td>₹${total.toFixed(2)}</td>
            </tr>
        `);
    });

    document.getElementById("subtotal").innerText = "₹" + subtotal.toFixed(2);
    document.getElementById("gstTotal").innerText = "₹" + gstTotal.toFixed(2);
    document.getElementById("grandTotal").innerText = "₹" + (subtotal + gstTotal).toFixed(2);
}

// -------- PDF Download --------
async function downloadPDF() {
    const element = document.querySelector(".container");
    const canvas = await html2canvas(element);
    const img = canvas.toDataURL("image/png");

    const pdf = new jspdf.jsPDF("p", "mm", "a4");
    pdf.addImage(img, "PNG", 0, 0, 210, 297);
    pdf.save("purchase-invoice.pdf");
}

// Load the latest invoice when page loads
loadLatest();
</script>

<!-- JS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>