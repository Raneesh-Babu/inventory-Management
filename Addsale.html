<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Invoice - Single Page</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{max-width:1100px;margin:18px auto;padding:18px;}
    h1{font-size:20px;margin:0 0 10px}
    .row{display:flex;gap:12px;margin-bottom:12px}
    .col{flex:1}
    label{display:block;font-size:12px;margin-bottom:6px}
    input,select,textarea,button{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
    textarea{min-height:60px}
    .card{padding:12px;border-radius:10px;border:1px solid #eee;margin-bottom:12px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .actions{display:flex;gap:8px}
    .btn{cursor:pointer}
    .small{width:120px}
    #video{width:280px;height:200px;background:#000}
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4)}
    .modal .box{background:#fff;padding:16px;border-radius:8px;max-width:560px;width:95%}
  </style>
</head>
<body>
  <h1>Sales Invoice (single page)</h1>
  <div class="card">
    <strong>Shop / Sales person</strong>
    <div class="row">
      <div class="col">
        <label>ShopID (from localStorage "ShopIDTag")</label>
        <input id="shopIdInput" placeholder="ShopID (auto from localStorage)" readonly />
      </div>
      <div class="col">
        <label>Sales Person (from localStorage "NameTag")</label>
        <input id="salesPersonInput" placeholder="Sales Person" readonly />
      </div>
      <div class="col small">
        <label>Invoice #</label>
        <input id="invoiceNo" readonly />
      </div>
    </div>
  </div>  <div class="card">
    <strong>Customer - (connected to Costomer table 736204)</strong>
    <div class="row">
      <div class="col">
        <label>Search Costomer by Costomer Name or Mobile</label>
        <input id="searchCostomer" placeholder="Type name or mobile and press Enter" />
      </div>
      <div class="col small">
        <label>Choose</label>
        <select id="costomerSelect"><option value="">-- none --</option></select>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Costomer Name</label>
        <input id="Costomer Name" />
      </div>
      <div class="col">
        <label>Mobile-Number</label>
        <input id="Mobile-Number" />
      </div>
      <div class="col">
        <label>GST- (optional)</label>
        <input id="GST- (optional)" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Address</label>
        <textarea id="Address-Long-Text"></textarea>
      </div>
    </div>
  </div>  <div class="card">
    <strong>Add Products</strong>
    <div class="row">
      <div class="col">
        <label>Search Product by Product Name or Product ID</label>
        <input id="searchProduct" placeholder="type and press Enter or use scanner" />
      </div>
      <div class="col small">
        <label>Scan</label>
        <div class="actions">
          <button id="openScanner" class="btn">Camera On</button>
          <button id="closeScanner" class="btn">Camera Off</button>
        </div>
      </div>
    </div>
    <div id="scannerArea" style="display:none;margin-bottom:12px">
      <video id="video" autoplay muted playsinline></video>
      <div style="margin-top:8px">Use rear camera if available. We use BarcodeDetector when present.</div>
    </div><table id="cartTable">
  <thead><tr><th>Product ID</th><th>Item Name</th><th>Batch No</th><th>Qty</th><th>Price</th><th>Line Total</th><th></th></tr></thead>
  <tbody></tbody>
</table>
<div style="text-align:right;margin-top:8px">Total: <span id="totalValue">0</span></div>

  </div>  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button id="saveInvoice" class="btn">Save Invoice</button>
    <button id="clearForm" class="btn">Clear</button>
  </div>  <div id="batchModal" class="modal"><div class="box"><h3>Select Batch</h3><div id="batchList"></div><div style="text-align:right;margin-top:12px"><button id="closeBatch">Close</button></div></div></div>  <script>
  // Configuration (from user)
  const API_KEY = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw';
  const BASE = 'https://api.baserow.io/api/database/rows/table/';
  const TABLES = {
    users: 729979,
    costomer: 736204,
    products: 734793,
    inventory: 734795,
    sales: 736209,
    ledger: 736207
  };

  // Helper Baserow functions (use user_field_names=true so we can use the same field labels)
  async function fetchRows(tableId, params=''){
    const url = BASE + tableId + '/?user_field_names=true' + (params?('&'+params):'');
    const res = await fetch(url, {headers:{Authorization:'Token '+API_KEY}});
    if(!res.ok) throw new Error('Failed to fetch rows: '+res.status);
    return res.json();
  }
  async function createRow(tableId, body){
    const url = BASE + tableId + '/?user_field_names=true';
    const res = await fetch(url, {method:'POST',headers:{Authorization:'Token '+API_KEY,'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!res.ok) throw new Error('create failed '+res.status);
    return res.json();
  }
  async function updateRow(tableId, rowId, body){
    const url = BASE + tableId + '/' + rowId + '/?user_field_names=true';
    const res = await fetch(url, {method:'PATCH',headers:{Authorization:'Token '+API_KEY,'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!res.ok) throw new Error('update failed '+res.status);
    return res.json();
  }

  // UI elements
  const shopIdInput = document.getElementById('shopIdInput');
  const salesPersonInput = document.getElementById('salesPersonInput');
  const invoiceNoInput = document.getElementById('invoiceNo');
  const searchCostomer = document.getElementById('searchCostomer');
  const costomerSelect = document.getElementById('costomerSelect');
  const CostomerNameInput = document.getElementById('Costomer Name');
  const MobileNumberInput = document.getElementById('Mobile-Number');
  const GSTInput = document.getElementById('GST- (optional)');
  const AddressInput = document.getElementById('Address-Long-Text');

  const searchProduct = document.getElementById('searchProduct');
  const cartTableBody = document.querySelector('#cartTable tbody');
  const totalValueSpan = document.getElementById('totalValue');
  const openScanner = document.getElementById('openScanner');
  const closeScanner = document.getElementById('closeScanner');
  const scannerArea = document.getElementById('scannerArea');
  const video = document.getElementById('video');
  const batchModal = document.getElementById('batchModal');
  const batchList = document.getElementById('batchList');
  const closeBatch = document.getElementById('closeBatch');

  let cart = [];
  let stream = null;

  function requireLoginFlow(){
    const shop = localStorage.getItem('ShopIDTag');
    const name = localStorage.getItem('NameTag');
    if(!shop || !name){
      alert('Missing ShopIDTag or NameTag in localStorage. Please login.');
      throw new Error('Login required');
    }
    shopIdInput.value = shop;
    salesPersonInput.value = name;
  }

  function genInvoice(){
    const ts = new Date().toISOString().replace(/[^0-9]/g,'').slice(0,14);
    return 'INV-'+ts+'-'+Math.floor(Math.random()*900+100);
  }

  function renderCart(){
    cartTableBody.innerHTML = '';
    let total=0;
    cart.forEach((line, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${line['Product ID']||''}</td><td>${line['Item Name']||''}</td><td>${line['Batch No']||''}</td><td><input type='number' min='1' value='${line.qty}' data-idx='${idx}' class='qtyInput' style='width:70px' /></td><td><input value='${line.price||0}' data-idx='${idx}' class='priceInput' style='width:90px' /></td><td>${(line.qty*line.price)||0}</td><td><button data-idx='${idx}' class='removeBtn'>Remove</button></td>`;
      cartTableBody.appendChild(tr);
      total += (line.qty*line.price);
    });
    totalValueSpan.textContent = total;
    // attach events
    document.querySelectorAll('.removeBtn').forEach(b=>b.addEventListener('click',e=>{const i=+e.target.dataset.idx;cart.splice(i,1);renderCart();}));
    document.querySelectorAll('.qtyInput').forEach(i=>i.addEventListener('input',e=>{const idx=+e.target.dataset.idx;cart[idx].qty = parseInt(e.target.value)||1;renderCart();}));
    document.querySelectorAll('.priceInput').forEach(i=>i.addEventListener('input',e=>{const idx=+e.target.dataset.idx;cart[idx].price = parseFloat(e.target.value)||0;renderCart();}));
  }

  // Costomer search
  async function performCostomerSearch(q){
    const shop = localStorage.getItem('ShopIDTag');
    if(!shop) return alert('ShopIDTag missing from localStorage');
    // query by name or mobile
    const rows = await fetchRows(TABLES.costomer, `search=${encodeURIComponent(q)}`);
    // filter by ShopID
    const filtered = rows.results.filter(r=>String(r['ShopID']).trim()===String(shop).trim());
    costomerSelect.innerHTML = '<option value="">-- none --</option>';
    filtered.forEach(r=>{
      const opt = document.createElement('option'); opt.value = r.id; opt.textContent = (r['Costomer Name']||'')+ ' — ' + (r['Mobile-Number']||'');
      opt.dataset.row = JSON.stringify(r);
      costomerSelect.appendChild(opt);
    });
  }

  costomerSelect.addEventListener('change',()=>{
    const opt = costomerSelect.selectedOptions[0];
    if(!opt || !opt.dataset.row) return;
    const r = JSON.parse(opt.dataset.row);
    // populate form fields using exact field names requested by user
    document.getElementById('Costomer Name').value = r['Costomer Name'] || '';
    document.getElementById('Mobile-Number').value = r['Mobile-Number'] || '';
    document.getElementById('GST- (optional)').value = r['GST'] || '';
    document.getElementById('Address-Long-Text').value = r['Address-Long Text'] || r['Address-Long-Text'] || r['Address'] || '';
  });

  searchCostomer.addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ await performCostomerSearch(searchCostomer.value); } });

  // Product search
  async function performProductSearch(q){
    const shop = localStorage.getItem('ShopIDTag');
    if(!shop) return alert('ShopIDTag missing');
    const rows = await fetchRows(TABLES.products, `search=${encodeURIComponent(q)}`);
    const filtered = rows.results.filter(r=>String(r['ShopID']).trim()===String(shop).trim());
    if(filtered.length===0) return alert('No product found for this ShopID');
    const p = filtered[0];
    // get inventory rows for this Product ID
    const invRows = await fetchRows(TABLES.inventory, `search=${encodeURIComponent(p['Product ID'])}`);
    const invFiltered = invRows.results.filter(r=>String(r['Product ID']).trim()===String(p['Product ID']).trim() && r['Count']>0 && String(r['ShopID']||'').trim()===String(shop).trim());
    if(invFiltered.length===0) return alert('No batches available for this product');
    // show modal to pick batch
    showBatchModal(invFiltered, p);
  }

  function showBatchModal(batches, product){
    batchList.innerHTML = '';
    batches.forEach(b=>{
      const d = document.createElement('div');
      d.style.padding='8px'; d.style.borderBottom='1px solid #eee';
      d.innerHTML = `<strong>Batch:</strong> ${b['Batch No']} &nbsp; <strong>Count:</strong> ${b['Count']} &nbsp; <strong>Exp:</strong> ${b['Expire Date']||''} <div style='margin-top:6px'><button data-b='${b.id}' class='selectBatch'>Select</button></div>`;
      d.querySelector('.selectBatch').addEventListener('click',()=>{
        // add to cart with default qty 1 and price from product table
        cart.push({
          'Product ID': product['Product ID'],
          'Item Name': product['Product Name'] || product['Product Name']||'',
          'Batch No': b['Batch No'],
          inventoryRowId: b.id,
          qty:1,
          price: product['Price'] || 0
        });
        renderCart();
        batchModal.style.display='none';
      });
      batchList.appendChild(d);
    });
    batchModal.style.display='flex';
  }

  closeBatch.addEventListener('click',()=>batchModal.style.display='none');

  searchProduct.addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ await performProductSearch(searchProduct.value); }});

  // Scanner
  openScanner.addEventListener('click', async ()=>{
    scannerArea.style.display='block';
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject = stream;
      // try BarcodeDetector
      const supports = ('BarcodeDetector' in window);
      if(supports){
        const formats = await BarcodeDetector.getSupportedFormats();
        const detector = new BarcodeDetector({formats});
        const scanLoop = async ()=>{
          if(video.readyState < 2) { requestAnimationFrame(scanLoop); return; }
          try{
            const barcodes = await detector.detect(video);
            if(barcodes && barcodes.length){
              const raw = barcodes[0].rawValue;
              searchProduct.value = raw;
              await performProductSearch(raw);
            }
          }catch(e){/*ignore*/}
          requestAnimationFrame(scanLoop);
        };
        scanLoop();
      }else{
        // fallback simple canvas+jsqr not included; user can copy-paste scanned code into input
        console.warn('BarcodeDetector not available — use manual input');
      }
    }catch(err){alert('Camera permission required: '+err.message)}
  });
  closeScanner.addEventListener('click', ()=>{
    scannerArea.style.display='none';
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  });

  // Save invoice
  document.getElementById('saveInvoice').addEventListener('click', async ()=>{
    try{
      requireLoginFlow();
      if(cart.length===0) return alert('Cart empty');
      // validate shopID matches
      const shop = localStorage.getItem('ShopIDTag');
      // build sales rows and ledger
      const invoiceNo = invoiceNoInput.value || genInvoice();
      // compute total
      const total = cart.reduce((s,l)=>s + (l.qty*l.price),0);
      // create sales row (main)
      const salesPayload = {
        'Costomer Name': document.getElementById('Costomer Name').value,
        'Mobile': document.getElementById('Mobile-Number').value,
        'Date': new Date().toISOString().slice(0,10),
        'Invoice Number': invoiceNo,
        'Total Invoice Value': total,
        'ShopID': shop
      };
      const salesRes = await createRow(TABLES.sales, salesPayload);
      // create ledger entry for each line as well
      for(const line of cart){
        const ledgerPayload = {
          'Invoice Number': invoiceNo,
          'Product ID': line['Product ID'],
          'Item Name': line['Item Name'],
          'Batch No': line['Batch No'],
          'Quantity': line.qty,
          'Price': line.price,
          'ShopID': shop,
          'Date': new Date().toISOString().slice(0,10)
        };
        await createRow(TABLES.ledger, ledgerPayload);
        // reduce inventory count for the selected batch row
        if(line.inventoryRowId){
          // fetch current row to know id and count
          // naive approach: update by patch subtracting qty
          try{
            // get inventory row
            const invRow = await fetchRows(TABLES.inventory, `id=${line.inventoryRowId}`);
            const r = invRow.results && invRow.results[0];
            if(r){
              const newCount = (Number(r['Count']||0) - Number(line.qty));
              if(newCount < 0) throw new Error('Not enough inventory in batch '+line['Batch No']);
              await updateRow(TABLES.inventory, r.id, {'Count': newCount});
            }
          }catch(er){console.error('Inventory update failed',er);}
        }
      }
      alert('Invoice saved: '+invoiceNo);
      // show invoice simple print popup
      const w = window.open('', '_blank');
      const html = `<html><head><title>Invoice ${invoiceNo}</title></head><body><h2>Invoice ${invoiceNo}</h2><div><strong>Shop:</strong> ${shop}</div><div><strong>Sales Person:</strong> ${localStorage.getItem('NameTag')||''}</div><div><strong>Costomer:</strong> ${document.getElementById('Costomer Name').value} - ${document.getElementById('Mobile-Number').value}</div><table border='1' cellpadding='6' style='border-collapse:collapse;margin-top:12px'><thead><tr><th>Product ID</th><th>Item</th><th>Batch</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>${cart.map(l=>`<tr><td>${l['Product ID']}</td><td>${l['Item Name']}</td><td>${l['Batch No']}</td><td>${l.qty}</td><td>${l.price}</td><td>${l.qty*l.price}</td></tr>`).join('')}</tbody></table><h3>Total: ${total}</h3></body></html>`;
      w.document.write(html); w.document.close();
      // clear form
      cart = []; renderCart();
    }catch(err){alert('Save failed: '+err.message)}
  });

  document.getElementById('clearForm').addEventListener('click', ()=>{ if(confirm('Clear form?')){cart=[];renderCart();document.getElementById('Costomer Name').value='';document.getElementById('Mobile-Number').value='';document.getElementById('GST- (optional)').value='';document.getElementById('Address-Long-Text').value='';invoiceNoInput.value = genInvoice();}});

  // init
  (function init(){
    try{ requireLoginFlow(); }catch(e){ /*stop further init*/ }
    invoiceNoInput.value = genInvoice();
    renderCart();
  })();
  </script></body>
</html>