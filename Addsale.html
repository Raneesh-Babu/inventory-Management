<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Invoice - Single Page</title>
  <style>
    :root{--accent:#2563eb;--muted:#666}
    body{font-family:Inter,system-ui,Arial;max-width:1100px;margin:18px auto;padding:18px}
    h1{font-size:20px;margin-bottom:8px}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:12px}
    .card{border:1px solid #e6e6e6;padding:12px;border-radius:8px;background:#fff}
    input,select,textarea,button{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
    .flex{display:flex;gap:8px;align-items:center}
    .products-list{margin-top:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .actions{display:flex;gap:8px}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center}
    .modal .card{width:600px;max-width:95%}
    .small{font-size:12px;color:var(--muted)}
    .camera{width:320px;height:240px;background:#000;display:flex;align-items:center;justify-content:center;color:#fff}
  </style>
</head>
<body>
  <h1>Sales Invoice (Single page)</h1>
  <div class="grid">
    <div class="card">
      <strong>Session / Shop</strong>
      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label>ShopID (from localStorage.ShopIDTag)</label>
          <input id="shopIdInput" placeholder="ShopID" />
        </div>
        <div style="width:220px">
          <label>Sales Person (localStorage.NameTag)</label>
          <input id="salesPersonInput" placeholder="Sales person" />
        </div>
        <div style="width:180px">
          <label>MobileTag (localStorage.MobileTag)</label>
          <input id="mobileTagInput" placeholder="MobileTag" />
        </div>
      </div>
      <div class="small" style="margin-top:8px">If any of the ShopID / Name / MobileTag are missing the UI will ask to login.</div>
      <hr style="margin:12px 0" />
      <strong>Section 1: Add Costomer</strong>
      <div style="margin-top:8px" class="row">
        <div style="flex:1">
          <label>Search Costomer (Name or Mobile)</label>
          <input id="costomerSearch" placeholder="Search by Costomer Name or Mobile" />
        </div>
        <div style="width:120px">
          <label>Filter ShopID</label>
          <input id="costomerShopFilter" placeholder="ShopID" />
        </div>
        <div style="width:90px">
          <button class="btn" id="searchCostomerBtn">Search</button>
        </div>
      </div>
      <div id="costomerResults" style="margin-top:10px"></div>
      <div style="margin-top:12px" class="row">
        <div style="flex:1">
          <label>Costomer Name</label>
          <input id="costomerName" />
        </div>
        <div style="width:180px">
          <label>Mobile</label>
          <input id="costomerMobile" />
        </div>
        <div style="width:220px">
          <label>Address</label>
          <input id="costomerAddress" />
        </div>
        <div style="width:140px">
          <label>GST</label>
          <input id="costomerGST" />
        </div>
      </div>
    </div><div class="card">
  <strong>Section 2: Add Product(s)</strong>
  <div style="margin-top:8px" class="row">
    <div style="flex:1">
      <label>Search Product (Name or Product ID)</label>
      <input id="productSearch" placeholder="Product name or Product ID" />
    </div>
    <div style="width:120px">
      <label>Filter ShopID</label>
      <input id="productShopFilter" placeholder="ShopID" />
    </div>
    <div style="width:90px">
      <button class="btn" id="searchProductBtn">Search</button>
    </div>
  </div>

  <div id="productResults" style="margin-top:10px"></div>

  <div style="margin-top:12px">
    <button class="btn" id="openScanner">Open Scanner</button>
    <button class="btn ghost" id="toggleCamera">Camera On</button>
  </div>

  <div class="products-list card" id="selectedProductsCard" style="margin-top:12px">
    <strong>Selected Products</strong>
    <table id="selectedProductsTable">
      <thead><tr><th>Product ID</th><th>Name</th><th>Batch</th><th>Qty</th><th>Price</th><th>Amount</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
      <div class="small">Invoice Number will be auto-generated</div>
      <div><strong>Total: ₹<span id="totalAmount">0</span></strong></div>
    </div>
  </div>

  <div style="margin-top:12px;display:flex;gap:8px">
    <button class="btn" id="saveInvoiceBtn">Save Invoice</button>
    <button class="btn ghost" id="clearBtn">Clear</button>
  </div>
</div>

<div id="scannerModal" class="modal" style="display:none">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Scanner</strong>
      <button id="closeScanner" class="btn ghost">Close</button>
    </div>
    <div style="margin-top:8px">
      <div class="camera" id="cameraPreview">Camera preview</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="scanBarcodeBtn" class="btn">Scan Now (one frame)</button>
        <button id="startStreamBtn" class="btn ghost">Start Stream</button>
        <button id="stopStreamBtn" class="btn ghost">Stop Stream</button>
      </div>
      <div class="small" style="margin-top:8px">If Barcode Detector API is not supported you can input Product ID manually.</div>
    </div>
  </div>
</div>

  </div>  <script>
    /* ========== CONFIG ========== */
    const API_KEY = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw';
    const BASE = 'https://api.baserow.io/api/database/rows/table';
    const TABLES = {
      users: 729979,
      costomers: 736204,
      products: 734793,
      inventory: 734795,
      sales: 736209,
      ledger: 736207
    };

    // convenience: use user_field_names=true so we can use the provided human field names
    const headers = {
      'Authorization': 'Token ' + API_KEY,
      'Content-Type': 'application/json'
    };

    /* ========== HELPERS ========== */
    function el(id){return document.getElementById(id)}
    function show(target, show=true){target.style.display = show ? 'block' : 'none'}

    function getLocal(name){return localStorage.getItem(name)}
    function requireSession(){
      const shop = el('shopIdInput').value || getLocal('ShopIDTag');
      const name = el('salesPersonInput').value || getLocal('NameTag');
      const mobile = el('mobileTagInput').value || getLocal('MobileTag');
      if(!shop || !name || !mobile){
        alert('Missing ShopID / Name or MobileTag. Please login or set localStorage.ShopIDTag, localStorage.NameTag and localStorage.MobileTag.');
        throw new Error('Missing session values');
      }
      return {shop,name,mobile};
    }

    async function fetchRows(tableId){
      const url = `${BASE}/${tableId}/?user_field_names=true&page_size=400`; // page_size increased
      const r = await fetch(url,{headers});
      if(!r.ok) throw new Error('Failed to fetch table '+tableId);
      return r.json();
    }

    async function postRow(tableId, fields){
      const url = `${BASE}/${tableId}/?user_field_names=true`;
      const r = await fetch(url,{method:'POST',headers,body:JSON.stringify({fields})});
      return r.json();
    }

    async function patchRow(tableId,rowId, fields){
      const url = `${BASE}/${tableId}/${rowId}/?user_field_names=true`;
      const r = await fetch(url,{method:'PATCH',headers,body:JSON.stringify({fields})});
      return r.json();
    }

    /* ========== COSTOMER SEARCH ========== */
    el('searchCostomerBtn').addEventListener('click',async()=>{
      try{
        const session = requireSession();
        el('costomerShopFilter').value = session.shop;
        const q = el('costomerSearch').value.trim().toLowerCase();
        const data = await fetchRows(TABLES.costomers);
        const rows = data.results || data;
        const filtered = rows.filter(r=>{
          const shopMatch = String(r['ShopID']||r['ShopID']||'').toLowerCase() === String(session.shop).toLowerCase();
          if(!shopMatch) return false;
          const name = (r['Costomer Name']||r['Costomer Name']||'').toString().toLowerCase();
          const mobile = (r['Mobile-Number']||r['Mobile']||'').toString().toLowerCase();
          return name.includes(q) || mobile.includes(q);
        });
        renderCostomerResults(filtered);
      }catch(e){console.error(e);}
    });

    function renderCostomerResults(rows){
      const container = el('costomerResults');
      container.innerHTML = '';
      if(!rows.length){container.innerHTML = '<div class="small">No costomers found</div>';return}
      const ul = document.createElement('div');
      rows.slice(0,10).forEach(r=>{
        const d = document.createElement('div');
        d.className='row';
        d.style.justifyContent='space-between';
        d.style.padding='6px 0';
        d.innerHTML = `<div><strong>${r['Costomer Name']||r['Costomer Name']||''}</strong><div class="small">${r['Mobile-Number']||r['Mobile']||''} — ${r['ShopID']||''}</div></div>`;
        const btn = document.createElement('button');btn.className='btn ghost';btn.textContent='Select';
        btn.onclick = ()=>{
          el('costomerName').value = r['Costomer Name']||r['Costomer Name']||'';
          el('costomerMobile').value = r['Mobile-Number']||r['Mobile']||'';
          el('costomerAddress').value = r['Address']||r['Address']||'';
          el('costomerGST').value = r['GST']||'';
        };
        d.appendChild(btn);
        ul.appendChild(d);
      });
      container.appendChild(ul);
    }

    /* ========== PRODUCT SEARCH ========== */
    el('searchProductBtn').addEventListener('click',async()=>{
      try{
        const session = requireSession();
        el('productShopFilter').value = session.shop;
        const q = el('productSearch').value.trim().toLowerCase();
        const data = await fetchRows(TABLES.products);
        const rows = data.results || data;
        const filtered = rows.filter(r=>{
          const shopMatch = String(r['ShopID']||'').toLowerCase() === String(session.shop).toLowerCase();
          if(!shopMatch) return false;
          const pid = (r['Product ID']||'').toString().toLowerCase();
          const name = (r['Product Name']||'').toString().toLowerCase();
          return pid.includes(q) || name.includes(q);
        });
        renderProductResults(filtered);
      }catch(e){console.error(e);}
    });

    function renderProductResults(rows){
      const c = el('productResults'); c.innerHTML='';
      if(!rows.length) {c.innerHTML='<div class="small">No products found</div>';return}
      rows.slice(0,12).forEach(r=>{
        const d = document.createElement('div');d.className='row';d.style.justifyContent='space-between';d.style.padding='6px 0';
        d.innerHTML = `<div><strong>${r['Product Name']||''}</strong><div class="small">ID: ${r['Product ID']||''} — Price: ₹${r['Price']||0}</div></div>`;
        const btn = document.createElement('button');btn.className='btn ghost';btn.textContent='Choose';
        btn.onclick = ()=>openBatchesModal(r['Product ID'], r['Product Name'], r['Price']);
        d.appendChild(btn); c.appendChild(d);
      });
    }

    /* ========== BATCHES MODAL & SELECT ========== */
    function openBatchesModal(productId, productName, price){
      // fetch inventory rows and show modal
      fetchRows(TABLES.inventory).then(data=>{
        const rows = data.results || data;
        const batches = rows.filter(r=>String(r['Product ID']||'')===String(productId) && (r['ShopID']||'')===(el('shopIdInput').value || getLocal('ShopIDTag')));
        // show simple modal built with prompt for now
        if(!batches.length){alert('No inventory batches found for this product in this shop');return}
        const pick = prompt('Found batches:\n' + batches.map((b,i)=>`${i+1}) Batch ${b['Batch No']||b['Batch']||''} — Count:${b['Count']||0} — Exp:${b['Expire Date']||''}`).join('\n') + '\n\nEnter batch index (1-based) and qty separated by comma, e.g. "1,2"');
        if(!pick) return;
        const [idxStr, qtyStr] = pick.split(',').map(s=>s && s.trim());
        const idx = parseInt(idxStr)-1; const qty = parseFloat(qtyStr||'0');
        if(isNaN(idx) || idx<0 || idx>=batches.length){alert('Invalid batch index');return}
        if(isNaN(qty) || qty<=0){alert('Invalid quantity');return}
        const batch = batches[idx];
        if(qty > (batch['Count']||0)) {alert('Quantity greater than available count');return}
        addSelectedProduct({productId,productName,price,batchNo:batch['Batch No']||batch['Batch']||'',inventoryRowId:batch.id,available:batch['Count']||0,qty});
      }).catch(e=>{console.error(e); alert('Error fetching batches')});
    }

    const selectedProducts = [];
    function addSelectedProduct(item){
      // merge if same product & batch
      const existing = selectedProducts.find(p=>p.productId===item.productId && p.batchNo===item.batchNo);
      if(existing){ existing.qty += item.qty; } else selectedProducts.push(item);
      renderSelectedProducts();
    }

    function renderSelectedProducts(){
      const tbody = el('selectedProductsTable').querySelector('tbody'); tbody.innerHTML='';
      let total=0;
      selectedProducts.forEach((p,i)=>{
        const tr = document.createElement('tr');
        const amount = (p.price||0) * (p.qty||0); total += amount;
        tr.innerHTML = `<td>${p.productId}</td><td>${p.productName}</td><td>${p.batchNo}</td><td>${p.qty}</td><td>₹${p.price}</td><td>₹${amount.toFixed(2)}</td><td><button data-i='${i}' class='btn ghost remove'>Remove</button></td>`;
        tbody.appendChild(tr);
      });
      el('totalAmount').textContent = total.toFixed(2);
      tbody.querySelectorAll('.remove').forEach(b=>b.addEventListener('click',e=>{const i=+e.target.dataset.i; selectedProducts.splice(i,1); renderSelectedProducts();}));
    }

    el('clearBtn').addEventListener('click',()=>{if(confirm('Clear form?')) location.reload()});

    /* ========== INVOICE GENERATION & SAVE ========== */
    function generateInvoiceNumber(){
      const now = new Date();
      const y = now.getFullYear().toString().slice(-2);
      const mo = String(now.getMonth()+1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      const t = String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0')+String(now.getSeconds()).padStart(2,'0');
      return `INV-${y}${mo}${d}-${t}-${Math.floor(Math.random()*900+100)}`;
    }

    el('saveInvoiceBtn').addEventListener('click',async()=>{
      try{
        if(!selectedProducts.length) {alert('Add at least one product');return}
        const session = requireSession();
        // gather costomer
        const costomer = {name:el('costomerName').value||'',mobile:el('costomerMobile').value||'',address:el('costomerAddress').value||'',gst:el('costomerGST').value||''};
        const invoiceNo = generateInvoiceNumber();
        const total = parseFloat(el('totalAmount').textContent)||0;

        // 1) Create sales row
        const salesFields = {
          'Costomer Name': costomer.name,
          'Mobile': costomer.mobile,
          'Mobile-Number': costomer.mobile,
          'Date': (new Date()).toISOString().split('T')[0],
          'Invoice Number': invoiceNo,
          'Total Invoice Value': total,
          'ShopID': session.shop,
          'Tag': 'Confirmed',
          'Sales Person': session.name,
          'Items': JSON.stringify(selectedProducts.map(p=>({productId:p.productId,productName:p.productName,batch:p.batchNo,qty:p.qty,price:p.price})))
        };
        const salesRes = await postRow(TABLES.sales, salesFields);

        // 2) Create ledger entry (simple)
        const ledgerFields = {
          'Invoice Number': invoiceNo,
          'Date': (new Date()).toISOString().split('T')[0],
          'Amount': total,
          'ShopID': session.shop,
          'Costomer Name': costomer.name
        };
        await postRow(TABLES.ledger, ledgerFields);

        // 3) Reduce inventory counts (PATCH each inventory row)
        for(const p of selectedProducts){
          try{
            const rowId = p.inventoryRowId;
            if(!rowId) continue;
            // fetch existing row to be safe
            const inv = await fetch(`${BASE}/${TABLES.inventory}/${rowId}/?user_field_names=true`, {headers});
            const invJson = await inv.json();
            const current = parseFloat(invJson['Count']||invJson['count']||0);
            const newCount = Math.max(0, current - p.qty);
            await patchRow(TABLES.inventory, rowId, {'Count': newCount});
          }catch(e){console.error('Inventory update failed for',p,e)}
        }

        alert('Invoice saved: ' + invoiceNo);
        // optionally open simple printable invoice
        openInvoicePrint({invoiceNo,date:(new Date()).toLocaleDateString(), costomer, items:selectedProducts, total});
        // clear after save
        selectedProducts.length=0; renderSelectedProducts();
      }catch(e){console.error(e); alert('Save failed: '+(e.message||e))}
    });

    function openInvoicePrint(data){
      const w = window.open('','_blank','width=800,height=900');
      const html = `
      <html><head><title>Invoice ${data.invoiceNo}</title></head><body>
      <h2>Invoice: ${data.invoiceNo}</h2>
      <div>Date: ${data.date}</div>
      <div>Costomer: ${data.costomer.name} — ${data.costomer.mobile}</div>
      <table border='1' cellpadding='6' style='border-collapse:collapse;margin-top:12px'><thead><tr><th>Product</th><th>Batch</th><th>Qty</th><th>Price</th><th>Amount</th></tr></thead><tbody>
      ${data.items.map(i=>`<tr><td>${i.productName}</td><td>${i.batchNo}</td><td>${i.qty}</td><td>₹${i.price}</td><td>₹${(i.qty*i.price).toFixed(2)}</td></tr>`).join('')}
      </tbody></table>
      <h3>Total: ₹${data.total.toFixed(2)}</h3>
      </body></html>`;
      w.document.write(html); w.document.close();
    }

    /* ========== CAMERA / SCANNER (simple) ========== */
    let stream;
    el('openScanner').addEventListener('click',()=>{el('scannerModal').style.display='flex'});
    el('closeScanner').addEventListener('click',()=>{el('scannerModal').style.display='none'; stopStream();});
    el('startStreamBtn').addEventListener('click', startStream);
    el('stopStreamBtn').addEventListener('click', stopStream);
    el('toggleCamera').addEventListener('click',()=>{
      const btn = el('toggleCamera'); if(btn.textContent.includes('On')) btn.textContent='Camera Off'; else btn.textContent='Camera On';
      // basic toggle: attempt to start/stop
      if(btn.textContent.includes('Off')) startStream(); else stopStream();
    });

    async function startStream(){
      const vidEl = el('cameraPreview');
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        const video = document.createElement('video'); video.autoplay=true; video.playsInline=true; video.srcObject=stream; video.style.maxWidth='100%';
        vidEl.innerHTML=''; vidEl.appendChild(video);
        await video.play();
        // draw one frame for scan when user clicks
        el('scanBarcodeBtn').onclick = async ()=>{
          const canvas = document.createElement('canvas'); canvas.width=video.videoWidth; canvas.height=video.videoHeight; const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0);
          // try BarcodeDetector
          if(window.BarcodeDetector){
            try{
              const detector = new BarcodeDetector({formats:['ean_13','ean_8','code_128','code_39','qr_code','upc_e','upc_a']});
              const detections = await detector.detect(canvas);
              if(detections && detections.length){
                const code = detections[0].rawValue; alert('Scanned: '+code); el('productSearch').value = code; el('searchProductBtn').click();
              } else alert('No barcode found in frame');
            }catch(e){alert('BarcodeDetector error: '+e.message)}
          } else {
            // fallback: try to read QR via canvas toDataURL and ask manual
            const dataUrl = canvas.toDataURL();
            alert('BarcodeDetector not supported. We placed current frame in clipboard — paste or type product id.');
            el('productSearch').value = ''; // user must fill
          }
        };
      }catch(e){alert('Camera access denied or not available: '+e.message)}
    }
    function stopStream(){ if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} const vidEl = el('cameraPreview'); vidEl.innerHTML='Camera preview'; }

    // initialize default shop/name from localStorage when page loads
    window.addEventListener('load', ()=>{
      el('shopIdInput').value = el('shopIdInput').value || getLocal('ShopIDTag') || '';
      el('salesPersonInput').value = el('salesPersonInput').value || getLocal('NameTag') || '';
      el('mobileTagInput').value = el('mobileTagInput').value || getLocal('MobileTag') || '';
    });
  </script></body>
</html>