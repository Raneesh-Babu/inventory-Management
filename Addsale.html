<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Invoice - Single Page</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:0;padding:0;background:#f5f7fb;color:#0f172a}
    .container{max-width:1100px;margin:24px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.08)}
    h1{font-size:20px;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;font-size:12px;color:#334155;margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid #e2e8f0;border-radius:8px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0ea5a4;color:#fff;cursor:pointer}
    button.secondary{background:#64748b}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e2e8f0;padding:8px;text-align:left}
    .muted{color:#64748b;font-size:13px}
    .scanner-controls{display:flex;gap:8px;align-items:center}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:flex;align-items:center;justify-content:center}
    .modal-card{background:#fff;padding:16px;border-radius:10px;max-width:640px;width:100%}
    .badge{background:#eef2ff;padding:4px 8px;border-radius:6px;font-size:12px}
    .right{margin-left:auto}
    .invoice-preview{background:#fbfbff;padding:12px;border-radius:8px;margin-top:12px}
  </style>
  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Sales Invoice (Single Page)</h1>
    <div id="status" class="muted">Checking login...</div><section style="margin-top:12px">
  <div class="row">
    <div class="col">
      <label>Customer Mobile / Search</label>
      <div style="display:flex;gap:8px"><input id="custSearch" placeholder="Enter mobile or name" /><button id="btnSearchCust">Search</button></div>
      <div style="margin-top:8px">
        <label>Customer Name</label>
        <input id="custName" readonly />
        <label style="margin-top:8px">Mobile</label>
        <input id="custMobile" readonly />
        <label style="margin-top:8px">Address</label>
        <textarea id="custAddress" rows="2" readonly></textarea>
        <label style="margin-top:8px">GST (optional)</label>
        <input id="custGST" readonly />
      </div>
    </div>
    <div class="col">
      <label>Product Scan / Search</label>
      <div class="scanner-controls">
        <button id="startScanner">Start Camera</button>
        <button id="stopScanner" class="secondary">Stop Camera</button>
        <div style="flex:1"><input id="productSearch" placeholder="Scan or search product by ID / name" /></div>
        <button id="btnSearchProduct">Search</button>
      </div>
      <div id="reader" style="margin-top:8px;min-height:150px"></div>

      <div style="margin-top:8px">
        <label>Product ID</label>
        <input id="productId" readonly />
        <label style="margin-top:8px">Item Name</label>
        <input id="itemName" readonly />
        <label style="margin-top:8px">Price (per unit)</label>
        <input id="price" readonly />
        <label style="margin-top:8px">Batch No</label>
        <input id="batchNo" readonly />
        <label style="margin-top:8px">Available Count</label>
        <input id="availableCount" readonly />
        <label style="margin-top:8px">Quantity</label>
        <input id="quantity" type="number" min="1" value="1" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="openBatches">Select Batch</button>
          <button id="addItem">Add Item</button>
        </div>
      </div>
    </div>
  </div>
</section>

<section style="margin-top:18px">
  <h3>Invoice Items</h3>
  <table id="itemsTable">
    <thead><tr><th>#</th><th>Product ID</th><th>Item Name</th><th>Batch</th><th>Qty</th><th>Price</th><th>Line Total</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>

  <div style="display:flex;align-items:center;margin-top:8px;gap:12px">
    <div class="muted">Tag: <span class="badge" id="tag">Order Confirmed</span></div>
    <div class="muted">Invoice #: <span id="invoiceNo" class="badge"></span></div>
    <div class="muted right">Total: ₹ <span id="totalAmount">0</span></div>
  </div>

  <div style="margin-top:12px;display:flex;gap:8px">
    <button id="saveInvoice">Save Invoice</button>
    <button id="printInvoice" class="secondary">Print Preview</button>
  </div>

  <div id="invoicePreview" class="invoice-preview" style="display:none"></div>
</section>

  </div>  <!-- Batch modal -->  <div id="batchModal" class="modal" style="display:none">
    <div class="modal-card">
      <h3>Select Batch</h3>
      <div id="batchList"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="closeBatch">Close</button></div>
    </div>
  </div>  <script>
    // ========== CONFIG ===========
    const BASEROW_API_KEY = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sh';
    const BASEROW_BASE = 'https://api.baserow.io/api/database/rows/table';
    const TABLE_USERS = 729979;
    const TABLE_CUSTOMERS = 736204;
    const TABLE_PRODUCTS = 734793;
    const TABLE_INVENTORY = 734795;
    const TABLE_SALES = 736209;
    const TABLE_LEDGER = 736207;

    // Local storage keys
    const KEY_MOBILE = 'MobileTag';
    const KEY_SHOPID = 'ShopIDTag';
    const KEY_NAME = 'NameTag';

    // State
    let items = [];
    let html5QrCode = null;
    let currentBatches = [];

    // Helpers for Baserow requests
    async function baserowFetch(tableId, params = ''){
      const url = `${BASEROW_BASE}/${tableId}/?user_field_names=true${params}`;
      const res = await fetch(url, {headers: {Authorization: `Token ${BASEROW_API_KEY}`}});
      if(!res.ok) throw new Error('Baserow fetch failed '+res.status);
      return res.json();
    }

    async function baserowCreate(tableId, data){
      const url = `${BASEROW_BASE}/${tableId}/?user_field_names=true`;
      const res = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json',Authorization:`Token ${BASEROW_API_KEY}`},body:JSON.stringify(data)});
      if(!res.ok){const t = await res.text(); throw new Error('Create failed '+res.status+' '+t);} 
      return res.json();
    }

    // ========== Login Check ==========
    async function checkLogin(){
      const mobile = localStorage.getItem(KEY_MOBILE);
      const statusEl = document.getElementById('status');
      if(!mobile){
        statusEl.textContent = 'MobileTag missing — redirecting to login.';
        setTimeout(()=> window.location.href = 'login.html', 1200);
        return false;
      }
      statusEl.textContent = 'Validating user...';
      try{
        const data = await baserowFetch(TABLE_USERS);
        const rows = data.results || data;
        // try matching on common possible username fields
        const found = rows.find(r => {
          const vals = [r.username, r.Username, r.user, r.User, r.name, r.Name, r.mobile, r.Mobile];
          return vals.some(v => v && String(v).trim() === mobile);
        });
        if(!found){
          statusEl.textContent = 'Mobile not found in users — redirecting to login.';
          setTimeout(()=> window.location.href = 'login.html', 1000);
          return false;
        }
        statusEl.textContent = `Welcome, ${found.name || found.Name || found.username || mobile}`;
        return true;
      }catch(err){
        statusEl.textContent = 'Error validating user: '+err.message;
        console.error(err);
        return false;
      }
    }

    // ========== Customer Search ==========
    document.getElementById('btnSearchCust').addEventListener('click', async ()=>{
      const q = document.getElementById('custSearch').value.trim();
      if(!q) return alert('Enter mobile or name to search');
      try{
        const data = await baserowFetch(TABLE_CUSTOMERS);
        const rows = data.results || data;
        const found = rows.find(r => {
          const mobiles = [r.mobile, r.Mobile, r.MobileNumber, r.Mobile_Number];
          const names = [r.name, r.Name, r['Costomer Name'], r['Costomer Name -Text'], r['Customer Name']];
          const byMobile = mobiles.some(m => m && String(m).includes(q));
          const byName = names.some(n => n && String(n).toLowerCase().includes(q.toLowerCase()));
          return byMobile || byName;
        });
        if(!found) return alert('Customer not found');
        // Map likely fields
        document.getElementById('custName').value = found.name || found.Name || found['Costomer Name'] || found['Costomer Name -Text'] || '';
        document.getElementById('custMobile').value = found.mobile || found.Mobile || '';
        document.getElementById('custAddress').value = found.address || found.Address || '';
        document.getElementById('custGST').value = found.gst || found.GST || '';
      }catch(err){console.error(err);alert('Customer search failed: '+err.message)}
    });

    // ========== Product Search & Scan ==========
    document.getElementById('btnSearchProduct').addEventListener('click', async ()=>{
      const q = document.getElementById('productSearch').value.trim();
      if(!q) return alert('Enter product id or name');
      try{
        const data = await baserowFetch(TABLE_PRODUCTS);
        const rows = data.results || data;
        const found = rows.find(r => {
          const ids = [r.id, r['Product ID'], r.ProductID, r.product_id, r['Product Id']];
          const names = [r.name, r.Name, r['Item Name'], r['Item Name -Text']];
          const byId = ids.some(i => i && String(i).toLowerCase() === q.toLowerCase());
          const byName = names.some(n => n && String(n).toLowerCase().includes(q.toLowerCase()));
          return byId || byName;
        });
        if(!found) return alert('Product not found');
        fillProductFields(found);
        await fetchBatchesForProduct(found.id || found['Product ID'] || found.ProductID || found.product_id);
      }catch(err){console.error(err);alert('Product search failed: '+err.message)}
    });

    function fillProductFields(row){
      document.getElementById('productId').value = row.id || row['Product ID'] || row.ProductID || '';
      document.getElementById('itemName').value = row.name || row.Name || row['Item Name'] || '';
      document.getElementById('price').value = row.price || row.Price || row['Selling Price'] || '';
    }

    // QR Scanner control
    document.getElementById('startScanner').addEventListener('click', ()=>startScanner());
    document.getElementById('stopScanner').addEventListener('click', ()=>stopScanner());

    function startScanner(){
      if(html5QrCode) return;
      const qrRegionId = 'reader';
      html5QrCode = new Html5Qrcode(qrRegionId);
      const config = { fps: 10, qrbox: {width:250, height:250}, experimentalFeatures:{useBarCodeDetectorIfSupported:true} };
      html5QrCode.start({ facingMode: { exact: 'environment' } }, config, qrCodeMessage => {
        // on success
        document.getElementById('productSearch').value = qrCodeMessage;
        document.getElementById('btnSearchProduct').click();
      }).catch(err => {
        // fallback: try without exact constraint
        html5QrCode.start({ facingMode: 'environment' }, config, qrCodeMessage => {
          document.getElementById('productSearch').value = qrCodeMessage;
          document.getElementById('btnSearchProduct').click();
        }).catch(e=>{
          console.error('Scanner start failed', e);
          alert('Camera start failed: '+e.message);
        });
      });
    }
    function stopScanner(){
      if(!html5QrCode) return;
      html5QrCode.stop().then(()=>{
        html5QrCode.clear(); html5QrCode = null; document.getElementById('reader').innerHTML='';
      }).catch(err=>console.error('stop failed',err));
    }

    // ========== Inventory / Batch Handling ==========
    document.getElementById('openBatches').addEventListener('click', ()=>{
      const modal = document.getElementById('batchModal');
      const list = document.getElementById('batchList');
      list.innerHTML = '';
      if(currentBatches.length===0){ list.innerHTML = '<div class="muted">No batches found for this product.</div>'; }
      currentBatches.forEach(b => {
        const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid #eef2ff';
        div.innerHTML = `<strong>Batch:</strong> ${b.batch_no || b.Batch || b.BatchNo} &nbsp; <strong>Count:</strong> ${b.count || b.Count || b.quantity || b.Qty}`;
        const sel = document.createElement('button'); sel.textContent='Select'; sel.style.float='right'; sel.addEventListener('click', ()=>{
          document.getElementById('batchNo').value = b.batch_no || b.Batch || b.BatchNo || '';
          document.getElementById('availableCount').value = b.count || b.Count || b.quantity || b.Qty || 0;
          modal.style.display='none';
        });
        div.appendChild(sel);
        list.appendChild(div);
      });
      modal.style.display='flex';
    });
    document.getElementById('closeBatch').addEventListener('click', ()=> document.getElementById('batchModal').style.display='none');

    async function fetchBatchesForProduct(productId){
      if(!productId) return;
      try{
        const res = await baserowFetch(TABLE_INVENTORY);
        const rows = res.results || res;
        currentBatches = rows.filter(r => {
          const pid = r.product_id || r['Product ID'] || r.ProductID || r.product;
          return String(pid) === String(productId);
        }).map(r=>({batch_no: r.batch_no || r.Batch || r.BatchNo, count: r.count || r.Count || r.quantity || r.Qty, raw: r}));
      }catch(err){console.error(err);currentBatches=[]}
    }

    // ========== Items Table ==========
    document.getElementById('addItem').addEventListener('click', ()=>{
      const pid = document.getElementById('productId').value;
      const name = document.getElementById('itemName').value;
      const batch = document.getElementById('batchNo').value || '';
      const qty = Number(document.getElementById('quantity').value) || 0;
      const available = Number(document.getElementById('availableCount').value) || 0;
      const price = Number(document.getElementById('price').value) || 0;
      if(!pid || !name) return alert('Select product first');
      if(qty<=0) return alert('Quantity must be at least 1');
      if(available && qty>available) return alert('Quantity exceeds available count');
      const lineTotal = qty * price;
      const item = {productId: pid, itemName: name, batch, qty, price, lineTotal};
      items.push(item);
      renderItems();
    });

    function renderItems(){
      const tbody = document.querySelector('#itemsTable tbody'); tbody.innerHTML='';
      let total = 0; items.forEach((it,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${it.productId}</td><td>${it.itemName}</td><td>${it.batch}</td><td>${it.qty}</td><td>₹ ${it.price}</td><td>₹ ${it.lineTotal}</td><td><button data-i='${i}' class='del'>Delete</button></td>`;
        tbody.appendChild(tr);
        total += it.lineTotal;
      });
      document.getElementById('totalAmount').textContent = total.toFixed(2);
      if(items.length>0 && !document.getElementById('invoiceNo').textContent) document.getElementById('invoiceNo').textContent = generateInvoiceNo();
      [...document.querySelectorAll('.del')].forEach(btn=>btn.addEventListener('click', e=>{ const idx = Number(e.target.dataset.i); items.splice(idx,1); renderItems(); }));
    }

    function generateInvoiceNo(){
      const d = new Date();
      const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0');
      const rnd = Math.floor(1000 + Math.random()*9000);
      return `INV-${y}${m}${day}-${rnd}`;
    }

    // ========== Save Invoice ==========
    document.getElementById('saveInvoice').addEventListener('click', async ()=>{
      if(items.length===0) return alert('Add at least one item');
      const invoiceNo = document.getElementById('invoiceNo').textContent || generateInvoiceNo();
      const shopId = localStorage.getItem(KEY_SHOPID) || '';
      const salesPerson = localStorage.getItem(KEY_NAME) || '';
      const custName = document.getElementById('custName').value;
      const custMobile = document.getElementById('custMobile').value;
      const date = new Date().toISOString();
      const total = Number(document.getElementById('totalAmount').textContent) || 0;

      try{
        // Create ledger entry (summary)
        await baserowCreate(TABLE_LEDGER, { 'Customer Name': custName, 'Mobile': custMobile, 'Date': date, 'Invoice Number': invoiceNo, 'Total Invoice Value': total, 'ShopID': shopId });

        // Create sales rows (one row per item)
        for(const it of items){
          await baserowCreate(TABLE_SALES, {
            'Costomer Name': custName,
            'Mobile': custMobile,
            'Date': date,
            'Invoice Number': invoiceNo,
            'Product ID': it.productId,
            'Item Name': it.itemName,
            'Batch No': it.batch,
            'Quantity': it.qty,
            'Price': it.price,
            'Tag': 'Order Confirmed',
            'ShopID': shopId,
            'Sales Person': salesPerson
          });
        }

        alert('Saved successfully');
        renderInvoicePreview({invoiceNo, custName, custMobile, date, items, total, shopId, salesPerson});
        // Clear items
        items = [];
        renderItems();

      }catch(err){console.error(err);alert('Save failed: '+err.message)}
    });

    // ========== Invoice Preview / Print ==========
    document.getElementById('printInvoice').addEventListener('click', ()=>{
      const html = document.getElementById('invoicePreview').innerHTML;
      if(!html) return alert('No invoice to preview');
      const w = window.open('','_blank');
      w.document.write('<html><head><title>Invoice</title></head><body>'+html+'</body></html>');
      w.document.close();
      w.print();
    });

    function renderInvoicePreview({invoiceNo,custName,custMobile,date,items,total,shopId,salesPerson}){
      const el = document.getElementById('invoicePreview');
      el.style.display='block';
      const rows = items.map((it,i)=>`<tr><td>${i+1}</td><td>${it.itemName}</td><td>${it.batch}</td><td>${it.qty}</td><td>₹ ${it.price}</td><td>₹ ${it.lineTotal}</td></tr>`).join('');
      el.innerHTML = `<div><h2>Invoice: ${invoiceNo}</h2><div class='muted'>Date: ${new Date(date).toLocaleString()}</div><div><strong>Customer:</strong> ${custName} (${custMobile})</div><table style='width:100%;border-collapse:collapse;margin-top:8px'><thead><tr><th>#</th><th>Item</th><th>Batch</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>${rows}</tbody></table><div style='margin-top:8px'><strong>Total: ₹ ${total.toFixed(2)}</strong></div><div class='muted'>ShopID: ${shopId} | Sales Person: ${salesPerson}</div></div>`;
    }

    // ======= Init =======
    (async ()=>{ await checkLogin(); })();

  </script></body>
</html>