<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sales Invoice</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 20px; }
    .container { background: #fff; border-radius: 10px; padding: 20px; max-width: 900px; margin: auto; box-shadow: 0 0 10px #ccc; }
    h2 { text-align: center; }
    input, select, textarea, button {
      width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { cursor: pointer; background: #007bff; color: white; border: none; }
    button:hover { background: #0056b3; }
    #preview { margin-top: 30px; padding: 15px; border: 1px solid #ccc; background: #fafafa; }
    #scanner { display: none; }
  </style>
</head>
<body>

<div class="container">
  <h2>Sales Invoice</h2>

  <div id="scanner">
    <video id="preview" width="100%" height="200"></video>
    <button id="stopScan">Stop Camera</button>
  </div>

  <h3>Customer Details</h3>
  <input id="searchMobile" placeholder="Enter Customer Mobile to Fetch Details">
  <button onclick="fetchCustomer()">Fetch Customer</button>

  <input id="customerName" placeholder="Customer Name">
  <input id="customerMobile" placeholder="Mobile">
  <textarea id="address" placeholder="Address"></textarea>
  <input id="gst" placeholder="GST (Optional)">
  <input id="date" type="date">

  <h3>Product Details</h3>
  <button onclick="startScanner()">Scan Product QR</button>
  <input id="productID" placeholder="Product ID">
  <button onclick="fetchProduct()">Fetch Product</button>
  <input id="productName" placeholder="Item Name">
  <input id="price" type="number" placeholder="Price">

  <select id="batchNo"><option value="">Select Batch</option></select>
  <input id="quantity" type="number" placeholder="Quantity">

  <button onclick="addProduct()">Add Product</button>

  <table id="invoiceTable">
    <thead>
      <tr>
        <th>Product ID</th><th>Item Name</th><th>Batch No</th><th>Qty</th><th>Price</th><th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Total: â‚¹<span id="totalAmount">0</span></h3>

  <button onclick="saveInvoice()">Save Invoice</button>
</div>

<script>
const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const baseUrl = "https://api.baserow.io/api/database/rows/table/";
const usersTable = 729979, customerTable = 736204, productTable = 734793, inventoryTable = 734795, salesTable = 736209, ledgerTable = 736207;

let invoiceItems = [];
let totalValue = 0;
let shopID = localStorage.getItem("ShopIDTag");
let mobileTag = localStorage.getItem("MobileTag");
let salesPerson = localStorage.getItem("NameTag");

// Access Validation
async function validateAccess() {
  if (!mobileTag) { alert("Please login first."); location.href = "login.html"; return; }
  const res = await fetch(`${baseUrl}${usersTable}/?user_field_names=true`, {
    headers: { Authorization: `Token ${apiKey}` }
  });
  const data = await res.json();
  const found = data.results.find(u => u.Username == mobileTag);
  if (!found) { alert("Access denied."); location.href = "login.html"; }
}
validateAccess();

// Fetch Customer
async function fetchCustomer() {
  const mobile = document.getElementById("searchMobile").value;
  const res = await fetch(`${baseUrl}${customerTable}/?user_field_names=true`, { headers: { Authorization: `Token ${apiKey}` }});
  const data = await res.json();
  const c = data.results.find(x => x.Mobile == mobile && x.ShopID == shopID);
  if (c) {
    document.getElementById("customerName").value = c["Costomer Name"];
    document.getElementById("customerMobile").value = c["Mobile"];
    document.getElementById("address").value = c["Address"];
    document.getElementById("gst").value = c["GST"] || "Nil";
    document.getElementById("date").value = new Date().toISOString().split("T")[0];
  } else alert("Customer not found for this Shop");
}

// Fetch Product
async function fetchProduct() {
  const pid = document.getElementById("productID").value;
  const res = await fetch(`${baseUrl}${productTable}/?user_field_names=true`, { headers: { Authorization: `Token ${apiKey}` }});
  const data = await res.json();
  const p = data.results.find(x => x["Product ID"] == pid && x.ShopID == shopID);
  if (p) {
    document.getElementById("productName").value = p["Item Name"];
    document.getElementById("price").value = p["Price"];
    fetchBatch(pid);
  } else alert("Product not found for this Shop");
}

// Fetch Batch
async function fetchBatch(pid) {
  const res = await fetch(`${baseUrl}${inventoryTable}/?user_field_names=true`, { headers: { Authorization: `Token ${apiKey}` }});
  const data = await res.json();
  const batches = data.results.filter(x => x["Product ID"] == pid && x.ShopID == shopID);
  const select = document.getElementById("batchNo");
  select.innerHTML = "<option value=''>Select Batch</option>";
  batches.forEach(b => {
    select.innerHTML += `<option value="${b["Batch No"]}" data-count="${b["Count"]}">${b["Batch No"]} (Count: ${b["Count"]})</option>`;
  });
}

// Add Product to Invoice
function addProduct() {
  const pid = productID.value, pname = productName.value, batch = batchNo.value, qty = +quantity.value, price = +document.getElementById("price").value;
  const batchOption = document.querySelector(`#batchNo option[value='${batch}']`);
  const available = batchOption ? +batchOption.dataset.count : 0;
  if (!pid || !batch || qty <= 0) return alert("Fill all fields");
  if (qty > available) return alert("Insufficient stock!");

  const total = qty * price;
  invoiceItems.push({ pid, pname, batch, qty, price, total });
  totalValue += total;
  document.getElementById("totalAmount").innerText = totalValue.toFixed(2);

  const row = `<tr><td>${pid}</td><td>${pname}</td><td>${batch}</td><td>${qty}</td><td>${price}</td><td>${total}</td></tr>`;
  document.querySelector("#invoiceTable tbody").insertAdjacentHTML("beforeend", row);
}

// Save Invoice
async function saveInvoice() {
  const invoiceNumber = "INV-" + Date.now();
  const payloads = invoiceItems.map(item => ({
    "Costomer Name": customerName.value,
    "Mobile": customerMobile.value,
    "Address": address.value,
    "GST": gst.value || "Nil",
    "Date": new Date().toISOString().split("T")[0],
    "Product ID": item.pid,
    "Item Name": item.pname,
    "Batch No": item.batch,
    "Quantity": item.qty,
    "Price": item.price,
    "Invoice Number": invoiceNumber,
    "Tag": "Order Confirmed",
    "ShopID": shopID,
    "Sales Person": salesPerson
  }));

  for (const p of payloads) {
    await fetch(`${baseUrl}${salesTable}/?user_field_names=true`, {
      method: "POST",
      headers: { Authorization: `Token ${apiKey}`, "Content-Type": "application/json" },
      body: JSON.stringify(p)
    });
  }

  await fetch(`${baseUrl}${ledgerTable}/?user_field_names=true`, {
    method: "POST",
    headers: { Authorization: `Token ${apiKey}`, "Content-Type": "application/json" },
    body: JSON.stringify({
      "Costomer Name": customerName.value,
      "Mobile": customerMobile.value,
      "Date": new Date().toISOString().split("T")[0],
      "Invoice Number": invoiceNumber,
      "Total Invoice Value": totalValue,
      "ShopID": shopID
    })
  });

  alert(`Invoice ${invoiceNumber} saved successfully!`);
  location.reload();
}

// QR Scanner (rear camera)
let scanner;
async function startScanner() {
  document.getElementById("scanner").style.display = "block";
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  const video = document.getElementById("preview");
  video.srcObject = stream;
  video.play();
  scanner = stream;
}
document.getElementById("stopScan").onclick = () => {
  if (scanner) scanner.getTracks().forEach(t => t.stop());
  document.getElementById("scanner").style.display = "none";
};
</script>
</body>
</html>