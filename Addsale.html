<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Invoice</title>
<style>
body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f4f6f8; }
.container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
h2 { text-align: center; color: #333; }
.section { border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
label { display: block; margin-top: 10px; }
input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; }
button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
button:hover { background: #0056b3; }
#productTable th, #productTable td { border: 1px solid #ccc; padding: 8px; text-align: center; }
#productTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
.modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
.modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; border-radius: 10px; }
#cameraView { width: 100%; }
</style>
</head>
<body>

<div class="container">
<h2>Sales Invoice Form</h2>

<!-- Customer Section -->
<div class="section">
<h3>Customer Details</h3>
<input type="text" id="customerSearch" placeholder="Search by Name or Mobile">
<div id="customerResults"></div>
<label>Customer Name</label><input id="custName">
<label>Mobile</label><input id="custMobile">
<label>Address</label><textarea id="custAddress"></textarea>
<label>GST</label><input id="custGST">
</div>

<!-- Product Section -->
<div class="section">
<h3>Add Products</h3>
<input type="text" id="productSearch" placeholder="Search Product by Name or ID">
<div id="productResults"></div>
<table id="productTable">
<thead>
<tr><th>Product ID</th><th>Name</th><th>Batch</th><th>Qty</th><th>Price</th><th>Total</th></tr>
</thead>
<tbody id="productList"></tbody>
</table>
</div>

<!-- Camera Scanner -->
<div class="section">
<h3>Scanner</h3>
<button onclick="startCamera()">Camera On</button>
<button onclick="stopCamera()">Camera Off</button>
<video id="cameraView" autoplay></video>
</div>

<!-- Save -->
<div class="section">
<button onclick="saveInvoice()">Save Invoice</button>
<div id="message"></div>
</div>
</div>

<!-- Batch Modal -->
<div id="batchModal" class="modal">
  <div class="modal-content">
    <h3>Select Batch</h3>
    <div id="batchList"></div>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const API_URL = "https://api.baserow.io/api/database/rows/table/";
const salesTable = 736209;
const ledgerTable = 736207;
const customerTable = 7362024;
const productTableId = 734793;
const inventoryTableId = 734795;

let ShopID = localStorage.getItem("ShopIDTag");
let SalesPerson = localStorage.getItem("NameTag");
let MobileTag = localStorage.getItem("MobileTag");
let invoiceNo = "INV-" + Date.now();
let currentStream = null;
let productList = [];

if(!ShopID || !MobileTag) {
  alert("Please login first");
  window.location.href = "login.html";
}

// --- Customer Search ---
document.getElementById("customerSearch").addEventListener("input", async (e)=>{
  let q = e.target.value.trim();
  if(q.length < 2) return;
  const res = await fetch(`${API_URL}${customerTable}/?user_field_names=true`, { headers:{ Authorization:`Token ${API_KEY}` }});
  const data = await res.json();
  const results = data.results.filter(c=> (c["ShopID"]==ShopID) && (c["Costomer Name"].toLowerCase().includes(q.toLowerCase()) || (c["Mobile"]+"").includes(q)));
  document.getElementById("customerResults").innerHTML = results.map(c=>`<div onclick='selectCustomer(${JSON.stringify(c)})'>${c["Costomer Name"]} - ${c["Mobile"]}</div>`).join("");
});
function selectCustomer(c){
  document.getElementById("custName").value = c["Costomer Name"];
  document.getElementById("custMobile").value = c["Mobile"];
  document.getElementById("custAddress").value = c["Address"];
  document.getElementById("custGST").value = c["GST"];
  document.getElementById("customerResults").innerHTML="";
}

// --- Product Search ---
document.getElementById("productSearch").addEventListener("input", async (e)=>{
  let q = e.target.value.trim();
  if(q.length < 2) return;
  const res = await fetch(`${API_URL}${productTableId}/?user_field_names=true`, { headers:{ Authorization:`Token ${API_KEY}` }});
  const data = await res.json();
  const results = data.results.filter(p=> p["ShopID"]==ShopID && (p["Product Name"].toLowerCase().includes(q.toLowerCase()) || p["Product ID"].toLowerCase().includes(q.toLowerCase())));
  document.getElementById("productResults").innerHTML = results.map(p=>`<div onclick='selectProduct(${JSON.stringify(p)})'>${p["Product Name"]} (${p["Product ID"]})</div>`).join("");
});

async function selectProduct(p){
  document.getElementById("productResults").innerHTML="";
  const inv = await fetch(`${API_URL}${inventoryTableId}/?user_field_names=true`, { headers:{ Authorization:`Token ${API_KEY}` }});
  const data = await inv.json();
  const batches = data.results.filter(b=>b["Product ID"]==p["Product ID"]);
  let html = batches.map(b=>`<div onclick='addProduct(${JSON.stringify(p)},${JSON.stringify(b)})'>Batch: ${b["Batch No"]} | Count: ${b["Count"]} | Exp: ${b["Expire Date"]}</div>`).join("");
  document.getElementById("batchList").innerHTML = html;
  document.getElementById("batchModal").style.display = "block";
}

function addProduct(p,b){
  closeModal();
  let qty = prompt("Enter Quantity (Available: "+b["Count"]+")");
  qty = parseInt(qty);
  if(!qty || qty <= 0 || qty > b["Count"]) return alert("Invalid Quantity");
  let total = qty * p["Price"];
  productList.push({ id:p["Product ID"], name:p["Product Name"], batch:b["Batch No"], qty, price:p["Price"], total });
  renderProducts();
}
function renderProducts(){
  document.getElementById("productList").innerHTML = productList.map(p=>`<tr><td>${p.id}</td><td>${p.name}</td><td>${p.batch}</td><td>${p.qty}</td><td>${p.price}</td><td>${p.total}</td></tr>`).join("");
}
function closeModal(){ document.getElementById("batchModal").style.display="none"; }

// --- Camera ---
async function startCamera(){
  stopCamera();
  currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
  document.getElementById("cameraView").srcObject = currentStream;
}
function stopCamera(){
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
  document.getElementById("cameraView").srcObject = null;
}

// --- Save Invoice ---
async function saveInvoice(){
  if(!productList.length) return alert("Add at least one product");
  let custName = document.getElementById("custName").value;
  let custMobile = document.getElementById("custMobile").value;
  let totalVal = productList.reduce((a,b)=>a+b.total,0);
  
  // Save to Sales Table
  for(let p of productList){
    await fetch(`${API_URL}${salesTable}/?user_field_names=true`, {
      method:"POST",
      headers:{ "Authorization":"Token "+API_KEY, "Content-Type":"application/json" },
      body:JSON.stringify({
        "Costomer Name": custName,
        "Mobile": custMobile,
        "Address": document.getElementById("custAddress").value,
        "GST": document.getElementById("custGST").value,
        "Date": new Date().toISOString().split('T')[0],
        "Product ID": p.id,
        "Item Name": p.name,
        "Batch No": p.batch,
        "Quantity": p.qty,
        "Price": p.price,
        "Invoice Number": invoiceNo,
        "Tag": "Order Confirmed",
        "ShopID": ShopID,
        "Sales Person": SalesPerson
      })
    });
  }

  // Save to Ledger Table
  await fetch(`${API_URL}${ledgerTable}/?user_field_names=true`, {
    method:"POST",
    headers:{ "Authorization":"Token "+API_KEY, "Content-Type":"application/json" },
    body:JSON.stringify({
      "Costomer Name": custName,
      "Mobile": custMobile,
      "Date": new Date().toISOString().split('T')[0],
      "Invoice Number": invoiceNo,
      "Total Invoice Value": totalVal,
      "ShopID": ShopID
    })
  });
  
  document.getElementById("message").innerText = `âœ… Invoice Saved Successfully! Invoice No: ${invoiceNo}`;
}
</script>

</body>
</html>