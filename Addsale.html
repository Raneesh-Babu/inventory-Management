<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Invoice - Functional</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; margin: 12px; color: #111; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .col { display:flex; flex-direction:column; gap:6px; }
    input, select, button, textarea { padding:8px; font-size:14px; border:1px solid #ccc; border-radius:6px; }
    button { cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border:1px solid #ddd; padding:6px; text-align:left; }
    .small { font-size:13px; color:#555; }
    .muted { color:#666; font-size:13px; }
    #video { width:320px; height:240px; background:#000; border-radius:6px; }
    #canvas { display:none; }
    .modal { position: fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; }
    .modal .box { background:#fff; padding:12px; border-radius:8px; max-width:600px; width:90%; }
    .hidden { display:none; }
  </style>
  <!-- jsQR library for QR decoding -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
  <h1>Sales Invoice — Functional</h1>
  <div id="status" class="muted">Initializing...</div>

  <!-- Customer / Auth area -->
  <div style="margin-top:12px;">
    <div class="row">
      <div class="col" style="flex:1">
        <label class="small">Customer Mobile (search)</label>
        <input id="custMobile" placeholder="Enter customer mobile and press Search" />
      </div>
      <div style="width:120px">
        <label class="small">&nbsp;</label>
        <button id="btnSearchCustomer">Search Customer</button>
      </div>
      <div style="width:160px">
        <label class="small">&nbsp;</label>
        <button id="btnAddCustomer">Add New Customer</button>
      </div>
    </div>

    <div class="row">
      <div class="col" style="flex:1">
        <label class="small">Customer Name</label>
        <input id="custName" />
      </div>
      <div class="col" style="width:240px">
        <label class="small">GST (optional)</label>
        <input id="custGST" />
      </div>
      <div class="col" style="flex:1">
        <label class="small">Address</label>
        <textarea id="custAddress" rows="2"></textarea>
      </div>
    </div>
  </div>

  <hr />

  <!-- Product add area -->
  <div>
    <h2 style="font-size:16px; margin:8px 0;">Add Product</h2>
    <div class="row">
      <div>
        <label class="small">Scan Product ID (QR)</label><br/>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" width="640" height="480"></canvas>
        <div style="margin-top:6px;">
          <button id="btnStartCam">Start Camera</button>
          <button id="btnStopCam" disabled>Stop Camera</button>
        </div>
      </div>

      <div style="flex:1;">
        <label class="small">Or enter Product ID</label>
        <input id="productIdInput" placeholder="Product ID" />
        <div style="margin-top:8px;">
          <label class="small">Or search by Product Name</label>
          <input id="productNameSearch" placeholder="Product name search" />
          <button id="btnSearchProduct">Search</button>
        </div>

        <div style="margin-top:10px;">
          <label class="small">Selected Product Name</label>
          <input id="selectedProductName" readonly />
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col">
            <label class="small">Price</label>
            <input id="selectedPrice" readonly />
          </div>
          <div class="col">
            <label class="small">Batch No (choose)</label>
            <input id="selectedBatchNo" readonly />
            <button id="btnOpenBatches">Choose Batch</button>
          </div>
          <div class="col">
            <label class="small">Available Count</label>
            <input id="availableCount" readonly />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label class="small">Quantity</label>
            <input id="qtyInput" type="number" min="1" value="1" style="width:100px" />
          </div>
          <div style="align-self:end">
            <label class="small">&nbsp;</label><br/>
            <button id="btnAddToInvoice">Add to Invoice</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr />

  <!-- Invoice area -->
  <div>
    <div class="row">
      <div>
        <label class="small">Invoice Number</label>
        <input id="invoiceNumber" readonly />
      </div>
      <div>
        <label class="small">Date</label>
        <input id="invoiceDate" readonly />
      </div>
      <div>
        <label class="small">Sales Person</label>
        <input id="salesPerson" readonly />
      </div>
      <div>
        <label class="small">ShopID</label>
        <input id="shopIdField" readonly />
      </div>
    </div>

    <table id="invoiceTable">
      <thead>
        <tr><th>#</th><th>Product ID</th><th>Item Name</th><th>Batch No</th><th>Qty</th><th>Price</th><th>Line Total</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
      <div class="muted">Initial Tag: <strong>Order Confirmed</strong></div>
      <div>
        <strong>Total: ₹<span id="invoiceTotal">0.00</span></strong>
        <button id="btnSaveInvoice" style="margin-left:10px;">Save Invoice</button>
      </div>
    </div>
  </div>

  <!-- Inventory Batches Modal -->
  <div id="batchesModal" class="modal hidden">
    <div class="box">
      <h3>Choose Batch</h3>
      <div id="batchesList" style="max-height:300px; overflow:auto;"></div>
      <div style="text-align:right; margin-top:8px;">
        <button id="closeBatches">Close</button>
      </div>
    </div>
  </div>

<script>
/*
  Functional Sales Invoice page for Baserow integration.
  - Uses the provided API Key and table IDs.
  - Filters by ShopIDTag from localStorage.
  - Scanning uses jsQR decode on video frames.
*/

/* ---------- CONFIG: change only if you must ---------- */
const API_KEY = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw';
const BASEROW_BASE = 'https://api.baserow.io/api/database/rows/table';
const TABLE_USERS = '729979';     // Users table
const TABLE_CUSTOMERS = '736204'; // Customer table (you specified 736204 earlier)
const TABLE_PRODUCTS = '734793';
const TABLE_INVENTORY = '734795';
const TABLE_SALES = '736209';
const TABLE_LEDGER = '736207';
/* ----------------------------------------------------- */

const $ = id => document.getElementById(id);
const status = $('status');

let localMobileTag = localStorage.getItem('MobileTag') || null;
let localShopID = localStorage.getItem('ShopIDTag') || null;
let localNameTag = localStorage.getItem('NameTag') || null;

let videoStream = null;
let video = $('video');
let canvasElem = $('canvas');
let canvas = canvasElem.getContext('2d');
let scanInterval = null;

let currentSelectedProduct = null; // object from products table
let currentSelectedBatch = null;   // object from inventory table
let invoiceItems = []; // { productId, name, batchNo, qty, price, inventoryRowId? }

function setStatus(msg, err=false) {
  status.textContent = msg;
  status.style.color = err ? 'crimson' : '#333';
}

/* ---------- Utility: Baserow fetch helpers ---------- */
async function baserowGet(tableId) {
  const url = `${BASEROW_BASE}/${tableId}/?user_field_names=true&size=100000`;
  const resp = await fetch(url, {
    headers: { 'Authorization': `Token ${API_KEY}` }
  });
  if (!resp.ok) throw new Error('Baserow GET failed: ' + resp.statusText);
  return resp.json();
}

async function baserowPost(tableId, bodyObj) {
  const url = `${BASEROW_BASE}/${tableId}/`;
  const resp = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': `Token ${API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(bodyObj)
  });
  if (!resp.ok) {
    const text = await resp.text();
    throw new Error('Baserow POST failed: ' + resp.status + ' ' + text);
  }
  return resp.json();
}

/* ---------- Auth check ---------- */
async function checkAuthAndInit() {
  setStatus('Checking authentication...');
  if (!localMobileTag) {
    setStatus('MobileTag missing in localStorage. Redirecting to login...', true);
    // redirect to login - change to your login path if needed
    setTimeout(() => window.location.href = '/login.html', 1200);
    return;
  }
  if (!localShopID) {
    setStatus('ShopIDTag missing in localStorage. Please set ShopIDTag.', true);
    return;
  }

  try {
    // fetch users table and look for username === localMobileTag
    const data = await baserowGet(TABLE_USERS);
    const rows = data.results || data;
    const userRow = rows.find(r => (r.Username || r.username || r.username) == localMobileTag);
    if (!userRow) {
      setStatus('User not found for MobileTag. Redirecting to login...', true);
      setTimeout(() => window.location.href = '/login.html', 1200);
      return;
    }
    // OK
    setStatus('Authenticated.');
    $('shopIdField').value = localShopID;
    $('salesPerson').value = localNameTag || '';
    initFormValues();
  } catch (err) {
    console.error(err);
    setStatus('Auth check failed: ' + err.message, true);
  }
}

/* ---------- Form init ---------- */
function initFormValues() {
  $('invoiceDate').value = new Date().toLocaleString();
  $('invoiceNumber').value = generateInvoiceNumber();
  if (localNameTag) $('salesPerson').value = localNameTag;
}

/* ---------- Invoice helpers ---------- */
function generateInvoiceNumber() {
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  const s = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  return 'INV-' + s;
}

function refreshInvoiceTable() {
  const tbody = $('invoiceTable').querySelector('tbody');
  tbody.innerHTML = '';
  let total = 0;
  invoiceItems.forEach((it, idx) => {
    const lineTotal = Number(it.qty) * Number(it.price || 0);
    total += lineTotal;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td>
      <td>${escapeHtml(it.productId)}</td>
      <td>${escapeHtml(it.name)}</td>
      <td>${escapeHtml(it.batchNo)}</td>
      <td>${it.qty}</td>
      <td>${it.price}</td>
      <td>${lineTotal.toFixed(2)}</td>
      <td><button data-idx="${idx}" class="btnRemove">Remove</button></td>`;
    tbody.appendChild(tr);
  });
  $('invoiceTotal').textContent = total.toFixed(2);
  // attach remove handlers
  tbody.querySelectorAll('.btnRemove').forEach(b => b.addEventListener('click', e => {
    const idx = Number(e.target.dataset.idx);
    invoiceItems.splice(idx,1);
    refreshInvoiceTable();
  }));
}

/* ---------- Customer functions ---------- */
async function searchCustomerByMobile(mobile) {
  setStatus('Searching customer...');
  try {
    const data = await baserowGet(TABLE_CUSTOMERS);
    const rows = data.results || data;
    // filter by mobile & ShopID
    const row = rows.find(r => {
      const mb = (r.Mobile || r.mobile || '') + '';
      const shop = (r.ShopID || r.shopid || r.ShopId || '') + '';
      return mb === (mobile + '') && shop === (localShopID + '');
    });
    if (!row) {
      setStatus('Customer not found (ShopID mismatch or no such mobile). You can add new.');
      return null;
    }
    setStatus('Customer found.');
    return row;
  } catch (err) {
    console.error(err);
    setStatus('Customer search failed: ' + err.message, true);
    return null;
  }
}

async function addCustomerIfMissing(mobile, name, address, gst) {
  setStatus('Saving new customer...');
  try {
    const body = {
      fields: {
        "Costomer Name": name || '',
        "Mobile": mobile || '',
        "Address": address || '',
        "GST": gst || '',
        "Date": new Date().toISOString().slice(0,10),
        "ShopID": localShopID || ''
      }
    };
    const resp = await baserowPost(TABLE_CUSTOMERS, body);
    setStatus('Customer added.');
    return resp;
  } catch (err) {
    console.error(err);
    setStatus('Failed adding customer: ' + err.message, true);
    return null;
  }
}

/* ---------- Product & Inventory functions ---------- */
async function fetchProductById(productId) {
  setStatus('Fetching product...');
  try {
    const data = await baserowGet(TABLE_PRODUCTS);
    const rows = data.results || data;
    const row = rows.find(r => ((r['Product ID']||r.productid||'')+'' === (productId+'')) && ((r.ShopID||'')+'' === (localShopID+'')));
    if (!row) {
      setStatus('Product not found or ShopID mismatch.', true);
      return null;
    }
    setStatus('Product fetched.');
    return row;
  } catch (err) {
    console.error(err);
    setStatus('Product fetch failed: ' + err.message, true);
    return null;
  }
}

async function searchProductByName(namePart) {
  setStatus('Searching product by name...');
  try {
    const data = await baserowGet(TABLE_PRODUCTS);
    const rows = data.results || data;
    const filtered = rows.filter(r => (r['Item Name'] || r.item_name || '').toLowerCase().includes(namePart.toLowerCase()) && ((r.ShopID||'')+'' === (localShopID+'')));
    setStatus(`Found ${filtered.length} product(s).`);
    return filtered;
  } catch (err) {
    console.error(err);
    setStatus('Product name search failed: ' + err.message, true);
    return [];
  }
}

async function fetchInventoryBatchesForProduct(productId) {
  setStatus('Fetching inventory batches...');
  try {
    const data = await baserowGet(TABLE_INVENTORY);
    const rows = data.results || data;
    const filtered = rows.filter(r => ((r['Product ID']||'')+'' === (productId+'') ) && ((r.ShopID||'')+'' === (localShopID+'')));
    setStatus(`Found ${filtered.length} batch(es).`);
    return filtered;
  } catch (err) {
    console.error(err);
    setStatus('Inventory fetch failed: ' + err.message, true);
    return [];
  }
}

/* ---------- Add to invoice ---------- */
function addToInvoice(productId, name, batchNo, qty, price, inventoryRowId=null) {
  // validate qty <= available
  const avail = Number($('availableCount').value || 0);
  if (qty <= 0) { setStatus('Quantity must be > 0', true); return; }
  if (avail && qty > avail) { setStatus('Quantity exceeds available count.', true); return; }

  invoiceItems.push({
    productId, name, batchNo, qty: Number(qty), price: Number(price || 0), inventoryRowId
  });
  refreshInvoiceTable();
  setStatus('Added to invoice.');
}

/* ---------- Save invoice to Sales and Ledger ---------- */
async function saveInvoice() {
  if (!invoiceItems.length) { setStatus('Invoice is empty.', true); return; }
  const customerName = $('custName').value.trim();
  const customerMobile = $('custMobile').value.trim();
  const address = $('custAddress').value.trim();
  if (!customerName || !customerMobile) { setStatus('Customer name & mobile required.', true); return; }

  const invoiceNo = $('invoiceNumber').value;
  const dateStr = new Date().toISOString();
  const total = Number($('invoiceTotal').textContent || 0);
  const shopId = localShopID || '';
  const salesperson = localNameTag || '';

  // Sales row payload
  const salesBody = {
    fields: {
      "Costomer Name": customerName,
      "Mobile": customerMobile,
      "Date": dateStr,
      "Invoice Number": invoiceNo,
      "Total Invoice Value": total,
      "ShopID": shopId,
      "Sales Person": salesperson,
      "Items": JSON.stringify(invoiceItems),
      "Tag": "Order Confirmed"
    }
  };

  // Ledger row payload
  const ledgerBody = {
    fields: {
      "Costomer Name": customerName,
      "Mobile": customerMobile,
      "Date": dateStr,
      "Invoice Number": invoiceNo,
      "Total Invoice Value": total,
      "ShopID": shopId
    }
  };

  try {
    setStatus('Saving invoice to Sales table...');
    const salesResp = await baserowPost(TABLE_SALES, salesBody);
    setStatus('Sales row saved. Now saving ledger...');
    const ledgerResp = await baserowPost(TABLE_LEDGER, ledgerBody);
    setStatus('Invoice saved to Sales and Ledger. Done.');
    // optionally reset invoice
    invoiceItems = [];
    refreshInvoiceTable();
    $('invoiceNumber').value = generateInvoiceNumber();
    $('invoiceDate').value = new Date().toLocaleString();
  } catch (err) {
    console.error(err);
    setStatus('Failed to save invoice: ' + err.message, true);
  }
}

/* ---------- QR Scanner (jsQR) ---------- */
async function startCameraAndScan() {
  if (videoStream) return; // already running
  setStatus('Starting camera (attempting back camera)...');
  try {
    // Prefer environment (back) camera
    const constraints = { video: { facingMode: { exact: "environment" } } };
    try {
      videoStream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch (e) {
      // fallback to any camera
      videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    }
    video.srcObject = videoStream;
    $('btnStartCam').disabled = true;
    $('btnStopCam').disabled = false;
    scanInterval = requestAnimationFrame(tick);
    setStatus('Camera started. Point the QR at camera.');
  } catch (err) {
    console.error(err);
    setStatus('Camera start failed: ' + err.message, true);
  }
}

function stopCamera() {
  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    videoStream = null;
  }
  if (scanInterval) {
    cancelAnimationFrame(scanInterval);
    scanInterval = null;
  }
  $('btnStartCam').disabled = false;
  $('btnStopCam').disabled = true;
  setStatus('Camera stopped.');
}

function tick() {
  if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) {
    scanInterval = requestAnimationFrame(tick);
    return;
  }
  // draw frame to canvas
  canvasElem.width = video.videoWidth;
  canvasElem.height = video.videoHeight;
  canvas.drawImage(video, 0, 0, canvasElem.width, canvasElem.height);
  const imageData = canvas.getImageData(0, 0, canvasElem.width, canvasElem.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height);
  if (code) {
    // QR found
    const text = code.data;
    setStatus('QR detected: ' + text);
    // fill product id input and auto-fetch product
    $('productIdInput').value = text;
    handleProductIdEntered(text);
    // stop camera automatically after scan to avoid repeated scans
    stopCamera();
    return;
  }
  scanInterval = requestAnimationFrame(tick);
}

/* ---------- Small helpers ---------- */
function escapeHtml(s) {
  if (s == null) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ---------- UI wiring ---------- */
document.getElementById('btnStartCam').addEventListener('click', startCameraAndScan);
document.getElementById('btnStopCam').addEventListener('click', stopCamera);

$('btnSearchCustomer').addEventListener('click', async () => {
  const mobile = $('custMobile').value.trim();
  if (!mobile) { setStatus('Enter mobile to search customer.', true); return; }
  const row = await searchCustomerByMobile(mobile);
  if (row) {
    $('custName').value = row['Costomer Name'] || row['Costomer Name'] || '';
    $('custMobile').value = row['Mobile'] || row['mobile'] || mobile;
    $('custAddress').value = row['Address'] || row['address'] || '';
    $('custGST').value = row['GST'] || row['gst'] || '';
  }
});

$('btnAddCustomer').addEventListener('click', async () => {
  const mobile = $('custMobile').value.trim();
  const name = $('custName').value.trim();
  const address = $('custAddress').value.trim();
  const gst = $('custGST').value.trim();
  if (!mobile || !name) { setStatus('Customer name & mobile required to add.', true); return; }
  const resp = await addCustomerIfMissing(mobile, name, address, gst);
  if (resp) setStatus('Customer added successfully.');
});

$('productIdInput').addEventListener('change', (e) => {
  const pid = e.target.value.trim();
  if (pid) handleProductIdEntered(pid);
});

async function handleProductIdEntered(pid) {
  const row = await fetchProductById(pid);
  if (!row) return;
  currentSelectedProduct = row;
  $('selectedProductName').value = row['Item Name'] || row['Item Name'] || '';
  $('selectedPrice').value = row['Price'] || row['price'] || 0;
  // fetch batches
  const batches = await fetchInventoryBatchesForProduct(pid);
  if (batches.length === 0) {
    $('selectedBatchNo').value = '';
    $('availableCount').value = '';
  } else if (batches.length === 1) {
    currentSelectedBatch = batches[0];
    $('selectedBatchNo').value = currentSelectedBatch['Batch No'] || currentSelectedBatch.batch || '';
    $('availableCount').value = currentSelectedBatch['Count'] || currentSelectedBatch.Count || 0;
  } else {
    // multiple batches - user chooses via modal
    showBatchesModal(batches);
  }
}

$('btnSearchProduct').addEventListener('click', async () => {
  const q = $('productNameSearch').value.trim();
  if (!q) { setStatus('Enter product name to search', true); return; }
  const res = await searchProductByName(q);
  if (!res.length) { setStatus('No product matched'); return; }

  // if many, pick first (functional approach). You could present a list.
  const chosen = res[0];
  $('productIdInput').value = chosen['Product ID'] || chosen['productid'] || '';
  await handleProductIdEntered(chosen['Product ID'] || chosen['productid'] || '');
});

$('btnOpenBatches').addEventListener('click', async () => {
  const pid = $('productIdInput').value.trim();
  if (!pid) { setStatus('Enter product id first.', true); return; }
  const batches = await fetchInventoryBatchesForProduct(pid);
  if (!batches.length) { setStatus('No batches found.'); return; }
  showBatchesModal(batches);
});

function showBatchesModal(batches) {
  const list = $('batchesList');
  list.innerHTML = '';
  batches.forEach(b => {
    const bn = b['Batch No'] || b.batch || b['BatchNo'] || '';
    const count = b['Count'] || b.count || b['Available'] || 0;
    const tr = document.createElement('div');
    tr.style.padding = '8px';
    tr.style.borderBottom = '1px solid #eee';
    tr.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div><strong>Batch:</strong> ${escapeHtml(bn)}</div>
        <div class="muted small">Count: ${count}</div>
      </div>
      <div>
        <button data-rowid="${b.id}" data-batch="${escapeHtml(bn)}" data-count="${count}" class="pickBatch">Pick</button>
      </div>
    </div>`;
    list.appendChild(tr);
  });
  $('batchesModal').classList.remove('hidden');

  // handlers
  list.querySelectorAll('.pickBatch').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const batchNo = e.target.dataset.batch;
      const count = Number(e.target.dataset.count);
      const rowId = e.target.dataset.rowid;
      currentSelectedBatch = { id: rowId, 'Batch No': batchNo, 'Count': count };
      $('selectedBatchNo').value = batchNo;
      $('availableCount').value = count;
      $('batchesModal').classList.add('hidden');
      setStatus(`Selected batch ${batchNo} (count ${count}).`);
    });
  });
}

$('closeBatches').addEventListener('click', () => {
  $('batchesModal').classList.add('hidden');
});

$('btnAddToInvoice').addEventListener('click', () => {
  const pid = $('productIdInput').value.trim();
  const name = $('selectedProductName').value.trim();
  const batchNo = $('selectedBatchNo').value.trim();
  const qty = Number($('qtyInput').value);
  const price = Number($('selectedPrice').value || 0);
  if (!pid || !name) { setStatus('Select a product first.', true); return; }
  if (!batchNo) { setStatus('Select batch first.', true); return; }
  addToInvoice(pid, name, batchNo, qty, price, currentSelectedBatch ? currentSelectedBatch.id : null);
});

/* Save invoice */
$('btnSaveInvoice').addEventListener('click', async () => {
  await saveInvoice();
});

/* ---------- Initialization ---------- */
checkAuthAndInit();

</script>
</body>
</html>