<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Invoice</title>
<style>
  body { font-family: Arial; margin: 20px; background: #f4f6f8; }
  h2 { color: #333; }
  .section { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  input, select, textarea, button { width: 100%; margin: 5px 0; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
  button { background: #007bff; color: white; border: none; cursor: pointer; }
  button:hover { background: #0056b3; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  #productList div, #customerList div { padding: 5px; border-bottom: 1px solid #ddd; cursor: pointer; }
  #productList div:hover, #customerList div:hover { background: #f0f0f0; }
  #cameraView { display: none; width: 100%; height: 300px; background: #000; }
</style>
</head>
<body>

<h2>Sales Invoice Form</h2>

<div class="section" id="customerSection">
  <h3>Customer Details</h3>
  <input type="text" id="customerSearch" placeholder="Search by Costomer Name or Mobile">
  <div id="customerList"></div>
  <input type="text" id="CostomerName" placeholder="Costomer Name">
  <input type="text" id="Mobile" placeholder="Mobile Number">
  <textarea id="Address" placeholder="Address"></textarea>
  <input type="text" id="GST" placeholder="GST (optional)">
</div>

<div class="section" id="productSection">
  <h3>Product Details</h3>
  <button onclick="toggleCamera()">üì∑ Scan Product ID</button>
  <video id="cameraView" autoplay></video>
  <input type="text" id="productSearch" placeholder="Search Product Name or Product ID">
  <div id="productList"></div>
  <table id="productTable">
    <thead><tr><th>Product ID</th><th>Item Name</th><th>Batch No</th><th>Qty</th><th>Price</th><th>Total</th><th>Remove</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="section">
  <h3>Invoice Summary</h3>
  <p><b>Invoice Number:</b> <span id="invoiceNum"></span></p>
  <p><b>Total:</b> ‚Çπ<span id="grandTotal">0</span></p>
  <button onclick="saveInvoice()">üíæ Save Invoice</button>
</div>

<script>
const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const baseURL = "https://api.baserow.io/api/database/rows/table/";
const customerTable = 736204;
const productTable = 734793;
const inventoryTable = 734795;
const salesTable = 736209;
const ledgerTable = 736207;

let ShopID = localStorage.getItem("ShopIDTag");
let SalesPerson = localStorage.getItem("NameTag");
let MobileTag = localStorage.getItem("MobileTag");

if (!ShopID || !MobileTag) {
  alert("Please Login First.");
  window.location.href = "login.html";
}

document.getElementById("invoiceNum").innerText = "INV" + Date.now();

// üîç Customer Search
document.getElementById("customerSearch").addEventListener("input", async function() {
  let query = this.value.trim();
  if (query.length < 2) return;
  let url = `${baseURL}${customerTable}/?user_field_names=true`;
  const res = await fetch(url, { headers: { Authorization: `Token ${apiKey}` } });
  const data = await res.json();
  const filtered = data.results.filter(x =>
    (x["Costomer Name"].toLowerCase().includes(query.toLowerCase()) ||
     x["Mobile"].includes(query)) &&
     x["ShopID"] === ShopID
  );
  const list = document.getElementById("customerList");
  list.innerHTML = "";
  filtered.forEach(c => {
    const div = document.createElement("div");
    div.textContent = `${c["Costomer Name"]} (${c["Mobile"]})`;
    div.onclick = () => {
      document.getElementById("CostomerName").value = c["Costomer Name"];
      document.getElementById("Mobile").value = c["Mobile"];
      document.getElementById("Address").value = c["Address"];
      document.getElementById("GST").value = c["GST"];
      list.innerHTML = "";
    };
    list.appendChild(div);
  });
});

// üîç Product Search
document.getElementById("productSearch").addEventListener("input", async function() {
  let query = this.value.trim();
  if (query.length < 2) return;
  let url = `${baseURL}${productTable}/?user_field_names=true`;
  const res = await fetch(url, { headers: { Authorization: `Token ${apiKey}` } });
  const data = await res.json();
  const filtered = data.results.filter(x =>
    (x["Product Name"].toLowerCase().includes(query.toLowerCase()) ||
     x["Product ID"].toLowerCase().includes(query.toLowerCase())) &&
     x["ShopID"] === ShopID
  );
  const list = document.getElementById("productList");
  list.innerHTML = "";
  filtered.forEach(p => {
    const div = document.createElement("div");
    div.textContent = `${p["Product Name"]} (‚Çπ${p["Price"]})`;
    div.onclick = () => selectProduct(p);
    list.appendChild(div);
  });
});

// Select Product ‚Üí Show Batch Options
async function selectProduct(p) {
  const invURL = `${baseURL}${inventoryTable}/?user_field_names=true`;
  const res = await fetch(invURL, { headers: { Authorization: `Token ${apiKey}` } });
  const data = await res.json();
  const batches = data.results.filter(b => b["Product ID"] === p["Product ID"]);

  if (batches.length === 0) return alert("No batches found!");

  const batch = prompt(`Select Batch No:\n${batches.map(x => `Batch ${x["Batch No"]} (Count: ${x["Count"]})`).join("\n")}`);
  const batchData = batches.find(x => x["Batch No"] == batch.match(/\d+/)?.[0]);

  const qty = parseInt(prompt("Enter Quantity:"));
  if (!qty || qty > batchData["Count"]) return alert("Invalid quantity!");

  const total = p["Price"] * qty;
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${p["Product ID"]}</td>
    <td>${p["Product Name"]}</td>
    <td>${batchData["Batch No"]}</td>
    <td>${qty}</td>
    <td>${p["Price"]}</td>
    <td>${total}</td>
    <td><button onclick="this.closest('tr').remove();updateTotal()">‚ùå</button></td>
  `;
  document.querySelector("#productTable tbody").appendChild(row);
  updateTotal();
  document.getElementById("productList").innerHTML = "";
}

function updateTotal() {
  let total = 0;
  document.querySelectorAll("#productTable tbody tr").forEach(r => {
    total += parseFloat(r.children[5].innerText);
  });
  document.getElementById("grandTotal").innerText = total.toFixed(2);
}

// üíæ Save Invoice
async function saveInvoice() {
  const rows = document.querySelectorAll("#productTable tbody tr");
  if (rows.length === 0) return alert("No products added!");
  const invoiceNum = document.getElementById("invoiceNum").innerText;
  const total = document.getElementById("grandTotal").innerText;
  const CostomerName = document.getElementById("CostomerName").value;
  const Mobile = document.getElementById("Mobile").value;
  const Address = document.getElementById("Address").value;
  const GST = document.getElementById("GST").value;
  const DateNow = new Date().toISOString().split("T")[0];

  for (let r of rows) {
    const obj = {
      "Costomer Name": CostomerName,
      "Mobile": Mobile,
      "Address": Address,
      "GST": GST,
      "Date": DateNow,
      "Product ID": r.children[0].innerText,
      "Item Name": r.children[1].innerText,
      "Batch No": r.children[2].innerText,
      "Quantity": parseInt(r.children[3].innerText),
      "Price": parseFloat(r.children[4].innerText),
      "Invoice Number": invoiceNum,
      "Tag": "Order Confirmed",
      "ShopID": ShopID,
      "Sales Person": SalesPerson
    };
    await fetch(`${baseURL}${salesTable}/?user_field_names=true`, {
      method: "POST",
      headers: { Authorization: `Token ${apiKey}`, "Content-Type": "application/json" },
      body: JSON.stringify(obj)
    });

    // üßæ Reduce inventory
    const invRes = await fetch(`${baseURL}${inventoryTable}/?user_field_names=true`, { headers: { Authorization: `Token ${apiKey}` } });
    const invData = await invRes.json();
    const batchRow = invData.results.find(x => x["Product ID"] === r.children[0].innerText && x["Batch No"] == r.children[2].innerText);
    if (batchRow) {
      const newCount = batchRow["Count"] - parseInt(r.children[3].innerText);
      await fetch(`${baseURL}${inventoryTable}/${batchRow.id}/?user_field_names=true`, {
        method: "PATCH",
        headers: { Authorization: `Token ${apiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({ "Count": newCount })
      });
    }
  }

  // üí∞ Add Ledger Entry
  await fetch(`${baseURL}${ledgerTable}/?user_field_names=true`, {
    method: "POST",
    headers: { Authorization: `Token ${apiKey}`, "Content-Type": "application/json" },
    body: JSON.stringify({
      "Costomer Name": CostomerName,
      "Mobile": Mobile,
      "Date": DateNow,
      "Invoice Number": invoiceNum,
      "Total Invoice Value": parseFloat(total),
      "ShopID": ShopID
    })
  });

  alert("‚úÖ Invoice Saved Successfully!");
  location.reload();
}

// üì∑ Camera Scanner
let cameraOn = false;
async function toggleCamera() {
  const video = document.getElementById("cameraView");
  if (cameraOn) {
    const stream = video.srcObject;
    const tracks = stream.getTracks();
    tracks.forEach(t => t.stop());
    video.style.display = "none";
    cameraOn = false;
    return;
  }
  video.style.display = "block";
  cameraOn = true;
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  video.srcObject = stream;

  const barcodeDetector = new BarcodeDetector({ formats: ["code_128", "ean_13", "qr_code"] });
  const scan = async () => {
    if (!cameraOn) return;
    try {
      const barcodes = await barcodeDetector.detect(video);
      if (barcodes.length > 0) {
        document.getElementById("productSearch").value = barcodes[0].rawValue;
        toggleCamera();
        document.getElementById("productSearch").dispatchEvent(new Event("input"));
      }
    } catch {}
    requestAnimationFrame(scan);
  };
  scan();
}
</script>
</body>
</html>