<!DOCTYPE html><html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sales Invoice</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.container { max-width: 900px; margin: auto; }
label { display: block; margin-top: 10px; }
input, textarea, select, button { width: 100%; padding: 8px; margin-top: 5px; }
#itemsTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
#itemsTable th, #itemsTable td { border: 1px solid #ccc; padding: 8px; text-align: center; }
button { cursor: pointer; margin-top: 10px; }
.hidden { display: none; }
</style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
<div class="container">
<h2>Sales Invoice</h2>
<div id="loginCheck"></div>
<div id="invoiceForm" class="hidden">
  <label>Customer Mobile</label>
  <input type="text" id="customerMobile" placeholder="Search customer by mobile" />
  <button onclick="fetchCustomer()">Fetch Customer</button><label>Customer Name</label> <input type="text" id="customerName" />

<label>Address</label>

  <textarea id="customerAddress"></textarea><label>GST</label> <input type="text" id="customerGST" placeholder="Nil" />

<label>Date</label> <input type="date" id="invoiceDate" />

  <hr>
  <h3>Products</h3>
  <div id="reader" style="width:300px;"></div>
  <button onclick="startScan()">Start Camera</button>
  <button onclick="stopScan()">Stop Camera</button><label>Product ID</label> <input type="text" id="productID" placeholder="Scan or enter product ID" /> <button onclick="fetchProduct()">Fetch Product</button>

<label>Item Name</label> <input type="text" id="itemName" />

<label>Batch No</label> <select id="batchNo"></select>

<label>Quantity</label> <input type="number" id="quantity" />

<label>Price</label> <input type="number" id="price" />

<button onclick="addItem()">Add Item</button>

  <table id="itemsTable">
    <thead>
      <tr>
        <th>Product ID</th><th>Item Name</th><th>Batch</th><th>Qty</th><th>Price</th><th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3 id="totalValue">Total: 0</h3>
  <button onclick="saveInvoice()">Save Invoice</button>
</div>
</div>
<script>
const API_KEY = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sh';
const BASE_URL = location.protocol.startsWith('http') ? 'https://api.baserow.io/api' : 'https://corsproxy.io/?https://api.baserow.io/api';const tables = { users: 729979, customers: 736204, products: 734793, inventory: 734795, ledger: 736207, sales: 736209 };

let html5QrCode; let total = 0; let invoiceNumber = 'INV' + Date.now();

window.onload = async () => { const mobileTag = localStorage.getItem('MobileTag'); if (!mobileTag) { alert('Please login first.'); window.location.href = 'login.html'; return; } document.getElementById('invoiceForm').classList.remove('hidden'); document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0]; const ok = await validateUser(mobileTag); if (!ok) { alert('Access denied'); window.location.href = 'login.html'; } };

async function validateUser(mobile) { try { const res = await fetch(${BASE_URL}/database/rows/table/${tables.users}/?user_field_names=true, { headers: { 'Authorization': Token ${API_KEY} } }); if (!res.ok) throw new Error(res.status); const data = await res.json(); return data.results.some(r => r.Username == mobile); } catch (e) { alert('Error validating user: ' + e); return false; } }

async function fetchCustomer() { const mobile = document.getElementById('customerMobile').value.trim(); if (!mobile) return alert('Enter mobile number'); try { const res = await fetch(${BASE_URL}/database/rows/table/${tables.customers}/?user_field_names=true, { headers: { 'Authorization': Token ${API_KEY} } }); const data = await res.json(); const c = data.results.find(r => r.Mobile == mobile); if (c) { document.getElementById('customerName').value = c['Costomer Name'] || ''; document.getElementById('customerAddress').value = c.Address || ''; document.getElementById('customerGST').value = c.GST || 'Nil'; } else alert('Customer not found'); } catch (e) { alert('Error fetching customer'); } }

async function fetchProduct() { const pid = document.getElementById('productID').value.trim(); if (!pid) return alert('Enter product ID'); try { const res = await fetch(${BASE_URL}/database/rows/table/${tables.products}/?user_field_names=true, { headers: { 'Authorization': Token ${API_KEY} } }); const data = await res.json(); const p = data.results.find(r => r['Product ID'] == pid || r.id == pid); if (p) { document.getElementById('itemName').value = p['Item Name'] || ''; document.getElementById('price').value = p.Price || 0; await fetchBatch(pid); } else alert('Product not found'); } catch (e) { alert('Error fetching product'); } }

async function fetchBatch(pid) { const res = await fetch(${BASE_URL}/database/rows/table/${tables.inventory}/?user_field_names=true, { headers: { 'Authorization': Token ${API_KEY} } }); const data = await res.json(); const batches = data.results.filter(r => r['Product ID'] == pid); const batchSelect = document.getElementById('batchNo'); batchSelect.innerHTML = ''; batches.forEach(b => { const opt = document.createElement('option'); opt.value = b['Batch No']; opt.textContent = Batch ${b['Batch No']} (Count ${b.Count}); batchSelect.appendChild(opt); }); }

function addItem() { const pid = productID.value.trim(); const name = itemName.value.trim(); const batch = batchNo.value; const qty = parseFloat(quantity.value); const price = parseFloat(document.getElementById('price').value); if (!pid || !qty || !price) return alert('Fill all product details'); const row = document.createElement('tr'); const totalRow = qty * price; total += totalRow; row.innerHTML = <td>${pid}</td><td>${name}</td><td>${batch}</td><td>${qty}</td><td>${price}</td><td>${totalRow}</td>; document.querySelector('#itemsTable tbody').appendChild(row); document.getElementById('totalValue').innerText = Total: ${total}; }

async function saveInvoice() { const cName = customerName.value; const mobile = customerMobile.value; const date = invoiceDate.value; const shopID = localStorage.getItem('ShopIDTag'); const salesperson = localStorage.getItem('NameTag');

const rows = Array.from(document.querySelectorAll('#itemsTable tbody tr')).map(tr => { const tds = tr.querySelectorAll('td'); return { 'Costomer Name': cName, 'Mobile': mobile, 'Address': customerAddress.value, 'GST': customerGST.value || 'Nil', 'Date': date, 'Product ID': tds[0].innerText, 'Item Name': tds[1].innerText, 'Batch No': parseInt(tds[2].innerText), 'Quantity': parseInt(tds[3].innerText), 'Price': parseFloat(tds[4].innerText), 'Invoice Number': invoiceNumber, 'Tag': 'Order Confirmed', 'ShopID': shopID, 'Sales Person': salesperson }; });

for (const row of rows) { await fetch(${BASE_URL}/database/rows/table/${tables.sales}/?user_field_names=true, { method: 'POST', headers: { 'Authorization': Token ${API_KEY}, 'Content-Type': 'application/json' }, body: JSON.stringify(row) }); }

const ledgerRow = { 'Costomer Name': cName, 'Mobile': mobile, 'Date': date, 'Invoice Number': invoiceNumber, 'Total Invoice Value': total, 'ShopID': shopID }; await fetch(${BASE_URL}/database/rows/table/${tables.ledger}/?user_field_names=true, { method: 'POST', headers: { 'Authorization': Token ${API_KEY}, 'Content-Type': 'application/json' }, body: JSON.stringify(ledgerRow) });

alert('Invoice saved successfully'); }

function startScan() { if (html5QrCode) return; html5QrCode = new Html5Qrcode("reader"); Html5Qrcode.getCameras().then(devices => { if (devices && devices.length) { const rear = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0]; html5QrCode.start({ deviceId: { exact: rear.id } }, { fps: 10, qrbox: 250 }, onScanSuccess); } }); }

function onScanSuccess(decodedText) { document.getElementById('productID').value = decodedText; stopScan(); fetchProduct(); }

function stopScan() { if (html5QrCode) { html5QrCode.stop(); html5QrCode.clear(); html5QrCode = null; } } </script>

</body>
</html>