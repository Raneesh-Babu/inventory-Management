<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Invoice — Single Page (Baserow)</title>
  <style>
    :root{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    body{margin:0;padding:18px;background:#f6f8fa;color:#111}
    .container{max-width:1100px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(11,15,30,0.06)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{font-size:20px;margin:0}
    .flex{display:flex;gap:12px;align-items:center}
    .row{display:flex;gap:12px;margin-top:12px}
    input,select,button,textarea{padding:8px;border-radius:6px;border:1px solid #d6dbe0;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .actions{display:flex;gap:8px}
    .btn{cursor:pointer;background:#0b69ff;color:#fff;border:none;padding:8px 10px;border-radius:6px}
    .btn.ghost{background:#fff;border:1px solid #cbd5e1;color:#111}
    .small{font-size:13px;padding:6px 8px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
    .modal .card{background:#fff;padding:18px;border-radius:8px;min-width:320px}
    #scanner{width:320px;height:240px;background:#000}
    .invoice{margin-top:18px;padding:12px;border:1px dashed #cbd5e1;border-radius:8px;background:#fcfeff}
    .print-hide{display:inline-block}
    @media print{.print-hide{display:none} body{background:#fff}}
  </style>
  <!-- html5-qrcode CDN -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sales Invoice — Single Page</h1>
      <div class="flex">
        <div id="status">Checking session...</div>
        <button id="logout" class="btn ghost small">Logout</button>
      </div>
    </header><!-- Customer / Product Controls -->
<div class="row">
  <div style="flex:1">
    <label>Customer Mobile (from localStorage MobileTag)</label><br>
    <input id="mobileTagInput" placeholder="Detected from localStorage" />
  </div>
  <div style="width:220px">
    <label>Search Customer by Mobile</label><br>
    <div class="flex">
      <input id="customerSearch" placeholder="Enter mobile to search" style="flex:1" />
      <button id="btnSearchCustomer" class="btn small">Search</button>
    </div>
  </div>
  <div style="width:160px">
    <label>Date</label><br>
    <input id="dateField" readonly />
  </div>
</div>

<div class="row" style="margin-top:8px;align-items:flex-start">
  <div style="flex:1">
    <label>Customer Name</label><br>
    <input id="custName" />
    <label style="display:block;margin-top:6px">Address</label>
    <textarea id="custAddress" rows="2"></textarea>
    <label style="display:block;margin-top:6px">GST (optional)</label>
    <input id="custGst" />
  </div>

  <div style="width:380px">
    <label>Product ID (scan or enter)</label>
    <div class="flex" style="margin-top:6px">
      <input id="productId" placeholder="Scan QR or enter Product ID manually" />
      <button id="startScan" class="btn small">Camera On</button>
      <button id="stopScan" class="btn small ghost">Camera Off</button>
    </div>

    <div id="scannerHolder" style="margin-top:8px"></div>

    <label style="display:block;margin-top:8px">Product Name</label>
    <input id="productName" readonly />
    <label style="display:block;margin-top:6px">Price</label>
    <input id="productPrice" readonly />

    <div style="margin-top:8px" class="flex">
      <button id="btnOpenBatches" class="btn small">Choose Batch</button>
      <button id="btnAddItem" class="btn small">Add to Invoice</button>
    </div>

  </div>
</div>

<table id="invoiceTable">
  <thead>
    <tr><th>Product ID</th><th>Item</th><th>Batch No</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr>
  </thead>
  <tbody></tbody>
</table>

<div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
  <div>
    <label>Tag</label>
    <select id="tagField"><option>Order Confirmed</option><option>Return</option><option>Warranty</option></select>
  </div>
  <div style="text-align:right">
    <div>Total: <strong id="grandTotal">0.00</strong></div>
    <div style="margin-top:8px">
      <button id="btnSave" class="btn">Save Invoice</button>
      <button id="btnPrint" class="btn ghost">Print</button>
    </div>
  </div>
</div>

<div class="invoice" id="invoicePreview" style="display:none"></div>

  </div>  <!-- Modal: Batch selection -->  <div id="modalBatch" class="modal">
    <div class="card">
      <h3>Select Batch</h3>
      <div id="batchList"></div>
      <div style="margin-top:12px;text-align:right">
        <button id="closeBatch" class="btn ghost">Close</button>
      </div>
    </div>
  </div>  <script>
  /* ----------------------------- Configuration ---------------------------- */
  const BASEROW_API_KEY = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw';
  const BASEROW_BASE = 'https://api.baserow.io/api/database/rows/table';

  const TABLE_USERS = 729979;      // Users table (check Username)
  const TABLE_CUSTOMER = 736204;   // Customer table (736204) - user said earlier 7362024 but recent list has 736204; using 736204 from user message
  const TABLE_PRODUCT = 734793;    // Product table
  const TABLE_INVENTORY = 734795;  // Inventory table (batches and counts)
  const TABLE_SALES = 736209;      // Sales table to save each product row
  const TABLE_LEDGER = 736207;     // Ledger table for invoice summary

  // NOTE: If your real customer table ID is different (you mentioned 7362024 earlier), update TABLE_CUSTOMER constant.

  /* ----------------------------- Helpers ---------------------------- */
  function apiUrl(tableId){
    return `${BASEROW_BASE}/${tableId}/?user_field_names=true`;
  }

  function headers(){
    return { 'Content-Type':'application/json', 'Authorization': `Token ${BASEROW_API_KEY}` };
  }

  async function fetchAllRows(tableId){
    // Simple approach: fetch all rows (paginated). We'll fetch multiple pages until done.
    const pageSize = 100;
    let all = [];
    let page = 1;
    while(true){
      const url = `${BASEROW_BASE}/${tableId}/?user_field_names=true&page=${page}&page_size=${pageSize}`;
      const res = await fetch(url, { headers: headers() });
      if(!res.ok) throw new Error('Failed to fetch rows: ' + res.status);
      const data = await res.json();
      if(Array.isArray(data.results)){
        all = all.concat(data.results);
        if(!data.next) break;
        page++;
      } else {
        // older API may return array directly
        all = all.concat(data);
        break;
      }
    }
    return all;
  }

  async function postRow(tableId, payload){
    const url = `${BASEROW_BASE}/${tableId}/?user_field_names=true`;
    const res = await fetch(url, { method:'POST', headers: headers(), body: JSON.stringify(payload) });
    if(!res.ok){
      const txt = await res.text();
      throw new Error('Upload failed: ' + res.status + ' ' + txt);
    }
    return res.json();
  }

  /* ----------------------------- Session & Init ---------------------------- */
  const statusEl = document.getElementById('status');
  const mobileTagInput = document.getElementById('mobileTagInput');
  const dateField = document.getElementById('dateField');
  const logoutBtn = document.getElementById('logout');

  function formatDateISO(d=new Date()){
    const pad=(n)=>n.toString().padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function formatDateHuman(d=new Date()){
    return d.toLocaleString();
  }

  // invoice state
  const invoiceItems = [];
  let selectedBatch = null; // {batch_no, count}

  function updateGrandTotal(){
    const gt = invoiceItems.reduce((s,i)=>s + (i.qty * i.price),0);
    document.getElementById('grandTotal').innerText = gt.toFixed(2);
  }

  function renderInvoiceTable(){
    const tbody = document.querySelector('#invoiceTable tbody');
    tbody.innerHTML = '';
    invoiceItems.forEach((it, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.product_id}</td><td>${it.name}</td><td>${it.batch_no || ''}</td><td>${it.qty}</td><td>${it.price}</td><td>${(it.qty*it.price).toFixed(2)}</td><td><button data-i="${idx}" class="btn ghost small">Remove</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button').forEach(b=>b.addEventListener('click', (e)=>{
      const i = +e.currentTarget.dataset.i;
      invoiceItems.splice(i,1);
      renderInvoiceTable(); updateGrandTotal();
    }));
  }

  async function init(){
    // Setup date
    dateField.value = formatDateISO();

    // get mobile tag from localStorage
    const mobileTag = localStorage.getItem('MobileTag') || localStorage.getItem('mobileTag') || localStorage.getItem('Mobile') || '';
    mobileTagInput.value = mobileTag || '';

    // get shopid and salesperson
    const shopIdTag = localStorage.getItem('ShopIDTag') || '';
    const nameTag = localStorage.getItem('NameTag') || '';
    // show in status
    statusEl.innerText = `Shop: ${shopIdTag || '-'} | Sales: ${nameTag || '-'}`;

    // validation: check mobileTag in users table
    if(!mobileTag){
      statusEl.innerText = 'No MobileTag found — redirecting to login...';
      setTimeout(()=>{ window.location.href = '/login.html'; },1200);
      return;
    }

    try{
      statusEl.innerText = 'Validating user...';
      const users = await fetchAllRows(TABLE_USERS);
      const found = users.find(u=> (u.Username && (u.Username+"") === mobileTag) || (u.username && (u.username+"")===mobileTag) );
      if(!found){
        statusEl.innerText = 'MobileTag not found in Users — redirecting to login...';
        setTimeout(()=>{ window.location.href = '/login.html'; },1200);
        return;
      }
      statusEl.innerText = `User validated (${mobileTag})`;
    }catch(err){
      console.error(err); statusEl.innerText = 'Error validating user: ' + err.message;
    }
  }

  init();

  logoutBtn.addEventListener('click', ()=>{
    localStorage.removeItem('MobileTag');
    localStorage.removeItem('NameTag');
    localStorage.removeItem('ShopIDTag');
    window.location.href = '/login.html';
  });

  /* ----------------------------- Customer Search & Fill ---------------------------- */
  document.getElementById('btnSearchCustomer').addEventListener('click', async ()=>{
    const q = document.getElementById('customerSearch').value.trim();
    if(!q){ alert('Enter mobile to search'); return; }
    try{
      const rows = await fetchAllRows(TABLE_CUSTOMER);
      // Search by Mobile or Customer Name
      const found = rows.find(r => (r.Mobile && String(r.Mobile) === q) || (r['Mobile'] && String(r['Mobile'])===q) || (r['Costomer Name'] && r['Costomer Name']===q));
      if(!found){ alert('Customer not found — you can add new customer by entering details'); return; }
      document.getElementById('custName').value = found['Costomer Name'] || found['Customer Name'] || '';
      document.getElementById('custAddress').value = found.Address || found['Address'] || '';
      document.getElementById('custGst').value = (found.GST || found['GST'] || '') || '';
    }catch(err){ alert('Error searching customer: '+err.message); }
  });

  /* ----------------------------- Product fetch & batches ---------------------------- */
  async function fetchProductById(pid){
    if(!pid) return null;
    try{
      const all = await fetchAllRows(TABLE_PRODUCT);
      const found = all.find(r => (r['Product ID'] && String(r['Product ID']) === String(pid)) || (r.id && String(r.id)===String(pid)) || (r.product_id && String(r.product_id)===String(pid)));
      return found || null;
    }catch(err){ console.error(err); return null; }
  }

  async function fetchBatchesForProduct(pid){
    if(!pid) return [];
    try{
      const all = await fetchAllRows(TABLE_INVENTORY);
      // inventory rows should have Product ID, Batch No and Count
      return all.filter(r=> (r['Product ID'] && String(r['Product ID'])===String(pid)) || (r.product_id && String(r.product_id)===String(pid)));
    }catch(err){ console.error(err); return []; }
  }

  document.getElementById('productId').addEventListener('change', async (e)=>{
    const pid = e.currentTarget.value.trim();
    if(!pid) return;
    const p = await fetchProductById(pid);
    if(!p){ alert('Product not found'); document.getElementById('productName').value=''; document.getElementById('productPrice').value=''; return; }
    document.getElementById('productName').value = p['Item Name'] || p['Item'] || p['Name'] || p.item_name || p.name || '';
    document.getElementById('productPrice').value = p['Price'] || p.price || 0;
  });

  document.getElementById('btnOpenBatches').addEventListener('click', async ()=>{
    const pid = document.getElementById('productId').value.trim();
    if(!pid){ alert('Enter Product ID first'); return; }
    const batches = await fetchBatchesForProduct(pid);
    const container = document.getElementById('batchList'); container.innerHTML = '';
    if(batches.length===0){ container.innerHTML = '<div>No batches found for this product in inventory.</div>'; }
    batches.forEach(b=>{
      const div = document.createElement('div');
      const batchNo = b['Batch No'] || b.batch_no || b['BatchNo'] || b.batch || 'N/A';
      const count = b['Count'] || b.count || b['Quantity'] || 0;
      div.innerHTML = `<div style="padding:8px;border-bottom:1px solid #eee"><strong>Batch:</strong> ${batchNo} &nbsp; <strong>Count:</strong> ${count} <div style="margin-top:6px"><input placeholder="Qty to pick" type="number" min="1" id="qty_${batchNo}" style="width:100px;padding:6px;border-radius:6px;border:1px solid #ddd" /> <button data-batch='${batchNo}' data-count='${count}' class="btn small chooseBatch">Select</button></div></div>`;
      container.appendChild(div);
    });
    document.getElementById('modalBatch').style.display = 'flex';
    container.querySelectorAll('.chooseBatch').forEach(btn=>{
      btn.addEventListener('click',(ev)=>{
        const batch_no = ev.currentTarget.dataset.batch;
        const count = +ev.currentTarget.dataset.count;
        const qtyInput = document.getElementById('qty_'+batch_no);
        const qty = qtyInput ? (+qtyInput.value || 1) : 1;
        if(qty > count){ alert('Quantity exceeds available count'); return; }
        selectedBatch = { batch_no, count };
        alert(`Selected batch ${batch_no} (available ${count}). Qty chosen: ${qty}`);
        // store chosen qty temporarily on selectedBatch
        selectedBatch.chosenQty = qty;
        document.getElementById('modalBatch').style.display='none';
      });
    });
  });
  document.getElementById('closeBatch').addEventListener('click', ()=>{ document.getElementById('modalBatch').style.display='none'; });

  document.getElementById('btnAddItem').addEventListener('click', ()=>{
    const pid = document.getElementById('productId').value.trim();
    if(!pid){ alert('Product ID required'); return; }
    const name = document.getElementById('productName').value || 'Unknown';
    const price = parseFloat(document.getElementById('productPrice').value) || 0;
    const qty = (selectedBatch && selectedBatch.chosenQty) ? selectedBatch.chosenQty : 1;
    if(selectedBatch && qty > selectedBatch.count){ alert('Qty exceeds available'); return; }
    invoiceItems.push({ product_id: pid, name, batch_no: selectedBatch?selectedBatch.batch_no:'', qty, price });
    // reset selection
    selectedBatch = null;
    renderInvoiceTable(); updateGrandTotal();
  });

  /* ----------------------------- Save Invoice ---------------------------- */
  document.getElementById('btnSave').addEventListener('click', async ()=>{
    if(invoiceItems.length===0){ alert('Add items to invoice first'); return; }
    // prepare invoice summary
    const invoiceNumber = generateInvoiceNumber();
    const custName = document.getElementById('custName').value || '';
    const custMobile = document.getElementById('customerSearch').value || mobileTagInput.value || '';
    const shopIdTag = localStorage.getItem('ShopIDTag') || '';
    const salesPerson = localStorage.getItem('NameTag') || '';
    const date = dateField.value;
    const totalValue = invoiceItems.reduce((s,i)=>s + (i.qty * i.price),0);
    const tag = document.getElementById('tagField').value;

    try{
      // 1) Save each product row to Sales table
      for(const it of invoiceItems){
        const payload = {
          'Costomer Name': custName,
          'Mobile': custMobile,
          'Date': date,
          'Invoice Number': invoiceNumber,
          'Product ID': it.product_id,
          'Item Name': it.name,
          'Batch No': it.batch_no,
          'Quantity': it.qty,
          'Price': it.price,
          'Total': (it.qty * it.price),
          'Tag': tag,
          'ShopID': shopIdTag,
          'Sales Person': salesPerson
        };
        await postRow(TABLE_SALES, payload);
      }

      // 2) Save summary to Ledger
      const ledgerPayload = {
        'Costomer Name': custName,
        'Mobile': custMobile,
        'Date': date,
        'Invoice Number': invoiceNumber,
        'Total Invoice Value': totalValue,
        'ShopID': shopIdTag
      };
      await postRow(TABLE_LEDGER, ledgerPayload);

      alert('Invoice saved successfully');
      showInvoicePreview({invoiceNumber,custName,custMobile,date,totalValue,items:invoiceItems,shopIdTag,salesPerson,tag});
      // Optionally clear invoice items for new invoice
      invoiceItems.length = 0; renderInvoiceTable(); updateGrandTotal();
    }catch(err){ alert('Save failed: '+err.message); console.error(err); }
  });

  function generateInvoiceNumber(){
    const d = new Date();
    const pad=(n)=>n.toString().padStart(2,'0');
    return `INV-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  }

  function showInvoicePreview(data){
    const div = document.getElementById('invoicePreview');
    div.style.display='block';
    let html = `<h3>Invoice ${data.invoiceNumber}</h3>`;
    html += `<div><strong>Date:</strong> ${data.date} &nbsp; <strong>Shop:</strong> ${data.shopIdTag} &nbsp; <strong>Sales:</strong> ${data.salesPerson}</div>`;
    html += `<div style="margin-top:8px"><strong>Customer:</strong> ${data.custName} &nbsp; <strong>Mobile:</strong> ${data.custMobile}</div>`;
    html += `<table style="margin-top:8px;width:100%"><thead><tr><th>Item</th><th>Batch</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>`;
    data.items.forEach(it=>{
      html += `<tr><td>${it.name}</td><td>${it.batch_no}</td><td>${it.qty}</td><td>${it.price}</td><td>${(it.qty*it.price).toFixed(2)}</td></tr>`;
    });
    html += `</tbody></table>`;
    html += `<div style="text-align:right;margin-top:8px"><strong>Grand Total: ${data.totalValue.toFixed(2)}</strong></div>`;
    div.innerHTML = html + '<div style="margin-top:8px"><button onclick="window.print()" class="btn">Print</button></div>';
  }

  document.getElementById('btnPrint').addEventListener('click', ()=>{ window.print(); });

  /* ----------------------------- QR Scanner ---------------------------- */
  let html5QrCode = null;
  let cameraId = null;
  const scannerHolder = document.getElementById('scannerHolder');
  document.getElementById('startScan').addEventListener('click', async ()=>{
    if(html5QrCode) return;
    try{
      const devices = await Html5Qrcode.getCameras();
      // pick back camera if possible (favors device with 'back' label)
      const back = devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[0];
      cameraId = back ? back.id : (devices[0] && devices[0].id);
      html5QrCode = new Html5Qrcode("scannerHolder");
      await html5QrCode.start(cameraId, { fps: 10, qrbox: { width: 300, height: 200 } }, (decodedText, decodedResult) => {
        // success callback
        document.getElementById('productId').value = decodedText;
        // trigger change to fetch product
        const ev = new Event('change'); document.getElementById('productId').dispatchEvent(ev);
        // optionally stop scanning right after detection
        stopScanner();
      });
    }catch(err){ alert('Unable to start camera: ' + err); }
  });

  async function stopScanner(){
    if(html5QrCode){
      try{ await html5QrCode.stop(); }catch(e){}
      html5QrCode.clear(); html5QrCode = null; scannerHolder.innerHTML = '';
    }
  }
  document.getElementById('stopScan').addEventListener('click', stopScanner);

  /* ----------------------------- Utility: quick product search on Enter ---------------------------- */
  document.getElementById('productId').addEventListener('keydown', async (e)=>{
    if(e.key === 'Enter'){
      const pid = e.currentTarget.value.trim();
      if(pid){
        const p = await fetchProductById(pid);
        if(p){ document.getElementById('productName').value = p['Item Name'] || p['Name'] || '';
                   document.getElementById('productPrice').value = p['Price'] || p.price || 0; }
        else alert('Product not found');
      }
    }
  });

  /* ----------------------------- Notes ---------------------------- */
  // IMPORTANT:
  // - This implementation fetches all rows from tables and filters client-side. For large tables, replace fetchAllRows with server-side filtering using Baserow filter/query parameters.
  // - Make sure the field names used in payloads (like 'Costomer Name', 'Mobile', 'Invoice Number') match your Baserow column names exactly.
  // - Browser must be served over HTTPS for camera access (or localhost).
  // - If you prefer the app to auto-redirect after save or to clear certain values, adjust accordingly.

  </script></body>
</html>