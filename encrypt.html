<!DOCTYPE html>
<html>
<head>
<title>Secure Fingerprint + Encrypted LocalStorage</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f4f6fa; }
button {
  padding:12px 20px; border:none; border-radius:8px;
  background:#007bff; color:white; font-size:16px;
  margin:10px 0; cursor:pointer;
}
button:hover { background:#0056b3; }
pre { background:#fff; padding:15px; border-radius:10px; }
</style>
</head>

<body>

<h2>üîê Secure Fingerprint + Encrypted LocalStorage</h2>

<button onclick="createFingerprintKey()">1. Create Fingerprint Key</button>
<button onclick="saveEncryptedData()">2. Save Encrypted Data</button>
<button onclick="unlockAndDecrypt()">3. Unlock With Fingerprint</button>

<h3>Local Storage (Encrypted):</h3>
<pre id="localData">(nothing stored yet)</pre>

<h3>Decrypted Output:</h3>
<pre id="decryptedData">(nothing decrypted yet)</pre>

<h3>Status:</h3>
<pre id="status">Ready</pre>

<script>
/* ----------------------------------------------------------
   STEP 1 ‚Äî CREATE FINGERPRINT KEY (WebAuthn)
-----------------------------------------------------------*/
async function createFingerprintKey() {

    if (!window.PublicKeyCredential) {
        return show("‚ùå WebAuthn not supported");
    }

    const challenge = new Uint8Array(32);
    crypto.getRandomValues(challenge);

    const userID = new Uint8Array(16);
    crypto.getRandomValues(userID);

    const publicKey = {
        challenge,
        rp: { name: "Secure App" },
        user: { id: userID, name: "user@app.com", displayName: "User" },
        pubKeyCredParams: [{ type: "public-key", alg: -7 }],
        authenticatorSelection: {
            authenticatorAttachment: "platform",
            userVerification: "required"
        },
        timeout: 60000
    };

    try {
        const credential = await navigator.credentials.create({ publicKey });

        const rawId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));

        localStorage.setItem("fingerprintKeyID", rawId);

        show("‚úÖ Fingerprint key created!\nKey ID saved.");

    } catch (err) {
        show("‚ùå Error: " + err);
    }
}

/* ----------------------------------------------------------
   STEP 2 ‚Äî BIOMETRIC VERIFICATION
-----------------------------------------------------------*/
async function verifyFingerprint() {

    const id = localStorage.getItem("fingerprintKeyID");
    if (!id) {
        alert("Fingerprint key not created yet");
        return false;
    }

    const credentialID = Uint8Array.from(atob(id), c => c.charCodeAt(0));

    const challenge = new Uint8Array(32);
    crypto.getRandomValues(challenge);

    try {
        const assertion = await navigator.credentials.get({
            publicKey: {
                challenge,
                allowCredentials: [{
                    type: "public-key",
                    id: credentialID
                }],
                userVerification: "required"
            }
        });

        show("‚úÖ Fingerprint verified!");
        return true;

    } catch (err) {
        show("‚ùå Fingerprint failed: " + err);
        return false;
    }
}

/* ----------------------------------------------------------
   STEP 3 ‚Äî SECURE ENCRYPTION / DECRYPTION
-----------------------------------------------------------*/
function deriveKey(pin) {
    return CryptoJS.PBKDF2(pin, "fixedSalt", {
        keySize: 256/32,
        iterations: 5000
    });
}

function encryptData(pin, data) {
    const key = deriveKey(pin);
    const iv = CryptoJS.lib.WordArray.random(16);
    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), key, { iv });

    return JSON.stringify({
        cipher: encrypted.toString(),
        iv: iv.toString()
    });
}

function decryptData(pin, encryptedString) {
    const obj = JSON.parse(encryptedString);
    const iv = CryptoJS.enc.Hex.parse(obj.iv);
    const key = deriveKey(pin);
    const decrypted = CryptoJS.AES.decrypt(obj.cipher, key, { iv });
    return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
}

/* ----------------------------------------------------------
   STEP 4 ‚Äî SAVE ENCRYPTED DATA
-----------------------------------------------------------*/
function saveEncryptedData() {

    const data = {
        name: "Raneesh",
        score: 200,
        time: new Date().toLocaleString()
    };

    const encrypted = encryptData("PIN12345", data);
    localStorage.setItem("secureData", encrypted);

    document.getElementById("localData").textContent = encrypted;

    show("üîê Encrypted data stored.");
}

/* ----------------------------------------------------------
   STEP 5 ‚Äî UNLOCK + DECRYPT DATA
-----------------------------------------------------------*/
async function unlockAndDecrypt() {

    const ok = await verifyFingerprint();
    if (!ok) return;

    const encrypted = localStorage.getItem("secureData");
    if (!encrypted) {
        show("No encrypted data stored.");
        return;
    }

    const decrypted = decryptData("PIN12345", encrypted);

    document.getElementById("decryptedData").textContent =
        JSON.stringify(decrypted, null, 2);

    show("üîì Data decrypted successfully!");
}

/* ----------------------------------------------------------*/
function show(msg) {
    document.getElementById("status").textContent = msg;
}
</script>

</body>
</html>