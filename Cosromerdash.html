<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Ledger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        h1 i {
            font-size: 2.2rem;
        }

        .search-container {
            margin-bottom: 25px;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: none;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--box-shadow);
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-box:focus {
            outline: none;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.2rem;
        }

        .summary-cards {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 30px;
            gap: 20px;
        }

        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            text-align: center;
            flex: 1;
            min-width: 200px;
            transition: var(--transition);
            border-top: 4px solid var(--primary);
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .summary-card h2 {
            font-size: 2.2rem;
            color: var(--primary);
            margin: 0;
            font-weight: 700;
        }

        .summary-card p {
            font-size: 1rem;
            color: var(--gray);
            margin-top: 10px;
            font-weight: 500;
        }

        .summary-card i {
            font-size: 2.5rem;
            color: var(--primary-light);
            margin-bottom: 15px;
        }

        .ledger-container {
            background: #fff;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .customer {
            border-bottom: 1px solid var(--gray-light);
            padding: 20px;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .customer:hover {
            background: #f8f9ff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-name {
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .customer-name i {
            color: var(--primary);
        }

        .rank {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #fff;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .NewFace { background: var(--warning); }
        .Acquainted { background: var(--info); }
        .Trusted { background: var(--success); }

        .customer-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .invoice-details {
            display: none;
            padding: 15px 0;
            color: #444;
        }

        .invoice-details.active {
            display: block;
        }

        .invoice {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px dashed #ddd;
            transition: var(--transition);
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .invoice:hover {
            background: var(--gray-light);
        }

        .invoice span:first-child {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary {
            margin-top: 15px;
            text-align: right;
            font-weight: bold;
            color: var(--dark);
            font-size: 1.1rem;
            padding-top: 10px;
            border-top: 1px solid var(--gray-light);
        }

        .progress-container {
            margin-top: 15px;
            background: #eee;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 10px;
            border-radius: 10px;
            transition: width 0.5s;
        }

        .progress-orange { background: var(--warning); }
        .progress-blue { background: var(--info); }
        .progress-green { background: var(--success); }

        .contact-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .contact-buttons button {
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .contact-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .whatsapp-btn { background: #25d366; }
        .call-btn { background: var(--success); }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: auto;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 95%;
            height: 95%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFade 0.3s;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalFade {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 25px;
            background: var(--primary);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
        }

        .invoice-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .summary-cards {
                flex-direction: column;
            }
            
            .customer-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .modal-content {
                width: 98%;
                height: 98%;
                margin: 1% auto;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-book"></i> Customer Ledger</h1>

    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" class="search-box" placeholder="Search by customer name or mobile number...">
    </div>

    <div class="summary-cards">
        <div class="summary-card">
            <i class="fas fa-users"></i>
            <h2 id="totalCustomers">0</h2>
            <p>Total Customers</p>
        </div>
        <div class="summary-card">
            <i class="fas fa-file-invoice"></i>
            <h2 id="totalInvoices">0</h2>
            <p>Total Invoices</p>
        </div>
        <div class="summary-card">
            <i class="fas fa-chart-line"></i>
            <h2 id="totalSales">₹0</h2>
            <p>Total Sales</p>
        </div>
    </div>

    <div class="ledger-container" id="ledgerContainer">Loading data...</div>
</div>

<!-- Invoice Modal -->
<div id="invoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-file-invoice"></i> Invoice Details</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <iframe id="invoiceIframe" class="invoice-iframe" src=""></iframe>
        </div>
    </div>
</div>

<script>
// Sample data for demonstration
const sampleData = {
    "results": [
        {
            "Costomer Name": "Rajesh Kumar",
            "Mobile": "9876543210",
            "Invoice Number": "INV-001",
            "Total Invoice Value": "12500.00",
            "Date": "2023-05-15",
            "Status": "Paid",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Priya Sharma",
            "Mobile": "8765432109",
            "Invoice Number": "INV-002",
            "Total Invoice Value": "8500.00",
            "Date": "2023-05-18",
            "Status": "Pending",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Amit Patel",
            "Mobile": "7654321098",
            "Invoice Number": "INV-003",
            "Total Invoice Value": "21000.00",
            "Date": "2023-05-20",
            "Status": "Paid",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Sneha Gupta",
            "Mobile": "6543210987",
            "Invoice Number": "INV-004",
            "Total Invoice Value": "7500.00",
            "Date": "2023-05-22",
            "Status": "Paid",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Vikram Singh",
            "Mobile": "5432109876",
            "Invoice Number": "INV-005",
            "Total Invoice Value": "15000.00",
            "Date": "2023-05-25",
            "Status": "Pending",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Rajesh Kumar",
            "Mobile": "9876543210",
            "Invoice Number": "INV-006",
            "Total Invoice Value": "9200.00",
            "Date": "2023-06-01",
            "Status": "Paid",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Neha Reddy",
            "Mobile": "4321098765",
            "Invoice Number": "INV-007",
            "Total Invoice Value": "11200.00",
            "Date": "2023-06-05",
            "Status": "Paid",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Rahul Verma",
            "Mobile": "3210987654",
            "Invoice Number": "INV-008",
            "Total Invoice Value": "6800.00",
            "Date": "2023-06-08",
            "Status": "Pending",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Priya Sharma",
            "Mobile": "8765432109",
            "Invoice Number": "INV-009",
            "Total Invoice Value": "13400.00",
            "Date": "2023-06-12",
            "Status": "Paid",
            "ShopID": "SHOP001"
        },
        {
            "Costomer Name": "Anil Mehta",
            "Mobile": "2109876543",
            "Invoice Number": "INV-010",
            "Total Invoice Value": "18900.00",
            "Date": "2023-06-15",
            "Status": "Paid",
            "ShopID": "SHOP001"
        }
    ]
};

const tableId = 736207;
const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const apiUrl = `https://api.baserow.io/api/database/rows/table/${tableId}/?user_field_names=true`;
const shopIdTag = localStorage.getItem("ShopIDTag") || "SHOP001";

// Sample data for demonstration (will be replaced with API data)
let allRows = [];

async function loadLedger() {
    try {
        // In a real implementation, you would use the API
        // const response = await fetch(apiUrl, {
        //     headers: { Authorization: `Token ${apiKey}` }
        // });
        // const data = await response.json();
        
        // For demonstration, using sample data
        const data = sampleData;
        allRows = data.results;
        const rows = allRows.filter(r => r.ShopID === shopIdTag);

        const customers = {};

        rows.forEach(r => {
            if (!customers[r["Costomer Name"]]) {
                customers[r["Costomer Name"]] = { 
                    mobile: r["Mobile"], 
                    invoices: [],
                    totalValue: 0
                };
            }
            customers[r["Costomer Name"]].invoices.push({
                invoice: r["Invoice Number"],
                value: parseFloat(r["Total Invoice Value"] || 0),
                date: r["Date"] || "N/A",
                status: r["Status"] || "Unknown"
            });
            customers[r["Costomer Name"]].totalValue += parseFloat(r["Total Invoice Value"] || 0);
        });

        // Top summary data
        const totalInvoices = rows.length;
        const totalCustomers = Object.keys(customers).length;
        const totalSales = rows.reduce((sum, r) => sum + parseFloat(r["Total Invoice Value"] || 0), 0);

        document.getElementById("totalInvoices").innerText = totalInvoices;
        document.getElementById("totalCustomers").innerText = totalCustomers;
        document.getElementById("totalSales").innerText = `₹${totalSales.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

        // Render customers
        renderCustomers(customers);
        
        // Add search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filterCustomers(customers, searchTerm);
        });
        
    } catch (error) {
        console.error(error);
        document.getElementById("ledgerContainer").innerHTML = "<p>Error loading data.</p>";
    }
}

function renderCustomers(customers) {
    // Sort customers by total purchase
    const sortedCustomers = Object.entries(customers)
        .sort((a, b) => b[1].totalValue - a[1].totalValue);

    let html = "";
    sortedCustomers.forEach(([name, data]) => {
        const invoiceCount = data.invoices.length;
        const totalValue = data.totalValue;

        // Ranking logic
        let rankLabel = "NewFace";
        let rankText = "New Face";
        let progressPercent = 25;
        let progressColor = "progress-orange";

        if (invoiceCount > 10 || totalValue > 50000) {
            rankLabel = "Trusted";
            rankText = "Trusted";
            progressPercent = 100;
            progressColor = "progress-green";
        } else if (invoiceCount > 3) {
            rankLabel = "Acquainted";
            rankText = "Acquainted";
            progressPercent = 60;
            progressColor = "progress-blue";
        }

        const encodedName = name.replace(/'/g, "\\'");
        const detailId = `details-${name.replace(/\s/g, '_')}`;

        html += `
            <div class="customer" data-name="${name.toLowerCase()}" data-mobile="${data.mobile}">
                <div class="customer-header" onclick="toggleDetails('${encodedName}')">
                    <span class="customer-name"><i class="fas fa-user"></i> ${name}</span>
                    <span class="rank ${rankLabel}"><i class="fas fa-${rankLabel === 'Trusted' ? 'crown' : rankLabel === 'Acquainted' ? 'handshake' : 'user-plus'}"></i> ${rankText}</span>
                </div>
                <div class="customer-info">
                    <span><i class="fas fa-file-invoice"></i> ${invoiceCount} Invoices</span>
                    <span><i class="fas fa-indian-rupee-sign"></i> ${totalValue.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar ${progressColor}" style="width: ${progressPercent}%;"></div>
                </div>
                <div class="invoice-details" id="${detailId}">
                    <p><strong>Invoice Count:</strong> ${invoiceCount}</p>
                    <p><strong>Total Purchase:</strong> ₹${totalValue.toLocaleString('en-IN', {minimumFractionDigits: 2})}</p>
                    ${data.invoices.map(inv => `
                        <div class="invoice">
                            <span onclick="event.stopPropagation(); openInvoiceModal('${inv.invoice}')"><i class="fas fa-file-invoice-dollar"></i> Invoice: ${inv.invoice}</span>
                            <span>₹${inv.value.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                        </div>
                    `).join('')}
                    <div class="summary">Total: ₹${totalValue.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>
                    <div class="contact-buttons">
                        <button class="whatsapp-btn" onclick="event.stopPropagation(); openWhatsApp('${data.mobile}')"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                        <button class="call-btn" onclick="event.stopPropagation(); callCustomer('${data.mobile}')"><i class="fas fa-phone"></i> Call</button>
                    </div>
                </div>
            </div>
        `;
    });

    document.getElementById("ledgerContainer").innerHTML = html || "<p>No customers found for your shop.</p>";
}

function filterCustomers(customers, searchTerm) {
    const customerElements = document.querySelectorAll('.customer');
    
    customerElements.forEach(customer => {
        const name = customer.getAttribute('data-name');
        const mobile = customer.getAttribute('data-mobile');
        
        if (name.includes(searchTerm) || mobile.includes(searchTerm)) {
            customer.style.display = 'block';
        } else {
            customer.style.display = 'none';
        }
    });
}

function toggleDetails(name) {
    const id = `details-${name.replace(/\s/g, '_')}`;
    const el = document.getElementById(id);
    el.classList.toggle("active");
}

function openInvoiceModal(invoiceNumber) {
    // Set the iframe source to invoice.html with the invoice number
    document.getElementById('invoiceIframe').src = `invoice.html?invoice=${encodeURIComponent(invoiceNumber)}`;
    
    // Show the modal
    document.getElementById("invoiceModal").style.display = "block";
}

function openWhatsApp(mobile) {
    window.open(`https://wa.me/91${mobile}`, '_blank');
}

function callCustomer(mobile) {
    window.location.href = `tel:+91${mobile}`;
}

// Modal close functionality
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById("invoiceModal");
    const closeBtn = document.querySelector(".close");
    
    closeBtn.onclick = function() {
        modal.style.display = "none";
        // Reset iframe source when closing modal
        document.getElementById('invoiceIframe').src = "";
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
            // Reset iframe source when closing modal
            document.getElementById('invoiceIframe').src = "";
        }
    }
});

loadLedger();
</script>

</body>
</html>