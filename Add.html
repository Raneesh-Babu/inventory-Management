<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manager Dashboard — Baserow</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--accent:#0b5fff}
    body{font-family:Inter,Segoe UI,system-ui,Arial;margin:0;background:var(--bg);color:#0f172a}
    .wrap{max-width:980px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(8,15,40,0.06)}
    .row{display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    label{min-width:120px;font-weight:600;color:#334155}
    input[type="text"], input[type="password"], textarea, select{flex:1;padding:10px;border:1px solid #e6eef8;border-radius:8px;font-size:14px}
    textarea{min-height:72px;resize:vertical}
    button{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer}
    button.secondary{background:#e6eef8;color:#0b5fff}
    .status{padding:8px;border-radius:8px}
    .blocked{background:#fff1f2;color:#9b1c1c}
    .active{background:#ecfeff;color:#056b6a}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:13px;padding:6px 10px;border-radius:8px}
    .muted{color:#64748b;font-size:13px}
    .notice{background:#f8fafc;padding:10px;border-radius:8px;margin-top:8px}
    .hidden{display:none}
    @media (max-width:640px){label{min-width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Manager Dashboard — Baserow</h1>
      <div class="muted">Table: <strong>729979</strong></div>
    </header>

    <div id="message" class="card" style="margin-bottom:12px;">
      <div id="msgText">Initializing...</div>
    </div>

    <div id="authCard" class="card">
      <div style="margin-bottom:8px;font-weight:700">Local storage / Validation</div>
      <p class="muted">This page reads localStorage key <code>"ShopIDtag"</code> and <code>"MobileTag"</code>. If MobileTag is missing, enter it below to continue.</p>
      <div class="row">
        <label>ShopID (from localStorage)</label>
        <input id="shopidInput" type="text" placeholder="ShopIDtag (read-only)" readonly />
      </div>
      <div class="row">
        <label>Mobile (Username)</label>
        <input id="mobileInput" type="text" placeholder="10-digit mobile (MobileTag)" />
        <button id="saveMobileBtn" class="small secondary">Save MobileTag</button>
      </div>
      <div class="row">
        <label></label>
        <div class="controls">
          <button id="validateBtn">Validate & Load User</button>
          <button id="clearLocalBtn" class="small secondary">Clear stored tags</button>
        </div>
      </div>
    </div>

    <div id="managerPanel" class="card hidden" style="margin-top:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="font-weight:700">Manager Controls</div>
        <div id="roleBadge" class="muted"></div>
      </div>

      <div id="userForm">
        <div class="row">
          <label>Username (Mobile)</label>
          <input id="f_username" type="text" />
        </div>
        <div class="row">
          <label>Name</label>
          <input id="f_name" type="text" />
        </div>
        <div class="row">
          <label>Shop Name</label>
          <input id="f_shopname" type="text" />
        </div>
        <div class="row">
          <label>Password</label>
          <input id="f_password" type="password" />
        </div>
        <div class="row">
          <label>Role</label>
          <select id="f_role">
            <option value="">-- select role --</option>
            <option>Manager</option>
            <option>Staff</option>
          </select>
        </div>
        <div class="row">
          <label>ShopID</label>
          <input id="f_shopid" type="text" />
        </div>
        <div class="row">
          <label>Notice</label>
          <textarea id="f_notice" placeholder="Write a notice..."></textarea>
        </div>

        <div class="row">
          <label>Block</label>
          <select id="f_block">
            <option value="">Active</option>
            <option value="B">Blocked (B)</option>
          </select>
          <div id="blockStatus" style="margin-left:6px"></div>
        </div>

        <div class="row">
          <label>Last Login</label>
          <input id="f_lastlogin" type="text" readonly />
        </div>

        <div class="row" style="margin-top:8px;">
          <label></label>
          <div class="controls">
            <button id="saveBtn">Save Changes</button>
            <button id="blockBtn" class="small secondary">Toggle Block</button>
            <button id="refreshBtn" class="small secondary">Refresh from Server</button>
          </div>
        </div>

        <div id="rowInfo" class="muted" style="margin-top:12px"></div>
      </div>
    </div>

    <div style="margin-top:12px" class="muted">Network logs and errors will appear in the browser console (F12) — useful if something fails.</div>
  </div>

<script>
(async function(){
  // === CONFIG: change if needed ===
  const BASE_URL = 'https://api.baserow.io/api/database/rows/table/729979/';
  const API_TOKEN = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw';

  // Field IDs mapping (as provided)
  const FIELDS = {
    username: 'field_6136323', // Mobile (10-digit)
    name: 'field_6138249',
    shopname: 'field_6138941',
    password: 'field_6136324',
    role: 'field_6136325',
    shopid: 'field_6138245',
    notice: 'field_6169112',
    block: 'field_6168111',
    lastlogin: 'field_6168126'
  };

  // Elements
  const msgText = document.getElementById('msgText');
  const shopidInput = document.getElementById('shopidInput');
  const mobileInput = document.getElementById('mobileInput');
  const saveMobileBtn = document.getElementById('saveMobileBtn');
  const validateBtn = document.getElementById('validateBtn');
  const clearLocalBtn = document.getElementById('clearLocalBtn');

  const managerPanel = document.getElementById('managerPanel');
  const roleBadge = document.getElementById('roleBadge');

  const f_username = document.getElementById('f_username');
  const f_name = document.getElementById('f_name');
  const f_shopname = document.getElementById('f_shopname');
  const f_password = document.getElementById('f_password');
  const f_role = document.getElementById('f_role');
  const f_shopid = document.getElementById('f_shopid');
  const f_notice = document.getElementById('f_notice');
  const f_block = document.getElementById('f_block');
  const f_lastlogin = document.getElementById('f_lastlogin');

  const saveBtn = document.getElementById('saveBtn');
  const blockBtn = document.getElementById('blockBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const rowInfo = document.getElementById('rowInfo');
  const blockStatus = document.getElementById('blockStatus');

  // Local storage keys
  const SHOPID_KEY = 'ShopIDTag'; // updated key (was "ShopID tag")
  const MOBILE_KEY = 'MobileTag';  // fallback key name for mobile

  // Runtime state
  let shopIdValue = null;
  let mobileValue = null;
  let loadedRow = null; // entire row object from Baserow
  let loadedRowId = null;

  // Util: show message
  function setMessage(text, isError=false){
    msgText.textContent = text;
    msgText.style.color = isError ? '#8b1c1c' : '#0b5fff';
  }

  // Read localStorage
  function readLocalTags(){
    shopIdValue = localStorage.getItem(SHOPID_KEY);
    mobileValue = localStorage.getItem(MOBILE_KEY);
    if (shopIdValue) shopidInput.value = shopIdValue;
    if (mobileValue) mobileInput.value = mobileValue;
  }

  // Save MobileTag to localStorage
  saveMobileBtn.addEventListener('click', () => {
    const v = mobileInput.value && mobileInput.value.trim();
    if (!v || v.length < 6) {
      alert('Enter a valid MobileTag (mobile number).');
      return;
    }
    localStorage.setItem(MOBILE_KEY, v);
    mobileValue = v;
    setMessage('MobileTag saved. Press Validate & Load User.');
  });

  clearLocalBtn.addEventListener('click', () => {
    localStorage.removeItem(SHOPID_KEY);
    localStorage.removeItem(MOBILE_KEY);
    shopidInput.value = '';
    mobileInput.value = '';
    setMessage('Cleared ShopIDtag and MobileTag from localStorage');
  });

  // Fetch rows from Baserow (returns array)
  async function fetchAllRows(){
    const url = BASE_URL + '?page_size=1000'; // try to fetch many rows; adjust if huge table
    const resp = await fetch(url, {
      headers: {
        'Authorization': 'Token ' + API_TOKEN,
        'Content-Type': 'application/json'
      }
    });
    if (!resp.ok) throw new Error('Fetch rows failed: ' + resp.status + ' ' + resp.statusText);
    const data = await resp.json();
    // data is expected to be array
    return data;
  }

  // Find row by username & shopid
  function findRow(rows, username, shopid){
    if (!Array.isArray(rows)) return null;
    username = (username || '').toString().trim();
    shopid = (shopid || '').toString().trim();
    return rows.find(r => {
      const ru = (r.values && r.values[FIELDS.username]) ? r.values[FIELDS.username].toString().trim() : '';
      const rs = (r.values && r.values[FIELDS.shopid]) ? r.values[FIELDS.shopid].toString().trim() : '';
      return ru === username && rs === shopid;
    }) || null;
  }

  // Update last login on server (PATCH single field)
  async function updateLastLogin(rowId){
    const nowIso = new Date().toISOString();
    const patchBody = {};
    patchBody[FIELDS.lastlogin] = nowIso;
    const resp = await fetch(BASE_URL + rowId + '/', {
      method: 'PATCH',
      headers: {
        'Authorization': 'Token ' + API_TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(patchBody)
    });
    if (!resp.ok) {
      console.warn('Failed to update last login', resp.status, resp.statusText);
      return null;
    }
    return await resp.json();
  }

  // Render loaded row to form
  function renderRowToForm(row){
    if (!row) return;
    const v = row.values || {};
    f_username.value = v[FIELDS.username] || '';
    f_name.value = v[FIELDS.name] || '';
    f_shopname.value = v[FIELDS.shopname] || '';
    f_password.value = v[FIELDS.password] || '';
    f_role.value = v[FIELDS.role] || '';
    f_shopid.value = v[FIELDS.shopid] || '';
    f_notice.value = v[FIELDS.notice] || '';
    f_block.value = v[FIELDS.block] || '';
    f_lastlogin.value = v[FIELDS.lastlogin] || '';
    rowInfo.textContent = `Loaded row id: ${row.id}  |  Created at: ${row.created_on || 'n/a'}`;
    const isBlocked = (v[FIELDS.block] === 'B');
    blockStatus.innerHTML = isBlocked ? '<span class="status blocked">Blocked</span>' : '<span class="status active">Active</span>';
  }

  // Toggle block value
  blockBtn.addEventListener('click', async () => {
    if (!loadedRow) { alert('No row loaded'); return; }
    const current = loadedRow.values[FIELDS.block] || '';
    const newVal = current === 'B' ? '' : 'B';
    f_block.value = newVal;
    await saveChanges({[FIELDS.block]: newVal});
  });

  // Save button
  saveBtn.addEventListener('click', async () => {
    if (!loadedRow) { alert('No row loaded'); return; }
    // gather all editable fields
    const body = {};
    body[FIELDS.username] = f_username.value.trim();
    body[FIELDS.name] = f_name.value.trim();
    body[FIELDS.shopname] = f_shopname.value.trim();
    body[FIELDS.password] = f_password.value;
    body[FIELDS.role] = f_role.value;
    body[FIELDS.shopid] = f_shopid.value.trim();
    body[FIELDS.notice] = f_notice.value;
    body[FIELDS.block] = f_block.value;
    // Always update last login when saving (optional)
    body[FIELDS.lastlogin] = new Date().toISOString();

    await saveChanges(body);
  });

  // Save changes helper: PATCH row
  async function saveChanges(fieldMap){
    if (!loadedRow) { alert('No row loaded'); return; }
    setMessage('Saving changes...');
    try {
      const resp = await fetch(BASE_URL + loadedRow.id + '/', {
        method: 'PATCH',
        headers: {
          'Authorization': 'Token ' + API_TOKEN,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(fieldMap)
      });
      if (!resp.ok) {
        const txt = await resp.text();
        console.error('Save failed', resp.status, resp.statusText, txt);
        setMessage('Save failed: ' + resp.status + ' ' + resp.statusText, true);
        return;
      }
      const updated = await resp.json();
      loadedRow = updated; // update local row snapshot
      renderRowToForm(loadedRow);
      setMessage('Saved successfully.');
    } catch (err) {
      console.error(err);
      setMessage('Save error: ' + err.message, true);
    }
  }

  // Refresh button
  refreshBtn.addEventListener('click', async () => {
    setMessage('Refreshing from server...');
    await validateAndLoad(); // refetch and update
  });

  // Main: validate and load user row
  async function validateAndLoad(){
    // ensure shopid and mobile present
    shopIdValue = localStorage.getItem(SHOPID_KEY);
    mobileValue = localStorage.getItem(MOBILE_KEY) || mobileInput.value.trim();

    if (!shopIdValue) {
      setMessage('ShopIDtag not found in localStorage. Please set localStorage key "' + SHOPID_KEY + '" then reload.', true);
      shopidInput.value = '';
      managerPanel.classList.add('hidden');
      return;
    }
    shopidInput.value = shopIdValue;

    if (!mobileValue) {
      setMessage('MobileTag not found. Enter mobile and click Save MobileTag or press Validate after entering mobile.', true);
      managerPanel.classList.add('hidden');
      return;
    }

    setMessage('Fetching user rows from Baserow...');
    try {
      const rows = await fetchAllRows();
      const row = findRow(rows, mobileValue, shopIdValue);
      if (!row) {
        setMessage('No matching row found for Mobile: ' + mobileValue + ' and ShopID: ' + shopIdValue, true);
        managerPanel.classList.add('hidden');
        return;
      }
      loadedRow = row;
      loadedRowId = row.id;
      setMessage('User row found. Updating Last Login...');
      // update last login
      const updated = await updateLastLogin(loadedRowId);
      if (updated && updated.values) {
        loadedRow = updated;
      } else {
        // if update failed, keep original row values
      }
      // if role is Manager -> show panel
      const roleVal = (loadedRow.values && loadedRow.values[FIELDS.role]) ? loadedRow.values[FIELDS.role].toString().trim() : '';
      if (roleVal.toLowerCase() !== 'manager') {
        setMessage('Loaded user role is "' + roleVal + '". Access to manager panel is restricted to users with role "Manager".', true);
        managerPanel.classList.add('hidden');
        return;
      }
      roleBadge.textContent = 'Role: ' + roleVal;
      renderRowToForm(loadedRow);
      managerPanel.classList.remove('hidden');
      setMessage('Manager loaded. You can edit fields and Save Changes.');
    } catch (err) {
      console.error(err);
      setMessage('Error fetching/validating: ' + err.message, true);
      managerPanel.classList.add('hidden');
    }
  }

  // initial load
  readLocalTags();
  setMessage('Ready — reading localStorage...');
  // Try auto-validate if both present
  if (localStorage.getItem(SHOPID_KEY) && localStorage.getItem(MOBILE_KEY)) {
    await validateAndLoad();
  } else {
    setMessage('Please ensure localStorage has "' + SHOPID_KEY + '". If MobileTag missing, enter mobile and Save MobileTag.');
  }

  // wire validate button
  validateBtn.addEventListener('click', async () => {
    // ensure saved MobileTag if entered
    const m = mobileInput.value && mobileInput.value.trim();
    if (m) {
      localStorage.setItem(MOBILE_KEY, m);
    }
    await validateAndLoad();
  });

})();
</script>
</body>
</html>