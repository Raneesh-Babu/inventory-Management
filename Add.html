<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manager Staff Control</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f9f9f9;
  padding: 20px;
  text-align: center;
}
.container {
  background: #fff;
  padding: 20px;
  max-width: 700px;
  margin: auto;
  border-radius: 10px;
  box-shadow: 0 0 10px #ccc;
}
input, button, select {
  padding: 10px;
  margin: 8px;
  border-radius: 5px;
  border: 1px solid #ccc;
}
button {
  background: #007bff;
  color: white;
  border: none;
  cursor: pointer;
}
button:hover {
  background: #0056b3;
}
.staff-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
.staff-table th, .staff-table td {
  border: 1px solid #ccc;
  padding: 8px;
}
.staff-table th {
  background: #007bff;
  color: white;
}
.editable {
  background: #e8f0fe;
}
</style>
</head>
<body>

<div class="container">
  <h2>ðŸ‘¤ Manager Dashboard</h2>
  <p id="status">Validating Manager...</p>
  <div id="addStaffSection" style="display:none;">
    <h3>Add New Staff</h3>
    <input type="text" id="newUsername" placeholder="Username (10-digit)" maxlength="10"><br>
    <input type="text" id="newName" placeholder="Name"><br>
    <input type="password" id="newPassword" placeholder="Password"><br>
    <button id="addStaffBtn" disabled>Add Staff</button>
  </div>

  <h3>Staff List</h3>
  <table class="staff-table" id="staffTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Username</th>
        <th>Notice</th>
        <th>Block</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="staffBody"></tbody>
  </table>
</div>

<script>
const API_URL = "https://api.baserow.io/api/database/rows/table/729979/";
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";

const headers = {
  Authorization: `Token ${API_KEY}`,
  "Content-Type": "application/json"
};

let managerData = {};
let shopID = "";
let shopName = "";

// Validate manager
async function validateManager() {
  const mobileTag = localStorage.getItem("MobileTag");
  if (!mobileTag) {
    document.getElementById("status").innerText = "âŒ MobileTag not found in local storage!";
    return;
  }

  const res = await fetch(API_URL + `?user_field_names=true`, { headers });
  const data = await res.json();
  const users = data.results;
  const manager = users.find(u => u.Username == mobileTag);

  if (!manager) {
    document.getElementById("status").innerText = "âŒ Manager not found!";
    return;
  }

  if (manager.Role !== "Manager") {
    document.getElementById("status").innerText = "âŒ Access Denied! Only Managers can view this page.";
    return;
  }

  managerData = manager;
  shopID = manager.ShopID;
  shopName = manager["Shop Name"];
  document.getElementById("status").innerText = `âœ… Welcome ${manager.Name} (${shopName})`;
  document.getElementById("addStaffSection").style.display = "block";
  document.getElementById("addStaffBtn").disabled = false;

  loadStaff();
}

// Load staff for this shop
async function loadStaff() {
  const res = await fetch(API_URL + `?user_field_names=true`, { headers });
  const data = await res.json();
  const staff = data.results.filter(u => u.ShopID == shopID && u.Role === "Staff");

  const tbody = document.getElementById("staffBody");
  tbody.innerHTML = "";

  staff.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td contenteditable="true" class="editable" data-field="Name" data-id="${u.id}">${u.Name}</td>
      <td>${u.Username}</td>
      <td contenteditable="true" class="editable" data-field="Notice" data-id="${u.id}">${u.Notice || ""}</td>
      <td contenteditable="true" class="editable" data-field="Block" data-id="${u.id}">${u.Block || ""}</td>
      <td>
        <button onclick="updateRow(${u.id})">ðŸ’¾ Save</button>
        <button onclick="deleteRow(${u.id})">ðŸ—‘ Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Add staff
document.getElementById("addStaffBtn").addEventListener("click", async () => {
  const username = document.getElementById("newUsername").value.trim();
  const name = document.getElementById("newName").value.trim();
  const password = document.getElementById("newPassword").value.trim();

  if (!username || !name || !password || username.length !== 10) {
    alert("Please fill all fields with valid data!");
    return;
  }

  const body = {
    Username: username,
    Name: name,
    Password: password,
    Role: "Staff",
    ShopID: shopID,
    "Shop Name": shopName,
    Notice: "",
    Block: ""
  };

  await fetch(API_URL + "?user_field_names=true", {
    method: "POST",
    headers,
    body: JSON.stringify(body)
  });

  alert("âœ… Staff added successfully!");
  loadStaff();
});

// Update row
async function updateRow(id) {
  const row = [...document.querySelectorAll(`[data-id='${id}']`)];
  const updated = {};
  row.forEach(cell => {
    updated[cell.getAttribute("data-field")] = cell.innerText.trim();
  });

  await fetch(API_URL + `${id}/?user_field_names=true`, {
    method: "PATCH",
    headers,
    body: JSON.stringify(updated)
  });

  alert("âœ… Updated successfully!");
  loadStaff();
}

// Delete staff
async function deleteRow(id) {
  if (!confirm("Are you sure you want to delete this staff?")) return;
  await fetch(API_URL + `${id}/`, {
    method: "DELETE",
    headers
  });
  alert("ðŸ—‘ Deleted successfully!");
  loadStaff();
}

validateManager();
</script>
</body>
</html>