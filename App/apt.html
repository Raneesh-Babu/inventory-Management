<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shop Data Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Import Google Fonts for premium feel */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --danger-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --warning-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
      --shadow-lg: 0 20px 60px rgba(0,0,0,0.15);
      --shadow-md: 0 10px 40px rgba(0,0,0,0.1);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #f5f7fb 0%, #e4edf5 100%);
      margin: 0; 
      padding: 20px;
      min-height: 100vh;
    }
    
    .card { 
      max-width: 900px; 
      margin: auto; 
      background: #fff; 
      padding: 40px; 
      border-radius: var(--radius-lg); 
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    h2 { 
      margin-top: 0; 
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 28px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .shop-header { 
      background: var(--primary-gradient);
      padding: 30px; 
      border-radius: var(--radius-md); 
      margin-bottom: 30px; 
      color: white;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .shop-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1%, transparent 1%);
      background-size: 20px 20px;
      opacity: 0.3;
    }
    
    .shop-header h3 { 
      margin: 0 0 12px 0; 
      font-size: 28px; 
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .shop-header .shop-id { 
      opacity: 0.9; 
      font-size: 14px; 
      font-family: 'Courier New', monospace; 
      background: rgba(255,255,255,0.15);
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .shop-details {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    
    .detail-item {
      background: rgba(255,255,255,0.15);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    button { 
      padding: 16px 24px; 
      border: none; 
      border-radius: var(--radius-sm); 
      cursor: pointer; 
      font-size: 15px; 
      font-weight: 600;
      margin: 5px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    button:disabled::before {
      display: none;
    }
    
    .danger { background: var(--danger-gradient); color:#fff; }
    .danger:hover { background: var(--danger-gradient); }
    
    .primary { background: var(--primary-gradient); color:#fff; }
    .primary:hover { background: var(--primary-gradient); }
    
    .success { background: var(--success-gradient); color:#fff; }
    .success:hover { background: var(--success-gradient); }
    
    .warning { background: var(--warning-gradient); color:#333; }
    .warning:hover { background: var(--warning-gradient); }
    
    .dark { background: var(--dark-gradient); color:#fff; }
    .dark:hover { background: var(--dark-gradient); }
    
    input[type=file] { padding:12px; }
    .hidden { display:none; }
    
    .log { 
      margin-top: 25px; 
      font-size: 14px; 
      white-space: pre-line; 
      background: #f8f9fa; 
      padding: 20px; 
      border-radius: var(--radius-sm); 
      border-left: 4px solid #667eea;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .log.error { border-left-color: #f5576c; background: #f8d7da; }
    .log.success { border-left-color: #38ef7d; background: #d4edda; }
    .log.warning { border-left-color: #fda085; background: #fff3cd; }
    .log.info { border-left-color: #667eea; background: #d1ecf1; }
    
    .progress-container {
      margin-top: 25px;
      background: #f8f9fa;
      padding: 25px;
      border-radius: var(--radius-md);
      display: none;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .progress-bar {
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      height: 20px;
      margin-bottom: 12px;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      width: 0%;
      background: var(--primary-gradient);
      transition: width .3s ease;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255,255,255,0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255,255,255,0.2) 50%,
        rgba(255,255,255,0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 50px 50px;
      animation: move 2s linear infinite;
    }
    
    @keyframes move {
      0% { background-position: 0 0; }
      100% { background-position: 50px 50px; }
    }
    
    .progress-text {
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      font-weight: 600;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 18px;
      margin: 25px 0;
    }
    
    .stat-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: var(--radius-sm);
      text-align: center;
      border-left: 4px solid #667eea;
      transition: var(--transition);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 800;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 8px 0;
    }
    
    .stat-label {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin: 30px 0;
    }
    
    .icon {
      font-size: 20px;
    }
    
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal {
      background: white;
      border-radius: var(--radius-lg);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      animation: modalSlide 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      overflow: hidden;
    }
    
    .modal::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
    }
    
    @keyframes modalSlide {
      from { transform: translateY(-50px) scale(0.9); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    
    .modal h3 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    
    .modal-content {
      font-size: 16px;
      line-height: 1.6;
      color: #5a6778;
      margin: 20px 0;
      padding: 0 5px;
    }
    
    .modal input {
      width: 100%;
      padding: 16px;
      margin: 20px 0;
      border: 2px solid #e1e8f0;
      border-radius: var(--radius-sm);
      font-size: 16px;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      transition: var(--transition);
    }
    
    .modal input:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 30px;
      justify-content: flex-end;
    }
    
    .modal-icon {
      font-size: 48px;
      text-align: center;
      margin: 20px 0;
    }
    
    .modal-icon.success { color: #38ef7d; }
    .modal-icon.error { color: #f5576c; }
    .modal-icon.warning { color: #fda085; }
    .modal-icon.info { color: #667eea; }
    .modal-icon.question { color: #764ba2; }
    
    .modal-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .modal-header-icon {
      font-size: 32px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .modal-header-icon.success { 
      background: linear-gradient(135deg, rgba(56, 239, 125, 0.1) 0%, rgba(17, 153, 142, 0.1) 100%);
      color: #11998e;
    }
    
    .modal-header-icon.error { 
      background: linear-gradient(135deg, rgba(245, 87, 108, 0.1) 0%, rgba(240, 147, 251, 0.1) 100%);
      color: #f5576c;
    }
    
    .modal-header-icon.warning { 
      background: linear-gradient(135deg, rgba(253, 160, 133, 0.1) 0%, rgba(246, 211, 101, 0.1) 100%);
      color: #fda085;
    }
    
    .modal-header-icon.info { 
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      color: #667eea;
    }
    
    .modal-header-icon.question { 
      background: linear-gradient(135deg, rgba(118, 75, 162, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
      color: #764ba2;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 10001;
      animation: toastSlide 0.3s ease;
      max-width: 400px;
      border-left: 4px solid #667eea;
    }
    
    .toast.success { border-left-color: #38ef7d; }
    .toast.error { border-left-color: #f5576c; }
    .toast.warning { border-left-color: #fda085; }
    .toast.info { border-left-color: #667eea; }
    
    @keyframes toastSlide {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .toast-icon {
      font-size: 24px;
    }
    
    .toast-content {
      flex-grow: 1;
    }
    
    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #999;
      cursor: pointer;
      padding: 0;
      margin: 0;
    }
    
    .toast-close:hover {
      color: #333;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-modal .modal-content {
      text-align: center;
      padding: 20px 0;
    }
    
    /* Stats Toggle */
    .stats-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: var(--radius-sm);
      cursor: pointer;
      border: 1px solid rgba(0,0,0,0.05);
      transition: var(--transition);
    }
    
    .stats-toggle:hover {
      background: #e9ecef;
    }
    
    .stats-toggle span {
      font-weight: 600;
      color: #2c3e50;
    }
    
    .stats-toggle i {
      transition: transform 0.3s ease;
    }
    
    .stats-toggle.active i {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
<div class="card" id="page">
  <div class="shop-header" id="shopHeader">
    <h3 id="shopName"><i class="fas fa-store"></i> Loading shop information...</h3>
    <div class="shop-id"><i class="fas fa-fingerprint"></i> Shop ID: <span id="shopIDDisplay">...</span></div>
    <div class="shop-details" id="shopDetails"></div>
  </div>
  
  <div class="stats-toggle" onclick="toggleStats()">
    <span><i class="fas fa-chart-bar"></i> Shop Statistics</span>
    <i class="fas fa-chevron-down"></i>
  </div>
  
  <div class="stats" id="statsContainer" style="display:none;">
    <!-- Stats will be populated dynamically -->
  </div>
  
  <h2><i class="fas fa-database"></i> Shop Data Management</h2>
  <p style="color: #666; line-height: 1.6; font-size: 15px; margin: 15px 0 25px 0;">
    <i class="fas fa-exclamation-triangle" style="color: #f5576c;"></i> <b>Warning:</b> 
    Operations below affect all shop data. Delete Shop is <span style="color:red; font-weight:bold;">PERMANENT</span> and cannot be undone.
  </p>
  
  <div class="action-buttons">
    <button class="primary" onclick="downloadAllData()" id="btnBackup">
      <i class="fas fa-download icon"></i>
      Download Backup
    </button>
    <button class="success" onclick="triggerRestore()" id="btnRestore">
      <i class="fas fa-upload icon"></i>
      Restore Data
    </button>
    <button class="dark" onclick="showStats()" id="btnStats">
      <i class="fas fa-chart-pie icon"></i>
      View Statistics
    </button>
    <button class="danger" onclick="deleteShop()" id="btnDelete">
      <i class="fas fa-trash-alt icon"></i>
      Delete Shop
    </button>
  </div>
  
  <input type="file" id="restoreFile" accept=".json" class="hidden" />
  
  <div class="progress-container" id="progressContainer">
    <div style="margin-bottom: 15px; font-weight: 600; color: #2c3e50;">
      <i class="fas fa-tasks"></i> Operation Progress:
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar"></div>
    </div>
    <div class="progress-text">
      <span id="progressText">0%</span>
      <span id="progressCount">0 / 0</span>
    </div>
  </div>
  
  <div class="log" id="log">
    <i class="fas fa-info-circle" style="color: #667eea;"></i> Ready. Select an action to begin.
  </div>
</div>

<!-- Shop ID Modal -->
<div id="shopIdModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-icon question">
        <i class="fas fa-key"></i>
      </div>
      <div>
        <h3>Enter Shop ID</h3>
        <p id="modalMessage" style="color: #666; margin: 0;">Shop ID is required to proceed</p>
      </div>
    </div>
    
    <div class="modal-content">
      <input type="text" id="shopIdInput" placeholder="Enter your Shop ID..." autocomplete="off">
    </div>
    
    <div class="modal-buttons">
      <button onclick="cancelShopId()" class="warning" style="padding: 12px 24px;">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button onclick="confirmShopId()" class="primary" style="padding: 12px 24px;">
        <i class="fas fa-check"></i> Confirm
      </button>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-icon warning" id="confirmIcon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div>
        <h3 id="confirmTitle">Confirm Action</h3>
        <p id="confirmMessage" style="color: #666; margin: 0;">Are you sure you want to proceed?</p>
      </div>
    </div>
    
    <div class="modal-content" id="confirmContent">
      <!-- Dynamic content will be inserted here -->
    </div>
    
    <div class="modal-buttons">
      <button onclick="cancelConfirm()" class="warning" style="padding: 12px 24px;">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button onclick="proceedConfirm()" class="primary" id="confirmProceedBtn" style="padding: 12px 24px;">
        <i class="fas fa-check"></i> Confirm
      </button>
    </div>
  </div>
</div>

<!-- Alert Modal -->
<div id="alertModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-icon info" id="alertIcon">
        <i class="fas fa-info-circle"></i>
      </div>
      <div>
        <h3 id="alertTitle">Information</h3>
        <p id="alertMessage" style="color: #666; margin: 0;"></p>
      </div>
    </div>
    
    <div class="modal-content" id="alertContent">
      <!-- Dynamic content will be inserted here -->
    </div>
    
    <div class="modal-buttons">
      <button onclick="closeAlert()" class="primary" style="padding: 12px 24px;">
        <i class="fas fa-check"></i> OK
      </button>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="modal-overlay loading-modal" style="display:none;">
  <div class="modal">
    <div class="modal-content" style="text-align: center;">
      <div class="spinner"></div>
      <h3 id="loadingTitle" style="margin: 20px 0 10px 0;">Processing...</h3>
      <p id="loadingMessage" style="color: #666;">Please wait while we process your request</p>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-icon success">
        <i class="fas fa-check-circle"></i>
      </div>
      <div>
        <h3 id="successTitle">Success!</h3>
        <p id="successMessage" style="color: #666; margin: 0;">Operation completed successfully</p>
      </div>
    </div>
    
    <div class="modal-content" id="successContent">
      <!-- Dynamic content will be inserted here -->
    </div>
    
    <div class="modal-buttons">
      <button onclick="closeSuccess()" class="success" style="padding: 12px 24px;">
        <i class="fas fa-check"></i> Continue
      </button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-icon error">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <div>
        <h3 id="errorTitle">Error</h3>
        <p id="errorMessage" style="color: #666; margin: 0;">An error occurred</p>
      </div>
    </div>
    
    <div class="modal-content" id="errorContent">
      <!-- Dynamic content will be inserted here -->
    </div>
    
    <div class="modal-buttons">
      <button onclick="closeError()" class="danger" style="padding: 12px 24px;">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  </div>
</div>

<script>
// ================= CONFIGURATION =================
const API_KEY = 'jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw'; // Your Baserow API Key
const BASE_URL = 'https://api.baserow.io/api/database/rows/table';
const TABLES = {
  users: 729979,
  inventory: 734795,
  products: 734793,
  customers: 736204,
  ledger: 736207,
  sale: 736209,
  supplier: 744412,
  transaction: 745465,
  shops: 999999 // Update this with your actual shops table ID
};

// ================= STATE MANAGEMENT =================
let shopInfo = null;
let shopStats = {};
let isOperationInProgress = false;
let pendingOperation = null;
let pendingOperationArgs = null;
let confirmCallback = null;
let confirmCancelCallback = null;

// ================= MODAL MANAGEMENT =================
function showModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

function hideModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// Shop ID Modal
function showShopIdModal(message, operation, args = null) {
  document.getElementById('modalMessage').textContent = message;
  pendingOperation = operation;
  pendingOperationArgs = args;
  document.getElementById('shopIdInput').value = '';
  showModal('shopIdModal');
  setTimeout(() => document.getElementById('shopIdInput').focus(), 300);
}

function cancelShopId() {
  hideModal('shopIdModal');
  log('Operation cancelled by user.', 'warning');
  pendingOperation = null;
  pendingOperationArgs = null;
}

function confirmShopId() {
  const shopId = document.getElementById('shopIdInput').value.trim();
  
  if (!shopId) {
    showAlert('Validation Error', 'Please enter a valid Shop ID.', 'warning');
    return;
  }
  
  // Save to localStorage
  localStorage.setItem('ShopIDtag', shopId);
  
  hideModal('shopIdModal');
  showToast('Shop ID saved successfully!', 'success');
  
  // Execute the pending operation
  if (pendingOperation) {
    if (pendingOperationArgs) {
      pendingOperation(...pendingOperationArgs);
    } else {
      pendingOperation();
    }
  }
  
  pendingOperation = null;
  pendingOperationArgs = null;
}

// Confirmation Modal
function showConfirm(title, message, content, type = 'warning', onConfirm, onCancel = null) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMessage').textContent = message;
  document.getElementById('confirmContent').innerHTML = content;
  
  // Set icon based on type
  const icon = document.getElementById('confirmIcon');
  icon.className = `modal-header-icon ${type}`;
  icon.innerHTML = `<i class="fas fa-${getIconForType(type)}"></i>`;
  
  // Set button color based on type
  const button = document.getElementById('confirmProceedBtn');
  button.className = type;
  
  confirmCallback = onConfirm;
  confirmCancelCallback = onCancel;
  
  showModal('confirmModal');
}

function cancelConfirm() {
  hideModal('confirmModal');
  if (confirmCancelCallback) {
    confirmCancelCallback();
  }
  confirmCallback = null;
  confirmCancelCallback = null;
}

function proceedConfirm() {
  hideModal('confirmModal');
  if (confirmCallback) {
    confirmCallback();
  }
  confirmCallback = null;
  confirmCancelCallback = null;
}

// Alert Modal
function showAlert(title, message, type = 'info') {
  document.getElementById('alertTitle').textContent = title;
  document.getElementById('alertMessage').textContent = message;
  
  // Set icon based on type
  const icon = document.getElementById('alertIcon');
  icon.className = `modal-header-icon ${type}`;
  icon.innerHTML = `<i class="fas fa-${getIconForType(type)}"></i>`;
  
  showModal('alertModal');
}

function closeAlert() {
  hideModal('alertModal');
}

// Loading Modal
function showLoading(title = 'Processing...', message = 'Please wait while we process your request') {
  document.getElementById('loadingTitle').textContent = title;
  document.getElementById('loadingMessage').textContent = message;
  showModal('loadingModal');
}

function hideLoading() {
  hideModal('loadingModal');
}

// Success Modal
function showSuccess(title = 'Success!', message = 'Operation completed successfully', content = '') {
  document.getElementById('successTitle').textContent = title;
  document.getElementById('successMessage').textContent = message;
  document.getElementById('successContent').innerHTML = content;
  showModal('successModal');
}

function closeSuccess() {
  hideModal('successModal');
}

// Error Modal
function showError(title = 'Error', message = 'An error occurred', content = '') {
  document.getElementById('errorTitle').textContent = title;
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('errorContent').innerHTML = content;
  showModal('errorModal');
}

function closeError() {
  hideModal('errorModal');
}

// Toast Notification
function showToast(message, type = 'info', duration = 5000) {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <div class="toast-icon">
      <i class="fas fa-${getIconForType(type)}"></i>
    </div>
    <div class="toast-content">${message}</div>
    <button class="toast-close" onclick="this.parentElement.remove()">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  document.body.appendChild(toast);
  
  // Auto remove after duration
  setTimeout(() => {
    if (toast.parentElement) {
      toast.remove();
    }
  }, duration);
  
  return toast;
}

function getIconForType(type) {
  const icons = {
    'success': 'check-circle',
    'error': 'exclamation-circle',
    'warning': 'exclamation-triangle',
    'info': 'info-circle',
    'question': 'question-circle'
  };
  return icons[type] || 'info-circle';
}

// ================= UTILITY FUNCTIONS =================
function getShopID() {
  const shopId = localStorage.getItem('ShopIDtag');
  
  if (shopId) {
    return shopId;
  }
  
  throw new Error('SHOP_ID_REQUIRED');
}

function getMobile() {
  const possibleKeys = ['MobileTag', 'mobileTag', 'Mobile', 'mobile', 'phone', 'Phone'];
  
  for (const key of possibleKeys) {
    const value = localStorage.getItem(key);
    if (value) {
      return value;
    }
  }
  
  // If not found, try to prompt user via modal
  showShopIdModal('Please enter your mobile number:', () => {
    const mobile = document.getElementById('shopIdInput').value.trim();
    if (mobile) {
      localStorage.setItem('MobileTag', mobile);
      showToast('Mobile number saved!', 'success');
      return mobile;
    }
  });
  
  throw new Error('MOBILE_REQUIRED');
}

// ================= API CONFIGURATION =================
const headers = {
  'Authorization': `Token ${API_KEY}`,
  'Content-Type': 'application/json'
};

// ================= UI HELPER FUNCTIONS =================
function updateButtonState(buttonId, isWorking) {
  const button = document.getElementById(buttonId);
  if (isWorking) {
    button.disabled = true;
    button.style.opacity = '0.7';
    button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${button.textContent}`;
  } else {
    button.disabled = false;
    button.style.opacity = '1';
    // Reset button content (remove spinner)
    const buttons = {
      'btnBackup': '<i class="fas fa-download icon"></i> Download Backup',
      'btnRestore': '<i class="fas fa-upload icon"></i> Restore Data',
      'btnStats': '<i class="fas fa-chart-pie icon"></i> View Statistics',
      'btnDelete': '<i class="fas fa-trash-alt icon"></i> Delete Shop'
    };
    button.innerHTML = buttons[buttonId] || button.textContent;
  }
}

function setAllButtonsState(isWorking) {
  const buttons = ['btnBackup', 'btnRestore', 'btnStats', 'btnDelete'];
  buttons.forEach(btnId => updateButtonState(btnId, isWorking));
  isOperationInProgress = isWorking;
}

function showProgress(show) {
  document.getElementById('progressContainer').style.display = show ? 'block' : 'none';
}

function setProgress(done, total, message = '') {
  const percent = total > 0 ? Math.round((done / total) * 100) : 0;
  document.getElementById('progressBar').style.width = percent + '%';
  document.getElementById('progressText').innerText = `${percent}%`;
  document.getElementById('progressCount').innerText = `${done} / ${total}`;
  
  if (message) {
    log(message, 'info');
  }
}

function log(message, type = 'info') {
  const logElement = document.getElementById('log');
  const timestamp = new Date().toLocaleTimeString();
  const icon = getIconForType(type);
  
  const logEntry = `<i class="fas fa-${icon}" style="color: ${getColorForType(type)};"></i> [${timestamp}] ${message}\n`;
  logElement.innerHTML += logEntry;
  logElement.className = `log ${type}`;
  logElement.scrollTop = logElement.scrollHeight;
}

function getColorForType(type) {
  const colors = {
    'success': '#38ef7d',
    'error': '#f5576c',
    'warning': '#fda085',
    'info': '#667eea'
  };
  return colors[type] || '#667eea';
}

function clearLog() {
  document.getElementById('log').innerHTML = '';
  document.getElementById('log').className = 'log';
}

function toggleStats() {
  const statsContainer = document.getElementById('statsContainer');
  const toggle = document.querySelector('.stats-toggle');
  const isVisible = statsContainer.style.display === 'grid';
  
  statsContainer.style.display = isVisible ? 'none' : 'grid';
  toggle.classList.toggle('active', !isVisible);
  
  showToast(isVisible ? 'Statistics hidden' : 'Statistics displayed', 'info');
}

// ================= API HELPER FUNCTIONS =================
async function fetchWithPagination(tableId, filters = {}) {
  let allResults = [];
  let page = 1;
  
  while (true) {
    try {
      let url = `${BASE_URL}/${tableId}/?user_field_names=true&page=${page}`;
      
      if (filters.shopID) {
        url += `&filter__ShopID__equal=${filters.shopID}`;
      }
      
      if (filters.mobile) {
        url += `&filter__Username__equal=${filters.mobile}`;
      }
      
      const response = await fetch(url, { headers });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      allResults = allResults.concat(data.results || []);
      
      if (!data.next) break;
      page++;
      
    } catch (error) {
      log(`Error fetching data: ${error.message}`, 'error');
      throw error;
    }
  }
  
  return allResults;
}

// ================= SHOP INFORMATION =================
async function loadShopInfo() {
  try {
    const shopID = getShopID();
    const mobile = getMobile();
    
    log(`Loading shop info for Shop ID: ${shopID}`, 'info');
    
    showLoading('Loading Shop Information', 'Fetching shop details...');
    
    const users = await fetchWithPagination(TABLES.users, { 
      shopID: shopID,
      mobile: mobile 
    });
    
    hideLoading();
    
    if (users.length === 0) {
      throw new Error('User not found in database');
    }
    
    const user = users[0];
    
    if (user.Role !== 'Manager') {
      showError(
        'Access Denied',
        'Manager role required',
        `<p>Your role: <strong>${user.Role}</strong></p>
         <p>Your Shop ID: <strong>${shopID}</strong></p>
         <p>Your Mobile: <strong>${mobile}</strong></p>`
      );
      return;
    }
    
    // Try to fetch shop details
    try {
      const shops = await fetchWithPagination(TABLES.shops, { shopID: shopID });
      if (shops.length > 0) {
        shopInfo = shops[0];
        log(`Found shop: ${shopInfo.name || 'Unnamed Shop'}`, 'success');
      } else {
        shopInfo = {
          name: `Shop ${shopID}`,
          id: shopID,
          owner: user.Username || mobile,
          role: user.Role,
          created: user.created_date || 'Unknown'
        };
        log(`Using generated shop info`, 'warning');
      }
    } catch (e) {
      shopInfo = {
        name: `Shop ${shopID}`,
        id: shopID,
        owner: user.Username || mobile,
        role: user.Role,
        created: user.created_date || 'Unknown'
      };
      log(`Could not access shops table`, 'warning');
    }
    
    updateShopUI(shopInfo, user);
    await loadShopStats();
    
  } catch (error) {
    hideLoading();
    
    if (error.message === 'SHOP_ID_REQUIRED') {
      showShopIdModal(
        'Shop ID is required to load shop information. Please enter your Shop ID:',
        loadShopInfo
      );
      return;
    }
    
    if (error.message === 'MOBILE_REQUIRED') {
      showShopIdModal(
        'Mobile number is required. Please enter your mobile number:',
        loadShopInfo
      );
      return;
    }
    
    showError(
      'Failed to Load Shop',
      error.message,
      `<button onclick="promptForShopId()" class="primary" style="margin-top: 10px; padding: 10px 20px;">
        <i class="fas fa-key"></i> Enter Shop ID Manually
      </button>`
    );
  }
}

function promptForShopId() {
  showShopIdModal(
    'Please enter your Shop ID to continue:',
    loadShopInfo
  );
}

function updateShopUI(shopInfo, user) {
  document.getElementById('shopName').innerHTML = `<i class="fas fa-store"></i> ${shopInfo.name || `Shop ${shopInfo.id}`}`;
  document.getElementById('shopIDDisplay').textContent = shopInfo.id;
  
  const detailsHTML = `
    <div class="detail-item">
      <i class="fas fa-user-tie"></i>
      <strong>Manager:</strong> ${user.Username || 'Unknown'}
    </div>
    <div class="detail-item">
      <i class="fas fa-mobile-alt"></i>
      <strong>Mobile:</strong> ${getMobile()}
    </div>
    <div class="detail-item">
      <i class="fas fa-user-shield"></i>
      <strong>Role:</strong> ${user.Role}
    </div>
    ${shopInfo.address ? `
      <div class="detail-item">
        <i class="fas fa-map-marker-alt"></i>
        <strong>Address:</strong> ${shopInfo.address}
      </div>
    ` : ''}
    ${shopInfo.phone ? `
      <div class="detail-item">
        <i class="fas fa-phone"></i>
        <strong>Phone:</strong> ${shopInfo.phone}
      </div>
    ` : ''}
    ${shopInfo.email ? `
      <div class="detail-item">
        <i class="fas fa-envelope"></i>
        <strong>Email:</strong> ${shopInfo.email}
      </div>
    ` : ''}
    ${shopInfo.created ? `
      <div class="detail-item">
        <i class="fas fa-calendar-alt"></i>
        <strong>Created:</strong> ${shopInfo.created}
      </div>
    ` : ''}
  `;
  
  document.getElementById('shopDetails').innerHTML = detailsHTML;
}

async function loadShopStats() {
  try {
    const shopID = getShopID();
    
    const statsPromises = Object.entries(TABLES).map(async ([tableName, tableId]) => {
      if (tableName === 'shops') return null;
      
      try {
        const data = await fetchWithPagination(tableId, { shopID: shopID });
        return { [tableName]: data.length };
      } catch (e) {
        return { [tableName]: 0 };
      }
    });
    
    const statsResults = await Promise.all(statsPromises);
    shopStats = Object.assign({}, ...statsResults.filter(Boolean));
    
    updateStatsUI();
    
  } catch (error) {
    if (error.message !== 'SHOP_ID_REQUIRED') {
      log(`Could not load statistics: ${error.message}`, 'warning');
    }
  }
}

function updateStatsUI() {
  const statsContainer = document.getElementById('statsContainer');
  if (Object.keys(shopStats).length === 0) return;
  
  const tableIcons = {
    'users': 'users',
    'inventory': 'boxes',
    'products': 'shopping-bag',
    'customers': 'user-friends',
    'ledger': 'book',
    'sale': 'receipt',
    'supplier': 'truck',
    'transaction': 'exchange-alt'
  };
  
  const statsHTML = Object.entries(shopStats).map(([table, count]) => `
    <div class="stat-card">
      <i class="fas fa-${tableIcons[table] || 'database'}" style="font-size: 24px; color: #667eea; margin-bottom: 10px;"></i>
      <div class="stat-value">${count}</div>
      <div class="stat-label">${table.charAt(0).toUpperCase() + table.slice(1)}</div>
    </div>
  `).join('');
  
  statsContainer.innerHTML = statsHTML;
}

// ================= BACKUP FUNCTION =================
async function downloadAllData() {
  if (isOperationInProgress) {
    showAlert('Operation in Progress', 'Please wait for the current operation to complete.', 'warning');
    return;
  }
  
  try {
    const shopID = getShopID();
    
    showConfirm(
      'Download Backup',
      `This will download all data for Shop ${shopID} as a JSON backup file.`,
      `<p><i class="fas fa-info-circle"></i> This may take a few moments depending on the amount of data.</p>
       <p><i class="fas fa-download"></i> File will be saved as: <code>SHOP_${shopID}_BACKUP.json</code></p>`,
      'info',
      async () => {
        try {
          setAllButtonsState(true);
          clearLog();
          showProgress(true);
          log('Starting backup process...', 'info');
          
          const backup = {};
          let totalTables = Object.keys(TABLES).length;
          let completedTables = 0;
          
          for (const [tableName, tableId] of Object.entries(TABLES)) {
            if (tableName === 'shops') continue;
            
            log(`Fetching ${tableName} data...`, 'info');
            try {
              const data = await fetchWithPagination(tableId, { shopID: shopID });
              backup[tableName] = data;
              log(`‚úì ${tableName}: ${data.length} records`, 'success');
            } catch (error) {
              log(`‚úó ${tableName}: Failed to fetch`, 'error');
              backup[tableName] = [];
            }
            
            completedTables++;
            setProgress(completedTables, totalTables - 1);
          }
          
          backup.metadata = {
            shopId: shopID,
            shopName: shopInfo?.name || `Shop ${shopID}`,
            mobile: getMobile(),
            backupDate: new Date().toISOString(),
            totalRecords: Object.values(backup).reduce((sum, data) => sum + (Array.isArray(data) ? data.length : 0), 0)
          };
          
          const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `SHOP_${shopID}_${shopInfo?.name?.replace(/\s+/g, '_') || 'BACKUP'}_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          log(`‚úÖ Backup completed! Total records: ${backup.metadata.totalRecords}`, 'success');
          setProgress(totalTables - 1, totalTables - 1, 'Backup complete');
          
          setTimeout(async () => {
            showProgress(false);
            await loadShopStats();
            showSuccess(
              'Backup Complete',
              `Backup file has been downloaded successfully!`,
              `<p><i class="fas fa-file-download"></i> <strong>File Name:</strong> ${a.download}</p>
               <p><i class="fas fa-database"></i> <strong>Total Records:</strong> ${backup.metadata.totalRecords}</p>
               <p><i class="fas fa-calendar"></i> <strong>Backup Date:</strong> ${new Date(backup.metadata.backupDate).toLocaleString()}</p>`
            );
          }, 2000);
          
        } catch (error) {
          showError('Backup Failed', error.message);
          log(`Backup failed: ${error.message}`, 'error');
        } finally {
          setAllButtonsState(false);
        }
      }
    );
    
  } catch (error) {
    if (error.message === 'SHOP_ID_REQUIRED') {
      showShopIdModal(
        'Shop ID is required to create a backup. Please enter your Shop ID:',
        downloadAllData
      );
    } else {
      showError('Backup Failed', error.message);
    }
  }
}

// ================= RESTORE FUNCTION =================
function triggerRestore() {
  if (isOperationInProgress) {
    showAlert('Operation in Progress', 'Please wait for the current operation to complete.', 'warning');
    return;
  }
  
  try {
    getShopID();
    document.getElementById('restoreFile').click();
  } catch (error) {
    if (error.message === 'SHOP_ID_REQUIRED') {
      showShopIdModal(
        'Shop ID is required to restore data. Please enter the Shop ID for this restore operation:',
        triggerRestore
      );
    } else {
      showError('Cannot Start Restore', error.message);
    }
  }
}

document.getElementById('restoreFile').onchange = async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const shopID = getShopID();
    
    showConfirm(
      'Restore Data',
      `This will restore data to Shop ${shopID}. Existing data may be overwritten.`,
      `<p><i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> This operation cannot be undone!</p>
       <p><i class="fas fa-file-import"></i> <strong>File:</strong> ${file.name}</p>
       <p><i class="fas fa-database"></i> <strong>Target Shop:</strong> ${shopID}</p>`,
      'warning',
      async () => {
        try {
          setAllButtonsState(true);
          clearLog();
          showProgress(true);
          showLoading('Restoring Data', 'Reading backup file...');
          
          const backupText = await file.text();
          const backupData = JSON.parse(backupText);
          
          hideLoading();
          
          if (!backupData.metadata || !backupData.metadata.shopId) {
            const backupShopId = prompt(
              'This backup file does not contain Shop ID information.\n\n' +
              'Please enter the Shop ID to use for this restore:\n' +
              '(Leave empty to use current Shop ID)',
              shopID
            );
            
            if (backupShopId === null) {
              setAllButtonsState(false);
              showProgress(false);
              return;
            }
            
            const finalShopId = backupShopId || shopID;
            backupData.metadata = backupData.metadata || {};
            backupData.metadata.shopId = finalShopId;
            backupData.metadata.shopName = `Shop ${finalShopId}`;
            
            log(`Using Shop ID: ${finalShopId} for restore`, 'warning');
          }
          
          const backupShopId = backupData.metadata.shopId;
          
          if (backupShopId !== shopID) {
            showConfirm(
              'Different Shop ID Detected',
              `This backup is for a different shop.`,
              `<p><i class="fas fa-store"></i> <strong>Backup Shop:</strong> ${backupShopId}</p>
               <p><i class="fas fa-store"></i> <strong>Current Shop:</strong> ${shopID}</p>
               <p>Do you want to restore to the backup's Shop ID?</p>`,
              'question',
              () => {
                localStorage.setItem('ShopIDtag', backupShopId);
                log(`Switched to Shop ID: ${backupShopId}`, 'info');
                continueRestore(backupData, backupShopId);
              },
              () => {
                continueRestore(backupData, shopID);
              }
            );
          } else {
            continueRestore(backupData, shopID);
          }
          
        } catch (error) {
          hideLoading();
          showError('Restore Failed', error.message);
          setAllButtonsState(false);
          showProgress(false);
        }
      }
    );
    
  } catch (error) {
    if (error.message === 'SHOP_ID_REQUIRED') {
      showShopIdModal(
        'Shop ID is required to restore data. Please enter your Shop ID:',
        () => {
          e.target.value = '';
          document.getElementById('restoreFile').click();
        }
      );
    } else {
      showError('Restore Failed', error.message);
    }
    e.target.value = '';
  }
};

async function continueRestore(backupData, targetShopID) {
  try {
    log(`Valid backup found for shop: ${backupData.metadata.shopName || 'Unknown'}`, 'success');
    log(`Restoring to Shop ID: ${targetShopID}`, 'info');
    
    let totalRecords = 0;
    const tablesToRestore = [];
    
    for (const [tableName, data] of Object.entries(backupData)) {
      if (tableName === 'metadata') continue;
      if (Array.isArray(data) && data.length > 0) {
        tablesToRestore.push({ tableName, data });
        totalRecords += data.length;
      }
    }
    
    log(`Found ${tablesToRestore.length} tables with ${totalRecords} records`, 'info');
    
    let restoredCount = 0;
    let errors = 0;
    
    for (const { tableName, data } of tablesToRestore) {
      log(`Restoring ${tableName}...`, 'info');
      
      for (const record of data) {
        try {
          const recordToInsert = { ...record };
          delete recordToInsert.id;
          
          if (recordToInsert.ShopID !== undefined) {
            recordToInsert.ShopID = targetShopID;
          }
          
          await fetch(`${BASE_URL}/${TABLES[tableName]}/?user_field_names=true`, {
            method: 'POST',
            headers,
            body: JSON.stringify(recordToInsert)
          });
          
          restoredCount++;
          setProgress(restoredCount, totalRecords);
          
        } catch (error) {
          errors++;
          log(`Failed to restore record in ${tableName}`, 'error');
        }
      }
    }
    
    log(`‚úÖ Restore completed! Success: ${restoredCount - errors}, Failed: ${errors}`, 
        errors === 0 ? 'success' : 'warning');
    
    setTimeout(async () => {
      showProgress(false);
      await loadShopStats();
      
      if (errors === 0) {
        showSuccess(
          'Restore Complete',
          `Data has been restored successfully!`,
          `<p><i class="fas fa-check-circle"></i> <strong>Successfully restored:</strong> ${restoredCount} records</p>
           <p><i class="fas fa-store"></i> <strong>Target Shop:</strong> ${targetShopID}</p>
           <p><i class="fas fa-calendar"></i> <strong>Restore Time:</strong> ${new Date().toLocaleString()}</p>`
        );
      } else {
        showAlert(
          'Restore Completed with Errors',
          `Restore completed with ${errors} errors.`,
          'warning'
        );
      }
    }, 1000);
    
  } catch (error) {
    showError('Restore Failed', error.message);
  } finally {
    setAllButtonsState(false);
    document.getElementById('restoreFile').value = '';
  }
}

// ================= DELETE FUNCTION =================
async function deleteShop() {
  if (isOperationInProgress) {
    showAlert('Operation in Progress', 'Please wait for the current operation to complete.', 'warning');
    return;
  }
  
  try {
    const shopID = getShopID();
    const shopName = shopInfo?.name || `Shop ${shopID}`;
    
    showConfirm(
      '‚ö†Ô∏è DANGER: Delete Shop',
      `This will delete ALL data for "${shopName}". This action is PERMANENT and CANNOT BE UNDONE!`,
      `<p><i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> All shop data will be permanently deleted!</p>
       <p><i class="fas fa-database"></i> <strong>Shop:</strong> ${shopName}</p>
       <p><i class="fas fa-fingerprint"></i> <strong>Shop ID:</strong> ${shopID}</p>
       <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px;">
         <i class="fas fa-skull-crossbones"></i> <strong>This action cannot be undone!</strong>
         <p style="margin: 5px 0 0 0; font-size: 14px;">All records will be permanently removed from the database.</p>
       </div>`,
      'error',
      async () => {
        // Second confirmation
        showConfirm(
          'Final Confirmation',
          `Type "DELETE ${shopName}" to confirm permanent deletion:`,
          `<input type="text" id="deleteConfirmInput" placeholder="Type DELETE ${shopName}" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-top: 10px;">`,
          'error',
          () => {
            const confirmation = document.getElementById('deleteConfirmInput').value;
            if (confirmation !== `DELETE ${shopName}`) {
              showAlert('Cancelled', 'Confirmation text did not match. Deletion cancelled.', 'warning');
              return;
            }
            
            // Third confirmation
            showConfirm(
              'üö® FINAL WARNING',
              `Are you absolutely sure you want to permanently delete "${shopName}"?`,
              `<div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <i class="fas fa-skull-crossbones" style="font-size: 32px; color: #d9534f;"></i>
                <p style="margin: 10px 0; font-weight: bold;">This is your last chance to cancel!</p>
                <p>All data will be lost forever.</p>
              </div>`,
              'error',
              async () => {
                try {
                  setAllButtonsState(true);
                  clearLog();
                  showProgress(true);
                  
                  log('Starting shop deletion process...', 'warning');
                  
                  let totalRecords = 0;
                  const tableCounts = {};
                  
                  for (const [tableName, tableId] of Object.entries(TABLES)) {
                    if (tableName === 'shops') continue;
                    
                    try {
                      const data = await fetchWithPagination(tableId, { shopID: shopID });
                      tableCounts[tableName] = data.length;
                      totalRecords += data.length;
                    } catch (error) {
                      tableCounts[tableName] = 0;
                    }
                  }
                  
                  log(`Found ${totalRecords} records to delete`, 'warning');
                  
                  let deletedCount = 0;
                  let errors = 0;
                  
                  for (const [tableName, tableId] of Object.entries(TABLES)) {
                    if (tableName === 'shops') continue;
                    
                    const count = tableCounts[tableName];
                    if (count === 0) continue;
                    
                    log(`Deleting ${tableName}...`, 'warning');
                    
                    try {
                      const data = await fetchWithPagination(tableId, { shopID: shopID });
                      
                      for (const record of data) {
                        try {
                          await fetch(`${BASE_URL}/${tableId}/${record.id}/`, {
                            method: 'DELETE',
                            headers
                          });
                          deletedCount++;
                          setProgress(deletedCount, totalRecords);
                        } catch (error) {
                          errors++;
                          log(`Failed to delete record in ${tableName}`, 'error');
                        }
                      }
                    } catch (error) {
                      log(`Error accessing ${tableName}`, 'error');
                    }
                  }
                  
                  if (errors > 0) {
                    showAlert(
                      'Deletion Completed with Errors',
                      `Deletion completed with ${errors} errors. ${deletedCount} records were deleted.`,
                      'warning'
                    );
                  } else {
                    showSuccess(
                      'Shop Deleted',
                      `Shop "${shopName}" has been permanently deleted.`,
                      `<p><i class="fas fa-trash-alt"></i> <strong>Records Deleted:</strong> ${deletedCount}</p>
                       <p><i class="fas fa-store"></i> <strong>Shop:</strong> ${shopName}</p>
                       <p><i class="fas fa-calendar"></i> <strong>Deletion Time:</strong> ${new Date().toLocaleString()}</p>`
                    );
                    
                    setTimeout(() => {
                      localStorage.clear();
                      window.location.href = '/login.html';
                    }, 3000);
                  }
                  
                } catch (error) {
                  showError('Deletion Failed', error.message);
                } finally {
                  setAllButtonsState(false);
                  showProgress(false);
                }
              }
            );
          }
        );
      }
    );
    
  } catch (error) {
    if (error.message === 'SHOP_ID_REQUIRED') {
      showShopIdModal(
        'Shop ID is required to delete shop data. Please enter your Shop ID:',
        deleteShop
      );
    } else {
      showError('Deletion Failed', error.message);
    }
  }
}

// ================= INITIALIZATION =================
async function initialize() {
  try {
    log('Initializing shop management system...', 'info');
    await loadShopInfo();
    log('‚úÖ System ready. You can now perform backup, restore, or delete operations.', 'success');
  } catch (error) {
    if (error.message !== 'SHOP_ID_REQUIRED') {
      showError('Initialization Failed', error.message);
    }
  }
}

// Start the application
window.addEventListener('DOMContentLoaded', initialize);

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
      case 'b':
        e.preventDefault();
        if (!isOperationInProgress) downloadAllData();
        break;
      case 'r':
        e.preventDefault();
        if (!isOperationInProgress) triggerRestore();
        break;
      case 'd':
        if (e.shiftKey) {
          e.preventDefault();
          if (!isOperationInProgress) deleteShop();
        }
        break;
    }
  }
  
  if (e.key === 'Escape') {
    const modals = ['shopIdModal', 'confirmModal', 'alertModal', 'loadingModal', 'successModal', 'errorModal'];
    for (const modal of modals) {
      if (document.getElementById(modal).style.display === 'flex') {
        if (modal === 'confirmModal') cancelConfirm();
        else if (modal === 'alertModal') closeAlert();
        else if (modal === 'shopIdModal') cancelShopId();
        else if (modal === 'successModal') closeSuccess();
        else if (modal === 'errorModal') closeError();
        break;
      }
    }
  }
});
</script>
</body>
</html>