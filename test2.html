<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Viewer</title>
  <!-- Include jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #dbeafe;
      --secondary: #7c3aed;
      --light: #f8fafc;
      --dark: #1e293b;
      --dark-light: #334155;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray: #64748b;
      --gray-light: #e2e8f0;
      --border-radius: 12px;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
      font-size: 15px;
    }
    
    .invoice-container {
      max-width: 1100px;
      background: white;
      margin: 30px auto;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--gray-light);
    }
    
    .invoice-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 35px 40px;
      position: relative;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    
    .shop-info {
      text-align: left;
      flex: 1;
      min-width: 300px;
    }
    
    .shop-name {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .shop-details {
      font-size: 16px;
      opacity: 0.95;
      line-height: 1.5;
    }
    
    .shop-address, .shop-phone {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .shop-id {
      font-size: 15px;
      opacity: 0.9;
      margin-top: 15px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.15);
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }
    
    .invoice-tag {
      background: rgba(255, 255, 255, 0.25);
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 16px;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      align-self: flex-end;
    }
    
    .search-section {
      padding: 35px 40px;
      background: white;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .search-container {
      display: flex;
      max-width: 700px;
      margin: 0 auto;
      gap: 15px;
    }
    
    .search-input {
      flex: 1;
      padding: 18px 24px;
      border-radius: var(--border-radius);
      border: 2px solid var(--gray-light);
      font-size: 16px;
      transition: var(--transition);
      background: var(--light);
      font-weight: 500;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    
    .search-btn {
      padding: 18px 32px;
      border: none;
      border-radius: var(--border-radius);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-btn:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
    }
    
    .search-btn:active {
      transform: translateY(0);
    }
    
    .search-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .invoice-body {
      padding: 40px;
    }
    
    .error {
      color: var(--danger);
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: rgba(239, 68, 68, 0.08);
      border-radius: var(--border-radius);
      font-weight: 600;
      border-left: 4px solid var(--danger);
    }
    
    .success {
      color: var(--success);
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: rgba(16, 185, 129, 0.08);
      border-radius: var(--border-radius);
      font-weight: 600;
      border-left: 4px solid var(--success);
    }
    
    .invoice-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
      padding: 30px;
      background: var(--light);
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
    }
    
    .detail-group {
      display: flex;
      flex-direction: column;
    }
    
    .label {
      font-weight: 600;
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .value {
      font-weight: 600;
      color: var(--dark);
      font-size: 18px;
      padding: 10px 0;
      border-bottom: 2px solid var(--primary-light);
    }
    
    /* Customer Info Section */
    .customer-section {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid var(--gray-light);
      box-shadow: var(--shadow-light);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
      color: var(--primary);
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary-light);
    }
    
    .section-header h3 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    
    .customer-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
    }
    
    .customer-field {
      display: flex;
      flex-direction: column;
    }
    
    .field-label {
      font-weight: 600;
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .field-value {
      font-weight: 500;
      color: var(--dark);
      font-size: 16px;
      padding: 14px 16px;
      background: var(--light);
      border-radius: 10px;
      border: 1px solid var(--gray-light);
      min-height: 50px;
      display: flex;
      align-items: center;
    }
    
    /* Items Table */
    .items-table-container {
      overflow-x: auto;
      margin: 40px 0;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      box-shadow: var(--shadow-light);
    }
    
    .items-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    .items-table thead {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }
    
    .items-table th {
      color: white;
      padding: 20px 16px;
      text-align: left;
      font-weight: 700;
      font-size: 15px;
      border: none;
      white-space: nowrap;
    }
    
    .items-table th:first-child {
      border-top-left-radius: 10px;
    }
    
    .items-table th:last-child {
      border-top-right-radius: 10px;
    }
    
    .items-table td {
      padding: 20px 16px;
      border: none;
      background: white;
      vertical-align: middle;
      font-size: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .items-table tbody tr {
      transition: var(--transition);
    }
    
    .items-table tbody tr:hover {
      background: rgba(37, 99, 235, 0.03);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .items-table tbody tr:nth-child(even) {
      background: rgba(0, 0, 0, 0.015);
    }
    
    .items-table tbody tr:nth-child(even):hover {
      background: rgba(37, 99, 235, 0.05);
    }
    
    /* Batch number styling */
    .batch-info {
      font-size: 13px;
      color: var(--gray);
      margin-top: 6px;
      font-weight: 500;
    }
    
    .summary {
      margin-top: 40px;
      padding: 30px;
      background: var(--light);
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
    }
    
    .total-amount {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid var(--gray-light);
      text-align: right;
    }
    
    .tax-details {
      margin-top: 20px;
      padding: 25px;
      background: white;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
    }
    
    .tax-row {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid var(--gray-light);
      font-size: 16px;
    }
    
    .tax-row:last-child {
      border-bottom: none;
      font-weight: 700;
      color: var(--primary);
      font-size: 18px;
      padding-top: 20px;
      margin-top: 10px;
      border-top: 2px solid var(--primary-light);
    }
    
    .tax-label {
      font-weight: 600;
      color: var(--dark);
    }
    
    .tax-value {
      font-weight: 600;
      color: var(--dark);
    }
    
    .tax-breakdown {
      margin-top: 30px;
      padding: 25px;
      background: white;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      box-shadow: var(--shadow-light);
    }
    
    .tax-category {
      margin-bottom: 25px;
    }
    
    .tax-category-title {
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 18px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--primary-light);
    }
    
    .tax-category-items {
      padding-left: 20px;
    }
    
    .tax-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      color: var(--gray);
      font-size: 15px;
      border-bottom: 1px dashed var(--gray-light);
    }
    
    .tax-item:last-child {
      border-bottom: none;
    }
    
    /* Action Buttons */
    .action-buttons-container {
      margin-top: 50px;
      padding-top: 40px;
      border-top: 2px solid var(--gray-light);
    }
    
    .action-buttons-title {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .action-btn {
      padding: 18px 24px;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      text-align: center;
      min-height: 60px;
    }
    
    .whatsapp-btn {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      color: white;
    }
    
    .copy-btn {
      background: linear-gradient(135deg, var(--gray) 0%, #475569 100%);
      color: white;
    }
    
    .template-btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }
    
    .print-btn {
      background: linear-gradient(135deg, #0ea5e9 0%, var(--primary) 100%);
      color: white;
    }
    
    .pdf-btn {
      background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
      color: white;
    }
    
    .action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .whatsapp-btn:hover {
      box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
    }
    
    .copy-btn:hover {
      box-shadow: 0 8px 25px rgba(100, 116, 139, 0.3);
    }
    
    .template-btn:hover {
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
    }
    
    .print-btn:hover {
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
    }
    
    .pdf-btn:hover {
      box-shadow: 0 8px 25px rgba(236, 72, 153, 0.3);
    }
    
    .action-btn i {
      font-size: 20px;
    }
    
    /* Template Selector */
    .template-selector {
      display: none;
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      margin: 30px 0;
      border: 1px solid var(--gray-light);
      box-shadow: var(--shadow-light);
    }
    
    .template-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-top: 25px;
    }
    
    .template-option {
      background: var(--light);
      padding: 25px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
      height: 100%;
    }
    
    .template-option:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow);
      border-color: var(--primary);
    }
    
    .template-option.active {
      border-color: var(--primary);
      background: var(--primary-light);
    }
    
    .template-name {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 12px;
      color: var(--primary);
    }
    
    .template-desc {
      color: var(--gray);
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* Share Section */
    .share-section {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      margin: 30px 0;
      border: 1px solid var(--gray-light);
      box-shadow: var(--shadow-light);
    }
    
    .copy-link-container {
      margin-top: 25px;
    }
    
    .copy-link-input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      font-size: 15px;
      margin-bottom: 15px;
      background: var(--light);
      font-family: 'Courier New', monospace;
      font-weight: 500;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 18px 28px;
      background: var(--dark);
      color: white;
      border-radius: var(--border-radius);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      font-weight: 600;
      max-width: 400px;
      border-left: 5px solid var(--primary);
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    /* Print Styles */
    @media print {
      .search-section, .action-buttons-container, .template-selector, .share-section {
        display: none !important;
      }
      body {
        background: white !important;
        padding: 0 !important;
        margin: 0 !important;
        font-size: 14px !important;
      }
      .invoice-container {
        box-shadow: none !important;
        margin: 0 !important;
        max-width: 100% !important;
        border: none !important;
      }
      .invoice-header {
        padding: 25px !important;
        background: #f1f5f9 !important;
        color: black !important;
        border-bottom: 2px solid #333 !important;
      }
      .invoice-body {
        padding: 25px !important;
      }
      .invoice-details, .customer-section, .tax-details, .tax-breakdown {
        border: 1px solid #ddd !important;
        box-shadow: none !important;
      }
      .action-btn, .search-btn {
        display: none !important;
      }
    }
    
    @media (max-width: 1024px) {
      .invoice-container {
        margin: 15px;
      }
      
      .invoice-header, .search-section, .invoice-body {
        padding: 25px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 20px;
      }
      
      .shop-info {
        text-align: center;
        min-width: auto;
      }
      
      .invoice-tag {
        align-self: center;
        margin-top: 15px;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .invoice-details {
        grid-template-columns: 1fr;
        padding: 25px;
      }
      
      .customer-details {
        grid-template-columns: 1fr;
      }
      
      .items-table {
        min-width: 800px;
      }
      
      .items-table th,
      .items-table td {
        padding: 16px 12px;
        font-size: 14px;
      }
      
      .action-buttons {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
      
      .action-btn {
        padding: 16px 20px;
        font-size: 15px;
      }
      
      .template-options {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 640px) {
      body {
        padding: 10px;
      }
      
      .invoice-header, .search-section, .invoice-body {
        padding: 20px;
      }
      
      .shop-name {
        font-size: 28px;
      }
      
      .shop-details {
        font-size: 15px;
      }
      
      .section-header h3 {
        font-size: 20px;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
      
      .toast {
        bottom: 20px;
        right: 20px;
        left: 20px;
        max-width: none;
      }
    }
    
    /* Animations */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* WhatsApp Preview */
    .whatsapp-preview-container {
      margin-top: 30px;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: var(--border-radius);
      padding: 25px;
    }
    
    .whatsapp-preview {
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
      font-family: 'SF Mono', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      white-space: pre-wrap;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
      font-size: 14px;
      color: #1e293b;
      border-left: 4px solid #25D366;
    }
    
    /* Info Badges */
    .info-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--primary-light);
      border-radius: 8px;
      font-size: 14px;
      color: var(--primary);
      font-weight: 600;
      margin-top: 5px;
    }
    
    /* Batch Number Highlight */
    .batch-highlight {
      background: #e0f2fe;
      color: #0369a1;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      display: inline-block;
    }
    
    /* PDF Generation Loading */
    .pdf-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      flex-direction: column;
      gap: 25px;
    }
    
    .pdf-loading-content {
      background: white;
      padding: 50px;
      border-radius: var(--border-radius);
      text-align: center;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .pdf-loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid var(--gray-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 25px;
    }
    
    .pdf-loading-text {
      color: var(--dark);
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .pdf-loading-subtext {
      color: var(--gray);
      font-size: 16px;
    }
    
    /* Highlight important numbers */
    .highlight-amount {
      color: var(--primary);
      font-weight: 700;
    }
    
    /* Section spacing */
    .section-spacing {
      margin: 40px 0;
    }
    
    /* Status indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .status-success {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    /* Card styling for better readability */
    .card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      border: 1px solid var(--gray-light);
      box-shadow: var(--shadow-light);
      margin-bottom: 25px;
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary-light);
    }
    
    /* Improved table readability */
    .table-cell {
      padding: 15px;
      vertical-align: middle;
    }
    
    .table-header {
      font-weight: 700;
      color: white;
      background: var(--primary);
      padding: 18px 15px;
    }
    
    /* Better contrast for text */
    .text-high-contrast {
      color: var(--dark);
      font-weight: 600;
    }
    
    .text-medium-contrast {
      color: var(--dark-light);
      font-weight: 500;
    }
    
    .text-low-contrast {
      color: var(--gray);
      font-weight: 400;
    }
    
    /* Focus states for accessibility */
    *:focus {
      outline: 3px solid var(--primary-light);
      outline-offset: 2px;
    }
    
    /* Selection color */
    ::selection {
      background-color: var(--primary-light);
      color: var(--dark);
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>
<body>

  <!-- PDF Loading Overlay -->
  <div id="pdfLoading" class="pdf-loading" style="display: none;">
    <div class="pdf-loading-content">
      <div class="pdf-loading-spinner"></div>
      <div class="pdf-loading-text">Generating PDF...</div>
      <div class="pdf-loading-subtext">Please wait while we prepare your invoice PDF</div>
    </div>
  </div>

  <div class="invoice-container">
    <div class="invoice-header">
      <div class="header-content">
        <div class="shop-info">
          <div class="shop-name" id="shopName">Invoice Viewer</div>
          <div class="shop-details">
            <div class="shop-address" id="shopAddress">
              <i class="fas fa-map-marker-alt"></i>
              <span>Loading address...</span>
            </div>
            <div class="shop-phone" id="shopPhone">
              <i class="fas fa-phone"></i>
              <span>Loading phone...</span>
            </div>
          </div>
          <div class="shop-id">
            <i class="fas fa-store"></i>
            <span>Shop ID: <span id="shopTag">Loading...</span></span>
          </div>
        </div>
        <div class="invoice-tag" id="invoiceTag" style="display: none;">
          <i class="fas fa-tag"></i>
          <span id="tagText"></span>
        </div>
      </div>
    </div>

    <div class="search-section" id="searchSection">
      <div class="search-container">
        <input type="text" id="invoiceNumber" class="search-input" placeholder="Enter Invoice Number (e.g. INV1762933901829)" aria-label="Invoice Number">
        <button class="search-btn" id="searchBtn" onclick="fetchInvoice()">
          <i class="fas fa-search" id="searchIcon"></i>
          <span id="btnText">Search Invoice</span>
        </button>
      </div>
    </div>

    <div class="invoice-body">
      <div id="errorMsg" class="error" style="display: none;"></div>
      <div id="successMsg" class="success" style="display: none;"></div>
      
      <div id="invoiceDetails" class="invoice-details" style="display: none;"></div>
      
      <!-- Customer Information Section -->
      <div id="customerSection" class="customer-section" style="display:none;">
        <div class="section-header">
          <i class="fas fa-user-circle fa-2x"></i>
          <h3>Customer Information</h3>
        </div>
        <div class="customer-details" id="customerDetails"></div>
      </div>

      <div id="itemsTable"></div>
      <div id="taxBreakdown"></div>
      <div id="totalAmount" class="summary" style="display: none;"></div>
      
      <!-- Action Buttons Container -->
      <div id="actionButtonsContainer" class="action-buttons-container" style="display:none;">
        <div class="action-buttons-title">
          <i class="fas fa-bolt"></i>
          Invoice Actions
        </div>
        <div id="actionButtons" class="action-buttons">
          <button class="action-btn whatsapp-btn" onclick="shareToWhatsApp()" aria-label="Share to WhatsApp">
            <i class="fab fa-whatsapp"></i>
            <span>Share to WhatsApp</span>
          </button>
          <button class="action-btn copy-btn" onclick="copyInvoiceText()" aria-label="Copy Invoice Text">
            <i class="fas fa-copy"></i>
            <span>Copy Invoice Text</span>
          </button>
          <button class="action-btn pdf-btn" onclick="generatePDF()" aria-label="Download as PDF">
            <i class="fas fa-file-pdf"></i>
            <span>Download as PDF</span>
          </button>
          <button class="action-btn template-btn" onclick="toggleTemplateSelector()" aria-label="Change Template">
            <i class="fas fa-palette"></i>
            <span>Change Template</span>
          </button>
          <button class="action-btn print-btn" onclick="window.print()" aria-label="Print Invoice">
            <i class="fas fa-print"></i>
            <span>Print Invoice</span>
          </button>
        </div>
      </div>
      
      <!-- Template Selector -->
      <div id="templateSelector" class="template-selector">
        <h3 class="section-header" style="border: none; padding: 0; margin: 0 0 25px 0;">
          <i class="fas fa-paint-brush"></i>
          <span>Choose Invoice Template</span>
        </h3>
        <div class="template-options">
          <div class="template-option active" data-template="modern" onclick="changeTemplate('modern')">
            <div class="template-name">Modern Gradient</div>
            <div class="template-desc">Clean modern design with detailed tax breakdown and improved readability</div>
          </div>
          <div class="template-option" data-template="whatsapp" onclick="changeTemplate('whatsapp')">
            <div class="template-name">WhatsApp Style</div>
            <div class="template-desc">Formatted exactly like WhatsApp bill template with clear tax details</div>
          </div>
          <div class="template-option" data-template="detailed" onclick="changeTemplate('detailed')">
            <div class="template-name">Detailed Tax View</div>
            <div class="template-desc">Comprehensive tax calculation breakdown with enhanced readability</div>
          </div>
          <div class="template-option" data-template="compact" onclick="changeTemplate('compact')">
            <div class="template-name">Compact View</div>
            <div class="template-desc">Space-efficient design with essential tax info and clear typography</div>
          </div>
        </div>
      </div>
      
      <!-- Share Section -->
      <div id="shareSection" class="share-section" style="display:none;">
        <h3 class="section-header" style="border: none; padding: 0; margin: 0 0 20px 0;">
          <i class="fas fa-share-alt"></i>
          <span>Share Invoice</span>
        </h3>
        <div class="copy-link-container">
          <p class="text-medium-contrast" style="margin-bottom: 15px;">Share this link to view invoice:</p>
          <input type="text" id="invoiceLink" class="copy-link-input" readonly aria-label="Invoice Share Link">
          <button class="action-btn copy-btn" onclick="copyInvoiceLink()" style="padding: 14px 24px; width: 100%; max-width: 200px;">
            <i class="fas fa-link"></i>
            <span>Copy Link</span>
          </button>
        </div>
        
        <!-- WhatsApp Template Preview -->
        <div id="whatsappPreview" style="margin-top: 35px; display: none;">
          <h4 style="color: #25D366; margin-bottom: 15px; font-weight: 700; font-size: 18px;">
            <i class="fab fa-whatsapp"></i>
            WhatsApp Preview:
          </h4>
          <div class="whatsapp-preview-container">
            <div id="whatsappTemplatePreview" class="whatsapp-preview"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    
    const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
    const salesTableId = 736209;
    const productTableId = 734793;
    const salesUrl = `https://api.baserow.io/api/database/rows/table/${salesTableId}/?user_field_names=true`;
    const productUrl = `https://api.baserow.io/api/database/rows/table/${productTableId}/?user_field_names=true`;
    
    let currentInvoiceData = null;
    let currentInvoiceNumber = null;
    let currentTemplate = 'modern';
    let shopGST = "Not Available";
    let taxBreakdownByRate = {};

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      loadShopInfo();
      
      const urlParams = new URLSearchParams(window.location.search);
      const invoiceParam = urlParams.get('invoice');
      
      if (invoiceParam) {
        document.getElementById('searchSection').style.display = 'none';
        document.getElementById('invoiceNumber').value = invoiceParam;
        fetchInvoice();
      }
      
      const savedTemplate = localStorage.getItem('invoiceTemplate') || 'modern';
      changeTemplate(savedTemplate, false);
      
      // Add keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'p') {
          e.preventDefault();
          window.print();
        }
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          generatePDF();
        }
      });
    });

    function parseShopTag(shopTag) {
      let shopName = "Invoice Viewer Pro";
      let address = "Business Address Not Available";
      let phone = "Phone Not Available";
      
      if (shopTag) {
        const firstSplit = shopTag.split('-');
        if (firstSplit.length > 1) {
          shopName = firstSplit[0].trim();
          const secondSplit = firstSplit[1].split('/');
          if (secondSplit.length > 1) {
            address = secondSplit[0].trim();
            phone = secondSplit[1].trim();
          } else {
            address = firstSplit[1].trim();
          }
        } else {
          shopName = shopTag.trim();
        }
      }
      
      return { shopName, address, phone };
    }

    function loadShopInfo() {
      const shopIDTag = localStorage.getItem("ShopIDTag");
      const shopTagValue = localStorage.getItem("ShopTag") || "Invoice Viewer Pro - Business Address/Phone";
      const shopInfo = parseShopTag(shopTagValue);
      
      if (shopIDTag) {
        document.getElementById('shopTag').textContent = shopIDTag;
        document.getElementById('shopName').textContent = shopInfo.shopName;
        document.getElementById('shopAddress').innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${shopInfo.address}</span>`;
        document.getElementById('shopPhone').innerHTML = `<i class="fas fa-phone"></i><span>${shopInfo.phone}</span>`;
      } else {
        document.getElementById('shopTag').textContent = "Not Set";
        document.getElementById('shopName').textContent = "Invoice Viewer";
        document.getElementById('shopAddress').innerHTML = '<i class="fas fa-map-marker-alt"></i><span>Please set your shop information</span>';
        document.getElementById('shopPhone').innerHTML = '<i class="fas fa-phone"></i><span>Update shop details</span>';
      }
    }

    function formatDate(dateString) {
      if (!dateString) return "N/A";
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
      } catch (error) {
        return dateString;
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    function calculateTaxes(price, quantity, taxPercentage, taxIncluded) {
      const totalAmount = price * quantity;
      let taxableAmount, taxAmount, sgst, cgst;
      
      if (taxIncluded) {
        // If tax is included in the price
        taxableAmount = totalAmount / (1 + (taxPercentage / 100));
        taxAmount = totalAmount - taxableAmount;
      } else {
        // If tax is not included in the price
        taxableAmount = totalAmount;
        taxAmount = taxableAmount * (taxPercentage / 100);
      }
      
      // Split tax equally between SGST and CGST
      sgst = taxAmount / 2;
      cgst = taxAmount / 2;
      
      return {
        taxableAmount,
        taxAmount,
        sgst,
        cgst,
        total: taxableAmount + taxAmount
      };
    }

    async function fetchInvoice() {
      const invoiceNumber = document.getElementById("invoiceNumber").value.trim();
      const shopIDTag = localStorage.getItem("ShopIDTag");
      const detailsDiv = document.getElementById("invoiceDetails");
      const customerSection = document.getElementById("customerSection");
      const customerDetails = document.getElementById("customerDetails");
      const errorDiv = document.getElementById("errorMsg");
      const successDiv = document.getElementById("successMsg");
      const itemsDiv = document.getElementById("itemsTable");
      const taxBreakdownDiv = document.getElementById("taxBreakdown");
      const totalDiv = document.getElementById("totalAmount");
      const actionButtonsContainer = document.getElementById("actionButtonsContainer");
      const actionButtons = document.getElementById("actionButtons");
      const shareSection = document.getElementById("shareSection");
      const searchBtn = document.getElementById("searchBtn");
      const btnText = document.getElementById("btnText");
      const searchIcon = document.getElementById("searchIcon");
      const invoiceTag = document.getElementById("invoiceTag");
      const tagText = document.getElementById("tagText");

      // Reset displays
      detailsDiv.innerHTML = "";
      detailsDiv.style.display = "none";
      customerSection.style.display = "none";
      customerDetails.innerHTML = "";
      errorDiv.style.display = "none";
      successDiv.style.display = "none";
      itemsDiv.innerHTML = "";
      taxBreakdownDiv.innerHTML = "";
      totalDiv.innerHTML = "";
      totalDiv.style.display = "none";
      actionButtonsContainer.style.display = "none";
      actionButtons.style.display = "none";
      shareSection.style.display = "none";
      invoiceTag.style.display = "none";
      currentInvoiceData = null;
      taxBreakdownByRate = {};

      // Show loading state
      searchBtn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> Searching...';
      searchIcon.className = "fas fa-spinner fa-spin";

      if (!invoiceNumber) {
        errorDiv.textContent = "⚠️ Please enter an invoice number.";
        errorDiv.style.display = "block";
        searchBtn.disabled = false;
        btnText.textContent = "Search Invoice";
        searchIcon.className = "fas fa-search";
        return;
      }

      if (!shopIDTag) {
        errorDiv.textContent = "⚠️ ShopIDTag not found. Please log in first.";
        errorDiv.style.display = "block";
        searchBtn.disabled = false;
        btnText.textContent = "Search Invoice";
        searchIcon.className = "fas fa-search";
        return;
      }

      try {
        const [productResponse, salesResponse] = await Promise.all([
          fetch(productUrl, { headers: { Authorization: `Token ${apiKey}` } }),
          fetch(salesUrl, { headers: { Authorization: `Token ${apiKey}` } })
        ]);
        
        const productData = await productResponse.json();
        const salesData = await salesResponse.json();

        const invoiceRows = salesData.results.filter(
          row => row["Invoice Number"] === invoiceNumber && row["ShopID"] === shopIDTag
        );

        if (invoiceRows.length === 0) {
          errorDiv.textContent = "❌ No invoice found for this number or invalid ShopID.";
          errorDiv.style.display = "block";
          searchBtn.disabled = false;
          btnText.textContent = "Search Invoice";
          searchIcon.className = "fas fa-search";
          return;
        }

        // Get shop GST from first row
        shopGST = invoiceRows[0]["GST"] || "Not Available";
        
        // Store invoice data
        currentInvoiceData = {
          invoice: invoiceRows[0],
          rows: invoiceRows,
          productData: productData.results
        };
        currentInvoiceNumber = invoiceNumber;

        // Display invoice
        displayInvoice();

        // Show success message
        successDiv.textContent = "✅ Invoice loaded successfully!";
        successDiv.style.display = "block";

        // Show action buttons and share section
        actionButtonsContainer.style.display = "block";
        actionButtons.style.display = "flex";
        shareSection.style.display = "block";
        
        // Generate and display shareable link
        const shareableLink = generateShareableLink(invoiceNumber);
        document.getElementById('invoiceLink').value = shareableLink;
        
        // Show WhatsApp preview
        if (currentTemplate === 'whatsapp') {
          document.getElementById('whatsappPreview').style.display = 'block';
          displayWhatsAppPreview();
        }
        
        // Update URL
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('invoice', invoiceNumber);
        window.history.pushState({}, '', newUrl);
        
        showToast('✅ Invoice loaded successfully!');
        
      } catch (error) {
        console.error(error);
        errorDiv.textContent = "⚠️ Error fetching data. Please try again.";
        errorDiv.style.display = "block";
        showToast('❌ Error loading invoice');
      } finally {
        searchBtn.disabled = false;
        btnText.textContent = "Search Invoice";
        searchIcon.className = "fas fa-search";
      }
    }

    function displayInvoice() {
      if (!currentInvoiceData) return;
      
      const { invoice, rows, productData } = currentInvoiceData;
      const detailsDiv = document.getElementById("invoiceDetails");
      const customerSection = document.getElementById("customerSection");
      const customerDetails = document.getElementById("customerDetails");
      const itemsDiv = document.getElementById("itemsTable");
      const taxBreakdownDiv = document.getElementById("taxBreakdown");
      const totalDiv = document.getElementById("totalAmount");
      const invoiceTag = document.getElementById("invoiceTag");
      const tagText = document.getElementById("tagText");

      // Display invoice tag
      if (invoice["Tag"]) {
        tagText.textContent = invoice["Tag"];
        invoiceTag.style.display = "flex";
      }

      // Apply current template
      applyTemplate();

      // Reset tax breakdown
      taxBreakdownByRate = {};
      
      // Calculate totals
      let grandTotal = 0;
      let totalTaxableAmount = 0;
      let totalSGST = 0;
      let totalCGST = 0;
      let totalTaxAmount = 0;
      let itemCount = 0;

      // Display invoice details section
      detailsDiv.innerHTML = `
        <div class="detail-group">
          <span class="label">Invoice Number</span>
          <span class="value text-high-contrast">${invoice["Invoice Number"]}</span>
        </div>
        <div class="detail-group">
          <span class="label">Invoice Date</span>
          <span class="value text-high-contrast">${formatDate(invoice["Date"])}</span>
        </div>
        <div class="detail-group">
          <span class="label">Sales Person</span>
          <span class="value text-high-contrast">${invoice["Sales Person"] || "Not Specified"}</span>
        </div>
        <div class="detail-group">
          <span class="label">Shop GST</span>
          <span class="value text-high-contrast">${shopGST}</span>
        </div>
      `;
      detailsDiv.style.display = "grid";

      // Display customer information section
      customerSection.style.display = "block";
      customerDetails.innerHTML = `
        <div class="customer-field">
          <span class="field-label">Customer Name</span>
          <div class="field-value text-high-contrast">${invoice["Costomer Name"] || "Not Specified"}</div>
        </div>
        <div class="customer-field">
          <span class="field-label">Customer Phone</span>
          <div class="field-value text-high-contrast">${invoice["Mobile"] || "Not Provided"}</div>
        </div>
        <div class="customer-field">
          <span class="field-label">Customer GST</span>
          <div class="field-value text-high-contrast">${invoice["GST"] || "Not Registered"}</div>
        </div>
        <div class="customer-field" style="grid-column: 1 / -1;">
          <span class="field-label">Customer Address</span>
          <div class="field-value text-high-contrast">${invoice["Address"] || "Not Provided"}</div>
        </div>
      `;

      // Build items table based on template
      let tableHTML = '';
      
      if (currentTemplate === 'detailed' || currentTemplate === 'modern') {
        tableHTML = `
          <div class="items-table-container">
            <table class="items-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Item Description</th>
                  <th>Batch No</th>
                  <th>Qty</th>
                  <th>Rate (₹)</th>
                  <th>Tax Rate</th>
                  <th>Taxable Amt (₹)</th>
                  <th>SGST (₹)</th>
                  <th>CGST (₹)</th>
                  <th>Total (₹)</th>
                </tr>
              </thead>
              <tbody>
        `;
      } else if (currentTemplate === 'compact') {
        tableHTML = `
          <div class="items-table-container">
            <table class="items-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Item</th>
                  <th>Batch</th>
                  <th>Qty</th>
                  <th>Rate</th>
                  <th>Tax %</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
        `;
      } else if (currentTemplate === 'whatsapp') {
        tableHTML = `
          <div class="items-table-container">
            <table class="items-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Item Description</th>
                  <th>Batch</th>
                  <th>Qty</th>
                  <th>Rate</th>
                  <th>Tax %</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
        `;
      }

      rows.forEach((row, index) => {
        const product = productData.find(p => p["Product ID"] === row["Product ID"]);
        const productName = product ? product["Product Name"] : "Not Found";
        const quantity = Number(row["Quantity"]) || 0;
        const price = Number(row["Price"]) || 0;
        const taxIncluded = product ? product["Tax Included"] : false;
        const taxPercentage = product ? Number(product["Tax Percentage"]) || 0 : 0;
        const batchNo = row["Batch No"] || "N/A";
        
        const taxes = calculateTaxes(price, quantity, taxPercentage, taxIncluded);
        
        // Update tax breakdown by rate
        if (!taxBreakdownByRate[taxPercentage]) {
          taxBreakdownByRate[taxPercentage] = {
            taxableAmount: 0,
            sgst: 0,
            cgst: 0,
            taxAmount: 0,
            count: 0
          };
        }
        taxBreakdownByRate[taxPercentage].taxableAmount += taxes.taxableAmount;
        taxBreakdownByRate[taxPercentage].sgst += taxes.sgst;
        taxBreakdownByRate[taxPercentage].cgst += taxes.cgst;
        taxBreakdownByRate[taxPercentage].taxAmount += taxes.taxAmount;
        taxBreakdownByRate[taxPercentage].count++;
        
        grandTotal += taxes.total;
        totalTaxableAmount += taxes.taxableAmount;
        totalSGST += taxes.sgst;
        totalCGST += taxes.cgst;
        totalTaxAmount += taxes.taxAmount;
        itemCount++;

        if (currentTemplate === 'detailed' || currentTemplate === 'modern') {
          tableHTML += `
            <tr>
              <td class="text-high-contrast">${index + 1}</td>
              <td>
                <div class="text-high-contrast" style="font-weight: 600; margin-bottom: 4px;">${productName}</div>
                <div class="batch-info text-medium-contrast">Product ID: ${row["Product ID"]}</div>
              </td>
              <td>
                <span class="batch-highlight">${batchNo}</span>
              </td>
              <td class="text-high-contrast">${quantity}</td>
              <td class="text-high-contrast">${formatCurrency(price)}</td>
              <td class="text-high-contrast">${taxPercentage}%</td>
              <td class="text-high-contrast">${formatCurrency(taxes.taxableAmount)}</td>
              <td class="text-high-contrast">${formatCurrency(taxes.sgst)}</td>
              <td class="text-high-contrast">${formatCurrency(taxes.cgst)}</td>
              <td class="text-high-contrast" style="font-weight: 700;">${formatCurrency(taxes.total)}</td>
            </tr>
          `;
        } else if (currentTemplate === 'compact') {
          tableHTML += `
            <tr>
              <td class="text-high-contrast">${index + 1}</td>
              <td class="text-high-contrast">${productName}</td>
              <td><span class="batch-highlight">${batchNo}</span></td>
              <td class="text-high-contrast">${quantity}</td>
              <td class="text-high-contrast">${formatCurrency(price)}</td>
              <td class="text-high-contrast">${taxPercentage}%</td>
              <td class="text-high-contrast" style="font-weight: 700;">${formatCurrency(taxes.total)}</td>
            </tr>
          `;
        } else if (currentTemplate === 'whatsapp') {
          tableHTML += `
            <tr>
              <td class="text-high-contrast">${index + 1}</td>
              <td>
                <div class="text-high-contrast" style="font-weight: 600;">${productName}</div>
                <div class="batch-info text-medium-contrast">Batch: ${batchNo}</div>
              </td>
              <td class="text-high-contrast">${batchNo}</td>
              <td class="text-high-contrast">${quantity}</td>
              <td class="text-high-contrast">${formatCurrency(price)}</td>
              <td class="text-high-contrast">${taxPercentage}%</td>
              <td class="text-high-contrast" style="font-weight: 700;">${formatCurrency(taxes.total)}</td>
            </tr>
          `;
        }
      });

      tableHTML += `</tbody></table></div>`;
      itemsDiv.innerHTML = tableHTML;
      
      // Calculate effective tax percentage
      const effectiveTaxPercentage = totalTaxableAmount > 0 ? 
        (totalTaxAmount / totalTaxableAmount * 100).toFixed(2) : "0.00";
      
      // Build tax breakdown section for detailed templates
      if (currentTemplate === 'detailed' || currentTemplate === 'modern') {
        let taxBreakdownHTML = '<div class="tax-breakdown fade-in">';
        taxBreakdownHTML += '<div class="section-header" style="border: none; padding: 0; margin: 0 0 20px 0;">';
        taxBreakdownHTML += '<i class="fas fa-chart-pie"></i>';
        taxBreakdownHTML += '<h3>Tax Breakdown by Rate</h3>';
        taxBreakdownHTML += '</div>';
        taxBreakdownHTML += '<div class="tax-category-items">';
        
        // Sort tax rates
        const sortedRates = Object.keys(taxBreakdownByRate).sort((a, b) => parseFloat(a) - parseFloat(b));
        
        sortedRates.forEach(rate => {
          const rateData = taxBreakdownByRate[rate];
          if (parseFloat(rate) > 0) {
            taxBreakdownHTML += `
              <div class="tax-item">
                <span class="text-medium-contrast">Items @ ${rate}% GST (${rateData.count} items):</span>
                <span class="text-high-contrast" style="font-weight: 600;">${formatCurrency(rateData.taxableAmount)}</span>
              </div>
              <div class="tax-item">
                <span class="text-low-contrast">&nbsp;&nbsp;SGST @ ${(rate/2).toFixed(2)}%:</span>
                <span class="text-high-contrast">${formatCurrency(rateData.sgst)}</span>
              </div>
              <div class="tax-item">
                <span class="text-low-contrast">&nbsp;&nbsp;CGST @ ${(rate/2).toFixed(2)}%:</span>
                <span class="text-high-contrast">${formatCurrency(rateData.cgst)}</span>
              </div>
            `;
          }
        });
        
        taxBreakdownHTML += '</div></div>';
        taxBreakdownDiv.innerHTML = taxBreakdownHTML;
      }
      
      // Build total section with tax details
      totalDiv.style.display = "block";
      let taxDetailsHTML = `
        <div class="section-header" style="border: none; padding: 0; margin: 0 0 25px 0;">
          <i class="fas fa-calculator"></i>
          <h3>Invoice Summary</h3>
        </div>
        <div class="tax-details">
          <div class="tax-row">
            <span class="tax-label text-medium-contrast">Total Items:</span>
            <span class="tax-value text-high-contrast">${itemCount}</span>
          </div>
          <div class="tax-row">
            <span class="tax-label text-medium-contrast">Taxable Amount:</span>
            <span class="tax-value text-high-contrast">${formatCurrency(totalTaxableAmount)}</span>
          </div>
      `;
      
      if (totalTaxAmount > 0) {
        taxDetailsHTML += `
          <div class="tax-row">
            <span class="tax-label text-medium-contrast">SGST (${(parseFloat(effectiveTaxPercentage)/2).toFixed(2)}%):</span>
            <span class="tax-value text-high-contrast">${formatCurrency(totalSGST)}</span>
          </div>
          <div class="tax-row">
            <span class="tax-label text-medium-contrast">CGST (${(parseFloat(effectiveTaxPercentage)/2).toFixed(2)}%):</span>
            <span class="tax-value text-high-contrast">${formatCurrency(totalCGST)}</span>
          </div>
          <div class="tax-row">
            <span class="tax-label text-medium-contrast">Total GST:</span>
            <span class="tax-value text-high-contrast">${formatCurrency(totalTaxAmount)}</span>
          </div>
        `;
      } else {
        taxDetailsHTML += `
          <div class="tax-row">
            <span class="tax-label text-medium-contrast">GST:</span>
            <span class="tax-value text-high-contrast">NIL</span>
          </div>
        `;
      }
      
      taxDetailsHTML += `
          <div class="tax-row">
            <span class="tax-label text-high-contrast" style="font-size: 18px;">Grand Total:</span>
            <span class="tax-value text-high-contrast" style="font-size: 22px; color: var(--primary);">${formatCurrency(grandTotal)}</span>
          </div>
        </div>
      `;
      
      totalDiv.innerHTML = taxDetailsHTML;
      
      // Add animations
      detailsDiv.classList.add('fade-in');
      customerSection.classList.add('fade-in');
      itemsDiv.classList.add('fade-in');
      if (taxBreakdownDiv.innerHTML) {
        taxBreakdownDiv.classList.add('fade-in');
      }
      totalDiv.classList.add('fade-in');
      
      // Display WhatsApp preview if needed
      if (currentTemplate === 'whatsapp') {
        displayWhatsAppPreview();
      }
    }

    function displayWhatsAppPreview() {
      if (!currentInvoiceData) return;
      
      const { invoice, rows, productData } = currentInvoiceData;
      const shopInfo = parseShopTag(localStorage.getItem("ShopTag") || "Invoice Viewer Pro");
      
      // Calculate totals
      let grandTotal = 0;
      let totalTaxableAmount = 0;
      let totalSGST = 0;
      let totalCGST = 0;
      let totalTaxAmount = 0;
      
      // Build items list with batch numbers
      let itemsList = '';
      rows.forEach((row, index) => {
        const product = productData.find(p => p["Product ID"] === row["Product ID"]);
        const productName = product ? product["Product Name"] : "Not Found";
        const quantity = Number(row["Quantity"]) || 0;
        const price = Number(row["Price"]) || 0;
        const taxIncluded = product ? product["Tax Included"] : false;
        const taxPercentage = product ? Number(product["Tax Percentage"]) || 0 : 0;
        const batchNo = row["Batch No"] || "N/A";
        
        const taxes = calculateTaxes(price, quantity, taxPercentage, taxIncluded);
        const total = taxes.taxableAmount + taxes.taxAmount;
        
        grandTotal += total;
        totalTaxableAmount += taxes.taxableAmount;
        totalSGST += taxes.sgst;
        totalCGST += taxes.cgst;
        totalTaxAmount += taxes.taxAmount;
        
        itemsList += `${index + 1}. ${productName} (Batch: ${batchNo})\n   Qty: ${quantity} x ${formatCurrency(price)} = ${formatCurrency(total)}\n   GST: ${taxPercentage}% (SGST: ${(taxPercentage/2).toFixed(2)}%, CGST: ${(taxPercentage/2).toFixed(2)}%)\n\n`;
      });
      
      // Calculate effective tax rates
      const effectiveTaxPercentage = totalTaxableAmount > 0 ? 
        (totalTaxAmount / totalTaxableAmount * 100).toFixed(2) : "0.00";
      const cgstRate = (parseFloat(effectiveTaxPercentage) / 2).toFixed(2);
      const sgstRate = (parseFloat(effectiveTaxPercentage) / 2).toFixed(2);
      
      // Generate WhatsApp template
      const whatsappTemplate = `*${shopInfo.shopName}*
${shopInfo.address}
📞 Ph: ${shopInfo.phone}
📍 GSTIN: ${shopGST}

🧾 *TAX INVOICE*
━━━━━━━━━━━━━━━━━━━━
📋 Invoice No : ${invoice["Invoice Number"]}
📅 Date       : ${formatDate(invoice["Date"])}
👤 Sales By   : ${invoice["Sales Person"] || "Not Specified"}

👤 *CUSTOMER DETAILS*
━━━━━━━━━━━━━━━━━━━━
👤 Name    : ${invoice["Costomer Name"] || "Not Specified"}
📱 Phone   : ${invoice["Mobile"] || "Not Provided"}
🏠 Address : ${invoice["Address"] || "Not Provided"}
📋 GST No  : ${invoice["GST"] || "Not Registered"}

📦 *ITEM DETAILS (with Batch Numbers)*
━━━━━━━━━━━━━━━━━━━━
${itemsList}
📊 *TAX SUMMARY*
━━━━━━━━━━━━━━━━━━━━
Taxable Amount : ${formatCurrency(totalTaxableAmount)}
CGST @ ${cgstRate}% : ${formatCurrency(totalCGST)}
SGST @ ${sgstRate}% : ${formatCurrency(totalSGST)}
━━━━━━━━━━━━━━━━━━━━
*GRAND TOTAL : ${formatCurrency(grandTotal)}*
━━━━━━━━━━━━━━━━━━━━

🔗 *Invoice Link:*
${generateShareableLink(currentInvoiceNumber)}

📞 *Contact for Queries:*
${shopInfo.phone}

Thank you for your Business! 🙏
*Terms:*
• Goods once sold will not be taken back
• Subject to ${shopInfo.shopName} jurisdiction`;
      
      // Display preview
      document.getElementById('whatsappTemplatePreview').textContent = whatsappTemplate;
    }

    function applyTemplate() {
      const container = document.querySelector('.invoice-container');
      const header = document.querySelector('.invoice-header');
      
      // Reset styles
      container.style = '';
      header.style = '';
      
      switch(currentTemplate) {
        case 'modern':
          // Default styles already applied
          break;
          
        case 'whatsapp':
          container.style.backgroundColor = '#ffffff';
          header.style.background = 'linear-gradient(135deg, #25D366 0%, #128C7E 100%)';
          header.style.color = 'white';
          break;
          
        case 'detailed':
          container.style.backgroundColor = '#ffffff';
          header.style.background = 'linear-gradient(135deg, #1e293b 0%, #334155 100%)';
          break;
          
        case 'compact':
          container.style.padding = '0';
          header.style.padding = '25px';
          document.querySelector('.invoice-body').style.padding = '25px';
          break;
      }
    }

    function changeTemplate(templateName, updateDisplay = true) {
      currentTemplate = templateName;
      localStorage.setItem('invoiceTemplate', templateName);
      
      // Update active template in selector
      document.querySelectorAll('.template-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.template === templateName) {
          option.classList.add('active');
        }
      });
      
      // Show/hide WhatsApp preview
      const whatsappPreview = document.getElementById('whatsappPreview');
      if (templateName === 'whatsapp' && currentInvoiceData) {
        whatsappPreview.style.display = 'block';
        displayWhatsAppPreview();
      } else {
        whatsappPreview.style.display = 'none';
      }
      
      // Re-display invoice if we have data
      if (currentInvoiceData && updateDisplay) {
        displayInvoice();
      }
      
      showToast(`✅ Template changed to ${templateName}`);
    }

    function toggleTemplateSelector() {
      const selector = document.getElementById('templateSelector');
      selector.style.display = selector.style.display === 'block' ? 'none' : 'block';
    }

    function generateShareableLink(invoiceNumber) {
      const baseUrl = window.location.origin + window.location.pathname;
      return `${baseUrl}?invoice=${encodeURIComponent(invoiceNumber)}`;
    }

    function copyInvoiceLink() {
      const linkInput = document.getElementById('invoiceLink');
      linkInput.select();
      linkInput.setSelectionRange(0, 99999);
      
      navigator.clipboard.writeText(linkInput.value)
        .then(() => showToast('✅ Invoice link copied to clipboard!'))
        .catch(() => {
          document.execCommand('copy');
          showToast('✅ Invoice link copied to clipboard!');
        });
    }

    function shareToWhatsApp() {
      if (!currentInvoiceData) {
        showToast('⚠️ Please load an invoice first');
        return;
      }
      
      const { invoice, rows, productData } = currentInvoiceData;
      const shopInfo = parseShopTag(localStorage.getItem("ShopTag") || "Invoice Viewer Pro");
      
      // Calculate totals
      let grandTotal = 0;
      let totalTaxableAmount = 0;
      let totalSGST = 0;
      let totalCGST = 0;
      let totalTaxAmount = 0;
      
      // Build items list with batch numbers
      let itemsList = '';
      rows.forEach((row, index) => {
        const product = productData.find(p => p["Product ID"] === row["Product ID"]);
        const productName = product ? product["Product Name"] : "Not Found";
        const quantity = Number(row["Quantity"]) || 0;
        const price = Number(row["Price"]) || 0;
        const taxIncluded = product ? product["Tax Included"] : false;
        const taxPercentage = product ? Number(product["Tax Percentage"]) || 0 : 0;
        const batchNo = row["Batch No"] || "N/A";
        
        const taxes = calculateTaxes(price, quantity, taxPercentage, taxIncluded);
        const total = taxes.taxableAmount + taxes.taxAmount;
        
        grandTotal += total;
        totalTaxableAmount += taxes.taxableAmount;
        totalSGST += taxes.sgst;
        totalCGST += taxes.cgst;
        totalTaxAmount += taxes.taxAmount;
        
        itemsList += `${index + 1}. ${productName} (Batch: ${batchNo})\n   Qty: ${quantity} x ${formatCurrency(price)} = ${formatCurrency(total)}\n   GST: ${taxPercentage}% (SGST: ${(taxPercentage/2).toFixed(2)}%, CGST: ${(taxPercentage/2).toFixed(2)}%)\n\n`;
      });
      
      // Calculate effective tax rates
      const effectiveTaxPercentage = totalTaxableAmount > 0 ? 
        (totalTaxAmount / totalTaxableAmount * 100).toFixed(2) : "0.00";
      const cgstRate = (parseFloat(effectiveTaxPercentage) / 2).toFixed(2);
      const sgstRate = (parseFloat(effectiveTaxPercentage) / 2).toFixed(2);
      
      // Create WhatsApp message
      const message = `*${shopInfo.shopName}*
${shopInfo.address}
📞 Ph: ${shopInfo.phone}
📍 GSTIN: ${shopGST}

🧾 *TAX INVOICE*
━━━━━━━━━━━━━━━━━━━━
📋 Invoice No : ${invoice["Invoice Number"]}
📅 Date       : ${formatDate(invoice["Date"])}
👤 Sales By   : ${invoice["Sales Person"] || "Not Specified"}

👤 *CUSTOMER DETAILS*
━━━━━━━━━━━━━━━━━━━━
👤 Name    : ${invoice["Costomer Name"] || "Not Specified"}
📱 Phone   : ${invoice["Mobile"] || "Not Provided"}
🏠 Address : ${invoice["Address"] || "Not Provided"}
📋 GST No  : ${invoice["GST"] || "Not Registered"}

📦 *ITEM DETAILS (with Batch Numbers)*
━━━━━━━━━━━━━━━━━━━━
${itemsList}
📊 *TAX SUMMARY*
━━━━━━━━━━━━━━━━━━━━
Taxable Amount : ${formatCurrency(totalTaxableAmount)}
CGST @ ${cgstRate}% : ${formatCurrency(totalCGST)}
SGST @ ${sgstRate}% : ${formatCurrency(totalSGST)}
━━━━━━━━━━━━━━━━━━━━
*GRAND TOTAL : ${formatCurrency(grandTotal)}*
━━━━━━━━━━━━━━━━━━━━

🔗 *Invoice Link:*
${generateShareableLink(currentInvoiceNumber)}

📞 *Contact for Queries:*
${shopInfo.phone}

Thank you for your Business! 🙏
*Terms:*
• Goods once sold will not be taken back
• Subject to ${shopInfo.shopName} jurisdiction`;
      
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
    }

    function copyInvoiceText() {
      if (!currentInvoiceData) {
        showToast('⚠️ Please load an invoice first');
        return;
      }
      
      const { invoice, rows, productData } = currentInvoiceData;
      const shopInfo = parseShopTag(localStorage.getItem("ShopTag") || "Invoice Viewer Pro");
      
      // Calculate totals
      let grandTotal = 0;
      let totalTaxableAmount = 0;
      let totalSGST = 0;
      let totalCGST = 0;
      let totalTaxAmount = 0;
      
      // Build detailed text version
      let text = `TAX INVOICE\n`;
      text += `============\n\n`;
      text += `Seller Details:\n`;
      text += `--------------\n`;
      text += `Shop Name: ${shopInfo.shopName}\n`;
      text += `Address: ${shopInfo.address}\n`;
      text += `Phone: ${shopInfo.phone}\n`;
      text += `GSTIN: ${shopGST}\n`;
      text += `Sales Person: ${invoice["Sales Person"] || "Not Specified"}\n\n`;
      
      text += `Invoice Information:\n`;
      text += `-------------------\n`;
      text += `Invoice Number: ${invoice["Invoice Number"]}\n`;
      text += `Invoice Date: ${formatDate(invoice["Date"])}\n\n`;
      
      text += `Customer Details:\n`;
      text += `----------------\n`;
      text += `Customer Name: ${invoice["Costomer Name"] || "Not Specified"}\n`;
      text += `Customer Phone: ${invoice["Mobile"] || "Not Provided"}\n`;
      text += `Customer Address: ${invoice["Address"] || "Not Provided"}\n`;
      text += `Customer GSTIN: ${invoice["GST"] || "Not Registered"}\n\n`;
      
      text += `Item Details (with Batch Numbers):\n`;
      text += `-------------------------------\n`;
      text += `S.No | Item Description | Batch No | Qty | Rate | Tax % | Taxable Amt | SGST | CGST | Total\n`;
      text += `------------------------------------------------------------------------------------------------\n`;
      
      rows.forEach((row, index) => {
        const product = productData.find(p => p["Product ID"] === row["Product ID"]);
        const productName = product ? product["Product Name"] : "Not Found";
        const quantity = Number(row["Quantity"]) || 0;
        const price = Number(row["Price"]) || 0;
        const taxIncluded = product ? product["Tax Included"] : false;
        const taxPercentage = product ? Number(product["Tax Percentage"]) || 0 : 0;
        const batchNo = row["Batch No"] || "N/A";
        
        const taxes = calculateTaxes(price, quantity, taxPercentage, taxIncluded);
        const total = taxes.taxableAmount + taxes.taxAmount;
        
        grandTotal += total;
        totalTaxableAmount += taxes.taxableAmount;
        totalSGST += taxes.sgst;
        totalCGST += taxes.cgst;
        totalTaxAmount += taxes.taxAmount;
        
        text += `${(index + 1).toString().padEnd(4)} | ${productName.padEnd(20)} | ${batchNo.padEnd(10)} | ${quantity.toString().padEnd(4)} | ${formatCurrency(price).padEnd(10)} | ${taxPercentage.toString().padEnd(5)}% | ${formatCurrency(taxes.taxableAmount).padEnd(12)} | ${formatCurrency(taxes.sgst).padEnd(10)} | ${formatCurrency(taxes.cgst).padEnd(10)} | ${formatCurrency(total)}\n`;
      });
      
      text += `\n`;
      
      // Calculate effective tax percentage
      const effectiveTaxPercentage = totalTaxableAmount > 0 ? 
        (totalTaxAmount / totalTaxableAmount * 100).toFixed(2) : "0.00";
      
      text += `Tax Summary:\n`;
      text += `-----------\n`;
      text += `Total Items: ${rows.length}\n`;
      text += `Taxable Amount: ${formatCurrency(totalTaxableAmount)}\n`;
      text += `SGST @ ${(parseFloat(effectiveTaxPercentage)/2).toFixed(2)}%: ${formatCurrency(totalSGST)}\n`;
      text += `CGST @ ${(parseFloat(effectiveTaxPercentage)/2).toFixed(2)}%: ${formatCurrency(totalCGST)}\n`;
      text += `Total GST: ${formatCurrency(totalTaxAmount)}\n\n`;
      
      text += `GRAND TOTAL: ${formatCurrency(grandTotal)}\n\n`;
      text += `Invoice Link: ${generateShareableLink(currentInvoiceNumber)}\n\n`;
      text += `Terms and Conditions:\n`;
      text += `--------------------\n`;
      text += `1. Goods once sold will not be taken back\n`;
      text += `2. Subject to ${shopInfo.shopName} jurisdiction\n`;
      text += `3. E. & O.E.\n\n`;
      text += `Generated on: ${new Date().toLocaleDateString()}\n`;
      text += `Thank you for your business!`;
      
      // Copy to clipboard
      navigator.clipboard.writeText(text)
        .then(() => showToast('✅ Invoice text copied to clipboard!'))
        .catch(() => {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showToast('✅ Invoice text copied to clipboard!');
        });
    }

    // SIMPLE WORKING PDF GENERATION
    async function generatePDF() {
      if (!currentInvoiceData) {
        showToast('⚠️ Please load an invoice first');
        return;
      }
      
      // Show loading overlay
      const pdfLoading = document.getElementById('pdfLoading');
      pdfLoading.style.display = 'flex';
      
      try {
        const { invoice, rows, productData } = currentInvoiceData;
        const shopInfo = parseShopTag(localStorage.getItem("ShopTag") || "Invoice Viewer Pro");
        
        // Calculate totals
        let grandTotal = 0;
        let totalTaxableAmount = 0;
        let totalSGST = 0;
        let totalCGST = 0;
        let totalTaxAmount = 0;
        let itemCount = 0;
        
        // Create PDF
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        
        // Set margins
        const marginLeft = 15;
        const marginTop = 20;
        const pageWidth = 210;
        const pageHeight = 297;
        let currentY = marginTop;
        
        // Add shop header
        pdf.setFontSize(24);
        pdf.setFont("helvetica", "bold");
        pdf.setTextColor(37, 99, 235); // Primary color
        pdf.text(shopInfo.shopName, marginLeft, currentY);
        
        currentY += 8;
        pdf.setFontSize(10);
        pdf.setFont("helvetica", "normal");
        pdf.setTextColor(0, 0, 0);
        pdf.text(shopInfo.address, marginLeft, currentY);
        currentY += 5;
        pdf.text(`Phone: ${shopInfo.phone}`, marginLeft, currentY);
        currentY += 5;
        pdf.text(`GSTIN: ${shopGST}`, marginLeft, currentY);
        
        // Add invoice tag if available
        if (invoice["Tag"]) {
          pdf.setFontSize(9);
          pdf.text(`Invoice Tag: ${invoice["Tag"]}`, pageWidth - marginLeft - 40, currentY - 10, { align: 'right' });
        }
        
        currentY += 10;
        
        // Add invoice title
        pdf.setFontSize(20);
        pdf.setFont("helvetica", "bold");
        pdf.setTextColor(37, 99, 235);
        pdf.text('TAX INVOICE', marginLeft, currentY);
        
        currentY += 8;
        
        // Add invoice details
        pdf.setFontSize(10);
        pdf.setFont("helvetica", "normal");
        pdf.setTextColor(0, 0, 0);
        pdf.text(`Invoice Number: ${invoice["Invoice Number"]}`, marginLeft, currentY);
        pdf.text(`Date: ${formatDate(invoice["Date"])}`, pageWidth - marginLeft - 40, currentY, { align: 'right' });
        
        currentY += 5;
        pdf.text(`Sales Person: ${invoice["Sales Person"] || "Not Specified"}`, marginLeft, currentY);
        
        currentY += 10;
        
        // Add customer section
        pdf.setFontSize(12);
        pdf.setFont("helvetica", "bold");
        pdf.setTextColor(37, 99, 235);
        pdf.text('CUSTOMER DETAILS', marginLeft, currentY);
        
        currentY += 6;
        pdf.setFontSize(10);
        pdf.setFont("helvetica", "normal");
        pdf.setTextColor(0, 0, 0);
        
        pdf.text(`Name: ${invoice["Costomer Name"] || "Not Specified"}`, marginLeft, currentY);
        currentY += 5;
        pdf.text(`Phone: ${invoice["Mobile"] || "Not Provided"}`, marginLeft, currentY);
        currentY += 5;
        pdf.text(`Address: ${invoice["Address"] || "Not Provided"}`, marginLeft, currentY);
        currentY += 5;
        pdf.text(`GSTIN: ${invoice["GST"] || "Not Registered"}`, marginLeft, currentY);
        
        currentY += 10;
        
        // Add items table header
        pdf.setFontSize(12);
        pdf.setFont("helvetica", "bold");
        pdf.setTextColor(37, 99, 235);
        pdf.text('ITEM DETAILS', marginLeft, currentY);
        
        currentY += 8;
        
        // Create table headers
        pdf.setFontSize(9);
        pdf.setFont("helvetica", "bold");
        pdf.setTextColor(255, 255, 255);
        pdf.setFillColor(37, 99, 235);
        
        // Draw header cells
        const colWidths = [10, 50, 15, 12, 15, 15, 20, 15, 15, 20];
        let xPos = marginLeft;
        
        const headers = ['#', 'Item Description', 'Batch', 'Qty', 'Rate', 'Tax %', 'Taxable Amt', 'SGST', 'CGST', 'Total'];
        
        headers.forEach((header, index) => {
          pdf.rect(xPos, currentY - 5, colWidths[index], 8, 'F');
          pdf.text(header, xPos + 2, currentY);
          xPos += colWidths[index];
        });
        
        currentY += 8;
        
        // Add items data
        pdf.setFont("helvetica", "normal");
        pdf.setTextColor(0, 0, 0);
        
        rows.forEach((row, index) => {
          const product = productData.find(p => p["Product ID"] === row["Product ID"]);
          const productName = product ? product["Product Name"] : "Not Found";
          const quantity = Number(row["Quantity"]) || 0;
          const price = Number(row["Price"]) || 0;
          const taxIncluded = product ? product["Tax Included"] : false;
          const taxPercentage = product ? Number(product["Tax Percentage"]) || 0 : 0;
          const batchNo = row["Batch No"] || "N/A";
          
          const taxes = calculateTaxes(price, quantity, taxPercentage, taxIncluded);
          
          grandTotal += taxes.total;
          totalTaxableAmount += taxes.taxableAmount;
          totalSGST += taxes.sgst;
          totalCGST += taxes.cgst;
          totalTaxAmount += taxes.taxAmount;
          itemCount++;
          
          // Check if we need a new page
          if (currentY > pageHeight - 40) {
            pdf.addPage();
            currentY = marginTop;
            
            // Redraw headers on new page
            xPos = marginLeft;
            pdf.setFont("helvetica", "bold");
            pdf.setTextColor(255, 255, 255);
            pdf.setFillColor(37, 99, 235);
            
            headers.forEach((header, i) => {
              pdf.rect(xPos, currentY - 5, colWidths[i], 8, 'F');
              pdf.text(header, xPos + 2, currentY);
              xPos += colWidths[i];
            });
            
            currentY += 8;
            pdf.setFont("helvetica", "normal");
            pdf.setTextColor(0, 0, 0);
          }
          
          // Draw row with alternate background
          if (index % 2 === 0) {
            pdf.setFillColor(240, 240, 240);
            xPos = marginLeft;
            colWidths.forEach(width => {
              pdf.rect(xPos, currentY - 4, width, 6, 'F');
              xPos += width;
            });
          }
          
          // Add row data
          xPos = marginLeft;
          const rowData = [
            (index + 1).toString(),
            productName.substring(0, 30), // Limit item name length
            batchNo,
            quantity.toString(),
            `₹${price.toFixed(2)}`,
            `${taxPercentage}%`,
            `₹${taxes.taxableAmount.toFixed(2)}`,
            `₹${taxes.sgst.toFixed(2)}`,
            `₹${taxes.cgst.toFixed(2)}`,
            `₹${taxes.total.toFixed(2)}`
          ];
          
          rowData.forEach((data, dataIndex) => {
            pdf.text(data, xPos + 2, currentY);
            xPos += colWidths[dataIndex];
          });
          
          currentY += 7;
        });
        
        currentY += 5;
        
        // Add tax breakdown if needed
        if (Object.keys(taxBreakdownByRate).length > 0) {
          pdf.setFontSize(11);
          pdf.setFont("helvetica", "bold");
          pdf.setTextColor(37, 99, 235);
          pdf.text('TAX BREAKDOWN', marginLeft, currentY);
          
          currentY += 6;
          pdf.setFontSize(9);
          pdf.setFont("helvetica", "normal");
          pdf.setTextColor(0, 0, 0);
          
          // Sort tax rates
          const sortedRates = Object.keys(taxBreakdownByRate).sort((a, b) => parseFloat(a) - parseFloat(b));
          
          sortedRates.forEach(rate => {
            const rateData = taxBreakdownByRate[rate];
            if (parseFloat(rate) > 0) {
              pdf.text(`Items @ ${rate}% GST (${rateData.count} items): ₹${rateData.taxableAmount.toFixed(2)}`, marginLeft, currentY);
              currentY += 4;
              pdf.text(`  SGST @ ${(rate/2).toFixed(2)}%: ₹${rateData.sgst.toFixed(2)}`, marginLeft + 5, currentY);
              currentY += 4;
              pdf.text(`  CGST @ ${(rate/2).toFixed(2)}%: ₹${rateData.cgst.toFixed(2)}`, marginLeft + 5, currentY);
              currentY += 6;
            }
          });
        }
        
        // Add summary section
        currentY += 5;
        pdf.setFontSize(12);
        pdf.setFont("helvetica", "bold");
        pdf.setTextColor(37, 99, 235);
        pdf.text('SUMMARY', marginLeft, currentY);
        
        currentY += 8;
        
        // Calculate effective tax percentage
        const effectiveTaxPercentage = totalTaxableAmount > 0 ? 
          (totalTaxAmount / totalTaxableAmount * 100).toFixed(2) : "0.00";
        
        // Create summary table
        const summaryData = [
          ['Total Items:', itemCount.toString()],
          ['Taxable Amount:', `₹${totalTaxableAmount.toFixed(2)}`]
        ];
        
        if (totalTaxAmount > 0) {
          summaryData.push(
            [`SGST @ ${(parseFloat(effectiveTaxPercentage)/2).toFixed(2)}%:`, `₹${totalSGST.toFixed(2)}`],
            [`CGST @ ${(parseFloat(effectiveTaxPercentage)/2).toFixed(2)}%:`, `₹${totalCGST.toFixed(2)}`],
            ['Total GST:', `₹${totalTaxAmount.toFixed(2)}`]
          );
        } else {
          summaryData.push(['GST:', 'NIL']);
        }
        
        summaryData.push(['GRAND TOTAL:', `₹${grandTotal.toFixed(2)}`]);
        
        pdf.setFontSize(10);
        pdf.setFont("helvetica", "normal");
        
        summaryData.forEach(([label, value]) => {
          pdf.text(label, marginLeft, currentY);
          pdf.text(value, pageWidth - marginLeft - 30, currentY, { align: 'right' });
          currentY += 5;
        });
        
        // Add footer
        currentY = pageHeight - 20;
        pdf.setFontSize(8);
        pdf.setTextColor(100);
        pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, marginLeft, currentY);
        pdf.text(`Invoice: ${currentInvoiceNumber}`, pageWidth / 2, currentY, { align: 'center' });
        pdf.text('E. & O.E.', pageWidth - marginLeft, currentY, { align: 'right' });
        
        currentY += 5;
        pdf.setFontSize(9);
        pdf.setTextColor(0, 0, 0);
        pdf.text('Terms and Conditions:', marginLeft, currentY);
        currentY += 4;
        pdf.text('1. Goods once sold will not be taken back', marginLeft + 5, currentY);
        currentY += 4;
        pdf.text(`2. Subject to ${shopInfo.shopName} jurisdiction`, marginLeft + 5, currentY);
        currentY += 4;
        pdf.text('3. All disputes subject to local jurisdiction only', marginLeft + 5, currentY);
        
        // Save PDF
        const fileName = `Invoice_${currentInvoiceNumber}_${shopInfo.shopName.replace(/\s+/g, '_')}.pdf`;
        pdf.save(fileName);
        
        showToast('✅ PDF downloaded successfully!');
        
      } catch (error) {
        console.error('PDF Generation Error:', error);
        showToast('❌ Error generating PDF. Please try again.');
      } finally {
        // Hide loading overlay
        pdfLoading.style.display = 'none';
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Allow pressing Enter to search
    document.getElementById("invoiceNumber").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        fetchInvoice();
      }
    });

    // Improve input focus
    document.getElementById("invoiceNumber").addEventListener("focus", function() {
      this.select();
    });
  </script>
</body>
</html>