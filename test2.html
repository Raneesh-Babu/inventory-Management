<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Viewer</title>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --light: #f8f9fa;
      --dark: #212529;
      --success: #4cc9f0;
      --danger: #f72585;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    
    .invoice-container {
      max-width: 1000px;
      background: white;
      margin: 30px auto;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    .invoice-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 30px;
      position: relative;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    
    .shop-info {
      text-align: left;
    }
    
    .shop-name {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }
    
    .shop-details {
      font-size: 15px;
      opacity: 0.9;
      line-height: 1.5;
    }
    
    .shop-address, .shop-phone {
      margin-bottom: 6px;
    }
    
    .shop-id {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 12px;
      font-weight: 500;
    }
    
    .invoice-tag {
      background: rgba(255, 255, 255, 0.25);
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 14px;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }
    
    .search-section {
      padding: 30px;
      background: white;
    }
    
    .search-container {
      display: flex;
      max-width: 600px;
      margin: 0 auto;
      gap: 15px;
    }
    
    .search-input {
      flex: 1;
      padding: 16px 20px;
      border-radius: var(--border-radius);
      border: 2px solid var(--gray-light);
      font-size: 16px;
      transition: var(--transition);
      background: var(--light);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
    }
    
    .search-btn {
      padding: 16px 28px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .search-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }
    
    .invoice-body {
      padding: 30px;
    }
    
    .error {
      color: var(--danger);
      text-align: center;
      margin: 20px 0;
      padding: 16px;
      background: rgba(247, 37, 133, 0.08);
      border-radius: var(--border-radius);
      font-weight: 500;
    }
    
    .invoice-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
      padding: 30px;
      background: var(--light);
      border-radius: var(--border-radius);
    }
    
    .detail-group {
      display: flex;
      flex-direction: column;
    }
    
    .label {
      font-weight: 600;
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .value {
      font-weight: 500;
      color: var(--dark);
      font-size: 16px;
    }
    
    .items-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 30px 0;
      border-radius: var(--border-radius);
      overflow: hidden;
      background: white;
    }
    
    .items-table thead {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }
    
    .items-table th {
      color: white;
      padding: 20px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 15px;
      border: none;
    }
    
    .items-table th:first-child {
      border-top-left-radius: var(--border-radius);
    }
    
    .items-table th:last-child {
      border-top-right-radius: var(--border-radius);
    }
    
    .items-table td {
      padding: 18px 16px;
      border: none;
      background: white;
    }
    
    .items-table tbody tr {
      transition: var(--transition);
    }
    
    .items-table tbody tr:hover {
      background: rgba(67, 97, 238, 0.03);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .items-table tbody tr:nth-child(even) {
      background: rgba(0, 0, 0, 0.015);
    }
    
    .items-table tbody tr:nth-child(even):hover {
      background: rgba(67, 97, 238, 0.05);
    }
    
    .summary {
      text-align: right;
      margin-top: 30px;
      padding: 25px;
      background: var(--light);
      border-radius: var(--border-radius);
    }
    
    .total-amount {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 14px 28px;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .whatsapp-btn {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      color: white;
    }
    
    .copy-btn {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
    }
    
    .template-btn {
      background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
      color: white;
    }
    
    .print-btn {
      background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
      color: white;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .whatsapp-btn:hover {
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);
    }
    
    .copy-btn:hover {
      box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
    }
    
    .template-btn:hover {
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }
    
    .print-btn:hover {
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }
    
    .template-selector {
      display: none;
      background: var(--light);
      padding: 25px;
      border-radius: var(--border-radius);
      margin: 20px 0;
    }
    
    .template-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .template-option {
      background: white;
      padding: 25px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
    }
    
    .template-option:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow);
      border-color: var(--primary);
    }
    
    .template-option.active {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
    }
    
    .template-name {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 10px;
      color: var(--primary);
    }
    
    .template-desc {
      color: var(--gray);
      font-size: 14px;
      line-height: 1.5;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      background: var(--dark);
      color: white;
      border-radius: var(--border-radius);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    @media print {
      .search-section, .action-buttons, .template-selector {
        display: none;
      }
      body {
        background: white;
        padding: 0;
      }
      .invoice-container {
        box-shadow: none;
        margin: 0;
      }
    }
    
    @media (max-width: 768px) {
      .invoice-container {
        margin: 15px;
      }
      
      .header-content {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }
      
      .shop-info {
        text-align: center;
      }
      
      .invoice-tag {
        margin-top: 15px;
        align-self: center;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .invoice-details {
        grid-template-columns: 1fr;
        padding: 20px;
      }
      
      .items-table {
        display: block;
        overflow-x: auto;
      }
      
      .items-table th,
      .items-table td {
        padding: 14px 12px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-btn {
        justify-content: center;
      }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .copy-link-container {
      background: var(--light);
      padding: 20px;
      border-radius: var(--border-radius);
      margin: 20px 0;
    }
    
    .copy-link-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      font-size: 14px;
      margin-bottom: 10px;
      background: white;
    }
  </style>
</head>
<body>

  <div class="invoice-container">
    <div class="invoice-header">
      <div class="header-content">
        <div class="shop-info">
          <div class="shop-name" id="shopName">Loading Shop Name...</div>
          <div class="shop-details">
            <div class="shop-address" id="shopAddress">Loading address...</div>
            <div class="shop-phone" id="shopPhone">Loading phone...</div>
          </div>
          <div class="shop-id">Shop ID: <span id="shopTag">Loading...</span></div>
        </div>
        <div class="invoice-tag" id="invoiceTag" style="display: none;"></div>
      </div>
    </div>

    <div class="search-section" id="searchSection">
      <div class="search-container">
        <input type="text" id="invoiceNumber" class="search-input" placeholder="Enter Invoice Number (e.g. INV1762933901829)">
        <button class="search-btn" id="searchBtn" onclick="fetchInvoice()">
          <span id="btnText">Search Invoice</span>
        </button>
      </div>
    </div>

    <div class="invoice-body">
      <div id="errorMsg" class="error"></div>
      <div id="invoiceDetails" class="invoice-details"></div>

      <div id="itemsTable"></div>
      <div id="totalAmount" class="summary"></div>
      
      <!-- Action Buttons -->
      <div id="actionButtons" class="action-buttons" style="display:none;">
        <button class="action-btn whatsapp-btn" onclick="shareToWhatsApp()">
          <span>üì±</span> Share to WhatsApp
        </button>
        <button class="action-btn copy-btn" onclick="copyInvoiceText()">
          <span>üìã</span> Copy Invoice Text
        </button>
        <button class="action-btn template-btn" onclick="toggleTemplateSelector()">
          <span>üé®</span> Change Template
        </button>
        <button class="action-btn print-btn" onclick="window.print()">
          <span>üñ®</span> Print / Save PDF
        </button>
      </div>
      
      <!-- Template Selector -->
      <div id="templateSelector" class="template-selector">
        <h3 style="margin-bottom: 20px; color: var(--primary);">Choose Invoice Template</h3>
        <div class="template-options">
          <div class="template-option active" data-template="modern" onclick="changeTemplate('modern')">
            <div class="template-name">Modern Gradient</div>
            <div class="template-desc">Modern design with gradient colors and smooth animations</div>
          </div>
          <div class="template-option" data-template="minimal" onclick="changeTemplate('minimal')">
            <div class="template-name">Minimal Clean</div>
            <div class="template-desc">Simple, clean design with focus on readability</div>
          </div>
          <div class="template-option" data-template="professional" onclick="changeTemplate('professional')">
            <div class="template-name">Professional</div>
            <div class="template-desc">Corporate style with formal layout and muted colors</div>
          </div>
          <div class="template-option" data-template="compact" onclick="changeTemplate('compact')">
            <div class="template-name">Compact View</div>
            <div class="template-desc">Space-efficient design for quick overview</div>
          </div>
        </div>
      </div>
      
      <!-- Copy Link Section -->
      <div id="copyLinkContainer" class="copy-link-container" style="display:none;">
        <h3 style="margin-bottom: 15px; color: var(--primary);">Share Invoice Link</h3>
        <input type="text" id="invoiceLink" class="copy-link-input" readonly>
        <button class="action-btn copy-btn" onclick="copyInvoiceLink()">
          <span>üîó</span> Copy Invoice Link
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
    const salesTableId = 736209;
    const productTableId = 734793;
    const salesUrl = `https://api.baserow.io/api/database/rows/table/${salesTableId}/?user_field_names=true`;
    const productUrl = `https://api.baserow.io/api/database/rows/table/${productTableId}/?user_field_names=true`;
    
    let currentInvoiceData = null;
    let currentInvoiceNumber = null;
    let currentTemplate = 'modern';

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      loadShopInfo();
      
      const urlParams = new URLSearchParams(window.location.search);
      const invoiceParam = urlParams.get('invoice');
      
      if (invoiceParam) {
        document.getElementById('searchSection').style.display = 'none';
        document.getElementById('invoiceNumber').value = invoiceParam;
        fetchInvoice();
      }
      
      // Apply saved template preference
      const savedTemplate = localStorage.getItem('invoiceTemplate') || 'modern';
      changeTemplate(savedTemplate, false);
    });

    function parseShopTag(shopTag) {
      let shopName = "Your Shop";
      let address = "Address not available";
      let phone = "Phone not available";
      
      if (shopTag) {
        const firstSplit = shopTag.split('-');
        if (firstSplit.length > 1) {
          shopName = firstSplit[0].trim();
          const secondSplit = firstSplit[1].split('/');
          if (secondSplit.length > 1) {
            address = secondSplit[0].trim();
            phone = secondSplit[1].trim();
          } else {
            address = firstSplit[1].trim();
          }
        } else {
          shopName = shopTag.trim();
        }
      }
      
      return { shopName, address, phone };
    }

    function loadShopInfo() {
      const shopIDTag = localStorage.getItem("ShopIDTag");
      const shopTagValue = localStorage.getItem("ShopTag") || "Your Shop";
      const shopInfo = parseShopTag(shopTagValue);
      
      if (shopIDTag) {
        document.getElementById('shopTag').textContent = shopIDTag;
        document.getElementById('shopName').textContent = shopInfo.shopName;
        document.getElementById('shopAddress').textContent = shopInfo.address;
        document.getElementById('shopPhone').textContent = shopInfo.phone;
      } else {
        document.getElementById('shopTag').textContent = "Not Set";
        document.getElementById('shopName').textContent = "Please Set Shop Information";
      }
    }

    function formatDate(dateString) {
      if (!dateString) return "N/A";
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (error) {
        return dateString;
      }
    }

    async function fetchInvoice() {
      const invoiceNumber = document.getElementById("invoiceNumber").value.trim();
      const shopIDTag = localStorage.getItem("ShopIDTag");
      const detailsDiv = document.getElementById("invoiceDetails");
      const errorDiv = document.getElementById("errorMsg");
      const itemsDiv = document.getElementById("itemsTable");
      const totalDiv = document.getElementById("totalAmount");
      const actionButtons = document.getElementById("actionButtons");
      const copyLinkContainer = document.getElementById("copyLinkContainer");
      const searchBtn = document.getElementById("searchBtn");
      const btnText = document.getElementById("btnText");
      const invoiceTag = document.getElementById("invoiceTag");

      // Reset displays
      detailsDiv.innerHTML = "";
      errorDiv.innerText = "";
      itemsDiv.innerHTML = "";
      totalDiv.innerHTML = "";
      actionButtons.style.display = "none";
      copyLinkContainer.style.display = "none";
      invoiceTag.style.display = "none";
      currentInvoiceData = null;

      // Show loading state
      searchBtn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> Searching...';

      if (!invoiceNumber) {
        errorDiv.innerText = "‚ö†Ô∏è Please enter an invoice number.";
        searchBtn.disabled = false;
        btnText.textContent = "Search Invoice";
        return;
      }

      if (!shopIDTag) {
        errorDiv.innerText = "‚ö†Ô∏è ShopIDTag not found. Please log in first.";
        searchBtn.disabled = false;
        btnText.textContent = "Search Invoice";
        return;
      }

      try {
        // Fetch data
        const [productResponse, salesResponse] = await Promise.all([
          fetch(productUrl, { headers: { Authorization: `Token ${apiKey}` } }),
          fetch(salesUrl, { headers: { Authorization: `Token ${apiKey}` } })
        ]);
        
        const productData = await productResponse.json();
        const salesData = await salesResponse.json();

        const invoiceRows = salesData.results.filter(
          row => row["Invoice Number"] === invoiceNumber && row["ShopID"] === shopIDTag
        );

        if (invoiceRows.length === 0) {
          errorDiv.innerText = "‚ùå No invoice found for this number or invalid ShopID.";
          searchBtn.disabled = false;
          btnText.textContent = "Search Invoice";
          return;
        }

        // Store invoice data
        currentInvoiceData = {
          invoice: invoiceRows[0],
          rows: invoiceRows,
          productData: productData.results
        };
        currentInvoiceNumber = invoiceNumber;

        // Display invoice
        displayInvoice();

        // Show action buttons and link
        actionButtons.style.display = "flex";
        copyLinkContainer.style.display = "block";
        
        // Generate and display shareable link
        const shareableLink = generateShareableLink(invoiceNumber);
        document.getElementById('invoiceLink').value = shareableLink;
        
        // Update URL
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('invoice', invoiceNumber);
        window.history.pushState({}, '', newUrl);
        
        showToast('‚úÖ Invoice loaded successfully!');
        
      } catch (error) {
        console.error(error);
        errorDiv.innerText = "‚ö†Ô∏è Error fetching data. Please try again.";
        showToast('‚ùå Error loading invoice');
      } finally {
        searchBtn.disabled = false;
        btnText.textContent = "Search Invoice";
      }
    }

    function displayInvoice() {
      if (!currentInvoiceData) return;
      
      const { invoice, rows, productData } = currentInvoiceData;
      const detailsDiv = document.getElementById("invoiceDetails");
      const itemsDiv = document.getElementById("itemsTable");
      const totalDiv = document.getElementById("totalAmount");
      const invoiceTag = document.getElementById("invoiceTag");

      // Display invoice tag
      if (invoice["Tag"]) {
        invoiceTag.textContent = invoice["Tag"];
        invoiceTag.style.display = "block";
      }

      // Apply current template
      applyTemplate();

      // Display details based on template
      if (currentTemplate === 'compact') {
        detailsDiv.innerHTML = `
          <div class="detail-group">
            <span class="label">Invoice #</span>
            <span class="value">${invoice["Invoice Number"]}</span>
          </div>
          <div class="detail-group">
            <span class="label">Customer</span>
            <span class="value">${invoice["Costomer Name"]}</span>
          </div>
          <div class="detail-group">
            <span class="label">Date</span>
            <span class="value">${formatDate(invoice["Date"])}</span>
          </div>
          <div class="detail-group">
            <span class="label">Mobile</span>
            <span class="value">${invoice["Mobile"]}</span>
          </div>
          <div class="detail-group">
            <span class="label">Total Items</span>
            <span class="value">${rows.length}</span>
          </div>
        `;
      } else {
        detailsDiv.innerHTML = `
          <div class="detail-group">
            <span class="label">Invoice Number</span>
            <span class="value">${invoice["Invoice Number"]}</span>
          </div>
          <div class="detail-group">
            <span class="label">Customer Name</span>
            <span class="value">${invoice["Costomer Name"]}</span>
          </div>
          <div class="detail-group">
            <span class="label">Mobile</span>
            <span class="value">${invoice["Mobile"]}</span>
          </div>
          <div class="detail-group">
            <span class="label">Address</span>
            <span class="value">${invoice["Address"]}</span>
          </div>
          <div class="detail-group">
            <span class="label">GST</span>
            <span class="value">${invoice["GST"] || "Nil"}</span>
          </div>
          <div class="detail-group">
            <span class="label">Date</span>
            <span class="value">${formatDate(invoice["Date"])}</span>
          </div>
          <div class="detail-group">
            <span class="label">Sales Person</span>
            <span class="value">${invoice["Sales Person"]}</span>
          </div>
        `;
      }

      // Build items table
      let tableHTML = `
        <table class="items-table">
          <thead>
            <tr>
              <th>Sl. No</th>
              <th>Item Name</th>
              <th>Product ID</th>
              ${currentTemplate !== 'compact' ? '<th>Batch No</th>' : ''}
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
      `;

      let grandTotal = 0;
      rows.forEach((row, index) => {
        const product = productData.find(p => p["Product ID"] === row["Product ID"]);
        const productName = product ? product["Product Name"] : "Not Found";
        const total = (Number(row["Quantity"]) || 0) * (Number(row["Price"]) || 0);
        grandTotal += total;

        tableHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${productName}</td>
            <td>${row["Product ID"]}</td>
            ${currentTemplate !== 'compact' ? `<td>${row["Batch No"]}</td>` : ''}
            <td>${row["Quantity"]}</td>
            <td>‚Çπ${Number(row["Price"]).toFixed(2)}</td>
            <td>‚Çπ${total.toFixed(2)}</td>
          </tr>
        `;
      });

      tableHTML += `</tbody></table>`;
      itemsDiv.innerHTML = tableHTML;
      totalDiv.innerHTML = `<div class="total-amount">Grand Total: ‚Çπ${grandTotal.toFixed(2)}</div>`;
      
      // Add animations
      detailsDiv.classList.add('fade-in');
      itemsDiv.classList.add('fade-in');
      totalDiv.classList.add('fade-in');
    }

    function applyTemplate() {
      const container = document.querySelector('.invoice-container');
      const header = document.querySelector('.invoice-header');
      const table = document.querySelector('.items-table');
      
      // Reset styles
      container.style = '';
      header.style = '';
      if (table) table.style = '';
      
      switch(currentTemplate) {
        case 'modern':
          // Already set as default
          break;
          
        case 'minimal':
          container.style.backgroundColor = '#ffffff';
          header.style.background = '#f8f9fa';
          header.style.color = '#212529';
          break;
          
        case 'professional':
          container.style.backgroundColor = '#ffffff';
          header.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)';
          if (table) {
            table.style.border = '1px solid #dee2e6';
            table.querySelector('thead').style.background = '#2c3e50';
          }
          break;
          
        case 'compact':
          container.style.padding = '0';
          header.style.padding = '20px';
          document.querySelector('.invoice-body').style.padding = '20px';
          break;
      }
    }

    function changeTemplate(templateName, updateDisplay = true) {
      currentTemplate = templateName;
      localStorage.setItem('invoiceTemplate', templateName);
      
      // Update active template in selector
      document.querySelectorAll('.template-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.template === templateName) {
          option.classList.add('active');
        }
      });
      
      // Re-display invoice if we have data
      if (currentInvoiceData && updateDisplay) {
        displayInvoice();
      }
    }

    function toggleTemplateSelector() {
      const selector = document.getElementById('templateSelector');
      selector.style.display = selector.style.display === 'block' ? 'none' : 'block';
    }

    function generateShareableLink(invoiceNumber) {
      const baseUrl = window.location.origin + window.location.pathname;
      return `${baseUrl}?invoice=${encodeURIComponent(invoiceNumber)}`;
    }

    function copyInvoiceLink() {
      const linkInput = document.getElementById('invoiceLink');
      linkInput.select();
      linkInput.setSelectionRange(0, 99999); // For mobile devices
      
      navigator.clipboard.writeText(linkInput.value)
        .then(() => showToast('‚úÖ Invoice link copied to clipboard!'))
        .catch(() => {
          // Fallback for older browsers
          document.execCommand('copy');
          showToast('‚úÖ Invoice link copied to clipboard!');
        });
    }

    function shareToWhatsApp() {
      if (!currentInvoiceData) return;
      
      const { invoice, rows } = currentInvoiceData;
      const shopInfo = parseShopTag(localStorage.getItem("ShopTag") || "Your Shop");
      const invoiceLink = generateShareableLink(currentInvoiceNumber);
      
      // Calculate totals
      let totalAmount = 0;
      rows.forEach(row => {
        totalAmount += (Number(row["Quantity"]) || 0) * (Number(row["Price"]) || 0);
      });
      
      // Create WhatsApp message
      const message = `üìÑ *Invoice Details*\n\n` +
                     `*Shop:* ${shopInfo.shopName}\n` +
                     `*Invoice #:* ${invoice["Invoice Number"]}\n` +
                     `*Customer:* ${invoice["Costomer Name"]}\n` +
                     `*Date:* ${formatDate(invoice["Date"])}\n` +
                     `*Items:* ${rows.length}\n` +
                     `*Total:* ‚Çπ${totalAmount.toFixed(2)}\n\n` +
                     `View full invoice:\n${invoiceLink}\n\n` +
                     `Thank you for your business! üõçÔ∏è`;
      
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
    }

    function copyInvoiceText() {
      if (!currentInvoiceData) return;
      
      const { invoice, rows, productData } = currentInvoiceData;
      const shopInfo = parseShopTag(localStorage.getItem("ShopTag") || "Your Shop");
      
      // Build text version
      let text = `INVOICE\n`;
      text += `========\n\n`;
      text += `Shop: ${shopInfo.shopName}\n`;
      text += `Address: ${shopInfo.address}\n`;
      text += `Phone: ${shopInfo.phone}\n\n`;
      text += `Invoice #: ${invoice["Invoice Number"]}\n`;
      text += `Customer: ${invoice["Costomer Name"]}\n`;
      text += `Mobile: ${invoice["Mobile"]}\n`;
      text += `Address: ${invoice["Address"]}\n`;
      text += `Date: ${formatDate(invoice["Date"])}\n`;
      text += `GST: ${invoice["GST"] || "Nil"}\n`;
      text += `Sales Person: ${invoice["Sales Person"]}\n\n`;
      text += `ITEMS:\n`;
      text += `------\n`;
      
      let grandTotal = 0;
      rows.forEach((row, index) => {
        const product = productData.find(p => p["Product ID"] === row["Product ID"]);
        const productName = product ? product["Product Name"] : "Not Found";
        const total = (Number(row["Quantity"]) || 0) * (Number(row["Price"]) || 0);
        grandTotal += total;
        
        text += `${index + 1}. ${productName}\n`;
        text += `   Product ID: ${row["Product ID"]}\n`;
        text += `   Batch: ${row["Batch No"]}\n`;
        text += `   Qty: ${row["Quantity"]} x ‚Çπ${Number(row["Price"]).toFixed(2)} = ‚Çπ${total.toFixed(2)}\n\n`;
      });
      
      text += `\n`;
      text += `GRAND TOTAL: ‚Çπ${grandTotal.toFixed(2)}\n\n`;
      text += `Invoice Link: ${generateShareableLink(currentInvoiceNumber)}\n`;
      text += `\nThank you for your business!`;
      
      // Copy to clipboard
      navigator.clipboard.writeText(text)
        .then(() => showToast('‚úÖ Invoice text copied to clipboard!'))
        .catch(() => {
          // Fallback for older browsers
          const textarea = document.createElement('textarea');
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showToast('‚úÖ Invoice text copied to clipboard!');
        });
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Allow pressing Enter to search
    document.getElementById("invoiceNumber").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        fetchInvoice();
      }
    });
  </script>
</body>
</html>