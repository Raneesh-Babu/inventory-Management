<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Product Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
h2 { text-align: center; color: #333; }
#searchBar { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
input, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
button { background-color: #007bff; color: white; border: none; cursor: pointer; }
button:hover { background-color: #0056b3; }
#productList { width: 100%; border-collapse: collapse; margin-top: 10px; }
#productList th, #productList td { border: 1px solid #ddd; padding: 10px; text-align: left; }
#productList th { background: #007bff; color: white; }
.details { background: #eef; padding: 10px; margin-top: 5px; display: none; border-radius: 5px; }
.price-edit { width: 60px; }
</style>
</head>
<body>

<h2>Product Dashboard</h2>

<div id="searchBar">
  <input type="text" id="searchInput" placeholder="Search by Product Name or ID">
  <button onclick="searchProduct()">Search</button>
  <button onclick="startScanner()">ðŸ“· Scan</button>
</div>

<video id="qrVideo" style="display:none; width:100%; max-height:400px;"></video>

<table id="productList">
  <thead>
    <tr>
      <th>Product ID</th>
      <th>Name</th>
      <th>Total Count</th>
      <th>Price</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody id="productBody"></tbody>
</table>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const BASEROW_URL = "https://api.baserow.io/api/database/rows/table";
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const PRODUCTS_TABLE = 734793;
const INVENTORY_TABLE = 734795;
const USERS_TABLE = 729979;

let shopID = localStorage.getItem("ShopIDTag");
let mobileTag = localStorage.getItem("MobileTag");
let userRole = null;

// âœ… Check login and role
async function checkUserRole() {
  if (!mobileTag) {
    alert("Please login first!");
    window.location.href = "login.html";
    return;
  }
  const res = await fetch(`${BASEROW_URL}/${USERS_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });
  const data = await res.json();
  const user = data.results.find(u => u.Username === mobileTag);
  if (!user) { alert("User not found!"); return; }
  userRole = user.Role;
  loadProducts();
}

// âœ… Load products and inventory
async function loadProducts() {
  const prodRes = await fetch(`${BASEROW_URL}/${PRODUCTS_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });
  const invRes = await fetch(`${BASEROW_URL}/${INVENTORY_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });
  const [prodData, invData] = await Promise.all([prodRes.json(), invRes.json()]);

  const products = prodData.results.filter(p => p.ShopID === shopID);
  const inventory = invData.results.filter(i => i.ShopID === shopID);

  displayProducts(products, inventory);
}

// âœ… Display table with expandable batch details
function displayProducts(products, inventory) {
  const tbody = document.getElementById("productBody");
  tbody.innerHTML = "";

  products.forEach(p => {
    const batches = inventory.filter(i => i["Product ID"] === p["Product ID"]);
    const totalCount = batches.reduce((sum, b) => sum + Number(b.Count || 0), 0);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p["Product ID"]}</td>
      <td>${p["Product Name"]}</td>
      <td>${totalCount}</td>
      <td>
        ${
          userRole === "Manager"
          ? `<input type="number" class="price-edit" value="${p.Price}" onchange="updatePrice('${p.id}', this.value)">`
          : p.Price
        }
      </td>
      <td><button onclick="toggleDetails('${p["Product ID"]}')">View</button></td>
    `;
    tbody.appendChild(tr);

    const detailsDiv = document.createElement("tr");
    detailsDiv.innerHTML = `
      <td colspan="5">
        <div id="details-${p["Product ID"]}" class="details">
          ${batches.map(b => `
            <p><b>Batch:</b> ${b["Batch No"]} | 
            <b>Count:</b> ${b.Count} | 
            <b>Expire:</b> ${b["Expire Date"]} | 
            <b>Location:</b> ${b.Location}</p>`).join("")}
        </div>
      </td>`;
    tbody.appendChild(detailsDiv);
  });
}

function toggleDetails(pid) {
  const div = document.getElementById(`details-${pid}`);
  div.style.display = div.style.display === "block" ? "none" : "block";
}

// âœ… Update product price (Manager only)
async function updatePrice(rowId, newPrice) {
  if (userRole !== "Manager") return alert("Only Manager can update price!");
  await fetch(`${BASEROW_URL}/${PRODUCTS_TABLE}/${rowId}/?user_field_names=true`, {
    method: "PATCH",
    headers: { Authorization: `Token ${API_KEY}`, "Content-Type": "application/json" },
    body: JSON.stringify({ Price: Number(newPrice) })
  });
  alert("Price updated successfully!");
}

// âœ… Search products
function searchProduct() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#productBody tr");
  rows.forEach(r => {
    r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}

// âœ… QR Scanner
function startScanner() {
  const videoElem = document.getElementById("qrVideo");
  videoElem.style.display = "block";
  const html5QrCode = new Html5Qrcode("qrVideo");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      document.getElementById("searchInput").value = decodedText;
      searchProduct();
      html5QrCode.stop();
      videoElem.style.display = "none";
    },
    (error) => {}
  ).catch(err => console.error(err));
}

checkUserRole();
</script>
</body>
</html>