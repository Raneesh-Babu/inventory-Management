<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì¶ Product Dashboard</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  body { font-family: 'Poppins', sans-serif; background:#f4f6f9; margin:0; padding:0; }
  header { background:#007bff; color:white; text-align:center; padding:15px; font-size:20px; font-weight:bold; }
  .container { padding:20px; max-width:900px; margin:auto; }
  .search-bar { display:flex; gap:10px; margin-bottom:20px; }
  input[type="text"] { flex:1; padding:8px; border:1px solid #ccc; border-radius:6px; }
  button { background:#007bff; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  button:disabled { background:#ccc; cursor:not-allowed; }
  .card { background:white; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:15px; padding:15px; }
  .card h3 { margin:0; color:#007bff; cursor:pointer; }
  .expandable { display:none; margin-top:10px; }
  .batch-item { border-top:1px solid #eee; padding:10px 0; }
  .batch-item input { width:100px; padding:4px; border:1px solid #ccc; border-radius:5px; }
  .btn-small { padding:4px 8px; font-size:12px; margin-top:5px; }
  #reader { width:100%; height: 350px; margin-top:10px; display:none; }
  .price-edit { background:#f8f9ff; padding:10px; border-radius:8px; margin-bottom:10px; }
</style>
</head>
<body>
<header>üì¶ Product Dashboard</header>

<div class="container">
  <div id="status"></div>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search by Product Name or ID">
    <button onclick="searchProduct()">Search</button>
    <button onclick="toggleScanner()">üì∑ Scan</button>
  </div>

  <div id="reader"></div>
  <h3>Products</h3>
  <div id="productList"></div>
</div>

<script>
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const USERS_TABLE = 729979;
const PRODUCTS_TABLE = 734793;
const INVENTORY_TABLE = 734795;

let role = "";
let shopID = localStorage.getItem("ShopIDTag");
let mobileTag = localStorage.getItem("MobileTag");
let html5QrCode;
let products = [];
let inventory = [];

async function init() {
  if (!mobileTag) {
    alert("Please login first.");
    location.href = "login.html";
    return;
  }

  // üîπ Fetch user role
  const res = await fetch(`https://api.baserow.io/api/database/rows/table/${USERS_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });
  const data = await res.json();
  const user = data.results.find(u => u.Username === mobileTag);
  if (!user) {
    alert("User not found.");
    return;
  }
  role = user.Role;
  document.getElementById("status").innerHTML = `<b>User:</b> ${mobileTag} | <b>Role:</b> ${role}`;

  await loadData();
}

async function loadData() {
  const pRes = await fetch(`https://api.baserow.io/api/database/rows/table/${PRODUCTS_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });
  const iRes = await fetch(`https://api.baserow.io/api/database/rows/table/${INVENTORY_TABLE}/?user_field_names=true`, {
    headers: { Authorization: `Token ${API_KEY}` }
  });

  const pData = await pRes.json();
  const iData = await iRes.json();

  products = pData.results.filter(p => p.ShopID === shopID);
  inventory = iData.results.filter(i => i.ShopID === shopID);

  renderProducts(products);
}

function renderProducts(list) {
  const container = document.getElementById("productList");
  container.innerHTML = "";
  list.forEach(prod => {
    const batches = inventory.filter(i => i["Product ID"] === prod["Product ID"]);
    const totalCount = batches.reduce((sum, b) => sum + Number(b.Count || 0), 0);
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h3 onclick="toggleExpand('${prod["Product ID"]}')">${prod["Product Name"]} (${prod["Product ID"]})</h3>
      <p><b>Total Count:</b> ${totalCount}</p>
      <p><b>Price:</b> ‚Çπ${prod.Price || 0}</p>
      ${role === "Manager" ? `<button class="btn-small" onclick="togglePriceEdit('${prod["Product ID"]}')">‚úèÔ∏è Edit Price</button>` : ""}
      <div id="priceEdit-${prod["Product ID"]}" class="price-edit" style="display:none;">
        <input type="number" id="priceVal-${prod.id}" value="${prod.Price || 0}">
        <button class="btn-small" onclick="updatePrice(${prod.id}, '${prod["Product ID"]}')">Save Price</button>
      </div>
      <div id="expand-${prod["Product ID"]}" class="expandable">
        ${batches.map(b => `
          <div class="batch-item">
            <p><b>Batch:</b> ${b["Batch No"]} | 
            <b>Count:</b> <input type="number" id="count-${b.id}" value="${b.Count}" ${role !== "Manager" ? "disabled" : ""}>
            <b>Expire:</b> <input type="date" id="exp-${b.id}" value="${b["Expire Date"] || ""}" ${role !== "Manager" ? "disabled" : ""}>
            <b>Location:</b> <input type="text" id="loc-${b.id}" value="${b.Location || ""}" ${role !== "Manager" ? "disabled" : ""}></p>
            ${role === "Manager" ? `<button class="btn-small" onclick="updateInventory(${b.id})">Save</button>` : ""}
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(div);
  });
}

function toggleExpand(pid) {
  const section = document.getElementById(`expand-${pid}`);
  section.style.display = section.style.display === "block" ? "none" : "block";
}

function togglePriceEdit(pid) {
  const section = document.getElementById(`priceEdit-${pid}`);
  section.style.display = section.style.display === "block" ? "none" : "block";
}

function searchProduct() {
  const val = document.getElementById("searchInput").value.trim().toLowerCase();
  const filtered = products.filter(p =>
    p["Product Name"].toLowerCase().includes(val) ||
    p["Product ID"].toLowerCase().includes(val)
  );
  renderProducts(filtered);
}

// ---- SCANNER ----
function toggleScanner() {
  const reader = document.getElementById("reader");
  if (reader.style.display === "none" || reader.style.display === "") {
    reader.style.display = "block";
    startScanner();
  } else {
    stopScanner();
  }
}

function startScanner() {
  html5QrCode = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
      html5QrCode.start(
        devices[0].id,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          stopScanner();
          document.getElementById("searchInput").value = decodedText;
          searchProduct();
        }
      );
    }
  });
}

function stopScanner() {
  const reader = document.getElementById("reader");
  reader.style.display = "none";
  if (html5QrCode) html5QrCode.stop().catch(() => {});
}

// ---- Update Inventory ----
async function updateInventory(id) {
  const count = parseInt(document.getElementById(`count-${id}`).value);
  const exp = document.getElementById(`exp-${id}`).value;
  const loc = document.getElementById(`loc-${id}`).value;

  await fetch(`https://api.baserow.io/api/database/rows/table/${INVENTORY_TABLE}/${id}/?user_field_names=true`, {
    method: "PATCH",
    headers: { Authorization: `Token ${API_KEY}`, "Content-Type": "application/json" },
    body: JSON.stringify({
      Count: count,
      "Expire Date": exp,
      Location: loc
    })
  });

  alert("Inventory updated successfully!");
  loadData();
}

// ---- Update Price ----
async function updatePrice(id, pid) {
  const newPrice = parseFloat(document.getElementById(`priceVal-${id}`).value);
  if (isNaN(newPrice) || newPrice <= 0) {
    alert("Invalid price");
    return;
  }

  await fetch(`https://api.baserow.io/api/database/rows/table/${PRODUCTS_TABLE}/${id}/?user_field_names=true`, {
    method: "PATCH",
    headers: { Authorization: `Token ${API_KEY}`, "Content-Type": "application/json" },
    body: JSON.stringify({ Price: newPrice })
  });

  alert("Price updated successfully!");
  document.getElementById(`priceEdit-${pid}`).style.display = "none";
  loadData();
}

init();
</script>
</body>
</html>