<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real Profit Margin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #43aa8b;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 15px;
      min-height: 100vh;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      margin: 8px 0;
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--gray);
      font-weight: 600;
    }
    
    .total-revenue { color: var(--primary); }
    .real-margin { color: var(--success); }
    .gross-margin { color: var(--info); }
    .total-invoices { color: var(--secondary); }
    .tax-savings { color: var(--warning); }
    
    .profit-explanation {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .explanation-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--primary);
    }
    
    .calculation-steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .calculation-step {
      padding: 15px;
      background: var(--light);
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary);
    }
    
    .step-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
    }
    
    .step-value {
      font-weight: 700;
      color: var(--primary);
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .chart-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .chart-actions {
      display: flex;
      gap: 8px;
    }
    
    .chart-btn {
      padding: 6px 12px;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      background: white;
      color: var(--gray);
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .chart-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .chart-btn:hover:not(.active) {
      background: var(--gray-light);
    }
    
    .chart-container {
      height: 250px;
      position: relative;
    }
    
    .tables-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .table-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      overflow-x: auto;
    }
    
    .table-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--dark);
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
    }
    
    .data-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid var(--gray-light);
      color: var(--gray);
      font-weight: 600;
      font-size: 13px;
    }
    
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--gray-light);
      font-size: 14px;
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .data-table tr:hover {
      background: rgba(67, 97, 238, 0.03);
    }
    
    .positive {
      color: var(--success);
      font-weight: 600;
    }
    
    .negative {
      color: var(--danger);
      font-weight: 600;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
    }
    
    .page-btn {
      padding: 6px 12px;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      background: white;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
      font-size: 13px;
    }
    
    .page-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .page-btn:hover:not(.active) {
      background: var(--gray-light);
    }
    
    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
      min-width: 150px;
    }
    
    .filter-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray);
    }
    
    .filter-select {
      padding: 10px 15px;
      border-radius: var(--border-radius);
      border: 2px solid var(--gray-light);
      background: white;
      color: var(--dark);
      font-weight: 500;
    }
    
    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .refresh-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      align-self: flex-end;
      height: fit-content;
    }
    
    .refresh-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }
    
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .error-message {
      background: var(--danger);
      color: white;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      text-align: center;
      font-weight: 500;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 1024px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .tables-container {
        grid-template-columns: 1fr;
      }
      
      .calculation-steps {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .filter-select {
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-value {
        font-size: 20px;
      }
      
      .chart-card {
        padding: 15px;
      }
      
      .chart-container {
        height: 200px;
      }
      
      .table-card {
        padding: 15px;
      }
      
      .data-table {
        min-width: 400px;
      }
      
      .data-table th, .data-table td {
        padding: 8px 10px;
        font-size: 12px;
      }
      
      .profit-explanation {
        padding: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .chart-actions {
        width: 100%;
        justify-content: center;
      }
      
      .data-table {
        min-width: 350px;
      }
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <!-- Error Message -->
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <!-- Filters Section -->
    <div class="filters">
      <div class="filter-group">
        <div class="filter-label">Time Period</div>
        <select id="timeFilter" class="filter-select">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month" selected>This Month</option>
          <option value="quarter">This Quarter</option>
          <option value="year">This Year</option>
        </select>
      </div>
      
      <div class="filter-group">
        <div class="filter-label">Product</div>
        <select id="productFilter" class="filter-select">
          <option value="all">All Products</option>
        </select>
      </div>
      
      <div class="filter-group">
        <div class="filter-label">Invoice</div>
        <select id="invoiceFilter" class="filter-select">
          <option value="all">All Invoices</option>
        </select>
      </div>
      
      <div class="filter-group">
        <div class="filter-label">Customer</div>
        <select id="customerFilter" class="filter-select">
          <option value="all">All Customers</option>
        </select>
      </div>
      
      <button class="refresh-btn" id="refreshBtn">
        <span id="btnText">Refresh Data</span>
      </button>
    </div>

    <!-- Profit Explanation -->
    <div class="profit-explanation">
      <div class="explanation-title">How Real Profit is Calculated</div>
      <div class="calculation-steps">
        <div class="calculation-step">
          <div class="step-title">Purchase Price (Incl. Tax)</div>
          <div class="step-value" id="purchasePriceEx">₹0.00</div>
          <small>You already paid tax on this amount</small>
        </div>
        <div class="calculation-step">
          <div class="step-title">Selling Price (Incl. Tax)</div>
          <div class="step-value" id="sellingPriceEx">₹0.00</div>
          <small>Customer pays tax on this amount</small>
        </div>
        <div class="calculation-step">
          <div class="step-title">Tax You Need to Pay</div>
          <div class="step-value" id="taxToPayEx">₹0.00</div>
          <small>Only on the profit margin</small>
        </div>
        <div class="calculation-step">
          <div class="step-title">Real Profit</div>
          <div class="step-value positive" id="realProfitEx">₹0.00</div>
          <small>After accounting for purchase tax</small>
        </div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value total-revenue" id="totalRevenue">₹0.00</div>
        <div class="stat-label">All Invoices</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Real Profit</div>
        <div class="stat-value real-margin" id="realMargin">₹0.00</div>
        <div class="stat-label">After Purchase Tax</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Gross Margin</div>
        <div class="stat-value gross-margin" id="grossMargin">₹0.00</div>
        <div class="stat-label">Before Tax Adjustment</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Tax Savings</div>
        <div class="stat-value tax-savings" id="taxSavings">₹0.00</div>
        <div class="stat-label">From Purchase Tax Credit</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Total Invoices</div>
        <div class="stat-value total-invoices" id="totalInvoices">0</div>
        <div class="stat-label">Processed</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Real Profit vs Gross Margin</div>
          <div class="chart-actions">
            <button class="chart-btn" data-chart="profitChart" data-type="daily">Daily</button>
            <button class="chart-btn active" data-chart="profitChart" data-type="monthly">Monthly</button>
            <button class="chart-btn" data-chart="profitChart" data-type="yearly">Yearly</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="profitChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Top Products by Real Profit</div>
          <div class="chart-actions">
            <button class="chart-btn active" data-chart="productChart" data-type="profit">By Profit</button>
            <button class="chart-btn" data-chart="productChart" data-type="margin">By Margin %</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="productChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Tables Section -->
    <div class="tables-container">
      <div class="table-card">
        <div class="table-title">Real Profit by Invoice</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Customer</th>
              <th>Revenue</th>
              <th>Real Profit</th>
              <th>Tax Paid</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
            <tr>
              <td colspan="5" style="text-align: center;">Loading data from Baserow...</td>
            </tr>
          </tbody>
        </table>
        <div class="pagination">
          <button class="page-btn active">1</button>
          <button class="page-btn">2</button>
          <button class="page-btn">3</button>
        </div>
      </div>
      
      <div class="table-card">
        <div class="table-title">Product Real Profitability</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Sold</th>
              <th>Revenue</th>
              <th>Real Profit</th>
              <th>Profit %</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <tr>
              <td colspan="5" style="text-align: center;">Loading data from Baserow...</td>
            </tr>
          </tbody>
        </table>
        <div class="pagination">
          <button class="page-btn active">1</button>
          <button class="page-btn">2</button>
          <button class="page-btn">3</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Baserow API Configuration
    const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
    const salesTableId = 736209;
    const productTableId = 734793;

    const salesUrl = `https://api.baserow.io/api/database/rows/table/${salesTableId}/?user_field_names=true`;
    const productUrl = `https://api.baserow.io/api/database/rows/table/${productTableId}/?user_field_names=true`;

    // Chart instances
    let profitChart, productChart;
    let allSalesData = [];
    let allProductData = [];

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      loadDashboardData();
    });

    function setupEventListeners() {
      // Filter change events
      document.getElementById('timeFilter').addEventListener('change', loadDashboardData);
      document.getElementById('productFilter').addEventListener('change', loadDashboardData);
      document.getElementById('invoiceFilter').addEventListener('change', loadDashboardData);
      document.getElementById('customerFilter').addEventListener('change', loadDashboardData);
      
      // Refresh button
      document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);
      
      // Chart button events
      document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const chartType = this.getAttribute('data-chart');
          const dataType = this.getAttribute('data-type');
          
          // Update active state
          this.parentElement.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Update chart
          updateChart(chartType, dataType);
        });
      });
    }

    async function fetchBaserowData() {
      try {
        // Fetch Product Table
        const productResponse = await fetch(productUrl, {
          headers: { Authorization: `Token ${apiKey}` }
        });
        
        if (!productResponse.ok) {
          throw new Error(`Product API error: ${productResponse.status}`);
        }
        
        const productData = await productResponse.json();
        allProductData = productData.results;

        // Fetch Sales Table
        const salesResponse = await fetch(salesUrl, {
          headers: { Authorization: `Token ${apiKey}` }
        });
        
        if (!salesResponse.ok) {
          throw new Error(`Sales API error: ${salesResponse.status}`);
        }
        
        const salesData = await salesResponse.json();
        allSalesData = salesData.results;

        return { success: true, products: allProductData, sales: allSalesData };
      } catch (error) {
        console.error('Error fetching Baserow data:', error);
        return { success: false, error: error.message };
      }
    }

    function calculateRealProfit(purchasePrice, sellingPrice, quantity, taxPercentage, taxIncluded = true) {
      if (!purchasePrice || !sellingPrice || !quantity) {
        return {
          purchaseBase: 0,
          sellingBase: 0,
          grossProfit: 0,
          realProfit: 0,
          taxToPay: 0,
          taxSavings: 0,
          purchaseTax: 0,
          sellingTax: 0
        };
      }

      purchasePrice = Number(purchasePrice);
      sellingPrice = Number(sellingPrice);
      quantity = Number(quantity);
      taxPercentage = Number(taxPercentage) || 0;

      // Calculate tax components
      const purchaseTax = taxIncluded ? (purchasePrice * taxPercentage) / (100 + taxPercentage) : 0;
      const sellingTax = taxIncluded ? (sellingPrice * taxPercentage) / (100 + taxPercentage) : 0;
      
      // Calculate base prices (without tax)
      const purchaseBase = taxIncluded ? purchasePrice - purchaseTax : purchasePrice;
      const sellingBase = taxIncluded ? sellingPrice - sellingTax : sellingPrice;
      
      // Calculate gross profit (before tax adjustment)
      const grossProfit = (sellingPrice - purchasePrice) * quantity;
      
      // Calculate tax you need to pay (only on the profit margin)
      const profitMargin = (sellingBase - purchaseBase) * quantity;
      const taxToPay = taxIncluded ? (profitMargin * taxPercentage) / 100 : 0;
      
      // Calculate real profit (after accounting for purchase tax)
      const realProfit = taxIncluded ? grossProfit - taxToPay : grossProfit;
      
      // Calculate tax savings (from purchase tax credit)
      const taxSavings = purchaseTax * quantity;
      
      return {
        purchaseBase: purchaseBase * quantity,
        sellingBase: sellingBase * quantity,
        grossProfit,
        realProfit,
        taxToPay,
        taxSavings,
        purchaseTax: purchaseTax * quantity,
        sellingTax: sellingTax * quantity
      };
    }

    async function loadDashboardData() {
      const refreshBtn = document.getElementById("refreshBtn");
      const btnText = document.getElementById("btnText");
      const errorDiv = document.getElementById("errorMessage");

      // Show loading state
      refreshBtn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> Loading...';
      errorDiv.style.display = 'none';

      try {
        // Fetch data from Baserow
        const baserowData = await fetchBaserowData();
        
        if (!baserowData.success) {
          throw new Error(baserowData.error);
        }

        // Get filter values
        const timeFilter = document.getElementById('timeFilter').value;
        const productFilter = document.getElementById('productFilter').value;
        const invoiceFilter = document.getElementById('invoiceFilter').value;
        const customerFilter = document.getElementById('customerFilter').value;

        // Filter data based on shop ID from localStorage
        const shopIDTag = localStorage.getItem("ShopIDTag");
        let filteredSales = baserowData.sales.filter(row => row.ShopID === shopIDTag);

        // Apply additional filters
        if (productFilter !== 'all') {
          filteredSales = filteredSales.filter(sale => sale["Product ID"] === productFilter);
        }
        
        if (invoiceFilter !== 'all') {
          filteredSales = filteredSales.filter(sale => sale["Invoice Number"] === invoiceFilter);
        }
        
        if (customerFilter !== 'all') {
          filteredSales = filteredSales.filter(sale => sale["Costomer Name"] === customerFilter);
        }

        // Update filters dropdowns with actual data
        updateFilterDropdowns(filteredSales, baserowData.products);

        // Calculate metrics
        calculateDashboardMetrics(filteredSales, baserowData.products);
        
        // Update charts
        updateCharts(filteredSales, baserowData.products);
        
        // Update tables
        updateTables(filteredSales, baserowData.products);

      } catch (error) {
        console.error("Error loading dashboard data:", error);
        errorDiv.textContent = `Error loading data: ${error.message}`;
        errorDiv.style.display = 'block';
      } finally {
        refreshBtn.disabled = false;
        btnText.textContent = "Refresh Data";
      }
    }

    function updateFilterDropdowns(salesData, productData) {
      // Update product filter
      const productFilter = document.getElementById('productFilter');
      // Clear existing options (keep "All Products")
      while (productFilter.children.length > 1) {
        productFilter.removeChild(productFilter.lastChild);
      }

      const uniqueProducts = [...new Set(salesData.map(sale => sale["Product ID"]))];
      uniqueProducts.forEach(productId => {
        const product = productData.find(p => p["Product ID"] === productId);
        const productName = product ? product["Product Name"] : productId;
        
        const option = document.createElement('option');
        option.value = productId;
        option.textContent = productName;
        productFilter.appendChild(option);
      });

      // Update invoice filter
      const invoiceFilter = document.getElementById('invoiceFilter');
      while (invoiceFilter.children.length > 1) {
        invoiceFilter.removeChild(invoiceFilter.lastChild);
      }

      const uniqueInvoices = [...new Set(salesData.map(sale => sale["Invoice Number"]))];
      uniqueInvoices.forEach(invoiceNo => {
        const option = document.createElement('option');
        option.value = invoiceNo;
        option.textContent = invoiceNo;
        invoiceFilter.appendChild(option);
      });

      // Update customer filter
      const customerFilter = document.getElementById('customerFilter');
      while (customerFilter.children.length > 1) {
        customerFilter.removeChild(customerFilter.lastChild);
      }

      const uniqueCustomers = [...new Set(salesData.map(sale => sale["Costomer Name"]))];
      uniqueCustomers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer;
        option.textContent = customer;
        customerFilter.appendChild(option);
      });
    }

    function calculateDashboardMetrics(salesData, productData) {
      let totalRevenue = 0;
      let totalGrossProfit = 0;
      let totalRealProfit = 0;
      let totalTaxSavings = 0;
      let invoiceCount = new Set(salesData.map(s => s["Invoice Number"])).size;

      let exampleData = null;

      salesData.forEach(sale => {
        const product = productData.find(p => p["Product ID"] === sale["Product ID"]);
        if (!product) return;

        const profitData = calculateRealProfit(
          product["Purchase Price"] || 0,
          sale.Price || 0,
          sale.Quantity || 0,
          product["Tax Percentage"] || 0,
          product["Tax Included"] || true
        );
        
        totalRevenue += (sale.Price || 0) * (sale.Quantity || 0);
        totalGrossProfit += profitData.grossProfit;
        totalRealProfit += profitData.realProfit;
        totalTaxSavings += profitData.taxSavings;

        // Store first product as example
        if (!exampleData && product["Purchase Price"] && sale.Price) {
          exampleData = {
            purchasePrice: product["Purchase Price"],
            sellingPrice: sale.Price,
            quantity: sale.Quantity || 1,
            taxPercentage: product["Tax Percentage"] || 0
          };
        }
      });

      // Update dashboard stats
      document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
      document.getElementById('realMargin').textContent = `₹${totalRealProfit.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
      document.getElementById('grossMargin').textContent = `₹${totalGrossProfit.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
      document.getElementById('taxSavings').textContent = `₹${totalTaxSavings.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
      document.getElementById('totalInvoices').textContent = invoiceCount;

      // Update example calculation
      if (exampleData) {
        const exampleProfit = calculateRealProfit(
          exampleData.purchasePrice,
          exampleData.sellingPrice,
          exampleData.quantity,
          exampleData.taxPercentage
        );
        
        document.getElementById('purchasePriceEx').textContent = `₹${(exampleData.purchasePrice * exampleData.quantity).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        document.getElementById('sellingPriceEx').textContent = `₹${(exampleData.sellingPrice * exampleData.quantity).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        document.getElementById('taxToPayEx').textContent = `₹${exampleProfit.taxToPay.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        document.getElementById('realProfitEx').textContent = `₹${exampleProfit.realProfit.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
      }
    }

    function updateCharts(salesData, productData) {
      // Group data by product for charts
      const productProfitMap = new Map();
      
      salesData.forEach(sale => {
        const product = productData.find(p => p["Product ID"] === sale["Product ID"]);
        if (!product) return;

        const profitData = calculateRealProfit(
          product["Purchase Price"] || 0,
          sale.Price || 0,
          sale.Quantity || 0,
          product["Tax Percentage"] || 0,
          product["Tax Included"] || true
        );

        const productName = product["Product Name"] || sale["Product ID"];
        
        if (!productProfitMap.has(productName)) {
          productProfitMap.set(productName, {
            realProfit: 0,
            revenue: 0
          });
        }
        
        const productData = productProfitMap.get(productName);
        productData.realProfit += profitData.realProfit;
        productData.revenue += (sale.Price || 0) * (sale.Quantity || 0);
      });

      const productNames = Array.from(productProfitMap.keys());
      const realProfits = productNames.map(name => productProfitMap.get(name).realProfit);
      const revenues = productNames.map(name => productProfitMap.get(name).revenue);

      // Profit vs Margin Chart
      const profitCtx = document.getElementById('profitChart').getContext('2d');
      
      if (profitChart) {
        profitChart.destroy();
      }
      
      profitChart = new Chart(profitCtx, {
        type: 'bar',
        data: {
          labels: productNames.slice(0, 6), // Top 6 products
          datasets: [
            {
              label: 'Real Profit',
              data: realProfits.slice(0, 6),
              backgroundColor: '#4cc9f0',
              borderColor: '#4cc9f0',
              borderWidth: 1
            },
            {
              label: 'Revenue',
              data: revenues.slice(0, 6),
              backgroundColor: '#4361ee',
              borderColor: '#4361ee',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '₹' + value.toLocaleString('en-IN');
                }
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ₹' + context.raw.toLocaleString('en-IN', {minimumFractionDigits: 2});
                }
              }
            }
          }
        }
      });

      // Product Profit Chart
      const productCtx = document.getElementById('productChart').getContext('2d');
      
      if (productChart) {
        productChart.destroy();
      }
      
      // Calculate percentages for doughnut chart
      const totalProfit = realProfits.reduce((sum, profit) => sum + Math.max(profit, 0), 0);
      const profitPercentages = realProfits.map(profit => 
        totalProfit > 0 ? (Math.max(profit, 0) / totalProfit) * 100 : 0
      );

      productChart = new Chart(productCtx, {
        type: 'doughnut',
        data: {
          labels: productNames,
          datasets: [{
            data: profitPercentages,
            backgroundColor: [
              '#4361ee', '#4cc9f0', '#7209b7', '#f8961e', '#43aa8b', '#f72585'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const profit = realProfits[context.dataIndex];
                  return `${context.label}: ${context.raw.toFixed(1)}% (₹${profit.toLocaleString('en-IN', {minimumFractionDigits: 2})})`;
                }
              }
            }
          }
        }
      });
    }

    function updateChart(chartType, dataType) {
      // This would update the chart based on the selected type
      console.log(`Updating ${chartType} with ${dataType} data`);
      // In a real implementation, you would fetch new data and update the chart
    }

    function updateTables(salesData, productData) {
      // Update invoice table
      const invoiceTableBody = document.getElementById('invoiceTableBody');
      invoiceTableBody.innerHTML = '';

      const invoiceMap = new Map();
      
      salesData.forEach(sale => {
        const invoiceNo = sale["Invoice Number"];
        if (!invoiceMap.has(invoiceNo)) {
          invoiceMap.set(invoiceNo, {
            invoiceNo: invoiceNo,
            customer: sale["Costomer Name"] || 'Unknown',
            revenue: 0,
            realProfit: 0,
            taxToPay: 0
          });
        }
        
        const invoice = invoiceMap.get(invoiceNo);
        const product = productData.find(p => p["Product ID"] === sale["Product ID"]);
        
        if (product) {
          const profitData = calculateRealProfit(
            product["Purchase Price"] || 0,
            sale.Price || 0,
            sale.Quantity || 0,
            product["Tax Percentage"] || 0,
            product["Tax Included"] || true
          );
          
          invoice.revenue += (sale.Price || 0) * (sale.Quantity || 0);
          invoice.realProfit += profitData.realProfit;
          invoice.taxToPay += profitData.taxToPay;
        }
      });

      const invoices = Array.from(invoiceMap.values()).sort((a, b) => b.realProfit - a.realProfit);
      
      if (invoices.length === 0) {
        invoiceTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No invoice data available</td></tr>';
      } else {
        invoices.forEach(invoice => {
          const profitClass = invoice.realProfit >= 0 ? 'positive' : 'negative';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${invoice.invoiceNo}</td>
            <td>${invoice.customer}</td>
            <td>₹${invoice.revenue.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
            <td class="${profitClass}">₹${invoice.realProfit.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
            <td>₹${invoice.taxToPay.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
          `;
          invoiceTableBody.appendChild(row);
        });
      }

      // Update product table
      const productTableBody = document.getElementById('productTableBody');
      productTableBody.innerHTML = '';

      const productMap = new Map();
      
      salesData.forEach(sale => {
        const productId = sale["Product ID"];
        const product = productData.find(p => p["Product ID"] === productId);
        
        if (product) {
          const productName = product["Product Name"] || productId;
          
          if (!productMap.has(productId)) {
            productMap.set(productId, {
              productName: productName,
              unitsSold: 0,
              revenue: 0,
              realProfit: 0
            });
          }
          
          const productSummary = productMap.get(productId);
          const profitData = calculateRealProfit(
            product["Purchase Price"] || 0,
            sale.Price || 0,
            sale.Quantity || 0,
            product["Tax Percentage"] || 0,
            product["Tax Included"] || true
          );
          
          productSummary.unitsSold += Number(sale.Quantity) || 0;
          productSummary.revenue += (sale.Price || 0) * (sale.Quantity || 0);
          productSummary.realProfit += profitData.realProfit;
        }
      });

      const products = Array.from(productMap.values()).sort((a, b) => b.realProfit - a.realProfit);
      
      if (products.length === 0) {
        productTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No product data available</td></tr>';
      } else {
        products.forEach(product => {
          const profitClass = product.realProfit >= 0 ? 'positive' : 'negative';
          const profitPercentage = product.revenue > 0 ? (product.realProfit / product.revenue) * 100 : 0;
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${product.productName}</td>
            <td>${product.unitsSold}</td>
            <td>₹${product.revenue.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
            <td class="${profitClass}">₹${product.realProfit.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
            <td class="${profitClass}">${profitPercentage.toFixed(2)}%</td>
          `;
          productTableBody.appendChild(row);
        });
      }
    }
  </script>

</body>
</html>