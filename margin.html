<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real Profit Margin Dashboard</title>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #43aa8b;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 15px;
      min-height: 100vh;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      display: none; /* Hidden as requested */
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .shop-info {
      text-align: left;
      flex: 1;
      min-width: 250px;
    }
    
    .shop-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    
    .shop-details {
      font-size: 14px;
      opacity: 0.9;
      line-height: 1.5;
    }
    
    .shop-id {
      font-size: 13px;
      opacity: 0.8;
      margin-top: 10px;
      font-weight: 500;
    }
    
    .date-range {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .date-input {
      padding: 8px 12px;
      border-radius: var(--border-radius);
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.15);
      color: white;
      font-weight: 500;
      flex: 1;
      min-width: 140px;
    }
    
    .date-input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.7);
    }
    
    .date-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      margin: 8px 0;
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--gray);
      font-weight: 600;
    }
    
    .total-revenue { color: var(--primary); }
    .real-margin { color: var(--success); }
    .gross-margin { color: var(--info); }
    .total-invoices { color: var(--secondary); }
    .tax-savings { color: var(--warning); }
    
    .profit-explanation {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .explanation-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--primary);
    }
    
    .calculation-steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .calculation-step {
      padding: 15px;
      background: var(--light);
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary);
    }
    
    .step-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
    }
    
    .step-value {
      font-weight: 700;
      color: var(--primary);
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .chart-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .chart-actions {
      display: flex;
      gap: 8px;
    }
    
    .chart-btn {
      padding: 6px 12px;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      background: white;
      color: var(--gray);
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .chart-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .chart-btn:hover:not(.active) {
      background: var(--gray-light);
    }
    
    .chart-canvas {
      height: 250px;
      width: 100%;
    }
    
    .tables-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .table-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      overflow-x: auto;
    }
    
    .table-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--dark);
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
    }
    
    .data-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid var(--gray-light);
      color: var(--gray);
      font-weight: 600;
      font-size: 13px;
    }
    
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--gray-light);
      font-size: 14px;
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .data-table tr:hover {
      background: rgba(67, 97, 238, 0.03);
    }
    
    .positive {
      color: var(--success);
      font-weight: 600;
    }
    
    .negative {
      color: var(--danger);
      font-weight: 600;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
    }
    
    .page-btn {
      padding: 6px 12px;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      background: white;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
      font-size: 13px;
    }
    
    .page-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .page-btn:hover:not(.active) {
      background: var(--gray-light);
    }
    
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 10px 15px;
      border-radius: var(--border-radius);
      border: 2px solid var(--gray-light);
      background: white;
      color: var(--dark);
      font-weight: 500;
      min-width: 150px;
      flex: 1;
    }
    
    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .refresh-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }
    
    .refresh-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }
    
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tax-breakdown {
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius);
      font-size: 13px;
    }
    
    .tax-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 1024px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .tables-container {
        grid-template-columns: 1fr;
      }
      
      .calculation-steps {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .header-content {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .shop-info {
        text-align: center;
      }
      
      .date-range {
        flex-direction: column;
        width: 100%;
      }
      
      .date-input {
        width: 100%;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .filter-select {
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-value {
        font-size: 20px;
      }
      
      .chart-card {
        padding: 15px;
      }
      
      .chart-canvas {
        height: 200px;
      }
      
      .table-card {
        padding: 15px;
      }
      
      .data-table {
        min-width: 400px;
      }
      
      .data-table th, .data-table td {
        padding: 8px 10px;
        font-size: 12px;
      }
      
      .profit-explanation {
        padding: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .shop-name {
        font-size: 20px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .chart-actions {
        width: 100%;
        justify-content: center;
      }
      
      .data-table {
        min-width: 350px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="dashboard-container">
    <!-- Header is hidden as requested -->
    <div class="dashboard-header" id="dashboardHeader">
      <div class="header-content">
        <div class="shop-info">
          <div class="shop-name" id="shopName">Real Profit Margin Dashboard</div>
          <div class="shop-details">
            <div class="shop-address" id="shopAddress">Actual Profit After Purchase Tax</div>
            <div class="shop-phone" id="shopPhone">Track your real margins</div>
          </div>
          <div class="shop-id">Shop ID: <span id="shopTag">Loading...</span></div>
        </div>
        <div class="date-range">
          <input type="date" id="startDate" class="date-input" placeholder="Start Date">
          <span>to</span>
          <input type="date" id="endDate" class="date-input" placeholder="End Date">
        </div>
      </div>
    </div>

    <div class="filters">
      <select id="timeFilter" class="filter-select">
        <option value="all">All Time</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
        <option value="quarter">This Quarter</option>
        <option value="year">This Year</option>
      </select>
      
      <select id="productFilter" class="filter-select">
        <option value="all">All Products</option>
      </select>
      
      <select id="invoiceFilter" class="filter-select">
        <option value="all">All Invoices</option>
      </select>
      
      <button class="refresh-btn" id="refreshBtn">
        <span id="btnText">Refresh Data</span>
      </button>
    </div>

    <div class="profit-explanation">
      <div class="explanation-title">How Real Profit is Calculated</div>
      <div class="calculation-steps">
        <div class="calculation-step">
          <div class="step-title">Purchase Price (Incl. Tax)</div>
          <div class="step-value" id="purchasePriceEx">₹0.00</div>
          <small>You already paid tax on this amount</small>
        </div>
        <div class="calculation-step">
          <div class="step-title">Selling Price (Incl. Tax)</div>
          <div class="step-value" id="sellingPriceEx">₹0.00</div>
          <small>Customer pays tax on this amount</small>
        </div>
        <div class="calculation-step">
          <div class="step-title">Tax You Need to Pay</div>
          <div class="step-value" id="taxToPayEx">₹0.00</div>
          <small>Only on the profit margin</small>
        </div>
        <div class="calculation-step">
          <div class="step-title">Real Profit</div>
          <div class="step-value positive" id="realProfitEx">₹0.00</div>
          <small>After accounting for purchase tax</small>
        </div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value total-revenue" id="totalRevenue">₹0.00</div>
        <div class="stat-label">All Invoices</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Real Profit</div>
        <div class="stat-value real-margin" id="realMargin">₹0.00</div>
        <div class="stat-label">After Purchase Tax</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Gross Margin</div>
        <div class="stat-value gross-margin" id="grossMargin">₹0.00</div>
        <div class="stat-label">Before Tax Adjustment</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Tax Savings</div>
        <div class="stat-value tax-savings" id="taxSavings">₹0.00</div>
        <div class="stat-label">From Purchase Tax Credit</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Total Invoices</div>
        <div class="stat-value total-invoices" id="totalInvoices">0</div>
        <div class="stat-label">Processed</div>
      </div>
    </div>

    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Real Profit vs Gross Margin</div>
          <div class="chart-actions">
            <button class="chart-btn active" data-chart-type="monthly">Monthly</button>
            <button class="chart-btn" data-chart-type="quarterly">Quarterly</button>
            <button class="chart-btn" data-chart-type="yearly">Yearly</button>
          </div>
        </div>
        <canvas id="profitComparisonChart" class="chart-canvas"></canvas>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Top Products by Real Profit</div>
        </div>
        <canvas id="productProfitChart" class="chart-canvas"></canvas>
      </div>
    </div>

    <div class="tables-container">
      <div class="table-card">
        <div class="table-title">Real Profit by Invoice</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Customer</th>
              <th>Revenue</th>
              <th>Real Profit</th>
              <th>Tax Paid</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
            <tr>
              <td colspan="5" style="text-align: center;">No data available</td>
            </tr>
          </tbody>
        </table>
        <div class="pagination" id="invoicePagination">
          <!-- Pagination will be generated here -->
        </div>
      </div>
      
      <div class="table-card">
        <div class="table-title">Product Real Profitability</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Sold</th>
              <th>Revenue</th>
              <th>Real Profit</th>
              <th>Profit %</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <tr>
              <td colspan="5" style="text-align: center;">No data available</td>
            </tr>
          </tbody>
        </table>
        <div class="pagination" id="productPagination">
          <!-- Pagination will be generated here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
    const salesTableId = 736209;
    const productTableId = 734793;

    const salesUrl = `https://api.baserow.io/api/database/rows/table/${salesTableId}/?user_field_names=true`;
    const productUrl = `https://api.baserow.io/api/database/rows/table/${productTableId}/?user_field_names=true`;

    let allSalesData = [];
    let allProductData = [];
    let filteredSalesData = [];
    let filteredProductData = [];
    
    // Pagination variables
    let currentInvoicePage = 1;
    let currentProductPage = 1;
    const itemsPerPage = 20;
    
    // Chart instances
    let profitComparisonChart = null;
    let productProfitChart = null;

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      loadShopInfo();
      setDefaultDates();
      setupEventListeners();
      loadDashboardData();
    });

    function setupEventListeners() {
      // Filter event listeners
      document.getElementById('timeFilter').addEventListener('change', applyFilters);
      document.getElementById('productFilter').addEventListener('change', applyFilters);
      document.getElementById('invoiceFilter').addEventListener('change', applyFilters);
      document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);
      
      // Chart period buttons
      document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          updateCharts(this.dataset.chartType);
        });
      });
      
      // Date range filters
      document.getElementById('startDate').addEventListener('change', applyFilters);
      document.getElementById('endDate').addEventListener('change', applyFilters);
    }

    function setDefaultDates() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      
      document.getElementById('startDate').valueAsDate = firstDay;
      document.getElementById('endDate').valueAsDate = today;
    }

    function parseShopTag(shopTag) {
      let shopName = "Your Shop";
      let address = "Address not available";
      let phone = "Phone not available";
      
      if (shopTag) {
        const firstSplit = shopTag.split('-');
        
        if (firstSplit.length > 1) {
          shopName = firstSplit[0].trim();
          const secondSplit = firstSplit[1].split('/');
          
          if (secondSplit.length > 1) {
            address = secondSplit[0].trim();
            phone = secondSplit[1].trim();
          } else {
            address = firstSplit[1].trim();
          }
        } else {
          shopName = shopTag.trim();
        }
      }
      
      return { shopName, address, phone };
    }

    function loadShopInfo() {
      const shopIDTag = localStorage.getItem("ShopIDTag");
      const shopTagValue = localStorage.getItem("ShopTag") || "Your Shop";
      
      const shopInfo = parseShopTag(shopTagValue);
      
      if (shopIDTag) {
        document.getElementById('shopTag').textContent = shopIDTag;
        document.getElementById('shopName').textContent = shopInfo.shopName + " - Real Profit Dashboard";
        document.getElementById('shopAddress').textContent = shopInfo.address;
        document.getElementById('shopPhone').textContent = shopInfo.phone;
      } else {
        document.getElementById('shopTag').textContent = "Not Set";
      }
    }

    function calculateRealProfit(purchasePrice, sellingPrice, quantity, taxPercentage) {
      // Calculate tax components
      const purchaseTax = (purchasePrice * taxPercentage) / (100 + taxPercentage);
      const sellingTax = (sellingPrice * taxPercentage) / (100 + taxPercentage);
      
      // Calculate base prices (without tax)
      const purchaseBase = purchasePrice - purchaseTax;
      const sellingBase = sellingPrice - sellingTax;
      
      // Calculate gross profit (before tax adjustment)
      const grossProfit = (sellingPrice - purchasePrice) * quantity;
      
      // Calculate tax you need to pay (only on the profit margin)
      const profitMargin = (sellingBase - purchaseBase) * quantity;
      const taxToPay = (profitMargin * taxPercentage) / 100;
      
      // Calculate real profit (after accounting for purchase tax)
      const realProfit = grossProfit - taxToPay;
      
      // Calculate tax savings (from purchase tax credit)
      const taxSavings = purchaseTax * quantity;
      
      return {
        purchaseBase: purchaseBase * quantity,
        sellingBase: sellingBase * quantity,
        grossProfit,
        realProfit,
        taxToPay,
        taxSavings,
        purchaseTax: purchaseTax * quantity,
        sellingTax: sellingTax * quantity
      };
    }

    async function loadDashboardData() {
      const refreshBtn = document.getElementById("refreshBtn");
      const btnText = document.getElementById("btnText");

      // Show loading state
      refreshBtn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> Loading...';

      try {
        // Fetch Product Table
        const productResponse = await fetch(productUrl, {
          headers: { Authorization: `Token ${apiKey}` }
        });
        const productData = await productResponse.json();
        allProductData = productData.results;

        // Fetch Sales Table
        const salesResponse = await fetch(salesUrl, {
          headers: { Authorization: `Token ${apiKey}` }
        });
        const salesData = await salesResponse.json();
        allSalesData = salesData.results;

        // Apply initial filters
        applyFilters();

      } catch (error) {
        console.error("Error loading dashboard data:", error);
        alert("Error loading data. Please check your connection and try again.");
      } finally {
        refreshBtn.disabled = false;
        btnText.textContent = "Refresh Data";
      }
    }

    function applyFilters() {
      const shopIDTag = localStorage.getItem("ShopIDTag");
      let filteredData = allSalesData.filter(row => row["ShopID"] === shopIDTag);
      
      // Apply time filter
      const timeFilter = document.getElementById('timeFilter').value;
      filteredData = filterByTimePeriod(filteredData, timeFilter);
      
      // Apply product filter
      const productFilter = document.getElementById('productFilter').value;
      if (productFilter !== 'all') {
        filteredData = filteredData.filter(row => row["Product ID"] === productFilter);
      }
      
      // Apply invoice filter
      const invoiceFilter = document.getElementById('invoiceFilter').value;
      if (invoiceFilter !== 'all') {
        filteredData = filteredData.filter(row => row["Invoice Number"] === invoiceFilter);
      }
      
      // Apply date range filter
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (startDate && endDate) {
        filteredData = filteredData.filter(row => {
          const rowDate = new Date(row["Date"]);
          const start = new Date(startDate);
          const end = new Date(endDate);
          end.setHours(23, 59, 59, 999); // Include entire end date
          return rowDate >= start && rowDate <= end;
        });
      }
      
      filteredSalesData = filteredData;
      
      // Calculate and display dashboard metrics
      calculateDashboardMetrics(filteredSalesData, allProductData);
      
      // Update filter dropdowns
      populateFilters(filteredSalesData, allProductData);
      
      // Update charts
      updateCharts('monthly');
      
      // Reset pagination
      currentInvoicePage = 1;
      currentProductPage = 1;
    }

    function filterByTimePeriod(data, period) {
      const now = new Date();
      let startDate = new Date(0); // Beginning of time
      
      switch(period) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          break;
        case 'week':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
          break;
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          startDate = new Date(now.getFullYear(), quarter * 3, 1);
          break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          break;
        default:
          // 'all' - no filtering needed
          return data;
      }
      
      return data.filter(row => {
        const rowDate = new Date(row["Date"]);
        return rowDate >= startDate && rowDate <= now;
      });
    }

    function calculateDashboardMetrics(salesData, productData) {
      let totalRevenue = 0;
      let totalGrossProfit = 0;
      let totalRealProfit = 0;
      let totalTaxSavings = 0;
      let totalTaxToPay = 0;
      let invoiceCount = 0;
      
      const invoiceMap = new Map();
      const productMap = new Map();

      // Example calculation for demonstration
      let examplePurchasePrice = 0;
      let exampleSellingPrice = 0;
      let exampleTaxPercentage = 0;
      let exampleQuantity = 0;

      // Process each sale record
      salesData.forEach(sale => {
        const product = productData.find(p => p["Product ID"] === sale["Product ID"]);
        if (!product) return;

        const quantity = Number(sale["Quantity"]) || 0;
        const sellingPrice = Number(sale["Price"]) || 0;
        const purchasePrice = Number(product["Purchase Price"]) || 0;
        const taxPercentage = Number(product["Tax Percentage"]) || 0;
        
        // Store example values for demonstration
        if (examplePurchasePrice === 0) {
          examplePurchasePrice = purchasePrice;
          exampleSellingPrice = sellingPrice;
          exampleTaxPercentage = taxPercentage;
          exampleQuantity = quantity;
        }
        
        // Calculate real profit
        const profitData = calculateRealProfit(purchasePrice, sellingPrice, quantity, taxPercentage);
        
        const revenue = sellingPrice * quantity;

        // Update invoice totals
        const invoiceNo = sale["Invoice Number"];
        if (!invoiceMap.has(invoiceNo)) {
          invoiceMap.set(invoiceNo, {
            invoiceNo: invoiceNo,
            date: sale["Date"],
            customer: sale["Costomer Name"],
            revenue: 0,
            grossProfit: 0,
            realProfit: 0,
            taxToPay: 0
          });
        }
        
        const invoice = invoiceMap.get(invoiceNo);
        invoice.revenue += revenue;
        invoice.grossProfit += profitData.grossProfit;
        invoice.realProfit += profitData.realProfit;
        invoice.taxToPay += profitData.taxToPay;

        // Update product totals
        const productId = sale["Product ID"];
        if (!productMap.has(productId)) {
          productMap.set(productId, {
            productId: productId,
            productName: product["Product Name"],
            unitsSold: 0,
            revenue: 0,
            grossProfit: 0,
            realProfit: 0,
            profitPercentage: 0
          });
        }
        
        const productSummary = productMap.get(productId);
        productSummary.unitsSold += quantity;
        productSummary.revenue += revenue;
        productSummary.grossProfit += profitData.grossProfit;
        productSummary.realProfit += profitData.realProfit;
        productSummary.profitPercentage = productSummary.revenue > 0 ? 
          (productSummary.realProfit / productSummary.revenue) * 100 : 0;

        // Update overall totals
        totalRevenue += revenue;
        totalGrossProfit += profitData.grossProfit;
        totalRealProfit += profitData.realProfit;
        totalTaxSavings += profitData.taxSavings;
        totalTaxToPay += profitData.taxToPay;
      });

      invoiceCount = invoiceMap.size;

      // Update dashboard stats
      document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toFixed(2)}`;
      document.getElementById('realMargin').textContent = `₹${totalRealProfit.toFixed(2)}`;
      document.getElementById('grossMargin').textContent = `₹${totalGrossProfit.toFixed(2)}`;
      document.getElementById('taxSavings').textContent = `₹${totalTaxSavings.toFixed(2)}`;
      document.getElementById('totalInvoices').textContent = invoiceCount;

      // Update example calculation
      if (examplePurchasePrice > 0) {
        const exampleProfit = calculateRealProfit(examplePurchasePrice, exampleSellingPrice, exampleQuantity, exampleTaxPercentage);
        document.getElementById('purchasePriceEx').textContent = `₹${(examplePurchasePrice * exampleQuantity).toFixed(2)}`;
        document.getElementById('sellingPriceEx').textContent = `₹${(exampleSellingPrice * exampleQuantity).toFixed(2)}`;
        document.getElementById('taxToPayEx').textContent = `₹${exampleProfit.taxToPay.toFixed(2)}`;
        document.getElementById('realProfitEx').textContent = `₹${exampleProfit.realProfit.toFixed(2)}`;
      }

      // Update tables with pagination
      updateInvoiceTable(Array.from(invoiceMap.values()));
      updateProductTable(Array.from(productMap.values()));
    }

    function updateInvoiceTable(invoices) {
      const tableBody = document.getElementById('invoiceTableBody');
      const pagination = document.getElementById('invoicePagination');
      
      tableBody.innerHTML = '';

      if (invoices.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No invoice data available</td></tr>';
        pagination.innerHTML = '';
        return;
      }

      // Sort by real profit (highest first)
      invoices.sort((a, b) => b.realProfit - a.realProfit);

      // Calculate pagination
      const totalPages = Math.ceil(invoices.length / itemsPerPage);
      const startIndex = (currentInvoicePage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, invoices.length);
      const pageInvoices = invoices.slice(startIndex, endIndex);

      // Update table
      pageInvoices.forEach(invoice => {
        const profitClass = invoice.realProfit >= 0 ? 'positive' : 'negative';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${invoice.invoiceNo}</td>
          <td>${invoice.customer}</td>
          <td>₹${invoice.revenue.toFixed(2)}</td>
          <td class="${profitClass}">₹${invoice.realProfit.toFixed(2)}</td>
          <td>₹${invoice.taxToPay.toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
      });

      // Update pagination
      updatePagination(pagination, currentInvoicePage, totalPages, 'invoice');
    }

    function updateProductTable(products) {
      const tableBody = document.getElementById('productTableBody');
      const pagination = document.getElementById('productPagination');
      
      tableBody.innerHTML = '';

      if (products.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No product data available</td></tr>';
        pagination.innerHTML = '';
        return;
      }

      // Sort by real profit (highest first)
      products.sort((a, b) => b.realProfit - a.realProfit);

      // Calculate pagination
      const totalPages = Math.ceil(products.length / itemsPerPage);
      const startIndex = (currentProductPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, products.length);
      const pageProducts = products.slice(startIndex, endIndex);

      // Update table
      pageProducts.forEach(product => {
        const profitClass = product.realProfit >= 0 ? 'positive' : 'negative';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.productName}</td>
          <td>${product.unitsSold}</td>
          <td>₹${product.revenue.toFixed(2)}</td>
          <td class="${profitClass}">₹${product.realProfit.toFixed(2)}</td>
          <td class="${profitClass}">${product.profitPercentage.toFixed(2)}%</td>
        `;
        tableBody.appendChild(row);
      });

      // Update pagination
      updatePagination(pagination, currentProductPage, totalPages, 'product');
    }

    function updatePagination(paginationElement, currentPage, totalPages, type) {
      paginationElement.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Previous button
      const prevButton = document.createElement('button');
      prevButton.className = 'page-btn';
      prevButton.textContent = '←';
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener('click', () => {
        if (type === 'invoice') {
          currentInvoicePage--;
          updateInvoiceTable(getInvoicesForCurrentFilter());
        } else {
          currentProductPage--;
          updateProductTable(getProductsForCurrentFilter());
        }
      });
      paginationElement.appendChild(prevButton);
      
      // Page buttons
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);
      
      for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        pageButton.textContent = i;
        pageButton.addEventListener('click', () => {
          if (type === 'invoice') {
            currentInvoicePage = i;
            updateInvoiceTable(getInvoicesForCurrentFilter());
          } else {
            currentProductPage = i;
            updateProductTable(getProductsForCurrentFilter());
          }
        });
        paginationElement.appendChild(pageButton);
      }
      
      // Next button
      const nextButton = document.createElement('button');
      nextButton.className = 'page-btn';
      nextButton.textContent = '→';
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener('click', () => {
        if (type === 'invoice') {
          currentInvoicePage++;
          updateInvoiceTable(getInvoicesForCurrentFilter());
        } else {
          currentProductPage++;
          updateProductTable(getProductsForCurrentFilter());
        }
      });
      paginationElement.appendChild(nextButton);
    }

    function getInvoicesForCurrentFilter() {
      const invoiceMap = new Map();
      
      filteredSalesData.forEach(sale => {
        const product = allProductData.find(p => p["Product ID"] === sale["Product ID"]);
        if (!product) return;

        const quantity = Number(sale["Quantity"]) || 0;
        const sellingPrice = Number(sale["Price"]) || 0;
        const purchasePrice = Number(product["Purchase Price"]) || 0;
        const taxPercentage = Number(product["Tax Percentage"]) || 0;
        
        const profitData = calculateRealProfit(purchasePrice, sellingPrice, quantity, taxPercentage);
        const revenue = sellingPrice * quantity;

        const invoiceNo = sale["Invoice Number"];
        if (!invoiceMap.has(invoiceNo)) {
          invoiceMap.set(invoiceNo, {
            invoiceNo: invoiceNo,
            date: sale["Date"],
            customer: sale["Costomer Name"],
            revenue: 0,
            grossProfit: 0,
            realProfit: 0,
            taxToPay: 0
          });
        }
        
        const invoice = invoiceMap.get(invoiceNo);
        invoice.revenue += revenue;
        invoice.grossProfit += profitData.grossProfit;
        invoice.realProfit += profitData.realProfit;
        invoice.taxToPay += profitData.taxToPay;
      });
      
      return Array.from(invoiceMap.values());
    }

    function getProductsForCurrentFilter() {
      const productMap = new Map();
      
      filteredSalesData.forEach(sale => {
        const product = allProductData.find(p => p["Product ID"] === sale["Product ID"]);
        if (!product) return;

        const quantity = Number(sale["Quantity"]) || 0;
        const sellingPrice = Number(sale["Price"]) || 0;
        const purchasePrice = Number(product["Purchase Price"]) || 0;
        const taxPercentage = Number(product["Tax Percentage"]) || 0;
        
        const profitData = calculateRealProfit(purchasePrice, sellingPrice, quantity, taxPercentage);
        const revenue = sellingPrice * quantity;

        const productId = sale["Product ID"];
        if (!productMap.has(productId)) {
          productMap.set(productId, {
            productId: productId,
            productName: product["Product Name"],
            unitsSold: 0,
            revenue: 0,
            grossProfit: 0,
            realProfit: 0,
            profitPercentage: 0
          });
        }
        
        const productSummary = productMap.get(productId);
        productSummary.unitsSold += quantity;
        productSummary.revenue += revenue;
        productSummary.grossProfit += profitData.grossProfit;
        productSummary.realProfit += profitData.realProfit;
        productSummary.profitPercentage = productSummary.revenue > 0 ? 
          (productSummary.realProfit / productSummary.revenue) * 100 : 0;
      });
      
      return Array.from(productMap.values());
    }

    function populateFilters(salesData, productData) {
      const productFilter = document.getElementById('productFilter');
      const invoiceFilter = document.getElementById('invoiceFilter');
      
      // Clear existing options (except "All")
      while (productFilter.children.length > 1) {
        productFilter.removeChild(productFilter.lastChild);
      }
      
      while (invoiceFilter.children.length > 1) {
        invoiceFilter.removeChild(invoiceFilter.lastChild);
      }
      
      // Add product options
      const uniqueProducts = [...new Set(salesData.map(sale => sale["Product ID"]))];
      uniqueProducts.forEach(productId => {
        const product = productData.find(p => p["Product ID"] === productId);
        const productName = product ? product["Product Name"] : productId;
        
        const option = document.createElement('option');
        option.value = productId;
        option.textContent = productName;
        productFilter.appendChild(option);
      });
      
      // Add invoice options
      const uniqueInvoices = [...new Set(salesData.map(sale => sale["Invoice Number"]))];
      uniqueInvoices.forEach(invoiceNo => {
        const option = document.createElement('option');
        option.value = invoiceNo;
        option.textContent = invoiceNo;
        invoiceFilter.appendChild(option);
      });
    }

    function updateCharts(period) {
      updateProfitComparisonChart(period);
      updateProductProfitChart();
    }

    function updateProfitComparisonChart(period) {
      const ctx = document.getElementById('profitComparisonChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (profitComparisonChart) {
        profitComparisonChart.destroy();
      }
      
      // Generate sample data based on period
      let labels, realProfitData, grossMarginData;
      
      switch(period) {
        case 'monthly':
          labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          realProfitData = labels.map(() => Math.random() * 100000 + 50000);
          grossMarginData = labels.map((_, i) => realProfitData[i] * (1 + Math.random() * 0.3));
          break;
        case 'quarterly':
          labels = ['Q1', 'Q2', 'Q3', 'Q4'];
          realProfitData = labels.map(() => Math.random() * 300000 + 150000);
          grossMarginData = labels.map((_, i) => realProfitData[i] * (1 + Math.random() * 0.3));
          break;
        case 'yearly':
          labels = ['2020', '2021', '2022', '2023', '2024'];
          realProfitData = labels.map(() => Math.random() * 1200000 + 600000);
          grossMarginData = labels.map((_, i) => realProfitData[i] * (1 + Math.random() * 0.3));
          break;
      }
      
      profitComparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Real Profit',
              data: realProfitData,
              backgroundColor: 'rgba(76, 201, 240, 0.7)',
              borderColor: 'rgba(76, 201, 240, 1)',
              borderWidth: 1
            },
            {
              label: 'Gross Margin',
              data: grossMarginData,
              backgroundColor: 'rgba(67, 97, 238, 0.5)',
              borderColor: 'rgba(67, 97, 238, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '₹' + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += '₹' + context.parsed.y.toLocaleString();
                  return label;
                }
              }
            }
          }
        }
      });
    }

    function updateProductProfitChart() {
      const ctx = document.getElementById('productProfitChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (productProfitChart) {
        productProfitChart.destroy();
      }
      
      // Get top 5 products by real profit
      const products = getProductsForCurrentFilter();
      const topProducts = products
        .sort((a, b) => b.realProfit - a.realProfit)
        .slice(0, 5);
      
      const labels = topProducts.map(p => p.productName);
      const data = topProducts.map(p => p.realProfit);
      const colors = [
        'rgba(67, 97, 238, 0.7)',
        'rgba(76, 201, 240, 0.7)',
        'rgba(114, 9, 183, 0.7)',
        'rgba(67, 170, 139, 0.7)',
        'rgba(248, 150, 30, 0.7)'
      ];
      
      productProfitChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  return `${label}: ₹${value.toLocaleString()}`;
                }
              }
            }
          }
        }
      });
    }
  </script>

</body>
</html>