<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Margin Dashboard</title>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #43aa8b;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 25px 30px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
      box-shadow: var(--shadow);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .shop-info {
      text-align: left;
    }
    
    .shop-name {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    
    .shop-details {
      font-size: 15px;
      opacity: 0.9;
      line-height: 1.5;
    }
    
    .shop-id {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 12px;
      font-weight: 500;
    }
    
    .date-range {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-top: 20px;
    }
    
    .date-input {
      padding: 10px 15px;
      border-radius: var(--border-radius);
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.15);
      color: white;
      font-weight: 500;
    }
    
    .date-input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.7);
    }
    
    .date-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--gray);
      font-weight: 600;
    }
    
    .total-revenue { color: var(--primary); }
    .total-margin { color: var(--success); }
    .avg-margin { color: var(--info); }
    .total-invoices { color: var(--secondary); }
    
    .charts-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin-bottom: 25px;
    }
    
    .chart-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .chart-actions {
      display: flex;
      gap: 10px;
    }
    
    .chart-btn {
      padding: 8px 15px;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      background: white;
      color: var(--gray);
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .chart-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .chart-placeholder {
      height: 300px;
      background: var(--light);
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray);
      font-weight: 500;
    }
    
    .tables-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 25px;
    }
    
    .table-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
    }
    
    .table-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--dark);
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 12px 15px;
      border-bottom: 2px solid var(--gray-light);
      color: var(--gray);
      font-weight: 600;
      font-size: 14px;
    }
    
    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .data-table tr:hover {
      background: rgba(67, 97, 238, 0.03);
    }
    
    .positive {
      color: var(--success);
      font-weight: 600;
    }
    
    .negative {
      color: var(--danger);
      font-weight: 600;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .page-btn {
      padding: 8px 15px;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-light);
      background: white;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .page-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .page-btn:hover:not(.active) {
      background: var(--gray-light);
    }
    
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 12px 20px;
      border-radius: var(--border-radius);
      border: 2px solid var(--gray-light);
      background: white;
      color: var(--dark);
      font-weight: 500;
      min-width: 180px;
    }
    
    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .refresh-btn {
      padding: 12px 25px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .refresh-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 1024px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .tables-container {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }
      
      .shop-info {
        text-align: center;
      }
      
      .date-range {
        flex-direction: column;
        width: 100%;
      }
      
      .date-input {
        width: 100%;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .filter-select {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-content">
        <div class="shop-info">
          <div class="shop-name" id="shopName">Margin Dashboard</div>
          <div class="shop-details">
            <div class="shop-address" id="shopAddress">Profitability Analysis</div>
            <div class="shop-phone" id="shopPhone">Track your invoice margins</div>
          </div>
          <div class="shop-id">Shop ID: <span id="shopTag">Loading...</span></div>
        </div>
        <div class="date-range">
          <input type="date" id="startDate" class="date-input" placeholder="Start Date">
          <span>to</span>
          <input type="date" id="endDate" class="date-input" placeholder="End Date">
        </div>
      </div>
    </div>

    <div class="filters">
      <select id="timeFilter" class="filter-select">
        <option value="all">All Time</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
        <option value="quarter">This Quarter</option>
        <option value="year">This Year</option>
      </select>
      
      <select id="productFilter" class="filter-select">
        <option value="all">All Products</option>
      </select>
      
      <select id="invoiceFilter" class="filter-select">
        <option value="all">All Invoices</option>
      </select>
      
      <button class="refresh-btn" id="refreshBtn" onclick="loadDashboardData()">
        <span id="btnText">Refresh Data</span>
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value total-revenue" id="totalRevenue">₹0.00</div>
        <div class="stat-label">All Invoices</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Total Margin</div>
        <div class="stat-value total-margin" id="totalMargin">₹0.00</div>
        <div class="stat-label">Net Profit</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Avg. Margin %</div>
        <div class="stat-value avg-margin" id="avgMargin">0.00%</div>
        <div class="stat-label">Across All Products</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Total Invoices</div>
        <div class="stat-value total-invoices" id="totalInvoices">0</div>
        <div class="stat-label">Processed</div>
      </div>
    </div>

    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Margin Trends</div>
          <div class="chart-actions">
            <button class="chart-btn">Daily</button>
            <button class="chart-btn active">Monthly</button>
            <button class="chart-btn">Yearly</button>
          </div>
        </div>
        <div class="chart-placeholder">
          Margin Trend Chart Will Appear Here
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Top Products by Margin</div>
        </div>
        <div class="chart-placeholder">
          Product Margin Chart Will Appear Here
        </div>
      </div>
    </div>

    <div class="tables-container">
      <div class="table-card">
        <div class="table-title">Invoice Margin Summary</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Revenue</th>
              <th>Cost</th>
              <th>Margin</th>
              <th>Margin %</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
            <tr>
              <td colspan="7" style="text-align: center;">No data available</td>
            </tr>
          </tbody>
        </table>
        <div class="pagination">
          <button class="page-btn active">1</button>
          <button class="page-btn">2</button>
          <button class="page-btn">3</button>
        </div>
      </div>
      
      <div class="table-card">
        <div class="table-title">Product Performance</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Product ID</th>
              <th>Product Name</th>
              <th>Units Sold</th>
              <th>Revenue</th>
              <th>Margin</th>
              <th>Margin %</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <tr>
              <td colspan="6" style="text-align: center;">No data available</td>
            </tr>
          </tbody>
        </table>
        <div class="pagination">
          <button class="page-btn active">1</button>
          <button class="page-btn">2</button>
          <button class="page-btn">3</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
    const salesTableId = 736209;
    const productTableId = 734793;

    const salesUrl = `https://api.baserow.io/api/database/rows/table/${salesTableId}/?user_field_names=true`;
    const productUrl = `https://api.baserow.io/api/database/rows/table/${productTableId}/?user_field_names=true`;

    let allSalesData = [];
    let allProductData = [];

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      loadShopInfo();
      setDefaultDates();
      loadDashboardData();
    });

    function setDefaultDates() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      
      document.getElementById('startDate').valueAsDate = firstDay;
      document.getElementById('endDate').valueAsDate = today;
    }

    function parseShopTag(shopTag) {
      let shopName = "Your Shop";
      let address = "Address not available";
      let phone = "Phone not available";
      
      if (shopTag) {
        const firstSplit = shopTag.split('-');
        
        if (firstSplit.length > 1) {
          shopName = firstSplit[0].trim();
          const secondSplit = firstSplit[1].split('/');
          
          if (secondSplit.length > 1) {
            address = secondSplit[0].trim();
            phone = secondSplit[1].trim();
          } else {
            address = firstSplit[1].trim();
          }
        } else {
          shopName = shopTag.trim();
        }
      }
      
      return { shopName, address, phone };
    }

    function loadShopInfo() {
      const shopIDTag = localStorage.getItem("ShopIDTag");
      const shopTagValue = localStorage.getItem("ShopTag") || "Your Shop";
      
      const shopInfo = parseShopTag(shopTagValue);
      
      if (shopIDTag) {
        document.getElementById('shopTag').textContent = shopIDTag;
        document.getElementById('shopName').textContent = shopInfo.shopName + " - Margin Dashboard";
        document.getElementById('shopAddress').textContent = shopInfo.address;
        document.getElementById('shopPhone').textContent = shopInfo.phone;
      } else {
        document.getElementById('shopTag').textContent = "Not Set";
      }
    }

    async function loadDashboardData() {
      const refreshBtn = document.getElementById("refreshBtn");
      const btnText = document.getElementById("btnText");

      // Show loading state
      refreshBtn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> Loading...';

      try {
        // Fetch Product Table
        const productResponse = await fetch(productUrl, {
          headers: { Authorization: `Token ${apiKey}` }
        });
        const productData = await productResponse.json();
        allProductData = productData.results;

        // Fetch Sales Table
        const salesResponse = await fetch(salesUrl, {
          headers: { Authorization: `Token ${apiKey}` }
        });
        const salesData = await salesResponse.json();
        allSalesData = salesData.results;

        // Filter data based on shop ID
        const shopIDTag = localStorage.getItem("ShopIDTag");
        const filteredSalesData = allSalesData.filter(row => row["ShopID"] === shopIDTag);

        // Calculate and display dashboard metrics
        calculateDashboardMetrics(filteredSalesData, allProductData);
        
        // Populate filter dropdowns
        populateFilters(filteredSalesData, allProductData);

      } catch (error) {
        console.error("Error loading dashboard data:", error);
      } finally {
        refreshBtn.disabled = false;
        btnText.textContent = "Refresh Data";
      }
    }

    function calculateDashboardMetrics(salesData, productData) {
      let totalRevenue = 0;
      let totalCost = 0;
      let totalMargin = 0;
      let invoiceCount = 0;
      
      const invoiceMap = new Map();
      const productMap = new Map();

      // Process each sale record
      salesData.forEach(sale => {
        const product = productData.find(p => p["Product ID"] === sale["Product ID"]);
        if (!product) return;

        const quantity = Number(sale["Quantity"]) || 0;
        const sellingPrice = Number(sale["Price"]) || 0;
        const purchasePrice = Number(product["Purchase Price"]) || 0;
        
        const revenue = quantity * sellingPrice;
        const cost = quantity * purchasePrice;
        const margin = revenue - cost;
        const marginPercent = revenue > 0 ? (margin / revenue) * 100 : 0;

        // Update invoice totals
        const invoiceNo = sale["Invoice Number"];
        if (!invoiceMap.has(invoiceNo)) {
          invoiceMap.set(invoiceNo, {
            invoiceNo: invoiceNo,
            date: sale["Date"],
            customer: sale["Costomer Name"],
            revenue: 0,
            cost: 0,
            margin: 0
          });
        }
        
        const invoice = invoiceMap.get(invoiceNo);
        invoice.revenue += revenue;
        invoice.cost += cost;
        invoice.margin += margin;

        // Update product totals
        const productId = sale["Product ID"];
        if (!productMap.has(productId)) {
          productMap.set(productId, {
            productId: productId,
            productName: product["Product Name"],
            unitsSold: 0,
            revenue: 0,
            margin: 0
          });
        }
        
        const productSummary = productMap.get(productId);
        productSummary.unitsSold += quantity;
        productSummary.revenue += revenue;
        productSummary.margin += margin;

        // Update overall totals
        totalRevenue += revenue;
        totalCost += cost;
        totalMargin += margin;
      });

      invoiceCount = invoiceMap.size;
      const avgMarginPercent = totalRevenue > 0 ? (totalMargin / totalRevenue) * 100 : 0;

      // Update dashboard stats
      document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toFixed(2)}`;
      document.getElementById('totalMargin').textContent = `₹${totalMargin.toFixed(2)}`;
      document.getElementById('avgMargin').textContent = `${avgMarginPercent.toFixed(2)}%`;
      document.getElementById('totalInvoices').textContent = invoiceCount;

      // Update invoice table
      updateInvoiceTable(Array.from(invoiceMap.values()));

      // Update product table
      updateProductTable(Array.from(productMap.values()));
    }

    function updateInvoiceTable(invoices) {
      const tableBody = document.getElementById('invoiceTableBody');
      tableBody.innerHTML = '';

      if (invoices.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No invoice data available</td></tr>';
        return;
      }

      // Sort by margin (highest first)
      invoices.sort((a, b) => b.margin - a.margin);

      invoices.forEach(invoice => {
        const marginPercent = invoice.revenue > 0 ? (invoice.margin / invoice.revenue) * 100 : 0;
        const marginClass = invoice.margin >= 0 ? 'positive' : 'negative';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${invoice.invoiceNo}</td>
          <td>${formatDate(invoice.date)}</td>
          <td>${invoice.customer}</td>
          <td>₹${invoice.revenue.toFixed(2)}</td>
          <td>₹${invoice.cost.toFixed(2)}</td>
          <td class="${marginClass}">₹${invoice.margin.toFixed(2)}</td>
          <td class="${marginClass}">${marginPercent.toFixed(2)}%</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateProductTable(products) {
      const tableBody = document.getElementById('productTableBody');
      tableBody.innerHTML = '';

      if (products.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No product data available</td></tr>';
        return;
      }

      // Sort by margin (highest first)
      products.sort((a, b) => b.margin - a.margin);

      products.forEach(product => {
        const marginPercent = product.revenue > 0 ? (product.margin / product.revenue) * 100 : 0;
        const marginClass = product.margin >= 0 ? 'positive' : 'negative';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.productId}</td>
          <td>${product.productName}</td>
          <td>${product.unitsSold}</td>
          <td>₹${product.revenue.toFixed(2)}</td>
          <td class="${marginClass}">₹${product.margin.toFixed(2)}</td>
          <td class="${marginClass}">${marginPercent.toFixed(2)}%</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function populateFilters(salesData, productData) {
      const productFilter = document.getElementById('productFilter');
      const invoiceFilter = document.getElementById('invoiceFilter');
      
      // Clear existing options (except "All")
      while (productFilter.children.length > 1) {
        productFilter.removeChild(productFilter.lastChild);
      }
      
      while (invoiceFilter.children.length > 1) {
        invoiceFilter.removeChild(invoiceFilter.lastChild);
      }
      
      // Add product options
      const uniqueProducts = [...new Set(salesData.map(sale => sale["Product ID"]))];
      uniqueProducts.forEach(productId => {
        const product = productData.find(p => p["Product ID"] === productId);
        const productName = product ? product["Product Name"] : productId;
        
        const option = document.createElement('option');
        option.value = productId;
        option.textContent = productName;
        productFilter.appendChild(option);
      });
      
      // Add invoice options
      const uniqueInvoices = [...new Set(salesData.map(sale => sale["Invoice Number"]))];
      uniqueInvoices.forEach(invoiceNo => {
        const option = document.createElement('option');
        option.value = invoiceNo;
        option.textContent = invoiceNo;
        invoiceFilter.appendChild(option);
      });
    }

    function formatDate(dateString) {
      if (!dateString) return "N/A";
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
      } catch (error) {
        return dateString;
      }
    }
  </script>

</body>
</html>